<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ·±åº¦è§£ç å™¨ | Deep Decoder</title>

    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Mammoth.js for DOCX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>

    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* ==================== ä¸»é¢˜ç³»ç»Ÿï¼ˆä¸ key-manager ä¸€è‡´ï¼‰==================== */
        :root {
            --bg: #f6f7fb;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, 0.86);
            --panel2: rgba(255, 255, 255, 0.72);
            --text: #0f172a;
            --muted: #475569;
            --border: rgba(15, 23, 42, 0.14);
            --accent: #2563eb;
            --accent2: #7c3aed;
            --good: #059669;
            --bad: #e11d48;
            --warn: #d97706;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            --shadow: 0 10px 40px rgba(2, 6, 23, 0.08);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0f19;
                --bg2: #0b1020;
                --panel: rgba(17, 24, 39, 0.86);
                --panel2: rgba(15, 23, 42, 0.72);
                --text: #e5e7eb;
                --muted: #9ca3af;
                --border: rgba(255, 255, 255, 0.14);
                --accent: #60a5fa;
                --accent2: #a78bfa;
                --good: #34d399;
                --bad: #fb7185;
                --warn: #fbbf24;
                --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
            }
        }

        html[data-theme="light"] {
            --bg: #f6f7fb;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, 0.86);
            --panel2: rgba(255, 255, 255, 0.72);
            --text: #0f172a;
            --muted: #475569;
            --border: rgba(15, 23, 42, 0.14);
            --accent: #2563eb;
            --accent2: #7c3aed;
            --good: #059669;
            --bad: #e11d48;
            --warn: #d97706;
            --shadow: 0 10px 40px rgba(2, 6, 23, 0.08);
        }

        html[data-theme="dark"] {
            --bg: #0b0f19;
            --bg2: #0b1020;
            --panel: rgba(17, 24, 39, 0.86);
            --panel2: rgba(15, 23, 42, 0.72);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.14);
            --accent: #60a5fa;
            --accent2: #a78bfa;
            --good: #34d399;
            --bad: #fb7185;
            --warn: #fbbf24;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
        }

        /* ==================== åŸºç¡€æ ·å¼ ==================== */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--sans);
            color: var(--text);
            background:
                radial-gradient(900px 600px at 20% 10%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 60%),
                radial-gradient(900px 600px at 85% 0%, color-mix(in srgb, var(--accent2) 14%, transparent), transparent 55%),
                var(--bg);
            min-height: 100vh;
        }

        a {
            color: var(--accent);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 18px 14px 60px;
        }

        /* ==================== Header ==================== */
        header {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            padding: 14px 14px;
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 16px;
            position: sticky;
            top: 10px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .title {
            font-size: 18px;
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .subtitle {
            color: var(--muted);
            font-size: 13px;
            line-height: 1.35;
            margin-top: 6px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            align-items: center;
        }

        /* ==================== é€šç”¨ç»„ä»¶ ==================== */
        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        label {
            font-size: 12px;
            color: var(--muted);
        }

        select,
        input[type="text"],
        textarea {
            background: color-mix(in srgb, var(--bg2) 86%, transparent);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 10px;
            outline: none;
            font-family: inherit;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            font-family: var(--mono);
            font-size: 12px;
            resize: vertical;
        }

        .btn {
            background: color-mix(in srgb, var(--accent) 14%, transparent);
            color: var(--text);
            border: 1px solid color-mix(in srgb, var(--accent) 32%, transparent);
            border-radius: 12px;
            padding: 9px 14px;
            cursor: pointer;
            font-weight: 800;
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .btn:hover {
            background: color-mix(in srgb, var(--accent) 22%, transparent);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .btn.primary:hover {
            background: color-mix(in srgb, var(--accent) 85%, black);
        }

        .btn.secondary {
            background: color-mix(in srgb, var(--text) 6%, transparent);
            border-color: var(--border);
            font-weight: 700;
        }

        .btn.danger {
            background: color-mix(in srgb, var(--bad) 12%, transparent);
            border-color: color-mix(in srgb, var(--bad) 30%, transparent);
        }

        .btn.danger:hover {
            background: color-mix(in srgb, var(--bad) 18%, transparent);
        }

        .pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 4px 9px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
        }

        .pill.good {
            border-color: color-mix(in srgb, var(--good) 34%, transparent);
            color: var(--good);
            background: color-mix(in srgb, var(--good) 10%, transparent);
        }

        .pill.bad {
            border-color: color-mix(in srgb, var(--bad) 34%, transparent);
            color: var(--bad);
            background: color-mix(in srgb, var(--bad) 10%, transparent);
        }

        .pill.warn {
            border-color: color-mix(in srgb, var(--warn) 34%, transparent);
            color: var(--warn);
            background: color-mix(in srgb, var(--warn) 10%, transparent);
        }

        .pill.accent {
            border-color: color-mix(in srgb, var(--accent) 34%, transparent);
            color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, transparent);
        }

        /* ==================== å¸ƒå±€ ==================== */
        .main-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 14px;
            margin-top: 14px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }
        }

        /* ==================== ç§»åŠ¨ç«¯æŠ½å±‰èœå• ==================== */
        .mobile-menu-btn {
            display: none;
        }

        .mobile-overlay {
            display: none;
        }

        .mobile-drawer-close {
            display: none;
        }

        @media (max-width: 900px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                border-radius: 12px;
                background: color-mix(in srgb, var(--accent) 14%, transparent);
                border: 1px solid color-mix(in srgb, var(--accent) 32%, transparent);
                cursor: pointer;
                font-size: 20px;
                flex-shrink: 0;
            }

            .mobile-menu-btn:hover {
                background: color-mix(in srgb, var(--accent) 22%, transparent);
            }

            .sidebar {
                display: block !important;
                position: fixed !important;
                top: 0 !important;
                left: -280px !important;
                width: 260px;
                height: 100vh;
                z-index: 1000;
                padding: 20px 14px;
                background: var(--bg);
                box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
                transition: left 0.3s ease;
                overflow-y: auto;
            }

            .sidebar.open {
                left: 0 !important;
            }

            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .mobile-overlay.open {
                display: block;
            }

            .mobile-drawer-close {
                display: flex;
                justify-content: flex-end;
                margin-bottom: 14px;
            }
        }

        .sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            margin: 0 0 10px;
            font-size: 15px;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
            line-height: 1.45;
        }

        .log {
            font-family: var(--mono);
            font-size: 12px;
            color: color-mix(in srgb, var(--text) 92%, transparent);
            background: color-mix(in srgb, var(--bg2) 55%, transparent);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 700px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        details {
            border: 1px dashed color-mix(in srgb, var(--border) 90%, transparent);
            border-radius: 14px;
            padding: 10px 12px;
            background: color-mix(in srgb, var(--bg2) 55%, transparent);
        }

        summary {
            cursor: pointer;
            font-weight: 900;
        }

        code {
            font-family: var(--mono);
            font-size: 12px;
            background: color-mix(in srgb, var(--text) 6%, transparent);
            border: 1px solid color-mix(in srgb, var(--border) 85%, transparent);
            border-radius: 6px;
            padding: 2px 6px;
        }

        /* ==================== é˜¶æ®µå¯¼èˆª ==================== */
        .stage-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stage-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .stage-item:hover {
            background: color-mix(in srgb, var(--text) 5%, transparent);
        }

        .stage-item.active {
            background: color-mix(in srgb, var(--accent) 12%, transparent);
            border-color: color-mix(in srgb, var(--accent) 30%, transparent);
        }

        .stage-item.completed {
            color: var(--good);
            cursor: pointer;
        }

        .stage-item.completed:hover {
            background: color-mix(in srgb, var(--good) 10%, transparent);
            transform: translateX(2px);
        }

        .stage-item.completed .stage-number {
            background: color-mix(in srgb, var(--good) 20%, transparent);
        }

        .stage-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stage-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: color-mix(in srgb, var(--text) 8%, transparent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 13px;
        }

        .stage-item.active .stage-number {
            background: var(--accent);
            color: white;
        }

        .stage-item.completed .stage-number {
            background: var(--good);
            color: white;
        }

        .stage-label {
            font-size: 13px;
            font-weight: 700;
        }

        /* ==================== æ–‡ä»¶ä¸Šä¼ åŒº ==================== */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: color-mix(in srgb, var(--bg2) 50%, transparent);
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 5%, transparent);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .file-list {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            font-size: 20px;
        }

        .file-name {
            font-weight: 700;
            font-size: 13px;
        }

        .file-size {
            font-size: 12px;
            color: var(--muted);
        }

        /* ==================== è·¯å¾„é€‰æ‹©å¡ç‰‡ ==================== */
        .path-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .path-card {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: color-mix(in srgb, var(--bg2) 60%, transparent);
        }

        .path-card:hover {
            border-color: var(--accent);
        }

        .path-card.selected {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, transparent);
        }

        .path-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .path-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .path-card.selected .path-checkbox {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .path-letter {
            font-weight: 900;
            font-size: 16px;
        }

        .path-name {
            font-weight: 800;
            font-size: 14px;
        }

        .path-desc {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.4;
        }

        /* ==================== è¾“å‡ºå±•ç¤ºåŒº ==================== */
        .output-panel {
            background: color-mix(in srgb, var(--bg2) 80%, transparent);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            background: color-mix(in srgb, var(--text) 3%, transparent);
        }

        .output-title {
            font-weight: 800;
            font-size: 13px;
        }

        .output-content {
            padding: 14px;
            max-height: 600px;
            overflow-y: auto;
        }

        .output-content.markdown-body {
            line-height: 1.7;
        }

        .output-content.markdown-body h1,
        .output-content.markdown-body h2,
        .output-content.markdown-body h3 {
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: 800;
        }

        .output-content.markdown-body h1 {
            font-size: 1.5em;
        }

        .output-content.markdown-body h2 {
            font-size: 1.3em;
        }

        .output-content.markdown-body h3 {
            font-size: 1.1em;
        }

        .output-content.markdown-body p {
            margin: 0.8em 0;
        }

        .output-content.markdown-body ul,
        .output-content.markdown-body ol {
            padding-left: 1.5em;
            margin: 0.8em 0;
        }

        .output-content.markdown-body li {
            margin: 0.3em 0;
        }

        .output-content.markdown-body pre {
            background: color-mix(in srgb, var(--text) 6%, transparent);
            border-radius: 10px;
            padding: 14px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .output-content.markdown-body code {
            font-family: var(--mono);
            font-size: 0.9em;
        }

        .output-content.markdown-body pre code {
            background: transparent;
            border: none;
            padding: 0;
        }

        .output-content.markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .output-content.markdown-body th,
        .output-content.markdown-body td {
            border: 1px solid var(--border);
            padding: 8px 10px;
            text-align: left;
        }

        .output-content.markdown-body th {
            background: color-mix(in srgb, var(--text) 5%, transparent);
            font-weight: 800;
        }

        .output-content.markdown-body blockquote {
            border-left: 4px solid var(--accent);
            margin: 1em 0;
            padding: 0.5em 1em;
            background: color-mix(in srgb, var(--accent) 5%, transparent);
        }

        /* ==================== åŠ è½½åŠ¨ç”» ==================== */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .streaming-cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: var(--accent);
            margin-left: 2px;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* ==================== äº¤ä»˜ç‰©æ ‡ç­¾é¡µ ==================== */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border);
            padding: 0 14px;
            background: color-mix(in srgb, var(--text) 2%, transparent);
        }

        .tab {
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 700;
            color: var(--muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== çº¦æŸè¡¨å• ==================== */
        .constraint-section {
            margin-bottom: 16px;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: color-mix(in srgb, var(--bg2) 50%, transparent);
        }

        .constraint-title {
            font-weight: 800;
            font-size: 14px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .radio-item,
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s ease;
        }

        .radio-item:hover,
        .checkbox-item:hover {
            background: color-mix(in srgb, var(--text) 4%, transparent);
        }

        .radio-item.selected,
        .checkbox-item.selected {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, transparent);
        }

        .radio-item input,
        .checkbox-item input {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* ==================== è‡ªå®šä¹‰æ·»åŠ è¡Œ ==================== */
        .custom-add-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
        }

        .custom-add-row .custom-input {
            flex: 1;
            padding: 6px 10px;
            font-size: 13px;
        }

        .custom-add-row .add-custom-btn {
            padding: 6px 12px;
            font-size: 12px;
            white-space: nowrap;
        }

        /* ==================== å¤šé€‰å¤é€‰æ¡†ç»„ ==================== */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-item {
            user-select: none;
        }

        .checkbox-item[data-custom="true"] {
            background: color-mix(in srgb, var(--warn) 8%, transparent);
            border-color: color-mix(in srgb, var(--warn) 30%, transparent);
        }

        .checkbox-item[data-custom="true"].selected {
            background: color-mix(in srgb, var(--accent) 12%, transparent);
            border-color: var(--accent);
        }

        .remove-custom {
            font-size: 16px;
            font-weight: bold;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        .remove-custom:hover {
            opacity: 1;
        }

        /* ==================== çº¦æŸåŒºå—æ ‡é¢˜ä¼˜åŒ– ==================== */
        .constraint-section {
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 14px;
            background: color-mix(in srgb, var(--bg2) 60%, transparent);
        }

        .constraint-title {
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid color-mix(in srgb, var(--border) 60%, transparent);
        }

        .field>label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            display: block;
        }

        /* ==================== ç§»åŠ¨ç«¯ä¸»å†…å®¹åŒºä¼˜åŒ– ==================== */
        @media (max-width: 600px) {

            /* å®¹å™¨è¾¹è·æ”¶ç´§ */
            .container {
                padding: 12px 10px 40px;
            }

            /* Header ç´§å‡‘åŒ– */
            header {
                position: relative;
                top: 0;
                padding: 10px;
                gap: 10px;
            }

            header .title {
                font-size: 15px;
            }

            header .subtitle {
                font-size: 11px;
                line-height: 1.3;
            }

            .controls {
                width: 100%;
                justify-content: flex-start;
            }

            .controls .row {
                width: 100%;
                flex-wrap: wrap;
            }

            /* æŒ‰é’®ç»„ä¼˜åŒ– */
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            /* å¡ç‰‡å†…æŒ‰é’®ç»„ç«–æ’ */
            .card .row {
                flex-direction: column;
                gap: 8px;
            }

            .card .row .btn {
                width: 100%;
                justify-content: center;
            }

            /* è¡¨å•å…ƒç´ ç´§å‡‘åŒ– */
            .radio-item,
            .checkbox-item {
                font-size: 12px;
                padding: 6px 10px;
            }

            .radio-item input,
            .checkbox-item input {
                width: 14px;
                height: 14px;
            }

            /* çº¦æŸåŒºå— */
            .constraint-section {
                padding: 12px;
                margin-bottom: 14px;
            }

            .constraint-title {
                font-size: 13px;
                margin-bottom: 10px;
                padding-bottom: 8px;
            }

            /* è·¯å¾„å¡ç‰‡å…¨å®½ */
            .path-grid {
                grid-template-columns: 1fr;
            }

            .path-card {
                padding: 12px;
            }

            .path-name {
                font-size: 13px;
            }

            .path-desc {
                font-size: 11px;
            }

            /* ä¸Šä¼ åŒºåŸŸ */
            .upload-zone {
                padding: 24px 14px;
            }

            .upload-icon {
                font-size: 36px;
            }

            /* è¾“å‡ºé¢æ¿ */
            .output-content {
                max-height: 350px;
                padding: 10px;
            }

            .output-header {
                padding: 8px 10px;
            }

            .output-title {
                font-size: 12px;
            }

            /* è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
            .output-content.markdown-body table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* ä»£ç å— */
            .output-content.markdown-body pre {
                padding: 10px;
                font-size: 11px;
            }

            /* æ—¥å¿—åŒºåŸŸ */
            .log {
                font-size: 11px;
                padding: 8px;
                max-height: 200px;
            }

            /* æ ‡ç­¾é¡µ */
            .tabs {
                padding: 0 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }

            /* æ–‡æœ¬åŸŸ */
            textarea {
                min-height: 100px;
                font-size: 12px;
            }

            /* è‡ªå®šä¹‰æ·»åŠ è¡Œ */
            .custom-add-row {
                flex-direction: column;
            }

            .custom-add-row .custom-input {
                width: 100%;
            }

            .custom-add-row .add-custom-btn {
                width: 100%;
            }

            /* å¡ç‰‡æ ‡é¢˜ */
            .card h2 {
                font-size: 14px;
            }

            /* æç¤ºæ–‡å­— */
            .hint {
                font-size: 11px;
            }

            /* details/summary */
            details {
                padding: 8px 10px;
            }

            summary {
                font-size: 13px;
            }

            /* æ–‡ä»¶åˆ—è¡¨ */
            .file-item {
                padding: 8px 10px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .file-name {
                font-size: 12px;
            }

            .file-size {
                font-size: 11px;
            }
        }
    </style>
</head>

<body>
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- ==================== å·¥å…·å…ƒæ•°æ® ==================== -->
    <script type="application/json" id="tool_meta">
{
    "tool_id": "meta-system-architect",
    "tool_name": "æ·±åº¦è§£ç å™¨",
    "tool_version": "1.0.0",
    "description": "æ´æ‚‰åº•å±‚é€»è¾‘ï¼Œæš´åŠ›æ‹†è§£ä¸€åˆ‡ã€‚å°†ä»»æ„ç´ ææ·±åº¦èƒå–ï¼Œç¬é—´é‡é“¸ä¸ºæ‚¨çš„ä»£ç ã€äº§å“æ–¹æ¡ˆä¸çŸ¥è¯†ä½“ç³»",
    "created_at": "2024-12-30",
    "capabilities": {
        "paste_first": false,
        "file_input": true,
        "download_output": true,
        "url_state": false,
        "local_draft": true,
        "networking": true,
        "ai": true
    },
    "inputs": ["file_upload", "paste_text"],
    "outputs": ["copy_text", "download_file"],
    "dependencies": ["pdf.js", "mammoth.js", "marked.js", "highlight.js"],
    "ai_integration": {
        "uses_key_manager": true,
        "providers": ["siliconflow", "openrouter", "deepseek", "custom"],
        "key_names": ["siliconflow_key", "openrouter_key", "deepseek_key", "custom_key"]
    },
    "tags": ["productivity", "ai", "writing", "coding", "knowledge"],
    "links": {
        "source_repo": "",
        "prompt_log": ""
    }
}
</script>

    <!-- ==================== ä¸»å®¹å™¨ ==================== -->
    <div class="container">
        <!-- Header -->
        <header>
            <div class="left">
                <div class="title">
                    âš›ï¸ æ·±åº¦è§£ç å™¨
                    <span class="pill accent">v1.0</span>
                </div>
                <div class="subtitle">
                    æ´æ‚‰åº•å±‚é€»è¾‘ï¼Œæš´åŠ›æ‹†è§£ä¸€åˆ‡ã€‚å°†ä»»æ„ç´ ææ·±åº¦èƒå–ï¼Œç¬é—´é‡é“¸ä¸ºæ‚¨çš„ä»£ç ã€äº§å“æ–¹æ¡ˆä¸çŸ¥è¯†ä½“ç³»ã€‚<br />
                    åŸºäºã€Œä¸‰ç»´èƒå–åè®®ã€ä¸ã€Œäº”é˜¶æ®µå·¥ä½œæµã€ã€‚
                </div>
            </div>
            <div class="controls">
                <button class="mobile-menu-btn" id="mobileMenuBtn" title="æ‰“å¼€èœå•">â˜°</button>
                <div class="row">
                    <select id="themeSelect" style="min-width: 100px;">
                        <option value="auto">ğŸŒ“ è·Ÿéšç³»ç»Ÿ</option>
                        <option value="light">â˜€ï¸ æµ…è‰²</option>
                        <option value="dark">ğŸŒ™ æ·±è‰²</option>
                    </select>
                    <a href="key-manager.html" target="_blank" class="btn secondary">ğŸ”‘ Key Manager</a>
                    <button class="btn secondary" id="resetBtn">ğŸ”„ é‡æ–°å¼€å§‹</button>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar: Stage Navigation -->
            <aside class="sidebar">
                <div class="mobile-drawer-close">
                    <button class="btn secondary" id="mobileDrawerClose">âœ• å…³é—­</button>
                </div>
                <div class="card">
                    <h2>å·¥ä½œæµé˜¶æ®µ</h2>
                    <div class="stage-nav" id="stageNav">
                        <div class="stage-item active" data-stage="1">
                            <div class="stage-number">1</div>
                            <div class="stage-label">è§£ç </div>
                        </div>
                        <div class="stage-item locked" data-stage="2">
                            <div class="stage-number">2</div>
                            <div class="stage-label">è·¯ç”±</div>
                        </div>
                        <div class="stage-item locked" data-stage="3">
                            <div class="stage-number">3</div>
                            <div class="stage-label">æ¥å£</div>
                        </div>
                        <div class="stage-item locked" data-stage="4">
                            <div class="stage-number">4</div>
                            <div class="stage-label">æ¶æ„</div>
                        </div>
                        <div class="stage-item locked" data-stage="5">
                            <div class="stage-number">5</div>
                            <div class="stage-label">äº¤ä»˜</div>
                        </div>
                    </div>
                </div>

                <!-- AI Settings -->
                <div class="card" style="margin-top: 14px;">
                    <div id="aiSettingsMount"></div>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="mainContent">
                <!-- Stage 1: è§£ç  -->
                <section class="card" id="stage1" data-stage="1">
                    <h2>é˜¶æ®µ 1ï¼šè§£ç ä¸å¤æ‚åº¦è¯„ä¼°</h2>
                    <div class="hint" style="margin-bottom: 14px;">
                        ä¸Šä¼ æ‚¨çš„ç´ ææ–‡ä»¶ï¼ˆæ”¯æŒ .txt, .md, .pdf, .docx, .jpg, .pngï¼‰ï¼Œæˆ–ç›´æ¥ç²˜è´´æ–‡æœ¬ã€‚<br />
                        ç³»ç»Ÿå°†æ‰§è¡Œã€Œä¸‰ç»´èƒå–åè®®ã€ï¼Œè¾“å‡ºã€Šæ–¹æ³•è®ºè§£æ„æŠ¥å‘Šã€‹ã€‚
                    </div>

                    <!-- Upload Zone -->
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div style="font-weight: 700; font-size: 15px;">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸Šä¼ </div>
                        <div class="hint" style="margin-top: 8px;">æ”¯æŒ: .txt .md .pdf .docx .jpg .png .webp</div>
                        <input type="file" id="fileInput" multiple accept=".txt,.md,.pdf,.docx,.jpg,.jpeg,.png,.webp"
                            style="display:none;" />
                    </div>

                    <!-- File List -->
                    <div class="file-list" id="fileList"></div>

                    <!-- Or paste text -->
                    <details style="margin-top: 14px;">
                        <summary>æˆ–è€…ï¼šç›´æ¥ç²˜è´´æ–‡æœ¬</summary>
                        <div class="field" style="margin-top: 10px;">
                            <textarea id="pasteTextArea" placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„ç´ ææ–‡æœ¬..."></textarea>
                        </div>
                    </details>

                    <!-- Content Preview -->
                    <div style="margin-top: 14px;" id="contentPreviewSection" hidden>
                        <h3 style="font-size: 14px; margin-bottom: 10px;">ğŸ“„ å†…å®¹é¢„è§ˆ</h3>
                        <div class="log" id="contentPreview" style="max-height: 200px;"></div>
                        <div class="hint" style="margin-top: 8px;">
                            <span id="contentStats"></span>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="row" style="margin-top: 14px; justify-content: flex-end;">
                        <button class="btn primary" id="startDecodeBtn" disabled>
                            ğŸš€ å¼€å§‹è§£ç 
                        </button>
                    </div>

                    <!-- Decode Output -->
                    <div id="decodeOutputSection" style="margin-top: 14px;" hidden>
                        <div class="output-panel">
                            <div class="output-header">
                                <div class="output-title">ğŸ“Š æ–¹æ³•è®ºè§£æ„æŠ¥å‘Š</div>
                                <div class="row">
                                    <button class="btn secondary" id="copyDecodeBtn">ğŸ“‹ å¤åˆ¶</button>
                                </div>
                            </div>
                            <div class="output-content markdown-body" id="decodeOutput"></div>
                        </div>

                        <div class="row" style="margin-top: 14px; justify-content: space-between;">
                            <div class="hint">è¯·ç¡®è®¤ï¼šæˆ‘æå–çš„è¿™äº›ã€Œçµé­‚è¦ç´ ã€æ˜¯å¦å‡†ç¡®ï¼Ÿ</div>
                            <div class="row">
                                <button class="btn secondary" id="reDecodeBtn">ğŸ”„ é‡æ–°è§£ç </button>
                                <button class="btn primary" id="confirmDecodeBtn">âœ… ç¡®è®¤ï¼Œè¿›å…¥é˜¶æ®µ 2</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Stage 2: è·¯ç”± -->
                <section class="card" id="stage2" data-stage="2" hidden>
                    <h2>é˜¶æ®µ 2ï¼šé¢†åŸŸè·¯ç”±ä¸å…¨æ ˆæ˜ å°„</h2>
                    <div class="hint" style="margin-bottom: 14px;">
                        é€»è¾‘å·²æå–ã€‚è¯·é€‰æ‹©æ‚¨å¸Œæœ›å°†è¿™å¥—æ–¹æ³•è®ºè½¬è¯‘ä¸ºä»€ä¹ˆå½¢æ€ï¼ˆæ”¯æŒå¤šé€‰ï¼‰ã€‚
                    </div>

                    <div class="path-grid" id="pathGrid">
                        <div class="path-card" data-path="A">
                            <div class="path-card-header">
                                <div class="path-checkbox"></div>
                                <div class="path-letter">A</div>
                            </div>
                            <div class="path-name">å†…å®¹ç”Ÿäº§</div>
                            <div class="path-desc">å¤ç”¨å…¶æ€æƒ³æ¥å†™æ–‡ç« /æ•™ç¨‹/è„šæœ¬</div>
                        </div>

                        <div class="path-card" data-path="B">
                            <div class="path-card-header">
                                <div class="path-checkbox"></div>
                                <div class="path-letter">B</div>
                            </div>
                            <div class="path-name">å·¥å…·å¼€å‘</div>
                            <div class="path-desc">å°†é€»è¾‘è½¬åŒ–ä¸ºä»£ç /è„šæœ¬/è‡ªåŠ¨åŒ–å·¥å…·</div>
                        </div>

                        <div class="path-card" data-path="C">
                            <div class="path-card-header">
                                <div class="path-checkbox"></div>
                                <div class="path-letter">C</div>
                            </div>
                            <div class="path-name">äº§å“è®¾è®¡</div>
                            <div class="path-desc">è½¬åŒ–ä¸ºç½‘ç«™/APP çš„åŠŸèƒ½æ¶æ„</div>
                        </div>

                        <div class="path-card" data-path="D">
                            <div class="path-card-header">
                                <div class="path-checkbox"></div>
                                <div class="path-letter">D</div>
                            </div>
                            <div class="path-name">çŸ¥è¯†æç‚¼</div>
                            <div class="path-desc">æç‚¼æ€ç»´æ¨¡å‹ï¼Œå­˜å…¥çŸ¥è¯†åº“</div>
                        </div>

                        <div class="path-card" data-path="E">
                            <div class="path-card-header">
                                <div class="path-checkbox"></div>
                                <div class="path-letter">E</div>
                            </div>
                            <div class="path-name">å…¨æ ˆå¥—è£…</div>
                            <div class="path-desc">åŒæ—¶ç”Ÿæˆ A+B+Dï¼Œæ‰“é€ å®Œæ•´é—­ç¯</div>
                        </div>
                    </div>

                    <div class="row"
                        style="margin-top: 14px; padding: 10px; background: color-mix(in srgb, var(--bg2) 60%, transparent); border-radius: 10px;">
                        <div class="hint">
                            <strong>å·²é€‰è·¯å¾„ï¼š</strong><span id="selectedPathsText">å°šæœªé€‰æ‹©</span>
                        </div>
                    </div>

                    <div class="row" style="margin-top: 14px; justify-content: flex-end;">
                        <button class="btn secondary" id="backToStage1Btn">â† è¿”å›é˜¶æ®µ 1</button>
                        <button class="btn primary" id="confirmPathsBtn" disabled>âœ… ç¡®è®¤è·¯å¾„ï¼Œè¿›å…¥é˜¶æ®µ 3</button>
                    </div>
                </section>

                <!-- Stage 3: æ¥å£ -->
                <section class="card" id="stage3" data-stage="3" hidden>
                    <h2>é˜¶æ®µ 3ï¼šæ¥å£å®šä¹‰ä¸ç¯å¢ƒçº¦æŸ</h2>
                    <div class="hint" style="margin-bottom: 14px;">
                        æ ¹æ®æ‚¨é€‰æ‹©çš„è·¯å¾„ï¼Œè¯·å¡«å†™ä»¥ä¸‹çº¦æŸæ¡ä»¶ã€‚è¿™å°†å¸®åŠ© AI ç”Ÿæˆæ›´ç²¾å‡†çš„äº¤ä»˜ç‰©ã€‚
                    </div>

                    <!-- AI æ¨èå¼€å‘æ–¹å‘ -->
                    <div id="aiRecommendationsSection" style="margin-bottom: 20px;">
                        <div class="constraint-section">
                            <div class="constraint-title">
                                <span class="pill accent">ğŸ’¡</span> AI æ¨èå¼€å‘æ–¹å‘
                                <small style="opacity: 0.6; font-weight: normal;">â€” åŸºäºè§£æ„æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆ</small>
                            </div>
                            <div id="aiRecommendationsContainer">
                                <div class="loading-spinner"></div> AI æ­£åœ¨åˆ†æå¯è¡Œçš„å¼€å‘æ–¹å‘...
                            </div>
                            <div id="aiRecommendationsGrid" style="display: none; gap: 12px; margin-top: 12px;"></div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border);">
                                <small style="opacity: 0.7;">ğŸ’¬ ä»¥ä¸Šæ˜¯ AI
                                    æ ¹æ®ç´ ææ¨èçš„å¼€å‘æ–¹å‘ï¼Œç‚¹å‡»å¡ç‰‡å¯è‡ªåŠ¨å¡«å……åç§°å’ŒåŠŸèƒ½ã€‚æ‚¨ä¹Ÿå¯ä»¥å¿½ç•¥æ¨èï¼Œç›´æ¥åœ¨ä¸‹æ–¹è‡ªå®šä¹‰å¡«å†™ã€‚</small>
                            </div>
                        </div>
                    </div>

                    <div id="constraintsForm"></div>

                    <div class="row" style="margin-top: 14px; justify-content: flex-end;">
                        <button class="btn secondary" id="backToStage2Btn">â† è¿”å›é˜¶æ®µ 2</button>
                        <button class="btn primary" id="confirmConstraintsBtn">âœ… ç¡®è®¤çº¦æŸï¼Œè¿›å…¥é˜¶æ®µ 4</button>
                    </div>
                </section>

                <!-- Stage 4: æ¶æ„ -->
                <section class="card" id="stage4" data-stage="4" hidden>
                    <h2>é˜¶æ®µ 4ï¼šæ¶æ„è®¾è®¡ä¸é€»è¾‘ç¡¬åŒ–</h2>
                    <div class="hint" style="margin-bottom: 14px;">
                        AI æ­£åœ¨æ ¹æ®æ‚¨çš„è·¯å¾„å’Œçº¦æŸï¼Œè®¾è®¡æ¶æ„æ–¹æ¡ˆå¹¶è¿›è¡Œé€»è¾‘ç¡¬åŒ–...
                    </div>

                    <div id="architectureOutputSection">
                        <div class="output-panel">
                            <div class="output-header">
                                <div class="output-title">ğŸ—ï¸ æ¶æ„è®¾è®¡æ–¹æ¡ˆ</div>
                                <div class="row">
                                    <button class="btn secondary" id="copyArchitectureBtn">ğŸ“‹ å¤åˆ¶</button>
                                </div>
                            </div>
                            <div class="output-content markdown-body" id="architectureOutput"></div>
                        </div>
                    </div>

                    <!-- ä¿®æ”¹æ„è§åŒºåŸŸ -->
                    <div class="card" id="revisionSection" style="margin-top: 14px; display: none;">
                        <h3 style="margin: 0 0 12px; font-size: 14px;">ğŸ’¡ æäº¤ä¿®æ”¹æ„è§</h3>
                        <div class="hint" style="margin-bottom: 10px;">
                            å¦‚æœå¯¹æ¶æ„æ–¹æ¡ˆæœ‰ä¿®æ”¹å»ºè®®ï¼Œè¯·åœ¨ä¸‹æ–¹å¡«å†™åæäº¤ï¼ŒAI å°†æ ¹æ®æ‚¨çš„æ„è§é‡æ–°ç”Ÿæˆã€‚
                        </div>
                        <div class="field">
                            <textarea id="revisionInput"
                                placeholder="è¯·æè¿°æ‚¨å¸Œæœ›ä¿®æ”¹çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š&#10;- è·¯å¾„Bçš„å·¥å…·åç§°æ”¹ä¸ºã€Œxxxã€&#10;- å¢åŠ æŸæŸåŠŸèƒ½æ¨¡å—&#10;- è°ƒæ•´é£æ ¼ä¸ºæ›´ç®€æ´çš„ç‰ˆæœ¬"
                                style="min-height: 100px;"></textarea>
                        </div>
                        <div class="row" style="margin-top: 10px;">
                            <button class="btn secondary" id="submitRevisionBtn">ğŸ”„ æäº¤ä¿®æ”¹æ„è§</button>
                        </div>
                    </div>

                    <div class="row" style="margin-top: 14px; justify-content: space-between;">
                        <button class="btn secondary" id="backToStage3Btn">â† è¿”å›é˜¶æ®µ 3</button>
                        <div class="row" style="gap: 10px;">
                            <button class="btn secondary" id="showRevisionBtn">ğŸ’¬ æˆ‘æœ‰ä¿®æ”¹æ„è§</button>
                            <button class="btn primary" id="confirmArchitectureBtn" disabled>âœ… ç¡®è®¤æ¶æ„ï¼Œç”Ÿæˆäº¤ä»˜ç‰©</button>
                        </div>
                    </div>
                </section>

                <!-- Stage 5: äº¤ä»˜ -->
                <section class="card" id="stage5" data-stage="5" hidden>
                    <h2>é˜¶æ®µ 5ï¼šæ²™ç›’æ¨¡æ‹Ÿä¸äº¤ä»˜</h2>
                    <div class="hint" style="margin-bottom: 14px;">
                        AI å·²å®Œæˆæ²™ç›’æ¨¡æ‹Ÿï¼Œä»¥ä¸‹æ˜¯æœ€ç»ˆäº¤ä»˜ç‰©ã€‚
                    </div>

                    <!-- Test Report -->
                    <details style="margin-bottom: 14px;">
                        <summary>ğŸ“‹ å‹åŠ›æµ‹è¯•æŠ¥å‘Š</summary>
                        <div class="log" id="testReportOutput" style="margin-top: 10px;"></div>
                    </details>

                    <!-- Deliverables Tabs -->
                    <div class="output-panel">
                        <div class="tabs" id="deliverableTabs"></div>
                        <div id="deliverableContents"></div>
                    </div>

                    <div class="row" style="margin-top: 14px; justify-content: space-between;">
                        <div class="row">
                            <button class="btn secondary" id="downloadAllBtn">ğŸ“¥ ä¸‹è½½å…¨éƒ¨ (Markdown)</button>
                            <button class="btn secondary" id="downloadJsonBtn">ğŸ“¥ ä¸‹è½½ JSON</button>
                        </div>
                        <button class="btn primary" id="newProjectBtn">ğŸ†• å¼€å§‹æ–°é¡¹ç›®</button>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- ==================== AI Module ==================== -->
    <script>
        /******************************
         * AI Module v2 (Chinese UI)
         * - With Domain Security Patch
         ******************************/

        const AI_MODULE = (() => {
            const KM_PROVIDER_OVERRIDES_KEY = "km_provider_overrides_v1";

            const AI_PROVIDERS = {
                "siliconflow": {
                    name: "ç¡…åŸºæµåŠ¨ (SiliconFlow)",
                    keyName: "siliconflow_key",
                    baseUrl: "https://api.siliconflow.cn/v1",
                    models: [
                        { id: "Qwen/Qwen3-VL-235B-A22B-Thinking", name: "Qwen 3 VLï¼ˆThinkingï¼‰" },
                        { id: "Pro/moonshotai/Kimi-K2-Thinking", name: "Kimi K2ï¼ˆThinkingï¼‰" },
                        { id: "Qwen/Qwen2.5-7B-Instruct", name: "Qwen 2.5 7Bï¼ˆFastï¼‰" },
                        { id: "deepseek-ai/DeepSeek-V3", name: "DeepSeek V3" },
                        { id: "Pro/zai-org/GLM-4.7", name: "GLM-4.7" },
                        { id: "Qwen/Qwen3-VL-32B-Thinking", name: "Qwen 3 VL 32Bï¼ˆThinkingï¼‰" }
                    ]
                },
                "openrouter": {
                    name: "OpenRouter",
                    keyName: "openrouter_key",
                    baseUrl: "https://openrouter.ai/api/v1",
                    models: [
                        { id: "openai/gpt-5.2-pro", name: "GPT-5.2 Pro" },
                        { id: "openai/gpt-5.2-chat", name: "GPT-5.2 Chat" },
                        { id: "google/gemini-3-pro-preview", name: "Gemini 3 Pro Preview" },
                        { id: "anthropic/claude-opus-4.5", name: "Claude Opus 4.5" },
                        { id: "nano banana pro", name: "Nano Banana Pro" }
                    ]
                },
                "deepseek": {
                    name: "DeepSeek Official",
                    keyName: "deepseek_key",
                    baseUrl: "https://api.deepseek.com",
                    models: [
                        { id: "deepseek-chat", name: "DeepSeek V3" },
                        { id: "deepseek-reasoner", name: "DeepSeek R1" }
                    ]
                },
                "custom": {
                    name: "è‡ªå®šä¹‰ / æœ¬åœ°ï¼ˆOllamaï¼‰",
                    keyName: "custom_key",
                    baseUrl: "http://localhost:11434/v1",
                    models: []
                }
            };

            const providerAdapters = {};

            function safeJsonParse(str) {
                try { return { ok: true, value: JSON.parse(str) }; }
                catch (e) { return { ok: false, error: String(e) }; }
            }

            function getOverrides() {
                const raw = localStorage.getItem(KM_PROVIDER_OVERRIDES_KEY);
                if (!raw) return {};
                const parsed = safeJsonParse(raw);
                if (!parsed.ok || !parsed.value || typeof parsed.value !== "object") return {};
                return parsed.value;
            }

            function normalizeBaseUrl(baseUrl) {
                const s = String(baseUrl || "").trim();
                return s.replace(/\/+$/, "");
            }

            function joinUrl(baseUrl, path) {
                const b = normalizeBaseUrl(baseUrl);
                const p = String(path || "").trim().replace(/^\/+/, "");
                return `${b}/${p}`;
            }

            function getProvider(providerId) {
                return AI_PROVIDERS[providerId];
            }

            function getMergedProviderConfig(providerId) {
                const p = getProvider(providerId);
                if (!p) throw new Error(`æœªçŸ¥ provider_id: ${providerId}`);

                const overrides = getOverrides();
                const o = overrides[providerId] || {};

                const customModels = Array.isArray(o.custom_models) ? o.custom_models : [];
                const mergedModels = [
                    ...(Array.isArray(p.models) ? p.models : []),
                    ...customModels
                        .filter(m => m && typeof m === "object" && m.id)
                        .map(m => ({ id: String(m.id), name: m.name ? String(m.name) : String(m.id), _custom: true }))
                ];

                const baseUrl = o.base_url_override ? String(o.base_url_override) : p.baseUrl;
                const modelId = o.model_id_override ? String(o.model_id_override) : (mergedModels[0]?.id || "");

                return {
                    provider_id: providerId,
                    name: p.name,
                    key_name: p.keyName,
                    base_url_default: p.baseUrl,
                    base_url: baseUrl,
                    models: mergedModels,
                    model_id_default: mergedModels[0]?.id || "",
                    model_id: modelId
                };
            }

            function getKeyStatus(providerId) {
                const p = getProvider(providerId);
                if (!p) return { ok: false, has_key: false, key_name: "" };
                const keyName = p.keyName;
                const key = localStorage.getItem(keyName);
                return { ok: true, has_key: Boolean(key), key_name: keyName };
            }

            // Domain Security Functions
            function getHostname(url) {
                try { return new URL(String(url || "").trim()).hostname; }
                catch { return ""; }
            }

            function isDomainAllowed(hostname, allowlist) {
                if (!hostname) return false;
                return (allowlist || []).some(allowed => {
                    if (hostname === allowed) return true;
                    if (hostname.endsWith('.' + allowed)) return true;
                    return false;
                });
            }

            function ensureDomainConsentOrThrow(hostname, consentKey = "ai_domain_consent_v1") {
                const raw = localStorage.getItem(consentKey) || "{}";
                let obj = {};
                try { obj = JSON.parse(raw); } catch { obj = {}; }

                if (obj[hostname] === true) return true;

                const ok = confirm(
                    `ä½ å³å°†æŠŠè¯·æ±‚ï¼ˆåŒ…å«å¯†é’¥ï¼‰å‘é€åˆ°åŸŸåï¼š${hostname}\n\n` +
                    `ç¡®è®¤è¦å…è®¸å—ï¼Ÿ\n` +
                    `å¦‚æœè¿™ä¸ªåŸŸåä¸æ˜¯ä½ ä¿¡ä»»çš„å¹³å°ï¼Œè¯·ç‚¹å–æ¶ˆã€‚`
                );
                if (!ok) throw new Error("ç¯å¢ƒé”™è¯¯: ç”¨æˆ·å–æ¶ˆäº†åŸŸåæˆæƒ");

                obj[hostname] = true;
                localStorage.setItem(consentKey, JSON.stringify(obj));
                return true;
            }

            const DOMAIN_ALLOWLIST = [
                "api.siliconflow.cn",
                "openrouter.ai",
                "api.deepseek.com",
                "api.openai.com",
                "localhost"
            ];

            function classifyFetchError(err) {
                const msg = String(err?.message || err || "");
                const lower = msg.toLowerCase();
                if (lower.includes("abort")) return { kind: "ç¯å¢ƒé”™è¯¯", msg: "è¯·æ±‚è¶…æ—¶/è¢«å–æ¶ˆï¼ˆAbortï¼‰" };
                if (lower.includes("failed to fetch") || lower.includes("network") || lower.includes("cors")) {
                    return { kind: "ç¯å¢ƒé”™è¯¯", msg: msg };
                }
                return { kind: "å†…éƒ¨é”™è¯¯", msg: msg };
            }

            function actionableErrorMessage(kind, msg) {
                if (kind === "ç”¨æˆ·è¾“å…¥é”™è¯¯") {
                    return `ç”¨æˆ·è¾“å…¥é”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}\n- æ€ä¹ˆä¿®å¤ï¼šæ£€æŸ¥ Base URL / Model ID / è¾“å…¥å†…å®¹æ˜¯å¦ä¸ºç©ºã€‚`;
                }
                if (kind === "ç¯å¢ƒé”™è¯¯") {
                    return `ç¯å¢ƒé”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}\n- æ€ä¹ˆä¿®å¤ï¼šæ£€æŸ¥ç½‘ç»œ/CORS/æ˜¯å¦ https é¡µé¢è®¿é—® httpï¼ˆæ··åˆå†…å®¹ï¼‰ã€‚`;
                }
                if (kind === "å¹³å°é”™è¯¯") {
                    return `å¹³å°é”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}\n- æ€ä¹ˆä¿®å¤ï¼šæ£€æŸ¥ key æ˜¯å¦æœ‰æ•ˆã€æ˜¯å¦é™æµã€æ¨¡å‹ ID æ˜¯å¦å­˜åœ¨ã€‚`;
                }
                return `å†…éƒ¨é”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}`;
            }

            async function corsProbe(baseUrl, timeoutMs = 8000) {
                const now = new Date().toISOString();
                const url = String(baseUrl || "").trim();
                if (!url) return { ok: false, kind: "ç”¨æˆ·è¾“å…¥é”™è¯¯", result: "ç©º URL", details: { now, url } };

                let u;
                try { u = new URL(url); }
                catch (e) {
                    return { ok: false, kind: "ç”¨æˆ·è¾“å…¥é”™è¯¯", result: "URL æ— æ•ˆ", details: { now, url, error: String(e) } };
                }

                if (location.protocol === "https:" && u.protocol === "http:") {
                    return { ok: false, kind: "ç¯å¢ƒé”™è¯¯", result: "æ··åˆå†…å®¹ï¼ˆhttps é¡µé¢ä¸èƒ½è®¿é—® httpï¼‰", details: { now, url } };
                }
                if (navigator.onLine === false) {
                    return { ok: false, kind: "ç¯å¢ƒé”™è¯¯", result: "ç¦»çº¿", details: { now, url } };
                }

                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const resp = await fetch(url, { method: "GET", mode: "cors", cache: "no-store", signal: controller.signal });
                    return { ok: true, kind: "OK", result: "èƒ½æ‹¿åˆ°å“åº”ï¼ˆCORS å¯èƒ½å¯ç”¨ï¼‰", details: { now, url, status: resp.status, statusText: resp.statusText } };
                } catch (e) {
                    const info = classifyFetchError(e);
                    return { ok: false, kind: info.kind, result: "å¯èƒ½è¢« CORS/ç½‘ç»œæ‹¦æˆª", details: { now, url, error: info.msg } };
                } finally {
                    clearTimeout(timer);
                }
            }

            // Unified caller with streaming support
            async function call_llm_stream({
                provider_id,
                base_url,
                api_key,
                model_id,
                messages,
                temperature = 0.7,
                max_tokens = 4096,
                timeout_ms = 120000,
                onChunk = null
            }) {
                if (!provider_id) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: provider_id ä¸ºç©º");
                if (!base_url) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: base_url ä¸ºç©º");
                if (!model_id) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: model_id ä¸ºç©º");
                if (!Array.isArray(messages) || messages.length === 0) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: messages ä¸ºç©º");

                if (!api_key) {
                    const e = new Error("å¹³å°é”™è¯¯: ç¼ºå°‘ API Keyï¼ˆè¯·å…ˆåœ¨ key-manager.html è®¾ç½®ï¼‰");
                    e._kind = "å¹³å°é”™è¯¯";
                    throw e;
                }

                // Domain security check
                const hostname = getHostname(base_url);
                if (!isDomainAllowed(hostname, DOMAIN_ALLOWLIST)) {
                    ensureDomainConsentOrThrow(hostname);
                }

                const url = joinUrl(base_url, "/chat/completions");
                const headers = {
                    "Authorization": `Bearer ${api_key}`,
                    "Content-Type": "application/json"
                };

                const body = {
                    model: model_id,
                    messages,
                    temperature,
                    max_tokens,
                    stream: true
                };

                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeout_ms);

                try {
                    const resp = await fetch(url, {
                        method: "POST",
                        mode: "cors",
                        headers,
                        body: JSON.stringify(body),
                        signal: controller.signal
                    });

                    if (!resp.ok) {
                        const text = await resp.text();
                        const e = new Error(`å¹³å°é”™è¯¯: HTTP ${resp.status} ${resp.statusText}\n${text.slice(0, 800)}`);
                        e._kind = "å¹³å°é”™è¯¯";
                        throw e;
                    }

                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = "";
                    let buffer = "";  // ç¼“å†²åŒºç”¨äºå¤„ç†è·¨ chunk çš„ä¸å®Œæ•´è¡Œ

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        // å°†æ–°æ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒº
                        buffer += decoder.decode(value, { stream: true });

                        // æŒ‰æ¢è¡Œç¬¦åˆ†å‰²ï¼Œä¿ç•™æœ€åä¸€ä¸ªå¯èƒ½ä¸å®Œæ•´çš„è¡Œ
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || "";  // æœ€åä¸€è¡Œå¯èƒ½ä¸å®Œæ•´ï¼Œæ”¾å›ç¼“å†²åŒº

                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (!trimmed.startsWith('data: ')) continue;

                            const data = trimmed.slice(6).trim();
                            if (data === '[DONE]') continue;

                            try {
                                const json = JSON.parse(data);
                                const content = json.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullContent += content;
                                    if (onChunk) onChunk(content, fullContent);
                                }
                            } catch (e) {
                                // Skip malformed JSON
                            }
                        }
                    }

                    // å¤„ç†ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®
                    if (buffer.trim().startsWith('data: ')) {
                        const data = buffer.trim().slice(6).trim();
                        if (data && data !== '[DONE]') {
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullContent += content;
                                    if (onChunk) onChunk(content, fullContent);
                                }
                            } catch (e) { }
                        }
                    }

                    return { text: fullContent };
                } catch (e) {
                    if (e && e._kind) throw e;
                    const info = classifyFetchError(e);
                    const err = new Error(`${info.kind}: ${info.msg}`);
                    err._kind = info.kind;
                    throw err;
                } finally {
                    clearTimeout(timer);
                }
            }

            // UI renderer
            function render_ai_settings_html() {
                const providerOptions = Object.keys(AI_PROVIDERS)
                    .map(pid => `<option value="${pid}">${AI_PROVIDERS[pid].name}</option>`)
                    .join("");

                return `
            <details id="aiSettings">
                <summary style="font-weight:900;">âš™ï¸ AI è®¾ç½®</summary>
                <div style="margin-top:10px;">
                    <div class="hint">
                        è¯·å…ˆåœ¨ <a href="key-manager.html" target="_blank">Key Manager</a> è®¾ç½®å¯†é’¥ã€‚
                    </div>

                    <div class="row" style="margin-top:10px;">
                        <span class="pill warn">
                            <input id="aiNetworkingToggle" type="checkbox" style="transform: translateY(1px);" />
                            <span>å…è®¸è”ç½‘</span>
                        </span>
                        <span class="pill" id="aiKeyStatusPill">å¯†é’¥ï¼šæœªæ£€æŸ¥</span>
                    </div>

                    <div class="field" style="margin-top:10px;">
                        <label for="aiProviderSelect">å¹³å°</label>
                        <select id="aiProviderSelect">${providerOptions}</select>
                    </div>

                    <div class="field" style="margin-top:10px;">
                        <label for="aiModelPresetSelect">æ¨¡å‹</label>
                        <select id="aiModelPresetSelect"></select>
                    </div>

                    <div class="field" style="margin-top:10px;">
                        <label for="aiBaseUrlInput">Base URL</label>
                        <input id="aiBaseUrlInput" type="text" placeholder="https://api.xxx.com/v1" />
                    </div>

                    <div class="field" style="margin-top:10px;">
                        <label for="aiModelIdInput">æ¨¡å‹ ID</label>
                        <input id="aiModelIdInput" type="text" placeholder="æ¨¡å‹åç§°" />
                    </div>

                    <details style="margin-top:10px;">
                        <summary>é«˜çº§å‚æ•°</summary>
                        <div class="two-col" style="margin-top:10px;">
                            <div class="field">
                                <label for="aiTemperature">temperature</label>
                                <input id="aiTemperature" type="text" value="0.7" />
                            </div>
                            <div class="field">
                                <label for="aiMaxTokens">max_tokens</label>
                                <input id="aiMaxTokens" type="text" value="4096" />
                            </div>
                        </div>
                    </details>

                    <div class="row" style="margin-top:10px;">
                        <button class="btn secondary" id="aiSyncBtn" type="button">ğŸ”„ åŒæ­¥é…ç½®</button>
                    </div>

                    <div class="log" id="aiLog" style="margin-top:10px; max-height: 100px;">AI æ¨¡å—å°±ç»ªã€‚</div>
                </div>
            </details>
        `;
            }

            function mount_ai_settings({ mount_el, default_provider_id = "siliconflow" }) {
                if (!mount_el) throw new Error("mount_el is required");

                mount_el.innerHTML = render_ai_settings_html();
                const $ = (id) => mount_el.querySelector(id);

                const aiNetworkingToggle = $("#aiNetworkingToggle");
                const aiProviderSelect = $("#aiProviderSelect");
                const aiBaseUrlInput = $("#aiBaseUrlInput");
                const aiModelPresetSelect = $("#aiModelPresetSelect");
                const aiModelIdInput = $("#aiModelIdInput");
                const aiKeyStatusPill = $("#aiKeyStatusPill");
                const aiTemperature = $("#aiTemperature");
                const aiMaxTokens = $("#aiMaxTokens");
                const aiLog = $("#aiLog");
                const aiSyncBtn = $("#aiSyncBtn");

                const state = {
                    networking_enabled: false,
                    provider_id: default_provider_id,
                    base_url: "",
                    model_id: "",
                    temperature: 0.7,
                    max_tokens: 4096
                };

                function setKeyStatusPill(providerId) {
                    const ks = getKeyStatus(providerId);
                    if (!ks.ok) {
                        aiKeyStatusPill.className = "pill bad";
                        aiKeyStatusPill.textContent = "å¯†é’¥ï¼šæœªçŸ¥";
                        return;
                    }
                    if (ks.has_key) {
                        aiKeyStatusPill.className = "pill good";
                        aiKeyStatusPill.textContent = `å¯†é’¥ï¼šâœ… å·²è®¾ç½®`;
                    } else {
                        aiKeyStatusPill.className = "pill bad";
                        aiKeyStatusPill.textContent = `å¯†é’¥ï¼šâŒ æœªè®¾ç½®`;
                    }
                }

                function rebuildModelPresetOptions(providerId, preferModelId = "") {
                    const cfg = getMergedProviderConfig(providerId);
                    const models = cfg.models || [];
                    const options = [
                        ...models.map(m => `<option value="${String(m.id)}">${String(m.name || m.id)}${m._custom ? "ï¼ˆè‡ªå®šä¹‰ï¼‰" : ""}</option>`),
                        `<option value="__custom__">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹ ID</option>`
                    ].join("");
                    aiModelPresetSelect.innerHTML = options;

                    const effectiveModelId = preferModelId || cfg.model_id || cfg.model_id_default || "";
                    const hasPreset = models.some(m => String(m.id) === String(effectiveModelId));
                    aiModelPresetSelect.value = hasPreset ? String(effectiveModelId) : "__custom__";
                }

                function syncFromKeyManager(providerId) {
                    const cfg = getMergedProviderConfig(providerId);
                    state.base_url = String(cfg.base_url || "");
                    state.model_id = String(cfg.model_id || "");
                    aiBaseUrlInput.value = state.base_url;
                    aiModelIdInput.value = state.model_id;

                    rebuildModelPresetOptions(providerId, state.model_id);
                    setKeyStatusPill(providerId);

                    aiLog.textContent = `å·²åŒæ­¥ï¼š${cfg.name}\nBase URL: ${state.base_url}\nModel: ${state.model_id}`;
                }

                // Initial
                aiProviderSelect.value = default_provider_id;
                syncFromKeyManager(default_provider_id);

                aiNetworkingToggle.addEventListener("change", () => {
                    state.networking_enabled = Boolean(aiNetworkingToggle.checked);
                    aiLog.textContent = state.networking_enabled
                        ? "å·²å…è®¸è”ç½‘ï¼šå¯ä»¥è°ƒç”¨ AI APIã€‚"
                        : "å·²å…³é—­è”ç½‘ï¼šä¸ä¼šå‘èµ·ä»»ä½• AI è¯·æ±‚ã€‚";
                });

                aiProviderSelect.addEventListener("change", () => {
                    state.provider_id = aiProviderSelect.value;
                    syncFromKeyManager(state.provider_id);
                });

                aiBaseUrlInput.addEventListener("change", () => {
                    state.base_url = String(aiBaseUrlInput.value || "").trim();
                });

                aiModelPresetSelect.addEventListener("change", () => {
                    const chosen = aiModelPresetSelect.value;
                    if (chosen === "__custom__") {
                        aiModelIdInput.focus();
                        return;
                    }
                    aiModelIdInput.value = chosen;
                    state.model_id = chosen;
                });

                aiModelIdInput.addEventListener("change", () => {
                    state.model_id = String(aiModelIdInput.value || "").trim();
                });

                aiTemperature.addEventListener("change", () => {
                    const v = Number(aiTemperature.value);
                    state.temperature = Number.isFinite(v) ? v : 0.7;
                });

                aiMaxTokens.addEventListener("change", () => {
                    const v = Number(aiMaxTokens.value);
                    state.max_tokens = Number.isFinite(v) ? Math.max(1, Math.floor(v)) : 4096;
                });

                aiSyncBtn.addEventListener("click", () => syncFromKeyManager(state.provider_id));

                function get_state() {
                    return {
                        ...state,
                        key_status: getKeyStatus(state.provider_id)
                    };
                }

                async function call_ai({ messages, onChunk }) {
                    const s = get_state();
                    if (!s.networking_enabled) {
                        const e = new Error("ç¯å¢ƒé”™è¯¯: å½“å‰æœªå…è®¸è”ç½‘ï¼ˆè¯·å‹¾é€‰ã€Œå…è®¸è”ç½‘ã€ï¼‰");
                        e._kind = "ç¯å¢ƒé”™è¯¯";
                        throw e;
                    }
                    const p = getProvider(s.provider_id);
                    const apiKey = localStorage.getItem(p.keyName) || "";

                    return await call_llm_stream({
                        provider_id: s.provider_id,
                        base_url: s.base_url,
                        api_key: apiKey,
                        model_id: s.model_id,
                        messages,
                        temperature: s.temperature,
                        max_tokens: s.max_tokens,
                        onChunk
                    });
                }

                function get_actionable_error(err) {
                    const kind = err?._kind || "å†…éƒ¨é”™è¯¯";
                    const msg = String(err?.message || err || "");
                    return actionableErrorMessage(kind, msg);
                }

                return {
                    get_state,
                    call_ai,
                    get_actionable_error,
                    sync: () => syncFromKeyManager(state.provider_id)
                };
            }

            return {
                AI_PROVIDERS,
                mount_ai_settings,
                getMergedProviderConfig,
                getKeyStatus,
                corsProbe,
                actionableErrorMessage
            };
        })();
    </script>

    <!-- ==================== File Parser Module ==================== -->
    <script>
        const FILE_PARSER = (() => {
            // Set PDF.js worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            async function parseTextFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('è¯»å–æ–‡æœ¬æ–‡ä»¶å¤±è´¥'));
                    reader.readAsText(file);
                });
            }

            async function parsePdfFile(file) {
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let text = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    text += pageText + '\n\n';
                }

                return text.trim();
            }

            async function parseDocxFile(file) {
                if (typeof mammoth === 'undefined') {
                    throw new Error('Mammoth.js æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }

                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            }

            async function parseImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result;
                        resolve({
                            type: 'image',
                            base64: base64,
                            mimeType: file.type,
                            name: file.name
                        });
                    };
                    reader.onerror = () => reject(new Error('è¯»å–å›¾ç‰‡å¤±è´¥'));
                    reader.readAsDataURL(file);
                });
            }

            async function parseFile(file) {
                const ext = file.name.split('.').pop().toLowerCase();
                const mimeType = file.type;

                if (ext === 'txt' || ext === 'md' || mimeType === 'text/plain' || mimeType === 'text/markdown') {
                    return { type: 'text', content: await parseTextFile(file), name: file.name };
                }

                if (ext === 'pdf' || mimeType === 'application/pdf') {
                    return { type: 'text', content: await parsePdfFile(file), name: file.name };
                }

                if (ext === 'docx' || mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    return { type: 'text', content: await parseDocxFile(file), name: file.name };
                }

                if (['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext) || mimeType.startsWith('image/')) {
                    return await parseImageFile(file);
                }

                throw new Error(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${ext}`);
            }

            async function parseMultipleFiles(files) {
                const results = [];
                const errors = [];

                for (const file of files) {
                    try {
                        const result = await parseFile(file);
                        results.push(result);
                    } catch (e) {
                        errors.push({ file: file.name, error: e.message });
                    }
                }

                return { results, errors };
            }

            function formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }

            return {
                parseFile,
                parseMultipleFiles,
                formatSize
            };
        })();
    </script>

    <!-- ==================== Prompt Templates ==================== -->
    <script>
        const PROMPT_TEMPLATES = (() => {

            const stage1Decode = (content, images = []) => `ä½ æ˜¯ä¸€åã€Œæ·±åº¦è§£ç å™¨ã€ï¼Œæ­£åœ¨æ‰§è¡Œã€Œæ·±åº¦è§£ç ä¸é€»è¾‘æå–ã€åè®®ã€‚

## æ ¸å¿ƒç†å¿µ
- æ–¹æ³•è®ºå³èµ„äº§ï¼šä»»ä½•ä¼˜ç§€çš„åŸå§‹ç´ æï¼Œéƒ½å¯ä»¥è¢«æ‹†è§£ä¸ºå¯å¤ç”¨çš„ä»£ç æˆ– Prompt
- åˆ†å·¥å³æ•ˆç‡ï¼šå¤æ‚çš„ä»»åŠ¡å¿…é¡»æ‹†è§£ä¸ºä¸åŒçš„"èŒèƒ½ä»£ç†ï¼ˆAgentsï¼‰"æ¥åä½œå®Œæˆ
- æµç¨‹å³äº§å“ï¼šäº¤ä»˜çš„ä¸åªæ˜¯ Promptï¼Œè€Œæ˜¯åŒ…å«è¾“å…¥ã€å¤„ç†ã€è¾“å‡ºã€åé¦ˆé—­ç¯çš„å®Œæ•´ç”Ÿäº§çº¿

## ä»»åŠ¡
å¯¹ç”¨æˆ·æä¾›çš„ç´ æè¿›è¡Œã€Œä¸‰ç»´èƒå–ã€ï¼Œè¾“å‡ºä¸€ä»½æ·±åº¦ä¸“ä¸šçš„ã€Šæ–¹æ³•è®ºè§£æ„æŠ¥å‘Šã€‹ã€‚

## è¾“å…¥ç´ æ
\`\`\`
${content.slice(0, 50000)}
\`\`\`

${images.length > 0 ? `## é™„å¸¦å›¾ç‰‡\nå…± ${images.length} å¼ å›¾ç‰‡ï¼Œè¯·ç»“åˆå›¾ç‰‡å†…å®¹è¿›è¡Œæ·±åº¦åˆ†æã€‚` : ''}

## è¾“å‡ºè¦æ±‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„è¾“å‡ºæ·±åº¦ä¸“ä¸šçš„è§£æ„æŠ¥å‘Šï¼š

---

# ğŸ“Š æ–¹æ³•è®ºè§£æ„æŠ¥å‘Š

## ä¸€ã€å…ƒä¿¡æ¯æ¦‚è§ˆ

| ç»´åº¦ | åˆ†æç»“æœ |
|------|----------|
| ç´ æç±»å‹ | [æ–¹æ³•è®º/æ•™ç¨‹/æ¡ˆä¾‹/ç†è®ºæ¡†æ¶/æ“ä½œæŒ‡å—/...] |
| é¢†åŸŸå½’å± | [å†™ä½œ/è¥é”€/äº§å“/æŠ€æœ¯/ç®¡ç†/...] |
| å¤æ‚åº¦è¯„çº§ | [L1 è½»é‡/L2 ç³»ç»Ÿ/L3 å¤æ‚] |
| é€‚ç”¨åœºæ™¯ | [å…·ä½“æè¿°é€‚ç”¨çš„ä¸šåŠ¡åœºæ™¯] |
| ç›®æ ‡äº§å‡º | [è¯¥æ–¹æ³•è®ºæœ€ç»ˆè¦äº§å‡ºä»€ä¹ˆ] |

---

## äºŒã€éª¨æ¶å±‚ï¼šæ ¸å¿ƒç®—æ³•æå–

### 2.1 åº•å±‚æ€ç»´æ¨¡å‹

ä¸»æ¨¡å‹è¯†åˆ«ï¼š[è¯†åˆ«ç´ æèƒŒåçš„æ ¸å¿ƒæ€ç»´æ¨¡å‹]

| æ¨¡å‹åç§° | æ¨¡å‹æœ¬è´¨ | åœ¨ç´ æä¸­çš„ä½“ç° |
|----------|----------|----------------|
| [å¦‚ï¼šæ¼æ–—æ¨¡å‹] | [æœ¬è´¨æè¿°] | [å…·ä½“ä½“ç°] |
| [å¦‚ï¼šé£è½®æ•ˆåº”] | [æœ¬è´¨æè¿°] | [å…·ä½“ä½“ç°] |

æ¨¡å‹é—´å…³ç³»ï¼š[æè¿°å¤šä¸ªæ¨¡å‹å¦‚ä½•ååŒè¿ä½œ]

### 2.2 æ ¸å¿ƒæ‰§è¡Œé“¾è·¯

\`\`\`pseudo
// ä¸»æµç¨‹ä¼ªä»£ç 
FUNCTION æ–¹æ³•è®ºä¸»æµç¨‹(è¾“å…¥å‚æ•°):
    
    // ç¬¬ä¸€é˜¶æ®µï¼š[é˜¶æ®µåç§°]
    IF æ¡ä»¶A THEN
        æ‰§è¡Œæ­¥éª¤ 1.1
        æ‰§è¡Œæ­¥éª¤ 1.2
    ELSE
        æ‰§è¡Œå¤‡é€‰è·¯å¾„
    
    // ç¬¬äºŒé˜¶æ®µï¼š[é˜¶æ®µåç§°]
    WHILE æœªè¾¾åˆ°ç›®æ ‡ DO
        æ‰§è¡Œæ ¸å¿ƒå¾ªç¯
        æ£€æŸ¥é€€å‡ºæ¡ä»¶
    
    // ç¬¬ä¸‰é˜¶æ®µï¼š[é˜¶æ®µåç§°]
    FOR EACH å…ƒç´  IN é›†åˆ DO
        å¤„ç†å•ä¸ªå…ƒç´ 
        ç´¯ç§¯ç»“æœ
    
    RETURN æœ€ç»ˆäº§å‡º

// å…³é”®å­å‡½æ•°
FUNCTION å­æµç¨‹A(å‚æ•°):
    [å…·ä½“é€»è¾‘]
    RETURN ç»“æœ
\`\`\`

### 2.3 å…³é”®å˜é‡å­—å…¸

| å˜é‡æ ‡è¯† | å˜é‡åç§° | æ•°æ®ç±»å‹ | å¿…å¡« | è¯´æ˜ | è´¨é‡è¦æ±‚ |
|----------|----------|----------|------|------|----------|
| \`[Q_Input_1]\` | [åç§°] | [æ–‡æœ¬/æ•°æ®/æ¡ˆä¾‹] | æ˜¯/å¦ | [è¯´æ˜] | [å…·ä½“è´¨é‡æ ‡å‡†] |
| \`[Q_Input_2]\` | [åç§°] | [æ–‡æœ¬/æ•°æ®/æ¡ˆä¾‹] | æ˜¯/å¦ | [è¯´æ˜] | [å…·ä½“è´¨é‡æ ‡å‡†] |
| \`[Q_Context]\` | [åç§°] | [æ–‡æœ¬/æ•°æ®/æ¡ˆä¾‹] | æ˜¯/å¦ | [è¯´æ˜] | [å…·ä½“è´¨é‡æ ‡å‡†] |

### 2.4 å†³ç­–åˆ†æ”¯å›¾è°±

\`\`\`
[èµ·ç‚¹]
    â”‚
    â–¼
[åˆ¤æ–­æ¡ä»¶ 1] â”€â”€â”€ Yes â”€â”€â†’ [è·¯å¾„ A] â”€â”€â†’ [å­åˆ¤æ–­] â”€â”€â”€ Yes â”€â”€â†’ [ç»“æœ A1]
    â”‚                                    â”‚
    No                                   No
    â”‚                                    â”‚
    â–¼                                    â–¼
[åˆ¤æ–­æ¡ä»¶ 2] â”€â”€â”€ Yes â”€â”€â†’ [è·¯å¾„ B]      [ç»“æœ A2]
    â”‚
    No
    â”‚
    â–¼
[é»˜è®¤è·¯å¾„ C]
\`\`\`

---

## ä¸‰ã€è¡€è‚‰å±‚ï¼šæŠ€æ³•ä¸çº¹ç†æå–

### 3.1 é£æ ¼æŒ‡çº¹åˆ†æ

| é£æ ¼ç»´åº¦ | å…·ä½“ç‰¹å¾ | å…¸å‹ç¤ºä¾‹ |
|----------|----------|----------|
| æ•´ä½“è°ƒæ€§ | [å¦‚ï¼šä¸¥è‚ƒä¸“ä¸š/è½»æ¾å¹½é»˜/æ¸©æš–æ²»æ„ˆ/çŠ€åˆ©é”åˆ©] | "[å¼•ç”¨åŸæ–‡ç¤ºä¾‹]" |
| è¯­è¨€å¯†åº¦ | [é«˜ä¿¡æ¯å¯†åº¦/ä¸­ç­‰/ä½å¯†åº¦å™äº‹] | "[å¼•ç”¨åŸæ–‡ç¤ºä¾‹]" |
| å¥å¼åå¥½ | [é•¿å¥ä¸ºä¸»/çŸ­å¥èŠ‚å¥/é—®ç­”äº¤æ›¿] | "[å¼•ç”¨åŸæ–‡ç¤ºä¾‹]" |
| ä¿®è¾ç‰¹ç‚¹ | [å–„ç”¨ç±»æ¯”/æ•°æ®é©±åŠ¨/æ•…äº‹åŒ–/æ¸…å•åŒ–] | "[å¼•ç”¨åŸæ–‡ç¤ºä¾‹]" |
| æƒ…æ„Ÿæ›²çº¿ | [å¹³ç¨³/èµ·ä¼/é€’è¿›é«˜æ½®] | "[æè¿°æƒ…æ„Ÿèµ°å‘]" |

### 3.2 é¢—ç²’åº¦è¿˜åŸï¼ˆå¾®ç»†èŠ‚åº“ï¼‰

> âš ï¸ è¿™äº›æ˜¯"å†…è¡Œæ‰æ‡‚"çš„ç»†èŠ‚ï¼Œæ™®é€š AI æ¦‚æ‹¬æ—¶æœ€å®¹æ˜“ä¸¢å¤±

æŠ€æ³•ç±»å¾®ç»†èŠ‚ï¼š
- ğŸ”¸ [å¾®ç»†èŠ‚ 1]ï¼š[è¯¦ç»†æè¿°] â†’ è¿™ä¸ªç»†èŠ‚çš„ä½œç”¨æ˜¯ [è¯´æ˜]
- ğŸ”¸ [å¾®ç»†èŠ‚ 2]ï¼š[è¯¦ç»†æè¿°] â†’ è¿™ä¸ªç»†èŠ‚çš„ä½œç”¨æ˜¯ [è¯´æ˜]
- ğŸ”¸ [å¾®ç»†èŠ‚ 3]ï¼š[è¯¦ç»†æè¿°] â†’ è¿™ä¸ªç»†èŠ‚çš„ä½œç”¨æ˜¯ [è¯´æ˜]

ç»“æ„ç±»å¾®ç»†èŠ‚ï¼š
- ğŸ”¹ [å¾®ç»†èŠ‚ 1]ï¼š[è¯¦ç»†æè¿°]
- ğŸ”¹ [å¾®ç»†èŠ‚ 2]ï¼š[è¯¦ç»†æè¿°]

è¡¨è¾¾ç±»å¾®ç»†èŠ‚ï¼š
- ğŸ”» [å¾®ç»†èŠ‚ 1]ï¼š[è¯¦ç»†æè¿°]
- ğŸ”» [å¾®ç»†èŠ‚ 2]ï¼š[è¯¦ç»†æè¿°]

### 3.3 é»‘è¯ä¸æœ¯è¯­ä½“ç³»

| æœ¯è¯­/é»‘è¯ | æ ‡å‡†è§£é‡Š | ä½¿ç”¨è¯­å¢ƒ | æ›¿ä»£è¡¨è¾¾ |
|-----------|----------|----------|----------|
| "[æœ¯è¯­1]" | [è§£é‡Š] | [ä»€ä¹ˆæ—¶å€™ç”¨] | [å¯æ›¿æ¢çš„è¯´æ³•] |
| "[æœ¯è¯­2]" | [è§£é‡Š] | [ä»€ä¹ˆæ—¶å€™ç”¨] | [å¯æ›¿æ¢çš„è¯´æ³•] |

### 3.4 éšå–»ä¸ç±»æ¯”åº“

| éšå–»/ç±»æ¯” | åŸæ–‡è¡¨è¾¾ | æ˜ å°„å…³ç³» | å¯å¤ç”¨åœºæ™¯ |
|-----------|----------|----------|------------|
| [éšå–»1] | "[åŸæ–‡]" | A æ¯”ä½œ Bï¼Œå› ä¸º [åŸå› ] | [å…¶ä»–å¯ç”¨åœºæ™¯] |
| [éšå–»2] | "[åŸæ–‡]" | A æ¯”ä½œ Bï¼Œå› ä¸º [åŸå› ] | [å…¶ä»–å¯ç”¨åœºæ™¯] |

---

## å››ã€çµé­‚å±‚ï¼šå¿ƒæ³•ä¸è¾¹ç•Œæå–

### 4.1 ä»·å€¼é”šç‚¹ï¼ˆä¸ºä»€ä¹ˆå®ƒæœ‰æ•ˆï¼‰

æ ¸å¿ƒæ´å¯Ÿï¼š
> [ç”¨ä¸€æ®µè¯æ€»ç»“è¿™ä¸ªæ–¹æ³•è®ºæœ€é¢ è¦†è®¤çŸ¥ã€æœ€æœ‰ä»·å€¼çš„ç‚¹]

æœ‰æ•ˆæ€§å½’å› ï¼š
| æˆåŠŸå› ç´  | æ·±å±‚åŸå›  | å¯è¿ç§»æ€§ |
|----------|----------|----------|
| [å› ç´ 1] | [ä¸ºä»€ä¹ˆè¿™ä¸ªå› ç´ æœ‰æ•ˆ] | [æ˜¯å¦å¯ä»¥è¿ç§»åˆ°å…¶ä»–åœºæ™¯] |
| [å› ç´ 2] | [ä¸ºä»€ä¹ˆè¿™ä¸ªå› ç´ æœ‰æ•ˆ] | [æ˜¯å¦å¯ä»¥è¿ç§»åˆ°å…¶ä»–åœºæ™¯] |

### 4.2 è¾¹ç•Œæ¡ä»¶ï¼ˆä»€ä¹ˆæ—¶å€™ä¸é€‚ç”¨ï¼‰

> âš ï¸ è¿™æ˜¯åŒºåˆ†ä¸“å®¶ä¸ AI çš„å…³é”®èƒ½åŠ›

| ä¸é€‚ç”¨åœºæ™¯ | åŸå› åˆ†æ | æ›¿ä»£æ–¹æ¡ˆå»ºè®® |
|------------|----------|--------------|
| [åœºæ™¯1] | [ä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ä¼šå¤±æ•ˆ] | [åº”è¯¥ç”¨ä»€ä¹ˆæ›¿ä»£] |
| [åœºæ™¯2] | [ä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ä¼šå¤±æ•ˆ] | [åº”è¯¥ç”¨ä»€ä¹ˆæ›¿ä»£] |
| [åœºæ™¯3] | [ä¸ºä»€ä¹ˆåœ¨è¿™ä¸ªåœºæ™¯ä¸‹ä¼šå¤±æ•ˆ] | [åº”è¯¥ç”¨ä»€ä¹ˆæ›¿ä»£] |

å¤±æ•ˆä¿¡å·ï¼ˆå‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶åº”åœæ­¢ä½¿ç”¨ï¼‰ï¼š
- âŒ [ä¿¡å·1]
- âŒ [ä¿¡å·2]
- âŒ [ä¿¡å·3]

### 4.3 å…ƒè®¤çŸ¥æå–ï¼ˆåº•å±‚ä»·å€¼è§‚ï¼‰

| å…ƒè®¤çŸ¥ç»´åº¦ | ä½œè€…éšå«çš„ä¿¡å¿µ | è¯æ®/ä½“ç° |
|------------|----------------|-----------|
| ä¸–ç•Œè§‚ | [ä½œè€…å¦‚ä½•çœ‹å¾…è¿™ä¸ªé¢†åŸŸ] | "[å¼•ç”¨è¯æ®]" |
| æ–¹æ³•è®º | [ä½œè€…ç›¸ä¿¡ä»€ä¹ˆæ ·çš„æ–¹æ³•æœ‰æ•ˆ] | "[å¼•ç”¨è¯æ®]" |
| ä»·å€¼æ’åº | [ä½œè€…è®¤ä¸ºä»€ä¹ˆæœ€é‡è¦] | "[å¼•ç”¨è¯æ®]" |
| é£é™©åå¥½ | [ä½œè€…å¯¹é£é™©çš„æ€åº¦] | "[å¼•ç”¨è¯æ®]" |

### 4.4 åå¸¸è¯†è¦ç‚¹

| å¸¸è¯†è®¤çŸ¥ | ç´ æä¸­çš„åå¸¸è¯†è§‚ç‚¹ | è®ºè¯é€»è¾‘ |
|----------|---------------------|----------|
| "äººä»¬é€šå¸¸è®¤ä¸º..." | "ä½†å®é™…ä¸Š..." | [ä¸ºä»€ä¹ˆåå¸¸è¯†æ˜¯å¯¹çš„] |

---

## äº”ã€ç³»ç»Ÿè®¾è®¡é¢„åˆ¤

### 5.1 å¤æ‚åº¦è¯„ä¼°

| è¯„ä¼°ç»´åº¦ | å½“å‰çŠ¶æ€ | è¯„åˆ†(1-5) |
|----------|----------|-----------|
| é€»è¾‘åˆ†æ”¯æ•°é‡ | [æè¿°] | â­â­â­â˜†â˜† |
| å˜é‡è€¦åˆç¨‹åº¦ | [æè¿°] | â­â­â­â˜†â˜† |
| é¢†åŸŸçŸ¥è¯†ä¾èµ– | [æè¿°] | â­â­â­â˜†â˜† |
| è¾“å‡ºè´¨é‡è¦æ±‚ | [æè¿°] | â­â­â­â˜†â˜† |

ç»¼åˆè¯„çº§ï¼šLevel [1/2/3]

### 5.2 å»ºè®®æ¶æ„

| æ¶æ„æ–¹æ¡ˆ | é€‚ç”¨æ¡ä»¶ | æ¨èæŒ‡æ•° |
|----------|----------|----------|
| å•ä½“ Prompt | [ä»€ä¹ˆæƒ…å†µä¸‹é€‰æ‹©] | â­â­â­â˜†â˜† |
| åŒ Agent åä½œ | [ä»€ä¹ˆæƒ…å†µä¸‹é€‰æ‹©] | â­â­â­â˜†â˜† |
| å¤š Agent æµæ°´çº¿ | [ä»€ä¹ˆæƒ…å†µä¸‹é€‰æ‹©] | â­â­â­â˜†â˜† |

æ¨èæ–¹æ¡ˆï¼š[å…·ä½“æ¨èå“ªç§æ¶æ„ï¼Œä»¥åŠä¸ºä»€ä¹ˆ]

### 5.3 é¢„åˆ¤çš„ Agent è§’è‰²

åŸºäºç´ æç‰¹æ€§ï¼Œé¢„åˆ¤éœ€è¦ä»¥ä¸‹ Agent è§’è‰²ï¼š

| Agent è§’è‰² | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|------------|------|------|------|
| [è§’è‰²1ï¼Œå¦‚ï¼šæ‹†è§£è€…] | [å…·ä½“èŒè´£] | [éœ€è¦ä»€ä¹ˆè¾“å…¥] | [äº§å‡ºä»€ä¹ˆ] |
| [è§’è‰²2ï¼Œå¦‚ï¼šèåˆè€…] | [å…·ä½“èŒè´£] | [éœ€è¦ä»€ä¹ˆè¾“å…¥] | [äº§å‡ºä»€ä¹ˆ] |
| [è§’è‰²3ï¼Œå¦‚ï¼šæ¶æ„å¸ˆ] | [å…·ä½“èŒè´£] | [éœ€è¦ä»€ä¹ˆè¾“å…¥] | [äº§å‡ºä»€ä¹ˆ] |
| [è§’è‰²4ï¼Œå¦‚ï¼šçŸ¿å·¥] | [å…·ä½“èŒè´£] | [éœ€è¦ä»€ä¹ˆè¾“å…¥] | [äº§å‡ºä»€ä¹ˆ] |

### 5.4 æ½œåœ¨é£é™©é¢„è­¦

| é£é™©ç±»å‹ | å…·ä½“é£é™© | é¢„é˜²æªæ–½ |
|----------|----------|----------|
| ä¿¡æ¯ä¸¢å¤±é£é™© | [ä»€ä¹ˆä¿¡æ¯å®¹æ˜“åœ¨è½¬è¯‘ä¸­ä¸¢å¤±] | [å¦‚ä½•é¢„é˜²] |
| é€»è¾‘æ–­å±‚é£é™© | [å“ªä¸ªç¯èŠ‚å®¹æ˜“å‡ºç°æ–­å±‚] | [å¦‚ä½•é¢„é˜²] |
| è´¨é‡æ³¢åŠ¨é£é™© | [ä»€ä¹ˆæƒ…å†µä¸‹è´¨é‡ä¼šä¸‹é™] | [å¦‚ä½•é¢„é˜²] |

---

## å…­ã€å¾…ç¡®è®¤äº‹é¡¹

åœ¨è¿›å…¥ä¸‹ä¸€é˜¶æ®µå‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é—®é¢˜ï¼š

### 6.1 å…³äºæ‚¨çš„èº«ä»½ï¼ˆWhoï¼‰
- æ‚¨çš„èŒä¸š/è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ
- æ‚¨åœ¨è¿™ä¸ªé¢†åŸŸçš„ç»éªŒæ°´å¹³ï¼Ÿ
- æ‚¨çš„ä¸ªäººé£æ ¼åå¥½ï¼Ÿ

### 6.2 å…³äºç›®æ ‡å—ä¼—ï¼ˆTo Whomï¼‰
- è¿™å¥—ç³»ç»Ÿçš„äº§å‡ºæ˜¯ç»™è°çœ‹çš„ï¼Ÿ
- å—ä¼—çš„è®¤çŸ¥æ°´å¹³å¦‚ä½•ï¼Ÿ
- å—ä¼—æœ€å…³å¿ƒä»€ä¹ˆï¼Ÿ

### 6.3 å…³äºæ ¸å¿ƒè¯‰æ±‚ï¼ˆWhatï¼‰
- æ‚¨å¸Œæœ›è¿™å¥—ç³»ç»Ÿä¸»è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
- æ‚¨å¸Œæœ›äº§å‡ºçš„å½¢å¼æ˜¯ä»€ä¹ˆï¼Ÿ
- æœ‰æ²¡æœ‰å¿…é¡»åŒ…å«/æ’é™¤çš„å…ƒç´ ï¼Ÿ

---

è¯·ç¡®è®¤ï¼šä»¥ä¸Šè§£æ„æŠ¥å‘Šæ˜¯å¦å‡†ç¡®ï¼Ÿæœ‰éœ€è¦è¡¥å……æˆ–ä¿®æ­£çš„åœ°æ–¹å—ï¼Ÿ
`;

            const stage4Architecture = (decodeReport, paths, constraints) => `ä½ æ˜¯ä¸€åã€Œæ·±åº¦è§£ç å™¨ã€ï¼Œæ­£åœ¨æ‰§è¡Œã€Œæ¶æ„è®¾è®¡ä¸é€»è¾‘ç¡¬åŒ–ã€ã€‚

## å·²æœ‰ä¿¡æ¯

### è§£æ„æŠ¥å‘Šæ‘˜è¦
${decodeReport}

### ç”¨æˆ·é€‰æ‹©çš„è·¯å¾„
${paths.join(', ')}

### ç”¨æˆ·çº¦æŸ
${JSON.stringify(constraints, null, 2)}

## ä»»åŠ¡
æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œä¸ºæ¯æ¡é€‰ä¸­çš„è·¯å¾„è®¾è®¡æ¶æ„æ–¹æ¡ˆå¹¶è¿›è¡Œé€»è¾‘ç¡¬åŒ–ã€‚

## è¾“å‡ºè¦æ±‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown ç»“æ„è¾“å‡ºï¼š

# æ¶æ„è®¾è®¡æ–¹æ¡ˆ

${paths.includes('A') || paths.includes('E') ? `
## è·¯å¾„ Aï¼šå†…å®¹ç”Ÿäº§æ¶æ„

### æ¶æ„è®¾è®¡
[æ ¹æ®å¤æ‚åº¦é€‰æ‹©å•ä½“ Prompt æˆ–å¤š Agent ç³»ç»Ÿ]

### é€»è¾‘ç¡¬åŒ–æªæ–½
- **Yå‹è·¯ç”±**ï¼š[çƒ­å¯åŠ¨ vs å†·å¯åŠ¨ç­–ç•¥]
- **ç»“æ„é€šèƒ€**ï¼š[å†…å®¹æ‰©å®¹ç­–ç•¥]
- **çº¹ç†ä¿çœŸ**ï¼š[é£æ ¼ä¿æŒç­–ç•¥]

### æ ¸å¿ƒ Prompt æ¡†æ¶
\`\`\`
[å†™ä½œ Prompt çš„æ ¸å¿ƒæ¡†æ¶]
\`\`\`
` : ''}

${paths.includes('B') || paths.includes('E') ? `
## è·¯å¾„ Bï¼šå·¥å…·å¼€å‘æ¶æ„

### æ¶æ„è®¾è®¡
[æŠ€æœ¯æ¶æ„æ–¹æ¡ˆ]

### é€»è¾‘ç¡¬åŒ–æªæ–½
- **è¾¹ç•Œé˜²å¾¡**ï¼š[é”™è¯¯å¤„ç†ç­–ç•¥]
- **è§„èŒƒå¯¹é½**ï¼š[ä»£ç è§„èŒƒ]
- **ä¼ªä»£ç é”šå®š**ï¼š[æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç ]

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
| æ¨¡å— | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| ... | ... | ... | ... |
` : ''}

${paths.includes('C') ? `
## è·¯å¾„ Cï¼šäº§å“è®¾è®¡æ¶æ„

### æ¶æ„è®¾è®¡
[äº§å“åŠŸèƒ½æ¶æ„]

### é€»è¾‘ç¡¬åŒ–æªæ–½
- **ä»·å€¼é—­ç¯**ï¼š[ç”¨æˆ·æ—…ç¨‹è®¾è®¡]
- **åŠŸèƒ½æ˜ å°„**ï¼š[æ ¸å¿ƒåŠŸèƒ½åˆ—è¡¨]

### åŠŸèƒ½æ¶æ„å›¾
[æ–‡å­—æè¿°äº§å“åŠŸèƒ½æ¶æ„]
` : ''}

${paths.includes('D') || paths.includes('E') ? `
## è·¯å¾„ Dï¼šçŸ¥è¯†æç‚¼æ¶æ„

### æ¶æ„è®¾è®¡
[çŸ¥è¯†ç»„ç»‡æ–¹æ¡ˆ]

### é€»è¾‘ç¡¬åŒ–æªæ–½
- **æ¦‚å¿µé™ç»´**ï¼š[å¦‚ä½•è®©å¤æ‚æ¦‚å¿µæ˜“æ‡‚]
- **å…ƒè®¤çŸ¥æå–**ï¼š[æå–å“ªäº›å…ƒè®¤çŸ¥]

### çŸ¥è¯†å¡ç‰‡æ¨¡æ¿
[å¡ç‰‡ç»“æ„è®¾è®¡]
` : ''}

## ç¡¬åŒ–æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| å˜é‡å‘½åä¸€è‡´æ€§ | âœ… | ... |
| è¾¹ç•Œæ¡ä»¶è¦†ç›– | âœ… | ... |
| é”™è¯¯å¤„ç†é¢„æ¡ˆ | âœ… | ... |
`;

            const stage5Deliver = (fullContext, paths) => `ä½ æ˜¯ä¸€åã€Œæ·±åº¦è§£ç å™¨ã€ï¼Œæ­£åœ¨æ‰§è¡Œã€Œæ²™ç›’æ¨¡æ‹Ÿä¸äº¤ä»˜ã€ã€‚

## å®Œæ•´ä¸Šä¸‹æ–‡
${JSON.stringify(fullContext, null, 2)}

## ä»»åŠ¡
1. æ‰§è¡Œæ²™ç›’æ¨¡æ‹Ÿï¼Œè¾“å‡ºã€Šå‹åŠ›æµ‹è¯•æŠ¥å‘Šã€‹
2. æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„è·¯å¾„ï¼ˆ${paths.join(', ')}ï¼‰ï¼Œç”Ÿæˆæœ€ç»ˆäº¤ä»˜ç‰©

## è¾“å‡ºè¦æ±‚

é¦–å…ˆè¾“å‡ºå‹åŠ›æµ‹è¯•æŠ¥å‘Šï¼Œç„¶åä¸ºæ¯æ¡è·¯å¾„è¾“å‡ºå®Œæ•´çš„äº¤ä»˜ç‰©ã€‚

ä½¿ç”¨ä»¥ä¸‹åˆ†éš”ç¬¦åŒºåˆ†ä¸åŒéƒ¨åˆ†ï¼š
- \`===TEST_REPORT===\` å¼€å§‹å‹åŠ›æµ‹è¯•æŠ¥å‘Š
- \`===PATH_A===\` å¼€å§‹è·¯å¾„ A äº¤ä»˜ç‰©
- \`===PATH_B===\` å¼€å§‹è·¯å¾„ B äº¤ä»˜ç‰©
- \`===PATH_C===\` å¼€å§‹è·¯å¾„ C äº¤ä»˜ç‰©
- \`===PATH_D===\` å¼€å§‹è·¯å¾„ D äº¤ä»˜ç‰©

===TEST_REPORT===

# å‹åŠ›æµ‹è¯•æŠ¥å‘Š

## æ•°æ®æµè½¬æ£€æŸ¥
[æ£€æŸ¥ä¸Šæ¸¸è¾“å‡ºèƒ½å¦è¢«ä¸‹æ¸¸æ­£ç¡®è¯»å–]

## æ½œåœ¨é£é™©ç‚¹
| é£é™© | çº§åˆ« | é¢„é˜²æªæ–½ |
|------|------|----------|
| ... | ... | ... |

## ä¿®å¤å»ºè®®
[é¢„åŸ‹çš„è‡ªæˆ‘ä¿®æ­£é€»è¾‘]

${paths.includes('A') || paths.includes('E') ? `
===PATH_A===

# è·¯å¾„ A äº¤ä»˜ç‰©ï¼šå†…å®¹ç”Ÿäº§

## System Prompt

\`\`\`
[å®Œæ•´çš„å¯ç›´æ¥ä½¿ç”¨çš„å†™ä½œ System Prompt]
\`\`\`

## æ–‡ç« æ¨¡æ¿

[æ–‡ç« ç»“æ„æ¨¡æ¿ï¼ŒåŒ…å« Hookã€ç—›ç‚¹ã€æ–¹æ³•ã€æ¡ˆä¾‹ã€CTA ç­‰]

## æ ‡é¢˜/é‡‘å¥ç´ æ

- [æ ‡é¢˜å»ºè®® 1]
- [æ ‡é¢˜å»ºè®® 2]
- [é‡‘å¥ 1]
- [é‡‘å¥ 2]
` : ''}

${paths.includes('B') || paths.includes('E') ? `
===PATH_B===

# è·¯å¾„ B äº¤ä»˜ç‰©ï¼šå·¥å…·å¼€å‘

## 1. å·¥å…·æ¦‚è¿°

### å·¥å…·åç§°
[æ ¹æ®ç”¨æˆ·è®¾å®šæˆ– AI æ¨èçš„å·¥å…·åç§°]

### ä¸€å¥è¯å®šä½
[è¿™ä¸ªå·¥å…·è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œç»™è°ç”¨]

### æ ¸å¿ƒä»·å€¼
- [ä»·å€¼ç‚¹ 1]
- [ä»·å€¼ç‚¹ 2]
- [ä»·å€¼ç‚¹ 3]

## 2. æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç 

\`\`\`pseudo
[å®Œæ•´çš„é€»è¾‘ä¼ªä»£ç ï¼ŒåŒ…å«ä¸»æµç¨‹å’Œå¼‚å¸¸å¤„ç†]
\`\`\`

## 3. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡
[æŠ€æœ¯æ¶æ„è¯´æ˜ï¼ŒåŒ…å«è¾“å…¥-å¤„ç†-è¾“å‡ºæµç¨‹]

### æŠ€æœ¯é€‰å‹ä¾æ®
| ç»„ä»¶ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| è¯­è¨€/æ¡†æ¶ | [é€‰æ‹©] | [ç†ç”±] |
| æ•°æ®å­˜å‚¨ | [é€‰æ‹©] | [ç†ç”±] |
| AI æ¨¡å‹ | [é€‰æ‹©] | [ç†ç”±] |

## 4. æ ¸å¿ƒä»£ç æ¡†æ¶

\`\`\`javascript
[æ ¸å¿ƒä»£ç æ¡†æ¶/ç¤ºä¾‹ï¼ŒåŒ…å«å…³é”®å‡½æ•°å’Œæ³¨é‡Š]
\`\`\`

## 5. ä½¿ç”¨è¯´æ˜ (Quick Start)

### å¿«é€Ÿå¼€å§‹
1. [ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ]
2. [ç¬¬äºŒæ­¥ï¼šé…ç½®/å®‰è£…]
3. [ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ/è°ƒç”¨]
4. [ç¬¬å››æ­¥ï¼šè·å–ç»“æœ]

### è¾“å…¥è¾“å‡ºè§„èŒƒ
- **è¾“å…¥æ ¼å¼**ï¼š[æè¿°è¾“å…¥çš„æ ¼å¼ã€ç±»å‹ã€ç¤ºä¾‹]
- **è¾“å‡ºæ ¼å¼**ï¼š[æè¿°è¾“å‡ºçš„æ ¼å¼ã€ç±»å‹ã€ç¤ºä¾‹]

### å¸¸è§é—®é¢˜
| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| [é—®é¢˜1] | [è§£å†³æ–¹æ¡ˆ] |
| [é—®é¢˜2] | [è§£å†³æ–¹æ¡ˆ] |

## 6. ä¼˜åŒ–æ–¹å‘ (Next Steps)

| ä¼˜åŒ–ç‚¹ | éš¾åº¦ | é¢„æœŸæ”¶ç›Š | å®ç°å»ºè®® |
|--------|------|----------|----------|
| [ä¼˜åŒ–1] | ğŸŸ¢ ç®€å• | [æ”¶ç›Šæè¿°] | [å¦‚ä½•å®ç°] |
| [ä¼˜åŒ–2] | ğŸŸ¡ ä¸­ç­‰ | [æ”¶ç›Šæè¿°] | [å¦‚ä½•å®ç°] |
| [ä¼˜åŒ–3] | ğŸ”´ å›°éš¾ | [æ”¶ç›Šæè¿°] | [å¦‚ä½•å®ç°] |

## 7. æ–¹æ³•è®ºå¯¼å‡º

ä»¥ä¸‹æ˜¯æœ¬å·¥å…·çš„æ ¸å¿ƒæ–¹æ³•è®ºï¼Œå¯ç›´æ¥å¤åˆ¶åˆ°å…¶ä»– AI å¹³å°ï¼ˆå¦‚ ChatGPTã€Claudeã€Kimiï¼‰ä½¿ç”¨ï¼š

### System Promptï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰
\`\`\`
[ç‹¬ç«‹çš„ã€å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨çš„ System Promptï¼ŒåŒ…å«å®Œæ•´çš„è§’è‰²è®¾å®šã€å¤„ç†é€»è¾‘å’Œè¾“å‡ºæ ¼å¼è¦æ±‚]
\`\`\`

### æ ¸å¿ƒæ€ç»´é“¾ (Chain of Thought)
\`\`\`
[å·¥å…·èƒŒåçš„æ¨ç†æ­¥éª¤ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£å·¥å…·çš„æ€è€ƒæ–¹å¼]
\`\`\`

## 8. è‡ªå®šä¹‰æŒ‡å¼•

å¦‚æœä½ æƒ³æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹æœ¬å·¥å…·ï¼š

| è‡ªå®šä¹‰éœ€æ±‚ | ä¿®æ”¹ä½ç½® | ä¿®æ”¹æ–¹æ³• |
|------------|----------|----------|
| è°ƒæ•´è¾“å‡ºæ ¼å¼ | [ä½ç½®] | [æ–¹æ³•] |
| æ·»åŠ æ–°åŠŸèƒ½ | [ä½ç½®] | [æ–¹æ³•] |
| ä¿®æ”¹å¤„ç†é€»è¾‘ | [ä½ç½®] | [æ–¹æ³•] |
| é€‚é…å…¶ä»–åœºæ™¯ | [ä½ç½®] | [æ–¹æ³•] |
` : ''}

${paths.includes('C') ? `
===PATH_C===

# è·¯å¾„ C äº¤ä»˜ç‰©ï¼šäº§å“è®¾è®¡

## 1. äº§å“æ¦‚è¿°

### äº§å“åç§°
[æ ¹æ®ç”¨æˆ·è®¾å®šæˆ– AI æ¨èçš„äº§å“åç§°]

### ä¸€å¥è¯å®šä½
[äº§å“å®šä½å’Œæ ¸å¿ƒä»·å€¼ä¸»å¼ ]

### ç›®æ ‡ç”¨æˆ·
| ç”¨æˆ·ç±»å‹ | ç‰¹å¾æè¿° | æ ¸å¿ƒç—›ç‚¹ | ä½¿ç”¨åœºæ™¯ |
|----------|----------|----------|----------|
| ä¸»è¦ç”¨æˆ· | [ç‰¹å¾] | [ç—›ç‚¹] | [åœºæ™¯] |
| æ¬¡è¦ç”¨æˆ· | [ç‰¹å¾] | [ç—›ç‚¹] | [åœºæ™¯] |

## 2. æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | åŠŸèƒ½æè¿° | ç”¨æˆ·ä»·å€¼ | ä¼˜å…ˆçº§ |
|----------|----------|----------|--------|
| [åŠŸèƒ½1] | [æè¿°] | [ä»·å€¼] | P0 |
| [åŠŸèƒ½2] | [æè¿°] | [ä»·å€¼] | P0 |
| [åŠŸèƒ½3] | [æè¿°] | [ä»·å€¼] | P1 |
| [åŠŸèƒ½4] | [æè¿°] | [ä»·å€¼] | P2 |

## 3. ç”¨æˆ·æ—…ç¨‹

### æ ¸å¿ƒæµç¨‹
\`\`\`
[ç”¨æˆ·] â†’ [è§¦å‘ç‚¹] â†’ [é¦–æ¬¡ä½¿ç”¨] â†’ [æ ¸å¿ƒä½“éªŒ] â†’ [ç•™å­˜/åˆ†äº«]
\`\`\`

### å…³é”®èŠ‚ç‚¹è®¾è®¡
| èŠ‚ç‚¹ | ç”¨æˆ·è¡Œä¸º | äº§å“å“åº” | æˆåŠŸæŒ‡æ ‡ |
|------|----------|----------|----------|
| [èŠ‚ç‚¹1] | [è¡Œä¸º] | [å“åº”] | [æŒ‡æ ‡] |
| [èŠ‚ç‚¹2] | [è¡Œä¸º] | [å“åº”] | [æŒ‡æ ‡] |

## 4. åŠŸèƒ½æ¶æ„

### å‰ç«¯æ¶æ„
[é¡µé¢/ç»„ä»¶ç»“æ„è¯´æ˜]

### åç«¯æ¶æ„
[æœåŠ¡/æ¥å£ç»“æ„è¯´æ˜]

### æ•°æ®æ¶æ„
[æ•°æ®æ¨¡å‹/å­˜å‚¨æ–¹æ¡ˆè¯´æ˜]

## 5. MVP å»ºè®®

### æ ¸å¿ƒèŒƒå›´
- âœ… å¿…é¡»åŒ…å«ï¼š[åŠŸèƒ½åˆ—è¡¨]
- â³ å¯å»¶åï¼š[åŠŸèƒ½åˆ—è¡¨]
- âŒ MVP ä¸åšï¼š[åŠŸèƒ½åˆ—è¡¨]

### å®ç°å‘¨æœŸä¼°ç®—
| é˜¶æ®µ | å†…å®¹ | é¢„ä¼°å·¥æ—¶ |
|------|------|----------|
| é˜¶æ®µ1 | [å†…å®¹] | [å·¥æ—¶] |
| é˜¶æ®µ2 | [å†…å®¹] | [å·¥æ—¶] |

## 6. å•†ä¸šæ¨¡å¼

### ç›ˆåˆ©æ¨¡å¼
| æ¨¡å¼ | æè¿° | é¢„æœŸæ”¶å…¥ |
|------|------|----------|
| [æ¨¡å¼1] | [æè¿°] | [é¢„æœŸ] |
| [æ¨¡å¼2] | [æè¿°] | [é¢„æœŸ] |

### ç«å“åˆ†æ
| ç«å“ | ä¼˜åŠ¿ | åŠ£åŠ¿ | æˆ‘ä»¬çš„å·®å¼‚åŒ– |
|------|------|------|--------------|
| [ç«å“1] | [ä¼˜åŠ¿] | [åŠ£åŠ¿] | [å·®å¼‚åŒ–] |

## 7. ä¼˜åŒ–æ–¹å‘ (Next Steps)

| ä¼˜åŒ–ç‚¹ | é˜¶æ®µ | é¢„æœŸæ”¶ç›Š | å®ç°å»ºè®® |
|--------|------|----------|----------|
| [ä¼˜åŒ–1] | MVPå | [æ”¶ç›Šæè¿°] | [å¦‚ä½•å®ç°] |
| [ä¼˜åŒ–2] | V2.0 | [æ”¶ç›Šæè¿°] | [å¦‚ä½•å®ç°] |
| [ä¼˜åŒ–3] | é•¿æœŸ | [æ”¶ç›Šæè¿°] | [å¦‚ä½•å®ç°] |

## 8. æ–¹æ³•è®ºå¯¼å‡º

### äº§å“éœ€æ±‚æ–‡æ¡£æ¨¡æ¿ï¼ˆå¯å¤ç”¨ï¼‰
\`\`\`markdown
[ç‹¬ç«‹çš„ã€å¯å¤åˆ¶åˆ°å…¶ä»–é¡¹ç›®ä½¿ç”¨çš„ PRD æ¨¡æ¿æ¡†æ¶]
\`\`\`

### AI äº§å“è®¾è®¡ Promptï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰
\`\`\`
[ç”¨äºå…¶ä»– AI å¹³å°ç”Ÿæˆç±»ä¼¼äº§å“è®¾è®¡çš„ System Prompt]
\`\`\`

## 9. è‡ªå®šä¹‰æŒ‡å¼•

| è‡ªå®šä¹‰éœ€æ±‚ | ä¿®æ”¹å»ºè®® |
|------------|----------|
| è°ƒæ•´ç›®æ ‡ç”¨æˆ· | [å»ºè®®] |
| ä¿®æ”¹åŠŸèƒ½ä¼˜å…ˆçº§ | [å»ºè®®] |
| é€‚é…å…¶ä»–å¹³å° | [å»ºè®®] |
| è°ƒæ•´å•†ä¸šæ¨¡å¼ | [å»ºè®®] |
` : ''}

${paths.includes('D') || paths.includes('E') ? `
===PATH_D===

# è·¯å¾„ D äº¤ä»˜ç‰©ï¼šçŸ¥è¯†æç‚¼

## æ ¸å¿ƒæ¦‚å¿µå¡ç‰‡

### æ¦‚å¿µ 1ï¼š[åç§°]
- **å®šä¹‰**ï¼š
- **åº”ç”¨åœºæ™¯**ï¼š
- **è¾¹ç•Œæ¡ä»¶**ï¼š
- **å…³è”æ¦‚å¿µ**ï¼š

### æ¦‚å¿µ 2ï¼š[åç§°]
- **å®šä¹‰**ï¼š
- **åº”ç”¨åœºæ™¯**ï¼š
- **è¾¹ç•Œæ¡ä»¶**ï¼š
- **å…³è”æ¦‚å¿µ**ï¼š

## æ€ç»´æ¨¡å‹å›¾è°±

[æ ¸å¿ƒæ€ç»´æ¨¡å‹åŠå…¶å…³ç³»]

## å…ƒè®¤çŸ¥æ¸…å•

- [ ] [å…ƒè®¤çŸ¥ 1]
- [ ] [å…ƒè®¤çŸ¥ 2]
- [ ] [å…ƒè®¤çŸ¥ 3]

## å¯å¯¼å‡ºæ ¼å¼

### Obsidian æ ¼å¼
\`\`\`markdown
[Obsidian åŒé“¾æ ¼å¼çš„çŸ¥è¯†å¡ç‰‡]
\`\`\`
` : ''}
`;

            return {
                stage1Decode,
                stage4Architecture,
                stage5Deliver
            };
        })();
    </script>

    <!-- ==================== Main Application ==================== -->
    <script>
        const APP = (() => {
            // ==================== State ====================
            const STATE = {
                currentStage: 1,
                files: [],
                parsedContent: {
                    texts: [],
                    images: []
                },
                decodeReport: '',
                selectedPaths: [],
                constraints: {
                    A: {
                        audience: [],      // æ”¹ä¸ºæ•°ç»„
                        format: [],        // æ”¹ä¸ºæ•°ç»„
                        style: [],         // æ”¹ä¸ºæ•°ç»„
                        platform: []       // æ–°å¢
                    },
                    B: {
                        toolName: '',      // å·¥å…·åç§°
                        toolFunction: '',  // æ ¸å¿ƒåŠŸèƒ½æè¿°
                        techStack: [],     // æ”¹ä¸ºæ•°ç»„
                        environment: [],   // æ”¹ä¸ºæ•°ç»„
                        toolType: [],      // æ–°å¢
                        integration: []    // æ–°å¢
                    },
                    C: {
                        productName: '',   // äº§å“åç§°
                        productFunction: '', // æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚
                        platform: [],      // æ”¹ä¸ºæ•°ç»„
                        positioning: '',   // ä¿æŒå•é€‰
                        targetUser: [],    // æ”¹ä¸ºæ•°ç»„
                        mvpScope: ''       // æ–°å¢ï¼Œå•é€‰
                    },
                    D: {
                        deliveryFormat: [], // æ”¹ä¸ºæ•°ç»„
                        granularity: [],    // æ”¹ä¸ºæ•°ç»„
                        usage: []           // æ–°å¢
                    }
                },
                architecture: '',
                deliverables: {
                    testReport: '',
                    A: '',
                    B: '',
                    C: '',
                    D: ''
                }
            };

            // ==================== DOM Elements ====================
            const $ = id => document.getElementById(id);
            const $$ = sel => document.querySelectorAll(sel);

            // ==================== AI Module Instance ====================
            let aiModule = null;

            // ==================== Theme ====================
            function initTheme() {
                const saved = localStorage.getItem('msa_theme') || 'auto';
                $('themeSelect').value = saved;
                applyTheme(saved);

                $('themeSelect').addEventListener('change', (e) => {
                    const theme = e.target.value;
                    localStorage.setItem('msa_theme', theme);
                    applyTheme(theme);
                });
            }

            function applyTheme(mode) {
                if (mode === 'light') document.documentElement.dataset.theme = 'light';
                else if (mode === 'dark') document.documentElement.dataset.theme = 'dark';
                else delete document.documentElement.dataset.theme;
            }

            // ==================== Stage Navigation ====================
            function updateStageNav() {
                $$('.stage-item').forEach(item => {
                    const stage = parseInt(item.dataset.stage);
                    item.classList.remove('active', 'completed', 'locked');

                    if (stage < STATE.currentStage) {
                        item.classList.add('completed');
                    } else if (stage === STATE.currentStage) {
                        item.classList.add('active');
                    } else {
                        item.classList.add('locked');
                    }
                });

                // Show/hide stage sections
                for (let i = 1; i <= 5; i++) {
                    const section = $(`stage${i}`);
                    if (section) {
                        section.hidden = (i !== STATE.currentStage);
                    }
                }
            }

            function goToStage(stage) {
                STATE.currentStage = stage;
                updateStageNav();
                saveState();

                // é˜¶æ®µ3ç‰¹æ®Šå¤„ç†ï¼šæ¸²æŸ“çº¦æŸè¡¨å•
                if (stage === 3) {
                    renderConstraintsForm();
                    // åªæœ‰å½“ AI æ¨èåŒºåŸŸä¸ºç©ºæˆ–æ˜¾ç¤ºå¤±è´¥æ—¶æ‰é‡æ–°ç”Ÿæˆ
                    const container = $('aiRecommendationsContainer');
                    const grid = $('aiRecommendationsGrid');
                    const hasRecommendations = grid && grid.children.length > 0;
                    if (!hasRecommendations) {
                        generateAIRecommendations();
                    }
                }
            }

            // åˆå§‹åŒ–é˜¶æ®µå¯¼èˆªç‚¹å‡»äº‹ä»¶
            function initStageNav() {
                $$('.stage-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const stage = parseInt(item.dataset.stage);
                        // åªèƒ½è·³è½¬åˆ°å·²å®Œæˆçš„é˜¶æ®µï¼ˆå½“å‰é˜¶æ®µä¹‹å‰çš„ï¼‰
                        if (stage < STATE.currentStage) {
                            goToStage(stage);
                        }
                    });
                });
            }

            // ==================== File Upload ====================
            function initFileUpload() {
                const uploadZone = $('uploadZone');
                const fileInput = $('fileInput');

                uploadZone.addEventListener('click', () => fileInput.click());

                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    await handleFiles(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', async (e) => {
                    await handleFiles(e.target.files);
                });

                // Paste text
                $('pasteTextArea').addEventListener('input', () => {
                    updateContentPreview();
                });
            }

            async function handleFiles(fileList) {
                const files = Array.from(fileList);
                STATE.files = [...STATE.files, ...files];

                renderFileList();
                await parseAllFiles();
                updateContentPreview();
            }

            function renderFileList() {
                const container = $('fileList');

                if (STATE.files.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = STATE.files.map((file, index) => `
            <div class="file-item">
                <div class="file-info">
                    <span class="file-icon">${getFileIcon(file)}</span>
                    <div>
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-size">${FILE_PARSER.formatSize(file.size)}</div>
                    </div>
                </div>
                <button class="btn secondary" onclick="APP.removeFile(${index})" style="padding: 6px 10px;">âœ•</button>
            </div>
        `).join('');
            }

            function getFileIcon(file) {
                const ext = file.name.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(ext)) return 'ğŸ–¼ï¸';
                if (ext === 'pdf') return 'ğŸ“•';
                if (ext === 'docx') return 'ğŸ“˜';
                return 'ğŸ“„';
            }

            function removeFile(index) {
                STATE.files.splice(index, 1);
                renderFileList();
                parseAllFiles().then(updateContentPreview);
            }

            async function parseAllFiles() {
                STATE.parsedContent = { texts: [], images: [] };

                if (STATE.files.length === 0) return;

                const { results, errors } = await FILE_PARSER.parseMultipleFiles(STATE.files);

                for (const result of results) {
                    if (result.type === 'text') {
                        STATE.parsedContent.texts.push({ name: result.name, content: result.content });
                    } else if (result.type === 'image') {
                        STATE.parsedContent.images.push(result);
                    }
                }

                if (errors.length > 0) {
                    console.warn('File parsing errors:', errors);
                }
            }

            function updateContentPreview() {
                const pasteText = $('pasteTextArea').value.trim();
                const hasContent = STATE.parsedContent.texts.length > 0 ||
                    STATE.parsedContent.images.length > 0 ||
                    pasteText.length > 0;

                $('contentPreviewSection').hidden = !hasContent;
                $('startDecodeBtn').disabled = !hasContent;

                if (!hasContent) return;

                // Build preview
                let preview = '';
                let totalChars = 0;

                for (const item of STATE.parsedContent.texts) {
                    preview += `--- ${item.name} ---\n${item.content.slice(0, 500)}${item.content.length > 500 ? '...' : ''}\n\n`;
                    totalChars += item.content.length;
                }

                if (pasteText) {
                    preview += `--- ç²˜è´´æ–‡æœ¬ ---\n${pasteText.slice(0, 500)}${pasteText.length > 500 ? '...' : ''}\n`;
                    totalChars += pasteText.length;
                }

                if (STATE.parsedContent.images.length > 0) {
                    preview += `\n--- å›¾ç‰‡ (${STATE.parsedContent.images.length} å¼ ) ---\n`;
                    preview += STATE.parsedContent.images.map(img => img.name).join('\n');
                }

                $('contentPreview').textContent = preview;
                $('contentStats').textContent = `å…± ${totalChars.toLocaleString()} å­—ç¬¦ï¼Œ${STATE.parsedContent.images.length} å¼ å›¾ç‰‡`;
            }

            // ==================== Stage 1: Decode ====================
            function initStage1() {
                $('startDecodeBtn').addEventListener('click', startDecode);
                $('reDecodeBtn').addEventListener('click', startDecode);
                $('confirmDecodeBtn').addEventListener('click', () => goToStage(2));
                $('copyDecodeBtn').addEventListener('click', () => copyToClipboard(STATE.decodeReport));
            }

            async function startDecode() {
                const state = aiModule.get_state();
                if (!state.networking_enabled) {
                    alert('è¯·å…ˆåœ¨å·¦ä¾§ã€ŒAI è®¾ç½®ã€ä¸­å‹¾é€‰ã€Œå…è®¸è”ç½‘ã€');
                    return;
                }

                if (!state.key_status.has_key) {
                    alert('è¯·å…ˆåœ¨ Key Manager ä¸­è®¾ç½® API Key');
                    return;
                }

                // Gather content
                let content = '';
                for (const item of STATE.parsedContent.texts) {
                    content += `\n\n--- ${item.name} ---\n${item.content}`;
                }
                const pasteText = $('pasteTextArea').value.trim();
                if (pasteText) {
                    content += `\n\n--- ç²˜è´´æ–‡æœ¬ ---\n${pasteText}`;
                }

                if (!content.trim()) {
                    alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´æ–‡æœ¬');
                    return;
                }

                // Show output section
                $('decodeOutputSection').hidden = false;
                $('decodeOutput').innerHTML = '<div class="loading-spinner"></div> AI æ­£åœ¨åˆ†æ...';
                $('startDecodeBtn').disabled = true;
                $('confirmDecodeBtn').disabled = true;

                try {
                    const prompt = PROMPT_TEMPLATES.stage1Decode(content, STATE.parsedContent.images);

                    const messages = [{ role: 'user', content: prompt }];

                    // Add images if any (for multimodal)
                    if (STATE.parsedContent.images.length > 0) {
                        // Note: This is simplified. Real implementation would need proper multimodal message format
                        messages[0].content = [
                            { type: 'text', text: prompt },
                            ...STATE.parsedContent.images.map(img => ({
                                type: 'image_url',
                                image_url: { url: img.base64 }
                            }))
                        ];
                    }

                    let fullMarkdown = '';
                    await aiModule.call_ai({
                        messages,
                        onChunk: (chunk, full) => {
                            fullMarkdown = full;  // ä¿å­˜åŸå§‹ Markdown
                            $('decodeOutput').innerHTML = renderMarkdown(full) + '<span class="streaming-cursor"></span>';
                        }
                    });

                    STATE.decodeReport = fullMarkdown;  // ä½¿ç”¨åŸå§‹ Markdown
                    $('decodeOutput').innerHTML = renderMarkdown(STATE.decodeReport);
                    $('confirmDecodeBtn').disabled = false;
                    saveState();

                } catch (e) {
                    $('decodeOutput').innerHTML = `<div class="pill bad">é”™è¯¯</div><pre>${aiModule.get_actionable_error(e)}</pre>`;
                } finally {
                    $('startDecodeBtn').disabled = false;
                }
            }

            // ==================== Stage 2: Path Selection ====================
            function initStage2() {
                $$('.path-card').forEach(card => {
                    card.addEventListener('click', () => togglePath(card.dataset.path));
                });

                $('backToStage1Btn').addEventListener('click', () => goToStage(1));
                $('confirmPathsBtn').addEventListener('click', () => {
                    if (STATE.selectedPaths.length === 0) {
                        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡è·¯å¾„');
                        return;
                    }
                    renderConstraintsForm();
                    goToStage(3);
                });
            }

            function togglePath(path) {
                // Special handling for E (Full Stack)
                if (path === 'E') {
                    if (STATE.selectedPaths.includes('E')) {
                        STATE.selectedPaths = [];
                    } else {
                        STATE.selectedPaths = ['E'];
                    }
                } else {
                    // Remove E if selecting individual paths
                    STATE.selectedPaths = STATE.selectedPaths.filter(p => p !== 'E');

                    const index = STATE.selectedPaths.indexOf(path);
                    if (index > -1) {
                        STATE.selectedPaths.splice(index, 1);
                    } else {
                        STATE.selectedPaths.push(path);
                    }
                }

                updatePathSelection();
            }

            function updatePathSelection() {
                $$('.path-card').forEach(card => {
                    const path = card.dataset.path;
                    const isSelected = STATE.selectedPaths.includes(path) ||
                        (STATE.selectedPaths.includes('E') && ['A', 'B', 'D'].includes(path));

                    card.classList.toggle('selected', isSelected);
                    card.querySelector('.path-checkbox').textContent = isSelected ? 'âœ“' : '';
                });

                // Update summary
                let summary = 'å°šæœªé€‰æ‹©';
                if (STATE.selectedPaths.length > 0) {
                    if (STATE.selectedPaths.includes('E')) {
                        summary = 'E (å…¨æ ˆå¥—è£…: A + B + D)';
                    } else {
                        summary = STATE.selectedPaths.join(' + ');
                    }
                }
                $('selectedPathsText').textContent = summary;
                $('confirmPathsBtn').disabled = STATE.selectedPaths.length === 0;
            }

            // ==================== Stage 3: Constraints ====================
            function initStage3() {
                $('backToStage2Btn').addEventListener('click', () => goToStage(2));
                $('confirmConstraintsBtn').addEventListener('click', () => {
                    collectConstraints();
                    startArchitecture();
                });
            }

            // AI æ¨èå¼€å‘æ–¹å‘
            async function generateAIRecommendations() {
                const paths = STATE.selectedPaths.includes('E') ? ['A', 'B', 'D'] : STATE.selectedPaths;
                const hasToolPath = paths.includes('B');
                const hasProductPath = paths.includes('C');

                // å¦‚æœæ²¡æœ‰é€‰æ‹©å·¥å…·æˆ–äº§å“è·¯å¾„ï¼Œéšè—æ¨èåŒºåŸŸ
                if (!hasToolPath && !hasProductPath) {
                    $('aiRecommendationsSection').style.display = 'none';
                    return;
                }

                // æ£€æŸ¥è§£æ„æŠ¥å‘Šæ˜¯å¦å­˜åœ¨
                if (!STATE.decodeReport || STATE.decodeReport.length < 100) {
                    console.warn('AI æ¨èè·³è¿‡ï¼šè§£æ„æŠ¥å‘Šä¸ºç©ºæˆ–å¤ªçŸ­', STATE.decodeReport?.length || 0);
                    $('aiRecommendationsSection').style.display = 'none';
                    return;
                }

                $('aiRecommendationsSection').style.display = 'block';
                $('aiRecommendationsContainer').innerHTML = '<div class="loading-spinner"></div> AI æ­£åœ¨åˆ†æå¯è¡Œçš„å¼€å‘æ–¹å‘...';
                $('aiRecommendationsGrid').style.display = 'none';

                const state = aiModule.get_state();

                // å®Œæ•´çš„ AI é…ç½®çŠ¶æ€æ£€æŸ¥
                const diagnostics = [];
                if (!state.networking_enabled) {
                    diagnostics.push('âŒ æœªå‹¾é€‰ã€Œå…è®¸è”ç½‘ã€');
                }
                if (!state.model_id) {
                    diagnostics.push('âŒ æœªé€‰æ‹© AI æ¨¡å‹');
                }
                if (!state.key_status.has_key) {
                    diagnostics.push('âŒ API Key æœªé…ç½®æˆ–æ— æ•ˆ');
                }

                if (diagnostics.length > 0) {
                    $('aiRecommendationsContainer').innerHTML = `
                        <div style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: rgba(251, 191, 36, 0.1);">
                            <div class="pill" style="background: #f59e0b; margin-bottom: 8px;">âš ï¸ AI é…ç½®ä¸å®Œæ•´</div>
                            <div style="font-size: 13px; margin-bottom: 10px;">
                                ${diagnostics.join('<br>')}
                            </div>
                            <div style="font-size: 12px; opacity: 0.7;">
                                è¯·åœ¨é¡µé¢é¡¶éƒ¨ã€ŒAI è®¾ç½®ã€åŒºåŸŸå®Œæˆé…ç½®ï¼Œæˆ–ç›´æ¥åœ¨ä¸‹æ–¹æ‰‹åŠ¨å¡«å†™ã€‚
                            </div>
                        </div>
                    `;
                    return;
                }

                let aiRawResponse = '';  // æåˆ°å¤–å±‚ä»¥ä¾¿åœ¨ catch ä¸­è®¿é—®

                try {
                    // æ ¹æ®é€‰æ‹©çš„è·¯å¾„ç¡®å®šæ¨èæ•°é‡
                    const toolCount = hasToolPath ? 3 : 0;
                    const productCount = hasProductPath ? 3 : 0;
                    const totalCount = toolCount + productCount;

                    // ç²¾ç®€è§£æ„æŠ¥å‘Šä»¥é¿å… token è¿‡é•¿å¯¼è‡´è¾“å‡ºè´¨é‡ä¸‹é™
                    const truncatedReport = STATE.decodeReport.length > 6000
                        ? STATE.decodeReport.slice(0, 6000) + '\n...(å†…å®¹å·²æˆªæ–­)'
                        : STATE.decodeReport;

                    const systemMessage = `ä½ æ˜¯ä¸€ä¸ª JSON ç”Ÿæˆå™¨ã€‚ä½ åªè¾“å‡ºæœ‰æ•ˆçš„ JSON æ•°ç»„ï¼Œä¸è¾“å‡ºä»»ä½•å…¶ä»–å†…å®¹ã€‚ä¸è¦è¾“å‡º markdown ä»£ç å—æ ‡è®°ã€‚`;

                    const recommendPrompt = `åŸºäºä»¥ä¸‹ç´ æè§£æ„æŠ¥å‘Šï¼Œæ¨è ${totalCount} ä¸ªå¼€å‘æ–¹å‘ã€‚

## ç´ ææ‘˜è¦
${truncatedReport}

## ä»»åŠ¡
${hasToolPath ? 'æ¨è 2-3 ä¸ªå·¥å…·å¼€å‘æ–¹å‘ï¼ˆtype: "tool"ï¼‰' : ''}
${hasProductPath ? 'æ¨è 2-3 ä¸ªäº§å“è®¾è®¡æ–¹å‘ï¼ˆtype: "product"ï¼‰' : ''}

## è¾“å‡ºè¦æ±‚
ç›´æ¥è¾“å‡º JSON æ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
[{"name":"åç§°","type":"tool","description":"æè¿°","features":["åŠŸèƒ½1","åŠŸèƒ½2","åŠŸèƒ½3"],"techStack":"æŠ€æœ¯æ ˆ","targetUser":"ç›®æ ‡ç”¨æˆ·"}]

æ³¨æ„ï¼š
- åªè¾“å‡º JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—
- name ä¸è¶…è¿‡ 10 ä¸ªå­—
- description ä¸è¶…è¿‡ 30 ä¸ªå­—
- features åŒ…å« 3-5 ä¸ªåŠŸèƒ½ç‚¹

JSON æ•°ç»„ï¼š`;

                    let fullResponse = '';
                    const result = await aiModule.call_ai({
                        messages: [
                            { role: 'system', content: systemMessage },
                            { role: 'user', content: recommendPrompt }
                        ],
                        onChunk: (chunk, full) => {
                            fullResponse = full;
                        }
                    });

                    // å¦‚æœæµå¼å“åº”æ²¡æœ‰å†…å®¹ï¼Œå°è¯•ä»ç»“æœä¸­è·å–
                    if (!fullResponse && result) {
                        fullResponse = typeof result === 'string' ? result : (result.content || result.text || JSON.stringify(result));
                    }

                    if (!fullResponse) {
                        throw new Error('AI æœªè¿”å›ä»»ä½•å†…å®¹');
                    }

                    aiRawResponse = fullResponse;  // ä¿å­˜åˆ°å¤–å±‚å˜é‡

                    console.log('AI æ¨èåŸå§‹å“åº”:', fullResponse);

                    // ========== JSON ä¿®å¤å·¥å…·å‡½æ•° ==========

                    // ä¿®å¤å¸¸è§çš„ JSON è¯­æ³•é”™è¯¯
                    function repairJSON(str) {
                        // é¦–å…ˆæ¸…ç†å¯èƒ½çš„ä¹±ç å’Œé JSON å†…å®¹
                        str = str
                            .replace(/```json\s*/gi, '')
                            .replace(/```\s*/g, '')
                            .replace(/^[^[\{]*(?=[\[\{])/s, '')
                            .replace(/""\s*:\s*/g, '')
                            .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '')
                            .replace(/"/g, '"')
                            .replace(/"/g, '"')
                            .replace(/\}\s*\{/g, '},{')
                            .replace(/\}\s*\n\s*\{/g, '},\n{');

                        return str
                            // ä¿®å¤ç¼ºå°‘å†’å·: "key" "value" â†’ "key": "value"
                            .replace(/"(\w+)"\s+"([^"]*)/g, '"$1": "$2')
                            // ä¿®å¤ç¼ºå°‘é€—å·: "value"\s+"nextKey" â†’ "value", "nextKey"
                            .replace(/"\s*\n\s*"/g, '",\n"')
                            .replace(/"\s{2,}"/g, '", "')
                            // ä¿®å¤æ•°ç»„ç»“å°¾ç¼ºå°‘é€—å·åç›´æ¥è·Ÿå¼•å·: ]\s+" â†’ ], "
                            .replace(/\]\s+"/g, '], "')
                            // ä¿®å¤å¯¹è±¡å±æ€§å€¼åç¼ºå°‘é€—å·: "value"    "key" â†’ "value", "key"
                            .replace(/("(?:[^"\\]|\\.)*")\s{2,}(")/g, '$1, $2')
                            // ä¿®å¤æ•°ç»„ç»“å°¾åç¼ºå°‘é€—å·: ]\s{2,}" â†’ ], "
                            .replace(/\]\s{2,}"/g, '], "');
                    }

                    // æ£€æµ‹æˆªæ–­å¹¶å°è¯•è¡¥å…¨
                    function completeJSON(str) {
                        const trimmed = str.trim();
                        // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„ JSON æ•°ç»„ï¼Œç›´æ¥è¿”å›
                        if (trimmed.endsWith(']')) {
                            return trimmed;
                        }

                        // å°è¯•æ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡
                        let braceCount = 0;
                        let lastCompleteObjEnd = -1;
                        let inString = false;
                        let escape = false;

                        for (let i = 0; i < trimmed.length; i++) {
                            const char = trimmed[i];

                            if (escape) {
                                escape = false;
                                continue;
                            }

                            if (char === '\\') {
                                escape = true;
                                continue;
                            }

                            if (char === '"') {
                                inString = !inString;
                                continue;
                            }

                            if (inString) continue;

                            if (char === '{') {
                                braceCount++;
                            } else if (char === '}') {
                                braceCount--;
                                if (braceCount === 0) {
                                    lastCompleteObjEnd = i;
                                }
                            }
                        }

                        // å¦‚æœæ‰¾åˆ°äº†å®Œæ•´çš„å¯¹è±¡ï¼Œè¡¥å…¨æ•°ç»„
                        if (lastCompleteObjEnd > 0) {
                            console.log('æ£€æµ‹åˆ° JSON æˆªæ–­ï¼Œå°è¯•è¡¥å…¨...');
                            return trimmed.slice(0, lastCompleteObjEnd + 1) + ']';
                        }

                        return trimmed;
                    }

                    // å°è¯•è§£æ JSONï¼Œå¤±è´¥æ—¶è¿”å› null
                    function tryParse(str, strategyName) {
                        try {
                            const result = JSON.parse(str);
                            console.log(`${strategyName} è§£ææˆåŠŸ`);
                            return result;
                        } catch (e) {
                            console.log(`${strategyName} è§£æå¤±è´¥:`, e.message);
                            return null;
                        }
                    }

                    // ========== å¤šç­–ç•¥è§£æ JSON ==========
                    let recommendations = null;

                    // æå– JSON å†…å®¹ï¼ˆå»é™¤ markdown ä»£ç å—ï¼‰
                    let jsonContent = fullResponse;
                    const codeBlockMatch = fullResponse.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                    if (codeBlockMatch) {
                        jsonContent = codeBlockMatch[1];
                    }

                    // å°è¯•ç›´æ¥åŒ¹é… JSON æ•°ç»„
                    const arrayMatch = jsonContent.match(/\[\s*\{[\s\S]*/);
                    if (arrayMatch) {
                        jsonContent = arrayMatch[0];
                    }

                    // ç­–ç•¥1: ç›´æ¥è§£æåŸå§‹å†…å®¹
                    recommendations = tryParse(jsonContent.trim(), 'ç­–ç•¥1-ç›´æ¥è§£æ');

                    // ç­–ç•¥2: ä¿®å¤ JSON è¯­æ³•åè§£æ
                    if (!recommendations) {
                        const repaired = repairJSON(jsonContent);
                        recommendations = tryParse(repaired.trim(), 'ç­–ç•¥2-è¯­æ³•ä¿®å¤');
                    }

                    // ç­–ç•¥3: è¡¥å…¨æˆªæ–­çš„ JSON åè§£æ
                    if (!recommendations) {
                        const completed = completeJSON(jsonContent);
                        recommendations = tryParse(completed, 'ç­–ç•¥3-æˆªæ–­è¡¥å…¨');
                    }

                    // ç­–ç•¥4: ä¿®å¤ + è¡¥å…¨
                    if (!recommendations) {
                        const repairedAndCompleted = completeJSON(repairJSON(jsonContent));
                        recommendations = tryParse(repairedAndCompleted, 'ç­–ç•¥4-ä¿®å¤+è¡¥å…¨');
                    }

                    // ç­–ç•¥5: æå–å•ä¸ªå¯¹è±¡é€ä¸ªè§£æ
                    if (!recommendations) {
                        console.log('ç­–ç•¥5-é€ä¸ªå¯¹è±¡è§£æ...');
                        const objRegex = /\{\s*"name"\s*:\s*"[^"]+"/g;
                        const objMatches = jsonContent.match(objRegex);
                        if (objMatches && objMatches.length > 0) {
                            recommendations = [];
                            // å°è¯•æå–æ¯ä¸ªå¯¹è±¡
                            let remaining = jsonContent;
                            for (let i = 0; i < objMatches.length && i < 10; i++) {
                                const startIdx = remaining.indexOf(objMatches[i]);
                                if (startIdx >= 0) {
                                    // æ‰¾åˆ°å¯¹åº”çš„ç»“æŸ }
                                    let depth = 0;
                                    let endIdx = startIdx;
                                    for (let j = startIdx; j < remaining.length; j++) {
                                        if (remaining[j] === '{') depth++;
                                        else if (remaining[j] === '}') {
                                            depth--;
                                            if (depth === 0) {
                                                endIdx = j;
                                                break;
                                            }
                                        }
                                    }
                                    const objStr = remaining.slice(startIdx, endIdx + 1);
                                    const repaired = repairJSON(objStr);
                                    const obj = tryParse(repaired, `ç­–ç•¥5-å¯¹è±¡${i + 1}`);
                                    if (obj && obj.name) {
                                        recommendations.push(obj);
                                    }
                                    remaining = remaining.slice(endIdx + 1);
                                }
                            }
                            if (recommendations.length === 0) {
                                recommendations = null;
                            }
                        }
                    }

                    if (recommendations && Array.isArray(recommendations) && recommendations.length > 0) {
                        renderRecommendationCards(recommendations);
                    } else {
                        console.error('AI æ¨èè§£æå¤±è´¥ï¼ŒåŸå§‹å“åº”:', fullResponse);
                        throw new Error('æ— æ³•è§£æ AI æ¨èç»“æœï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦æƒ…');
                    }
                } catch (e) {
                    console.error('AI æ¨èç”Ÿæˆå¤±è´¥:', e);
                    const errorMsg = e.message || 'æœªçŸ¥é”™è¯¯';
                    const isNetworkError = errorMsg.includes('network') || errorMsg.includes('fetch') || errorMsg.includes('API');

                    // æˆªå– AI å“åº”ç”¨äºæ˜¾ç¤º
                    const responsePreview = aiRawResponse
                        ? (aiRawResponse.length > 300 ? aiRawResponse.slice(0, 300) + '...' : aiRawResponse)
                        : '(æ— å“åº”å†…å®¹)';

                    $('aiRecommendationsContainer').innerHTML = `
                        <div style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: rgba(239, 68, 68, 0.05);">
                            <div class="pill bad" style="margin-bottom: 8px;">æ¨èç”Ÿæˆå¤±è´¥</div>
                            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 10px;">
                                ${isNetworkError ? 'âš ï¸ ç½‘ç»œæˆ– API é…ç½®é—®é¢˜' : 'âš ï¸ AI è¿”å›æ ¼å¼è§£æå¤±è´¥'}
                            </div>
                            <details style="margin-bottom: 10px;">
                                <summary style="cursor: pointer; font-size: 12px; color: var(--accent);">ğŸ“‹ æŸ¥çœ‹ AI åŸå§‹å“åº”</summary>
                                <pre style="margin-top: 8px; padding: 10px; background: var(--bg); border-radius: 6px; font-size: 11px; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto;">${responsePreview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                            </details>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn secondary" style="padding: 6px 12px; font-size: 12px;" onclick="generateAIRecommendations()">ğŸ”„ é‡è¯•</button>
                                <button class="btn secondary" style="padding: 6px 12px; font-size: 12px;" onclick="document.getElementById('customToolSection').style.display='block';document.getElementById('customProductSection') && (document.getElementById('customProductSection').style.display='block');">âœï¸ æ‰‹åŠ¨å¡«å†™</button>
                            </div>
                        </div>
                    `;
                }
            }

            function renderRecommendationCards(recommendations) {
                $('aiRecommendationsContainer').innerHTML = '';
                const grid = $('aiRecommendationsGrid');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';

                let html = '';
                recommendations.forEach((rec, index) => {
                    const typeLabel = rec.type === 'tool' ? 'ğŸ› ï¸ å·¥å…·' : 'ğŸ“¦ äº§å“';
                    const typeClass = rec.type === 'tool' ? 'accent' : 'good';
                    html += `
                    <div class="recommendation-card" data-index="${index}" style="
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        padding: 14px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: var(--card-bg);
                    " onmouseover="this.style.borderColor='var(--accent)';this.style.transform='translateY(-2px)';" 
                       onmouseout="this.style.borderColor='var(--border)';this.style.transform='translateY(0)';">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="pill ${typeClass}">${typeLabel}</span>
                            <strong>${rec.name}</strong>
                        </div>
                        <div style="opacity: 0.8; font-size: 13px; margin-bottom: 8px;">${rec.description}</div>
                        <div style="font-size: 12px; opacity: 0.6;">
                            ${rec.features.map(f => `â€¢ ${f}`).join('<br>')}
                        </div>
                        <div style="font-size: 11px; margin-top: 8px; opacity: 0.5; display: flex; gap: 12px; flex-wrap: wrap;">
                            <span>ğŸ”§ ${rec.techStack || 'å¾…å®š'}</span>
                            ${rec.targetUser ? `<span>ğŸ‘¤ ${rec.targetUser}</span>` : ''}
                        </div>
                    </div>
                    `;
                });
                grid.innerHTML = html;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                grid.querySelectorAll('.recommendation-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const index = parseInt(card.dataset.index);
                        const rec = recommendations[index];
                        applyRecommendation(rec);
                        // é«˜äº®é€‰ä¸­çš„å¡ç‰‡
                        grid.querySelectorAll('.recommendation-card').forEach(c => {
                            c.style.borderColor = 'var(--border)';
                            c.style.background = 'var(--card-bg)';
                        });
                        card.style.borderColor = 'var(--accent)';
                        card.style.background = 'rgba(99, 102, 241, 0.1)';
                    });
                });
            }

            function applyRecommendation(rec) {
                // æ ¹æ®ç±»å‹å¡«å……å¯¹åº”çš„è¾“å…¥æ¡†
                if (rec.type === 'tool') {
                    const nameInput = $('toolNameInput');
                    const funcInput = $('toolFunctionInput');
                    if (nameInput) nameInput.value = rec.name;
                    if (funcInput) funcInput.value = rec.features.join('\n');

                    // æ›´æ–°å½“å‰å·¥å…·æ˜¾ç¤º
                    const display = $('currentToolDisplay');
                    if (display) {
                        display.innerHTML = `
                            <strong style="font-size: 15px;">${rec.name}</strong>
                            <div style="margin-top: 6px; font-size: 12px; opacity: 0.7;">${rec.description}</div>
                            <div style="margin-top: 6px; font-size: 12px;">
                                ${rec.features.map(f => `<span style="display: inline-block; background: var(--bg); padding: 2px 8px; border-radius: 4px; margin: 2px 4px 2px 0;">â€¢ ${f}</span>`).join('')}
                            </div>
                        `;
                    }
                    // éšè—è‡ªå®šä¹‰åŒº
                    const customSection = $('customToolSection');
                    if (customSection) customSection.style.display = 'none';

                } else if (rec.type === 'product') {
                    const nameInput = $('productNameInput');
                    const funcInput = $('productFunctionInput');
                    if (nameInput) nameInput.value = rec.name;
                    if (funcInput) funcInput.value = rec.features.join('\n');

                    // æ›´æ–°å½“å‰äº§å“æ˜¾ç¤º
                    const display = $('currentProductDisplay');
                    if (display) {
                        display.innerHTML = `
                            <strong style="font-size: 15px;">${rec.name}</strong>
                            <div style="margin-top: 6px; font-size: 12px; opacity: 0.7;">${rec.description}</div>
                            <div style="margin-top: 6px; font-size: 12px;">
                                ${rec.features.map(f => `<span style="display: inline-block; background: var(--bg); padding: 2px 8px; border-radius: 4px; margin: 2px 4px 2px 0;">â€¢ ${f}</span>`).join('')}
                            </div>
                        `;
                    }
                    // éšè—è‡ªå®šä¹‰åŒº
                    const customSection = $('customProductSection');
                    if (customSection) customSection.style.display = 'none';
                }
            }

            function renderConstraintsForm() {
                const container = $('constraintsForm');
                const paths = STATE.selectedPaths.includes('E') ? ['A', 'B', 'D'] : STATE.selectedPaths;

                let html = '';

                if (paths.includes('A')) {
                    html += `
                <div class="constraint-section">
                    <div class="constraint-title">
                        <span class="pill accent">A</span> å†…å®¹ç”Ÿäº§çº¦æŸ
                    </div>
                    
                    <div class="field" style="margin-bottom: 12px;">
                        <label>ç›®æ ‡å—ä¼—</label>
                        <div class="radio-group" data-field="A.audience">
                            <label class="radio-item" data-value="beginner">
                                <input type="radio" name="A_audience" value="beginner">
                                å°ç™½ï¼ˆé›¶åŸºç¡€ï¼‰
                            </label>
                            <label class="radio-item" data-value="intermediate">
                                <input type="radio" name="A_audience" value="intermediate">
                                è¿›é˜¶è€…ï¼ˆæœ‰ä¸€å®šç»éªŒï¼‰
                            </label>
                            <label class="radio-item" data-value="expert">
                                <input type="radio" name="A_audience" value="expert">
                                ä¸“å®¶/åŒè¡Œ
                            </label>
                        </div>
                    </div>

                    <div class="field" style="margin-bottom: 12px;">
                        <label>å†…å®¹å½¢å¼</label>
                        <div class="radio-group" data-field="A.format">
                            <label class="radio-item" data-value="long-article">
                                <input type="radio" name="A_format" value="long-article">
                                é•¿æ–‡æ•™ç¨‹
                            </label>
                            <label class="radio-item" data-value="short-article">
                                <input type="radio" name="A_format" value="short-article">
                                çŸ­æ–‡/æ¨æ–‡
                            </label>
                            <label class="radio-item" data-value="video-script">
                                <input type="radio" name="A_format" value="video-script">
                                è§†é¢‘è„šæœ¬
                            </label>
                        </div>
                    </div>

                    <div class="field">
                        <label>é£æ ¼åå¥½</label>
                        <div class="radio-group" data-field="A.style">
                            <label class="radio-item" data-value="academic">
                                <input type="radio" name="A_style" value="academic">
                                å­¦é™¢æ´¾ï¼ˆä¸¥è°¨ï¼‰
                            </label>
                            <label class="radio-item" data-value="practical">
                                <input type="radio" name="A_style" value="practical">
                                å®æˆ˜æ´¾ï¼ˆæ¥åœ°æ°”ï¼‰
                            </label>
                            <label class="radio-item" data-value="geek">
                                <input type="radio" name="A_style" value="geek">
                                æå®¢æ´¾ï¼ˆç¡¬æ ¸ï¼‰
                            </label>
                        </div>
                    </div>
                </div>
            `;
                }

                if (paths.includes('B')) {
                    html += `
                <div class="constraint-section">
                    <div class="constraint-title">
                        <span class="pill accent">B</span> å·¥å…·å¼€å‘çº¦æŸ
                    </div>
                    
                    <!-- å·¥å…·åç§°å’ŒåŠŸèƒ½ï¼šæ˜¾ç¤ºå½“å‰é€‰æ‹©æˆ–è‡ªå®šä¹‰ -->
                    <div class="field" style="margin-bottom: 12px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 8px; border: 1px dashed var(--border);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <label style="margin: 0;">ğŸ“Œ å½“å‰å·¥å…·è®¾å®š</label>
                            <button type="button" class="btn secondary" style="padding: 4px 10px; font-size: 12px;" onclick="document.getElementById('customToolSection').style.display = document.getElementById('customToolSection').style.display === 'none' ? 'block' : 'none';">
                                âœï¸ è‡ªå®šä¹‰
                            </button>
                        </div>
                        <div id="currentToolDisplay" style="font-size: 13px; opacity: 0.8;">
                            <em>è¯·å…ˆåœ¨ä¸Šæ–¹ã€ŒAI æ¨èã€ä¸­é€‰æ‹©ä¸€ä¸ªæ–¹å‘ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªå®šä¹‰ã€æ‰‹åŠ¨è¾“å…¥</em>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰è¾“å…¥åŒºï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="customToolSection" style="display: none; margin-bottom: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                        <div style="font-size: 13px; opacity: 0.7; margin-bottom: 10px;">ğŸ’¡ å¦‚æœ AI æ¨èä¸æ»¡æ„ï¼Œå¯åœ¨æ­¤è‡ªå®šä¹‰ï¼š</div>
                        <div class="field" style="margin-bottom: 12px;">
                            <label>å·¥å…·åç§°</label>
                            <input type="text" id="toolNameInput" placeholder="ç»™ä½ çš„å·¥å…·èµ·ä¸€ä¸ªåå­—ï¼Œå¦‚ï¼šæ–‡ç« æ¶¦è‰²åŠ©æ‰‹" style="width: 100%;" />
                        </div>
                        <div class="field">
                            <label>æ ¸å¿ƒåŠŸèƒ½æè¿°</label>
                            <textarea id="toolFunctionInput" placeholder="æè¿°è¿™ä¸ªå·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š&#10;- è‡ªåŠ¨åˆ†ææ–‡ç« ç»“æ„&#10;- è¯†åˆ«å¹¶ä¼˜åŒ–å†—ä½™è¡¨è¿°&#10;- ç”Ÿæˆå¤šç‰ˆæœ¬æ”¹å†™å»ºè®®" style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div class="field" style="margin-bottom: 12px;">
                        <label>æŠ€æœ¯æ ˆï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="checkbox-group" data-field="B.techStack" data-type="multi">
                            <label class="checkbox-item" title="é€‚åˆæ•°æ®å¤„ç†ã€åç«¯æœåŠ¡ã€è‡ªåŠ¨åŒ–è„šæœ¬ã€AI/ML åº”ç”¨">
                                <input type="checkbox" name="B_techStack" value="python">
                                ğŸ Python <small style="opacity:0.6">â€” æ•°æ®/AI/è‡ªåŠ¨åŒ–</small>
                            </label>
                            <label class="checkbox-item" title="é€‚åˆ Web åº”ç”¨ã€æµè§ˆå™¨æ’ä»¶ã€å…¨æ ˆå¼€å‘ã€å®æ—¶äº¤äº’">
                                <input type="checkbox" name="B_techStack" value="javascript">
                                âš¡ JavaScript/Node.js <small style="opacity:0.6">â€” Web/å…¨æ ˆ</small>
                            </label>
                            <label class="checkbox-item" title="é›¶ä¾èµ–æœ¬åœ°å·¥å…·ï¼Œå• HTML æ–‡ä»¶å³å¯è¿è¡Œï¼Œé€‚åˆå¿«é€ŸåŸå‹å’Œä¸ªäººå·¥å…·">
                                <input type="checkbox" name="B_techStack" value="html-single">
                                ğŸ“„ HTML å•æ–‡ä»¶ <small style="opacity:0.6">â€” é›¶ä¾èµ–/å¿«é€ŸåŸå‹</small>
                            </label>
                            <label class="checkbox-item" title="æ— éœ€ç¼–ç¨‹ï¼Œç›´æ¥ç”¨äº ChatGPT/Claude/Kimi ç­‰ AI å¯¹è¯å¹³å°">
                                <input type="checkbox" name="B_techStack" value="prompt-only">
                                ğŸ’¬ çº¯ Prompt <small style="opacity:0.6">â€” é›¶ä»£ç /AI å¹³å°</small>
                            </label>
                            <label class="checkbox-item" title="é€‚åˆ Coze/Dify/FastGPT ç­‰æ— ä»£ç  AI Agent å¹³å°">
                                <input type="checkbox" name="B_techStack" value="ai-workflow">
                                ğŸ”— AI å·¥ä½œæµ <small style="opacity:0.6">â€” Coze/Dify</small>
                            </label>
                        </div>
                    </div>

                    <div class="field">
                        <label>è¿è¡Œç¯å¢ƒï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="checkbox-group" data-field="B.environment" data-type="multi">
                            <label class="checkbox-item" title="å¼€å‘è€…æœ¬åœ°ä½¿ç”¨ï¼Œé€‚åˆæ‰¹é‡å¤„ç†ã€è‡ªåŠ¨åŒ–ä»»åŠ¡">
                                <input type="checkbox" name="B_environment" value="cli">
                                ğŸ–¥ï¸ å‘½ä»¤è¡Œè„šæœ¬ <small style="opacity:0.6">â€” æ‰¹é‡/è‡ªåŠ¨åŒ–</small>
                            </label>
                            <label class="checkbox-item" title="å¯éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œé€‚åˆå‰ç«¯ç”¨æˆ·ã€å¤šäººä½¿ç”¨">
                                <input type="checkbox" name="B_environment" value="web">
                                ğŸŒ Web åº”ç”¨ <small style="opacity:0.6">â€” å¯éƒ¨ç½²/å¤šç”¨æˆ·</small>
                            </label>
                            <label class="checkbox-item" title="æä¾›ç»™å…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼Œé€‚åˆåç«¯é›†æˆã€å¾®æœåŠ¡">
                                <input type="checkbox" name="B_environment" value="api">
                                ğŸ”Œ API æœåŠ¡ <small style="opacity:0.6">â€” ç³»ç»Ÿé›†æˆ</small>
                            </label>
                            <label class="checkbox-item" title="Chrome/Edge æµè§ˆå™¨æ‰©å±•ï¼Œé€‚åˆå¢å¼ºç½‘é¡µåŠŸèƒ½">
                                <input type="checkbox" name="B_environment" value="browser-extension">
                                ğŸ§© æµè§ˆå™¨æ’ä»¶ <small style="opacity:0.6">â€” Chrome/Edge</small>
                            </label>
                            <label class="checkbox-item" title="Electron ç­‰è·¨å¹³å°æ–¹æ¡ˆï¼Œé€‚åˆéœ€è¦ç³»ç»Ÿçº§æƒé™çš„åº”ç”¨">
                                <input type="checkbox" name="B_environment" value="desktop">
                                ğŸ’» æ¡Œé¢åº”ç”¨ <small style="opacity:0.6">â€” è·¨å¹³å°</small>
                            </label>
                        </div>
                    </div>
                </div>
            `;
                }

                if (paths.includes('C')) {
                    html += `
                <div class="constraint-section">
                    <div class="constraint-title">
                        <span class="pill accent">C</span> äº§å“è®¾è®¡çº¦æŸ
                    </div>
                    
                    <!-- äº§å“åç§°å’ŒåŠŸèƒ½ï¼šæ˜¾ç¤ºå½“å‰é€‰æ‹©æˆ–è‡ªå®šä¹‰ -->
                    <div class="field" style="margin-bottom: 12px; padding: 12px; background: rgba(34, 197, 94, 0.05); border-radius: 8px; border: 1px dashed var(--border);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <label style="margin: 0;">ğŸ“Œ å½“å‰äº§å“è®¾å®š</label>
                            <button type="button" class="btn secondary" style="padding: 4px 10px; font-size: 12px;" onclick="document.getElementById('customProductSection').style.display = document.getElementById('customProductSection').style.display === 'none' ? 'block' : 'none';">
                                âœï¸ è‡ªå®šä¹‰
                            </button>
                        </div>
                        <div id="currentProductDisplay" style="font-size: 13px; opacity: 0.8;">
                            <em>è¯·å…ˆåœ¨ä¸Šæ–¹ã€ŒAI æ¨èã€ä¸­é€‰æ‹©ä¸€ä¸ªæ–¹å‘ï¼Œæˆ–ç‚¹å‡»ã€Œè‡ªå®šä¹‰ã€æ‰‹åŠ¨è¾“å…¥</em>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰è¾“å…¥åŒºï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="customProductSection" style="display: none; margin-bottom: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px;">
                        <div style="font-size: 13px; opacity: 0.7; margin-bottom: 10px;">ğŸ’¡ å¦‚æœ AI æ¨èä¸æ»¡æ„ï¼Œå¯åœ¨æ­¤è‡ªå®šä¹‰ï¼š</div>
                        <div class="field" style="margin-bottom: 12px;">
                            <label>äº§å“åç§°</label>
                            <input type="text" id="productNameInput" placeholder="ç»™ä½ çš„äº§å“èµ·ä¸€ä¸ªåå­—ï¼Œå¦‚ï¼šAIå†™ä½œåŠ©æ‰‹" style="width: 100%;" />
                        </div>
                        <div class="field">
                            <label>æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚</label>
                            <textarea id="productFunctionInput" placeholder="æè¿°äº§å“éœ€è¦å®ç°çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š&#10;1. ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£åè‡ªåŠ¨åˆ†æ&#10;2. ç”Ÿæˆä¼˜åŒ–å»ºè®®å¹¶ä¸€é”®æ”¹å†™&#10;3. æ”¯æŒå¤šé£æ ¼åˆ‡æ¢" style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div class="field" style="margin-bottom: 12px;">
                        <label>ç›®æ ‡å¹³å°</label>
                        <div class="radio-group" data-field="C.platform">
                            <label class="radio-item" data-value="web">
                                <input type="radio" name="C_platform" value="web">
                                Web åº”ç”¨
                            </label>
                            <label class="radio-item" data-value="mobile">
                                <input type="radio" name="C_platform" value="mobile">
                                ç§»åŠ¨ç«¯ APP
                            </label>
                            <label class="radio-item" data-value="mini-program">
                                <input type="radio" name="C_platform" value="mini-program">
                                å°ç¨‹åº
                            </label>
                        </div>
                    </div>

                    <div class="field" style="margin-bottom: 12px;">
                        <label>äº§å“å®šä½</label>
                        <div class="radio-group" data-field="C.positioning">
                            <label class="radio-item" data-value="free-tool">
                                <input type="radio" name="C_positioning" value="free-tool">
                                å…è´¹å·¥å…·
                            </label>
                            <label class="radio-item" data-value="saas">
                                <input type="radio" name="C_positioning" value="saas">
                                ä»˜è´¹ SaaS
                            </label>
                            <label class="radio-item" data-value="open-source">
                                <input type="radio" name="C_positioning" value="open-source">
                                å¼€æºé¡¹ç›®
                            </label>
                        </div>
                    </div>

                    <div class="field">
                        <label>æ ¸å¿ƒç”¨æˆ·</label>
                        <div class="radio-group" data-field="C.targetUser">
                            <label class="radio-item" data-value="creators">
                                <input type="radio" name="C_targetUser" value="creators">
                                å†…å®¹åˆ›ä½œè€…
                            </label>
                            <label class="radio-item" data-value="developers">
                                <input type="radio" name="C_targetUser" value="developers">
                                å¼€å‘è€…
                            </label>
                            <label class="radio-item" data-value="general">
                                <input type="radio" name="C_targetUser" value="general">
                                é€šç”¨ç”¨æˆ·
                            </label>
                        </div>
                    </div>
                </div>
            `;
                }

                if (paths.includes('D')) {
                    html += `
                <div class="constraint-section">
                    <div class="constraint-title">
                        <span class="pill accent">D</span> çŸ¥è¯†æç‚¼çº¦æŸ
                    </div>
                    
                    <div class="field" style="margin-bottom: 12px;">
                        <label>äº¤ä»˜æ ¼å¼</label>
                        <div class="radio-group" data-field="D.deliveryFormat">
                            <label class="radio-item" data-value="obsidian">
                                <input type="radio" name="D_deliveryFormat" value="obsidian">
                                Obsidian åŒé“¾
                            </label>
                            <label class="radio-item" data-value="notion">
                                <input type="radio" name="D_deliveryFormat" value="notion">
                                Notion å¡ç‰‡
                            </label>
                            <label class="radio-item" data-value="markdown">
                                <input type="radio" name="D_deliveryFormat" value="markdown">
                                çº¯ Markdown
                            </label>
                        </div>
                    </div>

                    <div class="field">
                        <label>çŸ¥è¯†é¢—ç²’åº¦</label>
                        <div class="radio-group" data-field="D.granularity">
                            <label class="radio-item" data-value="concept">
                                <input type="radio" name="D_granularity" value="concept">
                                æ¦‚å¿µçº§ï¼ˆæ¯ä¸ªæ¦‚å¿µä¸€å¼ å¡ï¼‰
                            </label>
                            <label class="radio-item" data-value="module">
                                <input type="radio" name="D_granularity" value="module">
                                æ¨¡å—çº§ï¼ˆæ¯ä¸ªé˜¶æ®µä¸€ä¸ªæ¨¡å—ï¼‰
                            </label>
                            <label class="radio-item" data-value="system">
                                <input type="radio" name="D_granularity" value="system">
                                ç³»ç»Ÿçº§ï¼ˆå®Œæ•´ä¸€ä»½ï¼‰
                            </label>
                        </div>
                    </div>
                </div>
            `;
                }

                container.innerHTML = html;

                // Add click handlers for radio items
                $$('.radio-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const input = item.querySelector('input');
                        input.checked = true;

                        // Update visual state
                        item.closest('.radio-group').querySelectorAll('.radio-item').forEach(i => {
                            i.classList.remove('selected');
                        });
                        item.classList.add('selected');
                    });
                });
            }

            function collectConstraints() {
                // å¤„ç†å¤šé€‰ checkbox ç»„
                $$('.checkbox-group').forEach(group => {
                    const field = group.dataset.field;
                    const [path, key] = field.split('.');
                    const checkedItems = group.querySelectorAll('input:checked');
                    const values = Array.from(checkedItems).map(input => input.value);

                    if (!STATE.constraints[path]) {
                        STATE.constraints[path] = {};
                    }
                    STATE.constraints[path][key] = values;
                });

                // å¤„ç†å•é€‰ radio ç»„
                $$('.radio-group').forEach(group => {
                    const field = group.dataset.field;
                    const [path, key] = field.split('.');
                    const selected = group.querySelector('input:checked');

                    if (!STATE.constraints[path]) {
                        STATE.constraints[path] = {};
                    }
                    STATE.constraints[path][key] = selected ? selected.value : '';
                });

                // å¤„ç†è·¯å¾„Bçš„å·¥å…·åç§°å’ŒåŠŸèƒ½æè¿°
                const toolNameInput = $('toolNameInput');
                const toolFunctionInput = $('toolFunctionInput');
                if (toolNameInput) {
                    STATE.constraints.B.toolName = toolNameInput.value.trim();
                }
                if (toolFunctionInput) {
                    STATE.constraints.B.toolFunction = toolFunctionInput.value.trim();
                }

                // å¤„ç†è·¯å¾„Cçš„äº§å“åç§°å’ŒåŠŸèƒ½éœ€æ±‚
                const productNameInput = $('productNameInput');
                const productFunctionInput = $('productFunctionInput');
                if (productNameInput) {
                    STATE.constraints.C.productName = productNameInput.value.trim();
                }
                if (productFunctionInput) {
                    STATE.constraints.C.productFunction = productFunctionInput.value.trim();
                }
            }

            // ==================== Stage 4: Architecture ====================
            async function startArchitecture() {
                goToStage(4);

                const state = aiModule.get_state();
                if (!state.networking_enabled) {
                    $('architectureOutput').innerHTML = '<div class="pill bad">è¯·å…ˆå…è®¸è”ç½‘</div>';
                    return;
                }

                $('architectureOutput').innerHTML = '<div class="loading-spinner"></div> AI æ­£åœ¨è®¾è®¡æ¶æ„...';
                $('confirmArchitectureBtn').disabled = true;

                try {
                    const paths = STATE.selectedPaths.includes('E') ? ['A', 'B', 'D'] : STATE.selectedPaths;
                    const prompt = PROMPT_TEMPLATES.stage4Architecture(
                        STATE.decodeReport,
                        paths,
                        STATE.constraints
                    );

                    await aiModule.call_ai({
                        messages: [{ role: 'user', content: prompt }],
                        onChunk: (chunk, full) => {
                            $('architectureOutput').innerHTML = renderMarkdown(full) + '<span class="streaming-cursor"></span>';
                        }
                    });

                    STATE.architecture = $('architectureOutput').textContent;
                    $('architectureOutput').innerHTML = renderMarkdown(STATE.architecture);
                    $('confirmArchitectureBtn').disabled = false;
                    saveState();

                } catch (e) {
                    $('architectureOutput').innerHTML = `<div class="pill bad">é”™è¯¯</div><pre>${aiModule.get_actionable_error(e)}</pre>`;
                }
            }

            // ==================== ä¿®æ”¹æ„è§åŠŸèƒ½ ====================
            async function reviseArchitecture() {
                const revisionText = $('revisionInput').value.trim();
                if (!revisionText) {
                    alert('è¯·å¡«å†™ä¿®æ”¹æ„è§');
                    return;
                }

                const state = aiModule.get_state();
                if (!state.networking_enabled) {
                    $('architectureOutput').innerHTML = '<div class="pill bad">è¯·å…ˆå…è®¸è”ç½‘</div>';
                    return;
                }

                $('architectureOutput').innerHTML = '<div class="loading-spinner"></div> AI æ­£åœ¨æ ¹æ®æ‚¨çš„æ„è§ä¿®æ”¹æ¶æ„...';
                $('submitRevisionBtn').disabled = true;
                $('confirmArchitectureBtn').disabled = true;

                try {
                    const paths = STATE.selectedPaths.includes('E') ? ['A', 'B', 'D'] : STATE.selectedPaths;
                    const revisionPrompt = `ä½ æ˜¯ä¸€åã€Œæ·±åº¦è§£ç å™¨ã€ï¼Œç”¨æˆ·å¯¹ä½ ä¹‹å‰ç”Ÿæˆçš„æ¶æ„æ–¹æ¡ˆæå‡ºäº†ä¿®æ”¹æ„è§ã€‚

## åŸæ¶æ„æ–¹æ¡ˆ
${STATE.architecture}

## ç”¨æˆ·çº¦æŸ
${JSON.stringify(STATE.constraints, null, 2)}

## ç”¨æˆ·ä¿®æ”¹æ„è§
${revisionText}

## âš ï¸ å…³é”®è¦æ±‚
ä½ **å¿…é¡»ä¸¥æ ¼æŒ‰ç…§**ç”¨æˆ·çš„ä¿®æ”¹æ„è§è¿›è¡Œè°ƒæ•´ï¼Œä¸å¾—å¿½ç•¥ä»»ä½•ä¸€æ¡ï¼

1. **åç§°ä¿®æ”¹**ï¼šå¦‚æœç”¨æˆ·è¦æ±‚ä¿®æ”¹å·¥å…·/äº§å“åç§°ï¼Œä½ å¿…é¡»åœ¨æ•´ä¸ªæ–¹æ¡ˆä¸­ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ–°åç§°ï¼Œå®Œå…¨æ›¿æ¢åŸåç§°
2. **åŠŸèƒ½ä¿®æ”¹**ï¼šå¦‚æœç”¨æˆ·è¦æ±‚è°ƒæ•´åŠŸèƒ½æè¿°ï¼Œå¿…é¡»å®Œå…¨æŒ‰ç…§ç”¨æˆ·çš„è¡¨è¿°ä¿®æ”¹
3. **ç»“æ„ä¿®æ”¹**ï¼šå¦‚æœç”¨æˆ·è¦æ±‚è°ƒæ•´æ¶æ„ç»“æ„ï¼Œå¿…é¡»æŒ‰è¦æ±‚é‡æ–°ç»„ç»‡
4. **å…¶ä»–ä¿®æ”¹**ï¼šä»»ä½•ç”¨æˆ·æåˆ°çš„ä¿®æ”¹ç‚¹éƒ½å¿…é¡»è¢«æ‰§è¡Œ

## è¾“å‡ºæ ¼å¼
é¦–å…ˆï¼Œç”¨ âœ… é€æ¡åˆ—å‡ºä½ å·²é‡‡çº³çš„ä¿®æ”¹ï¼ˆå¿…é¡»æ¶µç›–ç”¨æˆ·æåˆ°çš„æ¯ä¸€ç‚¹ï¼‰ï¼š
> âœ… å·²å°†å·¥å…·åç§°ä» "[åŸåç§°]" ä¿®æ”¹ä¸º "[æ–°åç§°]"
> âœ… å·²è°ƒæ•´ [å…·ä½“å†…å®¹]
> ...

ç„¶åï¼Œè¾“å‡ºå®Œæ•´çš„ä¿®æ”¹åçš„æ¶æ„æ–¹æ¡ˆï¼ˆä¿æŒåŸæœ‰æ ¼å¼ï¼‰ï¼š`;

                    let fullResponse = '';
                    await aiModule.call_ai({
                        messages: [{ role: 'user', content: revisionPrompt }],
                        onChunk: (chunk, full) => {
                            fullResponse = full;
                            $('architectureOutput').innerHTML = renderMarkdown(full) + '<span class="streaming-cursor"></span>';
                        }
                    });

                    STATE.architecture = fullResponse;
                    $('architectureOutput').innerHTML = renderMarkdown(STATE.architecture);
                    $('revisionInput').value = '';
                    $('revisionSection').style.display = 'none';
                    $('submitRevisionBtn').disabled = false;
                    $('confirmArchitectureBtn').disabled = false;
                    saveState();

                } catch (e) {
                    $('architectureOutput').innerHTML = `<div class="pill bad">é”™è¯¯</div><pre>${aiModule.get_actionable_error(e)}</pre>`;
                    $('submitRevisionBtn').disabled = false;
                }
            }

            function initStage4() {
                $('backToStage3Btn').addEventListener('click', () => goToStage(3));
                $('confirmArchitectureBtn').addEventListener('click', startDelivery);
                $('copyArchitectureBtn').addEventListener('click', () => copyToClipboard(STATE.architecture));

                // ä¿®æ”¹æ„è§åŠŸèƒ½
                $('showRevisionBtn').addEventListener('click', () => {
                    const section = $('revisionSection');
                    section.style.display = section.style.display === 'none' ? 'block' : 'none';
                });
                $('submitRevisionBtn').addEventListener('click', reviseArchitecture);
            }

            // ==================== Stage 5: Delivery ====================
            async function startDelivery() {
                goToStage(5);

                const state = aiModule.get_state();
                if (!state.networking_enabled) {
                    $('testReportOutput').textContent = 'è¯·å…ˆå…è®¸è”ç½‘';
                    return;
                }

                $('testReportOutput').textContent = 'AI æ­£åœ¨æ‰§è¡Œæ²™ç›’æ¨¡æ‹Ÿ...';
                $('deliverableTabs').innerHTML = '';
                $('deliverableContents').innerHTML = '<div class="output-content"><div class="loading-spinner"></div> æ­£åœ¨ç”Ÿæˆäº¤ä»˜ç‰©...</div>';

                try {
                    const paths = STATE.selectedPaths.includes('E') ? ['A', 'B', 'D'] : STATE.selectedPaths;
                    const fullContext = {
                        decodeReport: STATE.decodeReport,
                        selectedPaths: paths,
                        constraints: STATE.constraints,
                        architecture: STATE.architecture
                    };

                    const prompt = PROMPT_TEMPLATES.stage5Deliver(fullContext, paths);
                    let fullResponse = '';

                    await aiModule.call_ai({
                        messages: [{ role: 'user', content: prompt }],
                        onChunk: (chunk, full) => {
                            fullResponse = full;
                            $('deliverableContents').innerHTML = `<div class="output-content markdown-body">${renderMarkdown(full)}<span class="streaming-cursor"></span></div>`;
                        }
                    });

                    // Parse the response
                    parseDeliverables(fullResponse, paths);
                    saveState();

                } catch (e) {
                    $('deliverableContents').innerHTML = `<div class="output-content"><div class="pill bad">é”™è¯¯</div><pre>${aiModule.get_actionable_error(e)}</pre></div>`;
                }
            }

            function parseDeliverables(response, paths) {
                // Parse sections
                const sections = {
                    testReport: extractSection(response, '===TEST_REPORT===', '===PATH_'),
                    A: extractSection(response, '===PATH_A===', '===PATH_'),
                    B: extractSection(response, '===PATH_B===', '===PATH_'),
                    C: extractSection(response, '===PATH_C===', '===PATH_'),
                    D: extractSection(response, '===PATH_D===', '===PATH_')
                };

                STATE.deliverables = sections;

                // Render test report
                $('testReportOutput').textContent = sections.testReport || 'æ— å‹åŠ›æµ‹è¯•æŠ¥å‘Š';

                // Build tabs
                const tabs = [];
                const contents = [];

                paths.forEach((path, index) => {
                    if (sections[path]) {
                        const isActive = index === 0;
                        tabs.push(`<div class="tab ${isActive ? 'active' : ''}" data-tab="${path}">è·¯å¾„ ${path}</div>`);
                        contents.push(`
                    <div class="tab-content ${isActive ? 'active' : ''}" data-tab="${path}">
                        <div class="output-content markdown-body">${renderMarkdown(sections[path])}</div>
                    </div>
                `);
                    }
                });

                $('deliverableTabs').innerHTML = tabs.join('');
                $('deliverableContents').innerHTML = contents.join('');

                // Tab switching
                $$('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        $$('.tab').forEach(t => t.classList.remove('active'));
                        $$('.tab-content').forEach(c => c.classList.remove('active'));

                        tab.classList.add('active');
                        document.querySelector(`.tab-content[data-tab="${tab.dataset.tab}"]`).classList.add('active');
                    });
                });
            }

            function extractSection(text, startMarker, endMarkerPrefix) {
                const startIndex = text.indexOf(startMarker);
                if (startIndex === -1) return '';

                let content = text.slice(startIndex + startMarker.length);

                // Find the next section marker
                const endIndex = content.indexOf(endMarkerPrefix);
                if (endIndex > -1) {
                    content = content.slice(0, endIndex);
                }

                return content.trim();
            }

            function initStage5() {
                $('downloadAllBtn').addEventListener('click', downloadAllMarkdown);
                $('downloadJsonBtn').addEventListener('click', downloadJson);
                $('newProjectBtn').addEventListener('click', resetProject);
            }

            function downloadAllMarkdown() {
                let content = `# æ·±åº¦è§£ç å™¨ - é¡¹ç›®äº¤ä»˜ç‰©\n\n`;
                content += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n\n`;
                content += `---\n\n`;
                content += `## è§£æ„æŠ¥å‘Š\n\n${STATE.decodeReport}\n\n`;
                content += `---\n\n`;
                content += `## æ¶æ„è®¾è®¡\n\n${STATE.architecture}\n\n`;
                content += `---\n\n`;

                const paths = STATE.selectedPaths.includes('E') ? ['A', 'B', 'D'] : STATE.selectedPaths;
                paths.forEach(path => {
                    if (STATE.deliverables[path]) {
                        content += `## è·¯å¾„ ${path} äº¤ä»˜ç‰©\n\n${STATE.deliverables[path]}\n\n---\n\n`;
                    }
                });

                downloadFile('meta-system-architect-output.md', content, 'text/markdown');
            }

            function downloadJson() {
                const data = {
                    version: '1.0.0',
                    generatedAt: new Date().toISOString(),
                    selectedPaths: STATE.selectedPaths,
                    constraints: STATE.constraints,
                    decodeReport: STATE.decodeReport,
                    architecture: STATE.architecture,
                    deliverables: STATE.deliverables
                };

                downloadFile('meta-system-architect-output.json', JSON.stringify(data, null, 2), 'application/json');
            }

            function downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            function resetProject() {
                if (!confirm('ç¡®å®šè¦å¼€å§‹æ–°é¡¹ç›®å—ï¼Ÿå½“å‰è¿›åº¦å°†è¢«æ¸…é™¤ã€‚')) return;

                localStorage.removeItem('msa_state');
                location.reload();
            }

            // ==================== Utilities ====================
            function renderMarkdown(text) {
                if (typeof marked === 'undefined') return escapeHtml(text);

                marked.setOptions({
                    highlight: function (code, lang) {
                        if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return code;
                    }
                });

                return marked.parse(text);
            }

            function escapeHtml(str) {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    // Could show a toast notification here
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }

            function saveState() {
                const stateToSave = {
                    currentStage: STATE.currentStage,
                    decodeReport: STATE.decodeReport,
                    selectedPaths: STATE.selectedPaths,
                    constraints: STATE.constraints,
                    architecture: STATE.architecture,
                    deliverables: STATE.deliverables
                };
                localStorage.setItem('msa_state', JSON.stringify(stateToSave));
            }

            function loadState() {
                const saved = localStorage.getItem('msa_state');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        Object.assign(STATE, parsed);

                        if (STATE.currentStage > 1) {
                            // Restore UI state
                            if (STATE.decodeReport) {
                                $('decodeOutputSection').hidden = false;
                                $('decodeOutput').innerHTML = renderMarkdown(STATE.decodeReport);
                                $('confirmDecodeBtn').disabled = false;
                            }
                            updatePathSelection();
                        }
                    } catch (e) {
                        console.error('Failed to load state:', e);
                    }
                }
            }

            // ==================== Init ====================
            function init() {
                initTheme();

                // Mount AI settings
                aiModule = AI_MODULE.mount_ai_settings({
                    mount_el: $('aiSettingsMount'),
                    default_provider_id: 'siliconflow'
                });

                initFileUpload();
                initStageNav();  // åˆå§‹åŒ–é˜¶æ®µå¯¼èˆªç‚¹å‡»
                initStage1();
                initStage2();
                initStage3();
                initStage4();
                initStage5();

                // Reset button
                $('resetBtn').addEventListener('click', resetProject);

                // Load saved state
                loadState();
                updateStageNav();
            }

            // Expose for global access
            return {
                init,
                removeFile,
                STATE
            };
        })();

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', APP.init);

        // ==================== ç§»åŠ¨ç«¯æŠ½å±‰èœå•æ§åˆ¶ ====================
        const MobileDrawer = {
            init() {
                const menuBtn = document.getElementById('mobileMenuBtn');
                const overlay = document.getElementById('mobileOverlay');
                const sidebar = document.querySelector('.sidebar');
                const closeBtn = document.getElementById('mobileDrawerClose');

                if (!menuBtn || !sidebar) return;

                menuBtn.addEventListener('click', () => this.open());
                overlay?.addEventListener('click', () => this.close());
                closeBtn?.addEventListener('click', () => this.close());
            },

            open() {
                document.querySelector('.sidebar')?.classList.add('open');
                document.getElementById('mobileOverlay')?.classList.add('open');
                document.body.style.overflow = 'hidden';
            },

            close() {
                document.querySelector('.sidebar')?.classList.remove('open');
                document.getElementById('mobileOverlay')?.classList.remove('open');
                document.body.style.overflow = '';
            }
        };

        document.addEventListener('DOMContentLoaded', () => MobileDrawer.init());
    </script>

</body>

</html>