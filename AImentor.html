<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI å­¦ä¹ æ•™ç»ƒ - é€†å‘å­¦ä¹ å¼•å¯¼ç³»ç»Ÿ</title>
    <style>
        /* ========== Theme System ========== */
        :root {
            --bg: #f8fafc;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, 0.92);
            --panel2: rgba(255, 255, 255, 0.78);
            --text: #0f172a;
            --muted: #64748b;
            --border: rgba(15, 23, 42, 0.12);
            --accent: #6366f1;
            --accent2: #8b5cf6;
            --good: #10b981;
            --bad: #ef4444;
            --warn: #f59e0b;
            --coach-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --user-bg: #e0e7ff;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --bg2: #1e293b;
                --panel: rgba(30, 41, 59, 0.92);
                --panel2: rgba(30, 41, 59, 0.78);
                --text: #f1f5f9;
                --muted: #94a3b8;
                --border: rgba(255, 255, 255, 0.12);
                --user-bg: #312e81;
                --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
            }
        }

        html[data-theme="light"] {
            --bg: #f8fafc;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, 0.92);
            --panel2: rgba(255, 255, 255, 0.78);
            --text: #0f172a;
            --muted: #64748b;
            --border: rgba(15, 23, 42, 0.12);
            --user-bg: #e0e7ff;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
        }

        html[data-theme="dark"] {
            --bg: #0f172a;
            --bg2: #1e293b;
            --panel: rgba(30, 41, 59, 0.92);
            --panel2: rgba(30, 41, 59, 0.78);
            --text: #f1f5f9;
            --muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.12);
            --user-bg: #312e81;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
        }

        /* ========== Base Styles ========== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--sans);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== Layout ========== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        /* ========== Header ========== */
        .header {
            padding: 12px 16px;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            font-size: 24px;
        }

        .title-group h1 {
            font-size: 16px;
            font-weight: 800;
            background: var(--coach-bg);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title-group .subtitle {
            font-size: 11px;
            color: var(--muted);
        }

        .header-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* ========== Progress Bar ========== */
        .progress-bar {
            padding: 8px 16px;
            background: var(--panel2);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 4px;
            overflow-x: auto;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--muted);
            background: transparent;
            border: 1px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .progress-step.active {
            background: var(--coach-bg);
            color: white;
            border-color: transparent;
        }

        .progress-step.completed {
            background: rgba(16, 185, 129, 0.15);
            color: var(--good);
            border-color: var(--good);
        }

        .progress-step .step-icon {
            font-size: 12px;
        }

        .progress-connector {
            width: 16px;
            height: 2px;
            background: var(--border);
            flex-shrink: 0;
        }

        .progress-connector.completed {
            background: var(--good);
        }

        /* ========== Chat Area ========== */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.coach {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.coach .message-avatar {
            background: var(--coach-bg);
        }

        .message.user .message-avatar {
            background: var(--user-bg);
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 14px;
        }

        .message.coach .message-content {
            background: var(--panel);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: var(--user-bg);
            color: var(--text);
            border-bottom-right-radius: 4px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content strong {
            font-weight: 700;
        }

        .message-content em {
            font-style: italic;
            color: var(--muted);
        }

        .message-content code {
            font-family: var(--mono);
            font-size: 12px;
            background: rgba(99, 102, 241, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* ========== Quick Replies ========== */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-reply-btn {
            padding: 8px 14px;
            border-radius: 20px;
            border: 1px solid var(--accent);
            background: transparent;
            color: var(--accent);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-reply-btn:hover {
            background: var(--accent);
            color: white;
        }

        /* ========== Input Area ========== */
        .input-area {
            padding: 12px 16px;
            background: var(--panel);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 24px;
            background: var(--bg2);
            color: var(--text);
            font-size: 14px;
            font-family: var(--sans);
            resize: none;
            min-height: 48px;
            max-height: 150px;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: var(--accent);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--coach-bg);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, opacity 0.2s;
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========== Command Hints ========== */
        .command-hints {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .command-hint {
            font-size: 11px;
            color: var(--muted);
            padding: 4px 8px;
            background: var(--bg2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .command-hint:hover {
            background: var(--accent);
            color: white;
        }

        /* ========== First Win Card ========== */
        .first-win-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 16px;
            margin-top: 12px;
        }

        .first-win-card h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .first-win-task {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .first-win-deadline {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 12px;
        }

        .first-win-steps {
            list-style: none;
        }

        .first-win-steps li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            border-bottom: 1px dashed var(--border);
        }

        .first-win-steps li:last-child {
            border-bottom: none;
        }

        .step-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .step-checkbox.completed {
            background: var(--good);
            border-color: var(--good);
            color: white;
            font-size: 10px;
        }

        /* ========== Diagnosis Card ========== */
        .diagnosis-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
            border: 1px solid var(--warn);
            border-radius: 16px;
            padding: 16px;
            margin-top: 12px;
        }

        .diagnosis-card h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--warn);
            margin-bottom: 10px;
        }

        .trap-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border);
        }

        .trap-item:last-child {
            border-bottom: none;
        }

        .trap-icon {
            font-size: 20px;
        }

        .trap-info h5 {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .trap-info p {
            font-size: 12px;
            color: var(--muted);
        }

        /* ========== Buttons & Pills ========== */
        .btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg2);
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--panel2);
        }

        .btn.primary {
            background: var(--coach-bg);
            color: white;
            border: none;
        }

        .btn.primary:hover {
            opacity: 0.9;
        }

        .btn.secondary {
            background: transparent;
            border-color: var(--accent);
            color: var(--accent);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .pill.good {
            background: rgba(16, 185, 129, 0.15);
            color: var(--good);
        }

        .pill.bad {
            background: rgba(239, 68, 68, 0.15);
            color: var(--bad);
        }

        .pill.warn {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warn);
        }

        .pill.info {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        /* ========== Loading ========== */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--muted);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.4;
            }

            30% {
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        /* ========== Settings Panel ========== */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            max-width: 100vw;
            height: 100vh;
            background: var(--panel);
            border-left: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
            backdrop-filter: blur(12px);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--panel);
        }

        .settings-header h2 {
            font-size: 16px;
            font-weight: 700;
        }

        .close-settings {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            font-size: 18px;
        }

        .settings-body {
            padding: 16px;
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section h3 {
            font-size: 13px;
            font-weight: 700;
            color: var(--muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setting-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }

        .setting-row label {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
        }

        .setting-row select,
        .setting-row input[type="text"] {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg2);
            color: var(--text);
            font-size: 13px;
            outline: none;
        }

        .setting-row select:focus,
        .setting-row input[type="text"]:focus {
            border-color: var(--accent);
        }

        .setting-hint {
            font-size: 11px;
            color: var(--muted);
            line-height: 1.4;
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg2);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .setting-toggle span {
            font-size: 13px;
            font-weight: 600;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: var(--accent);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(20px);
        }

        .log-box {
            font-family: var(--mono);
            font-size: 11px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--muted);
        }

        /* ========== Overlay ========== */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ========== Welcome Screen ========== */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .welcome-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .welcome-screen h2 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 12px;
            background: var(--coach-bg);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-screen p {
            font-size: 14px;
            color: var(--muted);
            max-width: 400px;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .welcome-features {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 24px;
        }

        .welcome-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 13px;
        }

        .welcome-feature .icon {
            font-size: 18px;
        }

        /* ========== Responsive ========== */
        @media (max-width: 600px) {
            .header {
                padding: 10px 12px;
            }

            .title-group h1 {
                font-size: 14px;
            }

            .progress-bar {
                padding: 6px 12px;
            }

            .progress-step {
                padding: 4px 8px;
                font-size: 10px;
            }

            .chat-area {
                padding: 12px;
            }

            .message {
                max-width: 92%;
            }

            .input-area {
                padding: 10px 12px;
            }

            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>

<body>

    <!-- Tool Meta -->
    <script type="application/json" id="tool_meta">
{
    "tool_id": "ai-learning-coach",
    "tool_name": "AI å­¦ä¹ æ•™ç»ƒ",
    "tool_version": "1.0.0",
    "description": "åŸºäºã€Œé€†å‘å­¦ä¹ æ³•ã€çš„äº¤äº’å¼å­¦ä¹ å¼•å¯¼å·¥å…·ï¼Œå¸®åŠ©æˆäººæ‰“ç ´ã€Œå­¦ç”Ÿå¿ƒæ€é™·é˜±ã€ï¼Œè®¾è®¡é¦–èƒœé¡¹ç›®",
    "created_at": "2025-12-31",
    "capabilities": {
        "paste_first": false,
        "file_input": false,
        "download_output": true,
        "url_state": false,
        "local_draft": true,
        "networking": true,
        "ai": true
    },
    "inputs": ["chat_text"],
    "outputs": ["copy_text", "download_file"],
    "dependencies": [],
    "ai_integration": {
        "uses_key_manager": true,
        "providers": ["siliconflow", "openrouter", "deepseek", "custom"],
        "key_names": ["siliconflow_key", "openrouter_key", "deepseek_key", "custom_key"]
    },
    "tags": ["learning", "coaching", "ai", "productivity", "single_file"],
    "links": {
        "source_repo": "",
        "prompt_log": ""
    }
}
</script>

    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">ğŸ§­</div>
                <div class="title-group">
                    <h1>AI å­¦ä¹ æ•™ç»ƒ</h1>
                    <div class="subtitle">é€†å‘å­¦ä¹ å¼•å¯¼ç³»ç»Ÿ Â· Do first, learn later</div>
                </div>
            </div>
            <div class="header-right">
                <span class="pill info" id="statusPill">ç¦»çº¿æ¨¡å¼</span>
                <button class="btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-step active" data-step="0">
                <span class="step-icon">ğŸ‘‹</span>
                <span>ç ´å†°</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="1">
                <span class="step-icon">ğŸ¯</span>
                <span>å®šé”š</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="2">
                <span class="step-icon">ğŸ”</span>
                <span>è¯Šæ–­</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="3">
                <span class="step-icon">ğŸ—ºï¸</span>
                <span>ç¼ºå£</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="4">
                <span class="step-icon">ğŸ†</span>
                <span>é¦–èƒœ</span>
            </div>
            <div class="progress-connector"></div>
            <div class="progress-step" data-step="5">
                <span class="step-icon">ğŸ›¡ï¸</span>
                <span>æ‰˜åº•</span>
            </div>
        </div>

        <!-- Chat Area / Welcome Screen -->
        <div class="chat-area" id="chatArea">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-icon">ğŸ§­</div>
                <h2>å‡†å¤‡å¥½é‡æ–°å­¦ä¹ ã€Œå­¦ä¹ ã€äº†å—ï¼Ÿ</h2>
                <p>
                    å­¦æ ¡æ•™ä½ çš„å­¦ä¹ æ–¹æ³•ï¼Œæ°æ°æ˜¯æˆäººå­¦ä¹ çš„æœ€å¤§é˜»ç¢ã€‚<br>
                    æˆ‘ä¼šç”¨ä¸€ç§å®Œå…¨ä¸åŒçš„æ–¹å¼ï¼Œå¸®ä½ è®¾è®¡ä¸€ä¸ª <strong>3-7 å¤©å°±èƒ½å®Œæˆçš„å°é¡¹ç›®</strong>ï¼Œè®©ä½ è¾¹åšè¾¹å­¦ã€‚
                </p>
                <div class="welcome-features">
                    <div class="welcome-feature">
                        <span class="icon">ğŸ¯</span>
                        <span>ä»çœŸå®é—®é¢˜å‡ºå‘</span>
                    </div>
                    <div class="welcome-feature">
                        <span class="icon">ğŸ”„</span>
                        <span>å€’æ¨æ‰€éœ€çŸ¥è¯†</span>
                    </div>
                    <div class="welcome-feature">
                        <span class="icon">ğŸ†</span>
                        <span>è®¾è®¡é¦–èƒœé¡¹ç›®</span>
                    </div>
                </div>
                <button class="btn primary" id="startBtn">å¼€å§‹å¼•å¯¼ â†’</button>
                <p style="font-size: 11px; margin-top: 16px; color: var(--muted);">
                    æç¤ºï¼šä½¿ç”¨å‰è¯·å…ˆåœ¨ã€Œè®¾ç½®ã€ä¸­é…ç½® AI æœåŠ¡ï¼Œæˆ–å‰å¾€ <a href="key-manager.html" target="_blank">Key Manager</a> ç®¡ç†å¯†é’¥
                </p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area" id="inputArea" style="display: none;">
            <div class="input-wrapper">
                <textarea class="input-field" id="inputField" placeholder="è¾“å…¥ä½ çš„æƒ³æ³•..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn">â¤</button>
            </div>
            <div class="command-hints">
                <span class="command-hint" data-cmd="/restart">ğŸ”„ é‡æ–°å¼€å§‹</span>
                <span class="command-hint" data-cmd="/diagnose">ğŸ” è¯Šæ–­æ¨¡å¼</span>
                <span class="command-hint" data-cmd="/sos">ğŸ†˜ æˆ‘æƒ³æ”¾å¼ƒ</span>
                <span class="command-hint" data-cmd="/plan">ğŸ“‹ æŸ¥çœ‹ä»»åŠ¡</span>
                <span class="command-hint" data-cmd="/done">âœ… ä»»åŠ¡å®Œæˆ</span>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="overlay" id="overlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>âš™ï¸ è®¾ç½®</h2>
            <button class="close-settings" id="closeSettings">Ã—</button>
        </div>
        <div class="settings-body">
            <!-- AI Settings Mount Point -->
            <div id="aiSettingsMount"></div>

            <!-- Coach Style Settings -->
            <div class="settings-section" style="margin-top: 20px;">
                <h3>æ•™ç»ƒé£æ ¼</h3>
                <div class="setting-row">
                    <label>æ²Ÿé€šé£æ ¼</label>
                    <select id="coachStyleSelect">
                        <option value="warm">æ¸©æš–é¼“åŠ±å‹ï¼ˆé»˜è®¤ï¼‰</option>
                        <option value="rational">ç†æ€§åˆ†æå‹</option>
                        <option value="challenge">è½»åº¦æŒ‘æˆ˜å‹</option>
                    </select>
                </div>
            </div>

            <!-- Data Management -->
            <div class="settings-section">
                <h3>æ•°æ®ç®¡ç†</h3>
                <div class="setting-row">
                    <button class="btn secondary" id="exportDataBtn" style="width: 100%;">
                        ğŸ“¥ å¯¼å‡ºå¯¹è¯è®°å½•
                    </button>
                </div>
                <div class="setting-row">
                    <button class="btn" id="clearDataBtn"
                        style="width: 100%; background: rgba(239,68,68,0.1); border-color: var(--bad); color: var(--bad);">
                        ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                    </button>
                </div>
            </div>

            <!-- About -->
            <div class="settings-section">
                <h3>å…³äº</h3>
                <div class="setting-hint">
                    <strong>AI å­¦ä¹ æ•™ç»ƒ v1.0.0</strong><br>
                    åŸºäº Zara Zhangã€Œé€†å‘å­¦ä¹ æ³•ã€æ„å»º<br>
                    æ ¸å¿ƒç†å¿µï¼šDo first, learn later<br><br>
                    <a href="key-manager.html" target="_blank">æ‰“å¼€ Key Manager â†’</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        /******************************
         * AI Module v2 (Chinese UI)
         * - å®Œæ•´å¤åˆ¶æ‚¨æä¾›çš„ AI_MODULE
         * - å·²æ·»åŠ åŸŸåå®‰å…¨è¡¥ä¸
         ******************************/
        const AI_MODULE = (() => {
            const KM_PROVIDER_OVERRIDES_KEY = "km_provider_overrides_v1";

            const AI_PROVIDERS = {
                "siliconflow": {
                    name: "ç¡…åŸºæµåŠ¨ (SiliconFlow)",
                    keyName: "siliconflow_key",
                    baseUrl: "https://api.siliconflow.cn/v1",
                    models: [
                        { id: "Qwen/Qwen3-235B-A22B", name: "Qwen 3 235B" },
                        { id: "Pro/deepseek/deepseek-ai/DeepSeek-V3", name: "DeepSeek V3 (Pro)" },
                        { id: "Qwen/Qwen2.5-72B-Instruct", name: "Qwen 2.5 72B" },
                        { id: "deepseek-ai/DeepSeek-V3", name: "DeepSeek V3" }
                    ]
                },
                "openrouter": {
                    name: "OpenRouter",
                    keyName: "openrouter_key",
                    baseUrl: "https://openrouter.ai/api/v1",
                    models: [
                        { id: "anthropic/claude-sonnet-4", name: "Claude Sonnet 4" },
                        { id: "openai/gpt-4o", name: "GPT-4o" },
                        { id: "google/gemini-2.0-flash-001", name: "Gemini 2.0 Flash" }
                    ]
                },
                "deepseek": {
                    name: "DeepSeek Official",
                    keyName: "deepseek_key",
                    baseUrl: "https://api.deepseek.com",
                    models: [
                        { id: "deepseek-chat", name: "DeepSeek V3" },
                        { id: "deepseek-reasoner", name: "DeepSeek R1" }
                    ]
                },
                "custom": {
                    name: "è‡ªå®šä¹‰ / æœ¬åœ°ï¼ˆOllamaï¼‰",
                    keyName: "custom_key",
                    baseUrl: "http://localhost:11434/v1",
                    models: []
                }
            };

            const providerAdapters = {};

            function safeJsonParse(str) {
                try { return { ok: true, value: JSON.parse(str) }; }
                catch (e) { return { ok: false, error: String(e) }; }
            }

            function getOverrides() {
                const raw = localStorage.getItem(KM_PROVIDER_OVERRIDES_KEY);
                if (!raw) return {};
                const parsed = safeJsonParse(raw);
                if (!parsed.ok || !parsed.value || typeof parsed.value !== "object") return {};
                return parsed.value;
            }

            function normalizeBaseUrl(baseUrl) {
                const s = String(baseUrl || "").trim();
                return s.replace(/\/+$/, "");
            }

            function joinUrl(baseUrl, path) {
                const b = normalizeBaseUrl(baseUrl);
                const p = String(path || "").trim().replace(/^\/+/, "");
                return `${b}/${p}`;
            }

            function getProvider(providerId) {
                return AI_PROVIDERS[providerId];
            }

            function getMergedProviderConfig(providerId) {
                const p = getProvider(providerId);
                if (!p) throw new Error(`æœªçŸ¥ provider_id: ${providerId}`);

                const overrides = getOverrides();
                const o = overrides[providerId] || {};

                const customModels = Array.isArray(o.custom_models) ? o.custom_models : [];
                const mergedModels = [
                    ...(Array.isArray(p.models) ? p.models : []),
                    ...customModels
                        .filter(m => m && typeof m === "object" && m.id)
                        .map(m => ({ id: String(m.id), name: m.name ? String(m.name) : String(m.id), _custom: true }))
                ];

                const baseUrl = o.base_url_override ? String(o.base_url_override) : p.baseUrl;
                const modelId = o.model_id_override ? String(o.model_id_override) : (mergedModels[0]?.id || "");

                return {
                    provider_id: providerId,
                    name: p.name,
                    key_name: p.keyName,
                    base_url_default: p.baseUrl,
                    base_url: baseUrl,
                    models: mergedModels,
                    model_id_default: mergedModels[0]?.id || "",
                    model_id: modelId
                };
            }

            function getKeyStatus(providerId) {
                const p = getProvider(providerId);
                if (!p) return { ok: false, has_key: false, key_name: "" };
                const keyName = p.keyName;
                const key = localStorage.getItem(keyName);
                return { ok: true, has_key: Boolean(key), key_name: keyName };
            }

            function classifyFetchError(err) {
                const msg = String(err?.message || err || "");
                const lower = msg.toLowerCase();
                if (lower.includes("abort")) return { kind: "ç¯å¢ƒé”™è¯¯", msg: "è¯·æ±‚è¶…æ—¶/è¢«å–æ¶ˆï¼ˆAbortï¼‰" };
                if (lower.includes("failed to fetch") || lower.includes("network") || lower.includes("cors")) {
                    return { kind: "ç¯å¢ƒé”™è¯¯", msg: msg };
                }
                return { kind: "å†…éƒ¨é”™è¯¯", msg: msg };
            }

            function actionableErrorMessage(kind, msg) {
                if (kind === "ç”¨æˆ·è¾“å…¥é”™è¯¯") {
                    return `ç”¨æˆ·è¾“å…¥é”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}\n- æ€ä¹ˆä¿®å¤ï¼šæ£€æŸ¥ Base URL / Model ID / è¾“å…¥å†…å®¹æ˜¯å¦ä¸ºç©ºã€‚`;
                }
                if (kind === "ç¯å¢ƒé”™è¯¯") {
                    return `ç¯å¢ƒé”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}\n- æ€ä¹ˆä¿®å¤ï¼šæ£€æŸ¥ç½‘ç»œ/CORS/æ˜¯å¦ https é¡µé¢è®¿é—® httpã€‚`;
                }
                if (kind === "å¹³å°é”™è¯¯") {
                    return `å¹³å°é”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}\n- æ€ä¹ˆä¿®å¤ï¼šæ£€æŸ¥ key æ˜¯å¦æœ‰æ•ˆã€æ˜¯å¦é™æµã€æ¨¡å‹ ID æ˜¯å¦å­˜åœ¨ã€‚`;
                }
                return `å†…éƒ¨é”™è¯¯ï¼š\n- å‘ç”Ÿäº†ä»€ä¹ˆï¼š${msg}`;
            }

            // åŸŸåå®‰å…¨è¡¥ä¸
            function getHostname(url) {
                try { return new URL(String(url || "").trim()).hostname; }
                catch { return ""; }
            }

            function isDomainAllowed(hostname, allowlist) {
                if (!hostname) return false;
                return (allowlist || []).includes(hostname);
            }

            function ensureDomainConsentOrThrow(hostname, consentKey = "ai_domain_consent_v1") {
                const raw = localStorage.getItem(consentKey) || "{}";
                let obj = {};
                try { obj = JSON.parse(raw); } catch { obj = {}; }

                if (obj[hostname] === true) return true;

                const ok = confirm(
                    `ä½ å³å°†æŠŠè¯·æ±‚ï¼ˆåŒ…å«å¯†é’¥ï¼‰å‘é€åˆ°åŸŸåï¼š${hostname}\n\n` +
                    `ç¡®è®¤è¦å…è®¸å—ï¼Ÿ\n` +
                    `å¦‚æœè¿™ä¸ªåŸŸåä¸æ˜¯ä½ ä¿¡ä»»çš„å¹³å°ï¼Œè¯·ç‚¹å–æ¶ˆã€‚`
                );
                if (!ok) throw new Error("ç¯å¢ƒé”™è¯¯: ç”¨æˆ·å–æ¶ˆäº†åŸŸåæˆæƒ");

                obj[hostname] = true;
                localStorage.setItem(consentKey, JSON.stringify(obj));
                return true;
            }

            async function corsProbe(baseUrl, timeoutMs = 8000) {
                const now = new Date().toISOString();
                const url = String(baseUrl || "").trim();
                if (!url) return { ok: false, kind: "ç”¨æˆ·è¾“å…¥é”™è¯¯", result: "ç©º URL", details: { now, url } };

                let u;
                try { u = new URL(url); }
                catch (e) {
                    return { ok: false, kind: "ç”¨æˆ·è¾“å…¥é”™è¯¯", result: "URL æ— æ•ˆ", details: { now, url, error: String(e) } };
                }

                if (location.protocol === "https:" && u.protocol === "http:") {
                    return { ok: false, kind: "ç¯å¢ƒé”™è¯¯", result: "æ··åˆå†…å®¹ï¼ˆhttps é¡µé¢ä¸èƒ½è®¿é—® httpï¼‰", details: { now, url } };
                }
                if (navigator.onLine === false) {
                    return { ok: false, kind: "ç¯å¢ƒé”™è¯¯", result: "ç¦»çº¿", details: { now, url } };
                }

                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const resp = await fetch(url, { method: "GET", mode: "cors", cache: "no-store", signal: controller.signal });
                    return { ok: true, kind: "OK", result: "èƒ½æ‹¿åˆ°å“åº”ï¼ˆCORS å¯èƒ½å¯ç”¨ï¼‰", details: { now, url, status: resp.status, statusText: resp.statusText } };
                } catch (e) {
                    const info = classifyFetchError(e);
                    return { ok: false, kind: info.kind, result: "å¯èƒ½è¢« CORS/ç½‘ç»œæ‹¦æˆª", details: { now, url, error: info.msg } };
                } finally {
                    clearTimeout(timer);
                }
            }

            async function call_llm_unified({
                provider_id,
                base_url,
                api_key,
                model_id,
                messages,
                temperature = 0.7,
                max_tokens = 2000,
                timeout_ms = 60000,
                extra_headers = {},
                extra_body = {}
            }) {
                if (!provider_id) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: provider_id ä¸ºç©º");
                if (!base_url) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: base_url ä¸ºç©º");
                if (!model_id) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: model_id ä¸ºç©º");
                if (!Array.isArray(messages) || messages.length === 0) throw new Error("ç”¨æˆ·è¾“å…¥é”™è¯¯: messages ä¸ºç©º");

                if (!api_key) {
                    const e = new Error("å¹³å°é”™è¯¯: ç¼ºå°‘ API Keyï¼ˆè¯·å…ˆåœ¨ key-manager.html è®¾ç½®ï¼‰");
                    e._kind = "å¹³å°é”™è¯¯";
                    throw e;
                }

                const adapter = providerAdapters[provider_id] || null;

                const url = adapter?.buildUrl
                    ? adapter.buildUrl(base_url)
                    : joinUrl(base_url, "/chat/completions");

                const headers = adapter?.buildHeaders
                    ? adapter.buildHeaders(api_key)
                    : { "Authorization": `Bearer ${api_key}`, "Content-Type": "application/json" };

                const body = adapter?.buildBody
                    ? adapter.buildBody({ model_id, messages, temperature, max_tokens, extra_body })
                    : {
                        model: model_id,
                        messages,
                        temperature,
                        max_tokens,
                        ...extra_body
                    };

                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeout_ms);

                try {
                    const resp = await fetch(url, {
                        method: "POST",
                        mode: "cors",
                        headers: { ...headers, ...extra_headers },
                        body: JSON.stringify(body),
                        signal: controller.signal
                    });

                    const text = await resp.text();
                    let json = null;
                    const parsed = safeJsonParse(text);
                    if (parsed.ok) json = parsed.value;

                    if (!resp.ok) {
                        const e = new Error(`å¹³å°é”™è¯¯: HTTP ${resp.status} ${resp.statusText}\n${text.slice(0, 800)}`);
                        e._kind = "å¹³å°é”™è¯¯";
                        throw e;
                    }

                    const outText = adapter?.parseResponse
                        ? adapter.parseResponse(json)
                        : (json?.choices?.[0]?.message?.content ?? "");

                    if (!outText) {
                        const e = new Error("å¹³å°é”™è¯¯: å“åº”ä¸­æœªæ‰¾åˆ°å¯ç”¨æ–‡æœ¬ï¼ˆchoices[0].message.content ä¸ºç©ºï¼‰");
                        e._kind = "å¹³å°é”™è¯¯";
                        throw e;
                    }

                    return { text: String(outText), raw: json };
                } catch (e) {
                    if (e && e._kind) throw e;
                    const info = classifyFetchError(e);
                    const err = new Error(`${info.kind}: ${info.msg}`);
                    err._kind = info.kind;
                    throw err;
                } finally {
                    clearTimeout(timer);
                }
            }

            function render_ai_settings_html({ container_id = "aiSettingsMount" } = {}) {
                const providerOptions = Object.keys(AI_PROVIDERS)
                    .map(pid => `<option value="${pid}">${AI_PROVIDERS[pid].name}</option>`)
                    .join("");

                return `
            <div class="settings-section">
                <h3>AI æœåŠ¡é…ç½®</h3>

                <div class="setting-toggle">
                    <span>ğŸŒ å…è®¸è”ç½‘</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="aiNetworkingToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-hint" style="margin-bottom: 12px;">
                    é»˜è®¤å…³é—­ã€‚å¼€å¯åæ‰ä¼šå‘é€ AI è¯·æ±‚ã€‚
                </div>

                <div class="setting-row">
                    <span class="pill" id="aiKeyStatusPill">å¯†é’¥çŠ¶æ€ï¼šæœªæ£€æŸ¥</span>
                </div>

                <div class="setting-row">
                    <label>å¹³å°ï¼ˆProviderï¼‰</label>
                    <select id="aiProviderSelect">${providerOptions}</select>
                </div>

                <div class="setting-row">
                    <label>Base URLï¼ˆçœŸå€¼ï¼‰</label>
                    <input id="aiBaseUrlInput" type="text" placeholder="ä¾‹å¦‚ï¼šhttps://api.xxx.com/v1" />
                </div>

                <div class="setting-row">
                    <label>æ¨¡å‹é¢„è®¾</label>
                    <select id="aiModelPresetSelect"></select>
                </div>

                <div class="setting-row">
                    <label>æ¨¡å‹ IDï¼ˆçœŸå€¼ï¼‰</label>
                    <input id="aiModelIdInput" type="text" placeholder="ä¾‹å¦‚ï¼šdeepseek-chat" />
                </div>

                <details style="margin-top: 10px;">
                    <summary style="font-size: 12px; cursor: pointer;">é«˜çº§å‚æ•°</summary>
                    <div style="margin-top: 10px;">
                        <div class="setting-row">
                            <label>temperature</label>
                            <input id="aiTemperature" type="text" value="0.7" />
                        </div>
                        <div class="setting-row">
                            <label>max_tokens</label>
                            <input id="aiMaxTokens" type="text" value="2000" />
                        </div>
                        <div class="setting-row">
                            <label>timeout_ms</label>
                            <input id="aiTimeoutMs" type="text" value="60000" />
                        </div>
                    </div>
                </details>

                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="btn secondary" id="aiSyncBtn" type="button" style="flex: 1;">åŒæ­¥é…ç½®</button>
                    <button class="btn secondary" id="aiCorsProbeBtn" type="button" style="flex: 1;">CORS æ¢æµ‹</button>
                </div>

                <div class="log-box" id="aiLog" style="margin-top: 10px;">AI æ¨¡å—å°±ç»ªã€‚</div>
            </div>
        `;
            }

            function mount_ai_settings({
                mount_el,
                default_provider_id = "siliconflow",
                on_state_change = null
            }) {
                if (!mount_el) throw new Error("mount_el is required");

                mount_el.innerHTML = render_ai_settings_html();

                const aiNetworkingToggle = mount_el.querySelector("#aiNetworkingToggle");
                const aiProviderSelect = mount_el.querySelector("#aiProviderSelect");
                const aiBaseUrlInput = mount_el.querySelector("#aiBaseUrlInput");
                const aiModelPresetSelect = mount_el.querySelector("#aiModelPresetSelect");
                const aiModelIdInput = mount_el.querySelector("#aiModelIdInput");
                const aiKeyStatusPill = mount_el.querySelector("#aiKeyStatusPill");
                const aiTemperature = mount_el.querySelector("#aiTemperature");
                const aiMaxTokens = mount_el.querySelector("#aiMaxTokens");
                const aiTimeoutMs = mount_el.querySelector("#aiTimeoutMs");
                const aiLog = mount_el.querySelector("#aiLog");
                const aiSyncBtn = mount_el.querySelector("#aiSyncBtn");
                const aiCorsProbeBtn = mount_el.querySelector("#aiCorsProbeBtn");

                const state = {
                    networking_enabled: false,
                    provider_id: default_provider_id,
                    base_url: "",
                    model_id: "",
                    temperature: 0.7,
                    max_tokens: 2000,
                    timeout_ms: 60000
                };

                function emit() {
                    on_state_change && on_state_change(get_state());
                }

                function setKeyStatusPill(providerId) {
                    const ks = getKeyStatus(providerId);
                    if (!ks.ok) {
                        aiKeyStatusPill.className = "pill bad";
                        aiKeyStatusPill.textContent = "å¯†é’¥çŠ¶æ€ï¼šæœªçŸ¥";
                        return;
                    }
                    if (ks.has_key) {
                        aiKeyStatusPill.className = "pill good";
                        aiKeyStatusPill.textContent = `å¯†é’¥çŠ¶æ€ï¼šâœ… å·²è®¾ç½®`;
                    } else {
                        aiKeyStatusPill.className = "pill bad";
                        aiKeyStatusPill.textContent = `å¯†é’¥çŠ¶æ€ï¼šâŒ æœªè®¾ç½®`;
                    }
                }

                function rebuildModelPresetOptions(providerId, preferModelId = "") {
                    const cfg = getMergedProviderConfig(providerId);
                    const models = cfg.models || [];
                    const options = [
                        ...models.map(m => `<option value="${String(m.id)}">${String(m.name || m.id)}${m._custom ? "ï¼ˆè‡ªå®šä¹‰ï¼‰" : ""}</option>`),
                        `<option value="_custom_">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹ ID</option>`
                    ].join("");
                    aiModelPresetSelect.innerHTML = options;

                    const effectiveModelId = preferModelId || cfg.model_id || cfg.model_id_default || "";
                    const hasPreset = models.some(m => String(m.id) === String(effectiveModelId));
                    aiModelPresetSelect.value = hasPreset ? String(effectiveModelId) : "_custom_";
                }

                function syncFromKeyManager(providerId) {
                    const cfg = getMergedProviderConfig(providerId);
                    state.base_url = String(cfg.base_url || "");
                    state.model_id = String(cfg.model_id || "");
                    aiBaseUrlInput.value = state.base_url;
                    aiModelIdInput.value = state.model_id;

                    rebuildModelPresetOptions(providerId, state.model_id);
                    setKeyStatusPill(providerId);

                    aiLog.textContent =
                        `å·²åŒæ­¥é…ç½®ï¼š\n` +
                        `provider: ${cfg.name}\n` +
                        `base_url: ${state.base_url}\n` +
                        `model_id: ${state.model_id}`;

                    emit();
                }

                // Initial
                aiProviderSelect.value = default_provider_id;
                syncFromKeyManager(default_provider_id);

                aiNetworkingToggle.addEventListener("change", () => {
                    state.networking_enabled = Boolean(aiNetworkingToggle.checked);
                    aiLog.textContent = state.networking_enabled
                        ? "å·²å…è®¸è”ç½‘ï¼šAI åŠŸèƒ½å·²å¯ç”¨"
                        : "å·²å…³é—­è”ç½‘ï¼šAI åŠŸèƒ½å·²ç¦ç”¨";
                    emit();
                });

                aiProviderSelect.addEventListener("change", () => {
                    state.provider_id = aiProviderSelect.value;
                    syncFromKeyManager(state.provider_id);
                });

                aiBaseUrlInput.addEventListener("change", () => {
                    state.base_url = String(aiBaseUrlInput.value || "").trim();
                    emit();
                });

                aiModelPresetSelect.addEventListener("change", () => {
                    const chosen = aiModelPresetSelect.value;
                    if (chosen === "_custom_") {
                        aiModelIdInput.focus();
                        aiModelIdInput.select();
                        return;
                    }
                    aiModelIdInput.value = chosen;
                    state.model_id = chosen;
                    emit();
                });

                aiModelIdInput.addEventListener("change", () => {
                    state.model_id = String(aiModelIdInput.value || "").trim();
                    emit();
                });

                aiTemperature.addEventListener("change", () => {
                    const v = Number(aiTemperature.value);
                    state.temperature = Number.isFinite(v) ? v : 0.7;
                    emit();
                });

                aiMaxTokens.addEventListener("change", () => {
                    const v = Number(aiMaxTokens.value);
                    state.max_tokens = Number.isFinite(v) ? Math.max(1, Math.floor(v)) : 2000;
                    emit();
                });

                aiTimeoutMs.addEventListener("change", () => {
                    const v = Number(aiTimeoutMs.value);
                    state.timeout_ms = Number.isFinite(v) ? Math.max(1000, Math.floor(v)) : 60000;
                    emit();
                });

                aiSyncBtn.addEventListener("click", () => syncFromKeyManager(state.provider_id));

                aiCorsProbeBtn.addEventListener("click", async () => {
                    const url = String(aiBaseUrlInput.value || "").trim();
                    aiLog.textContent = "CORS æ¢æµ‹ä¸­...";
                    const res = await corsProbe(url, 8000);
                    aiLog.textContent = JSON.stringify(res, null, 2);
                });

                function get_state() {
                    return {
                        ...state,
                        key_status: getKeyStatus(state.provider_id)
                    };
                }

                async function call_ai({ messages }) {
                    const s = get_state();
                    if (!s.networking_enabled) {
                        const e = new Error("ç¯å¢ƒé”™è¯¯: å½“å‰æœªå…è®¸è”ç½‘ï¼ˆè¯·åœ¨è®¾ç½®ä¸­å¼€å¯ï¼‰");
                        e._kind = "ç¯å¢ƒé”™è¯¯";
                        throw e;
                    }

                    // åŸŸåå®‰å…¨æ£€æŸ¥
                    const hostname = getHostname(s.base_url);
                    const allowlist = ["api.siliconflow.cn", "openrouter.ai", "api.deepseek.com", "localhost"];
                    if (!isDomainAllowed(hostname, allowlist)) {
                        ensureDomainConsentOrThrow(hostname);
                    }

                    const p = getProvider(s.provider_id);
                    const apiKey = localStorage.getItem(p.keyName) || "";

                    return await call_llm_unified({
                        provider_id: s.provider_id,
                        base_url: s.base_url,
                        api_key: apiKey,
                        model_id: s.model_id,
                        messages,
                        temperature: s.temperature,
                        max_tokens: s.max_tokens,
                        timeout_ms: s.timeout_ms
                    });
                }

                function get_actionable_error(err) {
                    const kind = err?._kind || "å†…éƒ¨é”™è¯¯";
                    const msg = String(err?.message || err || "");
                    return actionableErrorMessage(kind, msg);
                }

                return {
                    get_state,
                    call_ai,
                    get_actionable_error,
                    sync: () => syncFromKeyManager(state.provider_id)
                };
            }

            return {
                AI_PROVIDERS,
                mount_ai_settings,
                getMergedProviderConfig,
                getKeyStatus,
                corsProbe,
                call_llm_unified,
                actionableErrorMessage
            };
        })();



        /******************************
         * Learning Coach Core Engine
         ******************************/
        const LearningCoach = (() => {
            // Storage keys
            const STORAGE_KEYS = {
                profile: 'lc_user_profile_v1',
                conversation: 'lc_conversation_v1',
                firstWin: 'lc_first_win_v1',
                preferences: 'lc_preferences_v1'
            };

            // State
            let currentStep = 0;
            let conversationHistory = [];
            let userProfile = {};
            let firstWinTask = null;
            let coachStyle = 'warm';
            let aiInstance = null;

            // System Prompts
            const SYSTEM_PROMPTS = {
                base: `ä½ æ˜¯ä¸€ä½ã€Œé€†å‘å­¦ä¹ æ•™ç»ƒã€ï¼ŒåŸºäºã€ŒDo first, learn laterã€çš„ç†å¿µå¸®åŠ©æˆäººå­¦ä¹ è€…ã€‚

ä½ çš„æ ¸å¿ƒä¿¡å¿µï¼š
- å­¦æ ¡æ•™çš„å­¦ä¹ æ–¹æ³•æ˜¯æˆäººå­¦ä¹ çš„æœ€å¤§é˜»ç¢
- æˆäººå­¦ä¹ å¿…é¡»ä»çœŸå®é—®é¢˜å‡ºå‘ï¼Œå€’æ¨æ‰€éœ€çŸ¥è¯†
- äº§å‡ºæ¯”è¾“å…¥é‡è¦ 1000 å€
- å®Œæˆæ¯”å®Œç¾é‡è¦ 1000 å€
- ä½ çš„ä»»åŠ¡æ˜¯å¸®ç”¨æˆ·è®¾è®¡ä¸€ä¸ª 3-7 å¤©èƒ½å®Œæˆçš„ã€Œé¦–èƒœé¡¹ç›®ã€

ä½ çš„æ²Ÿé€šé£æ ¼ï¼š
- åƒä¸€ä¸ªè¿‡æ¥äººæœ‹å‹åœ¨å’–å•¡é¦†èŠå¤©
- æ¸©æš–ä½†ç›´æ¥ï¼Œæœ‰è½»å¾®å›é€†æ„Ÿ
- æ¯æ¬¡å›å¤æ§åˆ¶åœ¨ 3 æ®µä»¥å†…
- æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼ˆä¸è¦åˆ—æ¸…å•å¼æé—®ï¼‰
- å¤§èƒ†æŒ‘æˆ˜ç”¨æˆ·çš„ã€Œå­¦ç”Ÿå¿ƒæ€ã€ï¼Œä½†æ€åº¦æ¸©å’Œ

ç»å¯¹ç¦æ­¢ï¼š
- ç»™å‡ºã€Œç³»ç»Ÿæ€§å­¦ä¹ è®¡åˆ’ã€
- å»ºè®®ã€Œä»åŸºç¡€å¼€å§‹ã€
- æ¨èã€Œå®Œæ•´è¯¾ç¨‹ã€
- ä½¿ç”¨ã€Œå¾ªåºæ¸è¿›ã€ç­‰è¯æ±‡`,

                step0: `å½“å‰é˜¶æ®µï¼šç ´å†°ï¼ˆStep 0ï¼‰

ç›®æ ‡ï¼šå»ºç«‹ä¿¡ä»»ï¼Œæ‰“ç ´ç”¨æˆ·çš„é˜²å¾¡å¿ƒæ€ã€‚

å¼€åœºæ–¹å¼ï¼ˆé€‰æ‹©å…¶ä¸­ä¸€ç§ï¼‰ï¼š
1. å…±æƒ…å¼€åœºï¼š"å­¦ä¸€ä¸ªæ–°ä¸œè¥¿ï¼Œç„¶ååŠé€”è€ŒåºŸâ€”â€”è¿™ç§ç»å†ä½ æœ‰è¿‡å‡ æ¬¡äº†ï¼Ÿåˆ«æ‹…å¿ƒï¼Œè¿™ä¸æ˜¯ä½ çš„é—®é¢˜ã€‚æ˜¯æ–¹æ³•é”™äº†ã€‚"
2. æŒ‘æˆ˜å¼€åœºï¼š"å¦‚æœæˆ‘å‘Šè¯‰ä½ ï¼Œå­¦æ ¡æ•™ä½ çš„å­¦ä¹ æ–¹æ³•ï¼Œæ°æ°æ˜¯ä½ ç°åœ¨å­¦ä¸ä¸‹å»çš„åŸå› â€”â€”ä½ æ„¿æ„å¬å¬ä¸ä¸€æ ·çš„æ€è·¯å—ï¼Ÿ"

ç”¨æˆ·å›åº”åï¼š
- ç§¯æå“åº” â†’ ç»§ç»­å¼•å¯¼ï¼Œè¯¢é—®ä»–ä»¬æƒ³å­¦ä»€ä¹ˆ
- é˜²å¾¡å“åº”ï¼ˆ"åˆæ˜¯é¸¡æ±¤"ï¼‰ â†’ æ‰¿è®¤æ€€ç–‘åˆç†ï¼Œé—®ä¸€ä¸ªé—®é¢˜ï¼š"ä½ ä¸Šä¸€æ¬¡çœŸæ­£'å­¦ä¼š'ä¸€æ ·ä¸œè¥¿æ˜¯æ€ä¹ˆå­¦ä¼šçš„ï¼Ÿ"
- ç®€å•å›å¤ â†’ è¿½åŠ ä¸€ä¸ªè½»é‡é—®é¢˜

å®Œæˆæ¡ä»¶ï¼šç”¨æˆ·è¡¨è¾¾å‡ºæƒ³å­¦ä¹ æŸæ ·ä¸œè¥¿çš„æ„æ„¿`,

                step1: `å½“å‰é˜¶æ®µï¼šå®šé”šçœŸå®é—®é¢˜ï¼ˆStep 1ï¼‰

ç›®æ ‡ï¼šå¸®ç”¨æˆ·å®šä¹‰ä¸€ä¸ªå…·ä½“çš„ã€ŒJobs-to-be-Doneã€ã€‚

ä¸è¦é—®"ä½ æƒ³å­¦ä»€ä¹ˆ"ï¼Œè€Œæ˜¯ï¼š
1. å…ˆé—®ç—›ç‚¹æ—¶åˆ»ï¼š"æœ€è¿‘æœ‰ä»€ä¹ˆäº‹è®©ä½ è§‰å¾—'è¦æ˜¯æˆ‘ä¼š XX å°±å¥½äº†'ï¼Ÿ"
2. å†æ·±æŒ–åœºæ™¯ï¼š"é‚£ä¸ªåœºæ™¯å…·ä½“æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿå½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"
3. æœ€åè¿æ¥ä»·å€¼ï¼š"å¦‚æœè¿™ä¸ªé—®é¢˜è§£å†³äº†ï¼Œå¯¹ä½ æœ€å¤§çš„æ”¹å˜æ˜¯ä»€ä¹ˆï¼Ÿ"

è¾“å‡ºæ ¼å¼ï¼šå½“ç¡®è®¤åï¼Œç”¨ä»¥ä¸‹æ ¼å¼æ€»ç»“ JTBDï¼š
ã€Œå½“æˆ‘å¤„äº [åœºæ™¯] æ—¶ï¼Œæˆ‘æƒ³è¦ [èƒ½åŠ›]ï¼Œè¿™æ ·æˆ‘å°±èƒ½ [ä»·å€¼/æƒ…ç»ªæ”¶ç›Š]ã€

å®Œæˆæ¡ä»¶ï¼šç”¨æˆ·ç¡®è®¤äº† JTBD é™ˆè¿°`,

                step2: `å½“å‰é˜¶æ®µï¼šå¿ƒæ€é™·é˜±è¯Šæ–­ï¼ˆStep 2ï¼‰

ç›®æ ‡ï¼šè¯†åˆ«ç”¨æˆ·æ˜¯å¦é™·å…¥ã€Œå­¦ç”Ÿå¿ƒæ€é™·é˜±ã€ã€‚

é€šè¿‡å¯¹è¯æ¢æµ‹ï¼š
1. "å…³äºå­¦è¿™ä¸ªï¼Œä½ ä¹‹å‰å°è¯•è¿‡ä»€ä¹ˆæ–¹æ³•ï¼Ÿ"
2. "ä½ è§‰å¾—å­¦ä¼šè¿™ä¸ªæŠ€èƒ½ï¼Œå¤§æ¦‚éœ€è¦å¤šä¹…ï¼Ÿ"
3. "å¦‚æœè®©ä½ ç°åœ¨å°±å¼€å§‹ç”¨è¿™ä¸ªæŠ€èƒ½åšç‚¹ä»€ä¹ˆï¼Œå“ªæ€•åšå¾—å¾ˆçƒ‚ï¼Œä½ ä¼šæœ‰ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ"

é™·é˜±æ£€æµ‹ï¼š
- åŸºç¡€æ‰§å¿µï¼šå‡ºç°"å…ˆæ‰“åŸºç¡€"ã€"ä»å¤´å­¦èµ·"
- ç³»ç»Ÿå¹»è§‰ï¼šå‡ºç°"ç³»ç»Ÿè¯¾ç¨‹"ã€"å®Œæ•´ä½“ç³»"
- è¾“å…¥ä¸Šç˜¾ï¼šå‡ºç°"æ”¶è—äº†å¾ˆå¤š"ã€"ä¹°äº†å¾ˆå¤šä¹¦"
- å®Œç¾æ‹–å»¶ï¼šå‡ºç°"å‡†å¤‡å¥½å†å¼€å§‹"
- è·¯å¾„ä¾èµ–ï¼šå‡ºç°"ä»¥å‰å°±è¿™æ ·å­¦"

æ£€æµ‹åˆ°é™·é˜±åï¼š
- æ¸©å’ŒæŒ‡å‡ºï¼Œä¸æ‰¹è¯„
- è¯æœ¯ï¼š"æˆ‘ç†è§£è¿™ç§æƒ³æ³•ï¼Œä½†è®©æˆ‘åˆ†äº«ä¸€ä¸ªä¸åŒçš„è§†è§’..."
- ç»™å‡ºå¤„æ–¹

å®Œæˆæ¡ä»¶ï¼šå®Œæˆè¯Šæ–­å¹¶ç»™å‡ºå¤„æ–¹`,

                step3: `å½“å‰é˜¶æ®µï¼šçŸ¥è¯†ç¼ºå£å€’æ¨ï¼ˆStep 3ï¼‰

ç›®æ ‡ï¼šä» JTBD é€†å‘æ¨å¯¼æœ€å°çŸ¥è¯†é›†ã€‚

æµç¨‹ï¼š
1. èƒ½åŠ›æ‹†è§£ï¼š"è¦åšåˆ° [JTBD]ï¼Œä½ éœ€è¦å“ªäº›å…·ä½“èƒ½åŠ›ï¼Ÿ"
2. ç°çŠ¶è¯„ä¼°ï¼š"è¿™äº›èƒ½åŠ›é‡Œï¼Œä½ ç°åœ¨å“ªäº›å·²ç»æœ‰äº†ï¼Ÿ"
3. ä¼˜å…ˆçº§æ’åºï¼šç”¨ã€Œé«˜æ”¶ç›Š+ä½é—¨æ§›=é¦–æ”»ã€çš„çŸ©é˜µ

è¾“å‡ºï¼šç²¾ç®€çš„ç¼ºå£æ¸…å•ï¼ˆæœ€å¤š 2 é¡¹ï¼‰
- æ ‡æ³¨ã€Œå¿…é¡»å­¦ã€vsã€Œå¯ä»¥è·³è¿‡ã€
- æ˜ç¡®æŒ‡å‡ºã€Œæš‚æ—¶ä¸ç”¨å­¦ã€çš„å†…å®¹

ç»å¯¹ç¦æ­¢è¾“å‡ºã€Œå®Œæ•´çŸ¥è¯†ä½“ç³»ã€

å®Œæˆæ¡ä»¶ï¼šç”¨æˆ·ç¡®è®¤äº†ç¼ºå£æ¸…å•`,

                step4: `å½“å‰é˜¶æ®µï¼šé¦–èƒœè®¾è®¡ï¼ˆStep 4ï¼‰

ç›®æ ‡ï¼šè®¾è®¡ä¸€ä¸ª 3-7 å¤©èƒ½å®Œæˆçš„å°äº§å‡ºã€‚

é¦–èƒœåŸåˆ™ï¼š
1. å°åˆ°ä¸å¯èƒ½å¤±è´¥
2. å¿…é¡»æœ‰å¯è§äº§å‡ºï¼ˆä¸æ˜¯"æ„Ÿè§‰å­¦åˆ°äº†"ï¼‰
3. å¿…é¡»æœ‰è§‚ä¼—ï¼ˆå“ªæ€•åªæ˜¯ AIï¼‰
4. å¿…é¡»å€’é€¼å­¦ä¹ 
5. å¿…é¡»æœ‰å‘å¸ƒæ—¶åˆ»

æµç¨‹ï¼š
1. æä¾› 3-4 ä¸ªé¦–èƒœé¡¹ç›®é€‰é¡¹
2. è®©ç”¨æˆ·é€‰æ‹©æœ€å¿ƒåŠ¨çš„
3. è¯¢é—®å®ŒæˆæŠŠæ¡ï¼ˆ1-10 åˆ†ï¼‰ï¼Œ< 6 åˆ†åˆ™ç¼©å°èŒƒå›´
4. è¯¢é—®å‘å¸ƒæ¸ é“
5. æ‹†è§£ä¸º 3-5 ä¸ªæ‰§è¡Œæ­¥éª¤

è¾“å‡ºæ ¼å¼ï¼ˆå½“ç¡®å®šé¡¹ç›®åï¼‰ï¼š
ã€Œ
ğŸ¯ ä½ çš„é¦–èƒœä»»åŠ¡
é¡¹ç›®ï¼š[ä»»åŠ¡åç§°]
æˆªæ­¢ï¼š[å…·ä½“æ—¥æœŸ]
å‘å¸ƒï¼š[å‘å¸ƒæ¸ é“]

æ­¥éª¤æ‹†è§£ï¼š
â–¡ Day 1: [æ­¥éª¤1]
â–¡ Day 2: [æ­¥éª¤2]
â–¡ Day 3: [æ­¥éª¤3]
â–¡ Day 4: [æ­¥éª¤4]
ã€

å®Œæˆæ¡ä»¶ï¼šç”Ÿæˆäº†é¦–èƒœä»»åŠ¡å¡`,

                step5: `å½“å‰é˜¶æ®µï¼šæ‰˜åº•æœºåˆ¶æ¿€æ´»ï¼ˆStep 5ï¼‰

ç›®æ ‡ï¼šæ¿€æ´»æ‰˜åº•æœºåˆ¶ï¼Œé¢„é˜²ç”¨æˆ·æ”¾å¼ƒã€‚

å†…å®¹ï¼š
1. å‘Šè¯‰ç”¨æˆ·ä½ ä¼š"é™ªä¼´"ä»–ä»¬
2. ä»‹ç»å¯ç”¨å‘½ä»¤ï¼š/sosï¼ˆæˆ‘æƒ³æ”¾å¼ƒï¼‰ã€/stuckï¼ˆæˆ‘å¡ä½äº†ï¼‰ã€/doneï¼ˆæˆ‘å®Œæˆäº†ï¼‰
3. è¯¢é—®æ˜¯å¦éœ€è¦æ¯æ—¥æé†’
4. ç»“æŸè¯­ï¼š"åšè¿™ä¸ªé¡¹ç›®æ—¶ï¼Œé‡åˆ°ä¸æ‡‚çš„å°±æ¥é—®æˆ‘ã€‚è®°ä½ï¼šå®Œæˆæ¯”å®Œç¾é‡è¦ 1000 å€ã€‚"

å®Œæˆæ¡ä»¶ï¼šç”¨æˆ·ç¡®è®¤ç†è§£æ‰˜åº•æœºåˆ¶`,

                sos: `ç”¨æˆ·è§¦å‘äº† SOS æ¨¡å¼ï¼ˆæƒ³æ”¾å¼ƒï¼‰

ä½ çš„å“åº”åŸåˆ™ï¼š
1. ä¸è¯„åˆ¤ã€ä¸è¯´æ•™ã€ä¸å‚¬ä¿ƒ
2. å…ˆå¤„ç†æƒ…ç»ªï¼š"è°¢è°¢ä½ å‘Šè¯‰æˆ‘ï¼Œè€Œä¸æ˜¯é»˜é»˜æ¶ˆå¤±ã€‚è¿™å¾ˆé‡è¦ã€‚"
3. è¯Šæ–­é˜»å¡ç±»å‹ï¼š"èƒ½å‘Šè¯‰æˆ‘ï¼Œæ˜¯å¡åœ¨å“ªä¸€æ­¥äº†å—ï¼Ÿæ˜¯'ä¸çŸ¥é“æ€ä¹ˆåš'ï¼Œè¿˜æ˜¯'çŸ¥é“ä½†ä¸æƒ³åš'ï¼Ÿ"
4. æä¾›å¯¹åº”æ”¯æŒ

å¡ç‚¹æ€¥æ•‘ï¼š
- "ä¸çŸ¥é“æ€ä¹ˆå¼€å§‹" â†’ ç»™ä¸€ä¸ªæ›´å°çš„ç¬¬ä¸€æ­¥
- "åšäº†ä¸€åŠä¸æƒ³åšäº†" â†’ æƒ…ç»ªæ”¯æŒ + å®Œæˆåº¦åº†ç¥
- "æ„Ÿè§‰åšå¾—å¾ˆçƒ‚" â†’ é‡æ–°æ¡†æ¶ï¼ˆ"çƒ‚ä¹Ÿæ˜¯å®Œæˆ"ï¼‰
- "æ²¡æ—¶é—´" â†’ æ—¶é—´å®¡è®¡ + ä¼˜å…ˆçº§åå•†

çµæ´»ç¼©æ°´ï¼š"å¦‚æœå®åœ¨å®Œä¸æˆ 100%ï¼Œå®Œæˆ 30% ä¹Ÿæ˜¯èƒœåˆ©ã€‚æˆ‘ä»¬æ¥èŠèŠå¯ä»¥ç æ‰ä»€ä¹ˆã€‚"`,

                done: `ç”¨æˆ·æŠ¥å‘Šä»»åŠ¡å®Œæˆ

ä½ çš„å“åº”ï¼š
1. çœŸè¯šåº†ç¥ï¼š"ğŸ‰ ä½ åšåˆ°äº†ï¼"
2. è¯·ç”¨æˆ·å±•ç¤ºä½œå“
3. æ‰¾å‡º 3 ä¸ªäº®ç‚¹çœŸè¯šå¤¸å¥–
4. å¼•å¯¼åæ€ï¼š"åšè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ"
5. æ’­ç§ä¸‹ä¸€é¢—ç§å­ï¼š"ä¸‹ä¸€ä¸ªé¦–èƒœæƒ³æŒ‘æˆ˜ä»€ä¹ˆï¼Ÿ"`
            };

            // Coach style variants
            const STYLE_MODIFIERS = {
                warm: 'ä½¿ç”¨æ¸©æš–é¼“åŠ±çš„è¯­æ°”ï¼Œå¤šç”¨"æˆ‘ç†è§£"ã€"å¾ˆæ£’"ã€"ä½ å·²ç»å¾ˆå‰å®³äº†"ç­‰è¡¨è¾¾ã€‚',
                rational: 'ä½¿ç”¨ç†æ€§åˆ†æçš„è¯­æ°”ï¼Œå¤šç”¨æ•°æ®ã€é€»è¾‘ã€æ¡†æ¶æ¥è¯´æœï¼Œå°‘ç”¨æƒ…æ„Ÿè¯æ±‡ã€‚',
                challenge: 'ä½¿ç”¨è½»åº¦æŒ‘æˆ˜çš„è¯­æ°”ï¼Œæ•¢äºè´¨ç–‘ç”¨æˆ·çš„å‡è®¾ï¼Œç”¨é—®é¢˜å¼•å¯¼æ€è€ƒã€‚'
            };

            // Initialize
            function init(aiModuleInstance) {
                aiInstance = aiModuleInstance;
                loadState();
                return {
                    getState,
                    processUserInput,
                    handleCommand,
                    setCoachStyle,
                    reset,
                    getCurrentStep: () => currentStep,
                    getConversationHistory: () => conversationHistory,
                    getFirstWinTask: () => firstWinTask,
                    saveState
                };
            }

            function loadState() {
                try {
                    const profile = localStorage.getItem(STORAGE_KEYS.profile);
                    const conversation = localStorage.getItem(STORAGE_KEYS.conversation);
                    const firstWin = localStorage.getItem(STORAGE_KEYS.firstWin);
                    const prefs = localStorage.getItem(STORAGE_KEYS.preferences);

                    if (profile) userProfile = JSON.parse(profile);
                    if (conversation) {
                        const data = JSON.parse(conversation);
                        conversationHistory = data.history || [];
                        currentStep = data.currentStep || 0;
                    }
                    if (firstWin) firstWinTask = JSON.parse(firstWin);
                    if (prefs) {
                        const prefsData = JSON.parse(prefs);
                        coachStyle = prefsData.coachStyle || 'warm';
                    }
                } catch (e) {
                    console.error('Failed to load state:', e);
                }
            }

            function saveState() {
                try {
                    localStorage.setItem(STORAGE_KEYS.profile, JSON.stringify(userProfile));
                    localStorage.setItem(STORAGE_KEYS.conversation, JSON.stringify({
                        history: conversationHistory,
                        currentStep: currentStep
                    }));
                    if (firstWinTask) {
                        localStorage.setItem(STORAGE_KEYS.firstWin, JSON.stringify(firstWinTask));
                    }
                    localStorage.setItem(STORAGE_KEYS.preferences, JSON.stringify({
                        coachStyle
                    }));
                } catch (e) {
                    console.error('Failed to save state:', e);
                }
            }

            function getState() {
                return {
                    currentStep,
                    conversationHistory,
                    userProfile,
                    firstWinTask,
                    coachStyle
                };
            }

            function setCoachStyle(style) {
                if (STYLE_MODIFIERS[style]) {
                    coachStyle = style;
                    saveState();
                }
            }

            function buildSystemPrompt(mode = 'normal') {
                let prompt = SYSTEM_PROMPTS.base + '\n\n';
                prompt += STYLE_MODIFIERS[coachStyle] + '\n\n';

                if (mode === 'sos') {
                    prompt += SYSTEM_PROMPTS.sos;
                } else if (mode === 'done') {
                    prompt += SYSTEM_PROMPTS.done;
                } else {
                    const stepKey = `step${currentStep}`;
                    if (SYSTEM_PROMPTS[stepKey]) {
                        prompt += SYSTEM_PROMPTS[stepKey];
                    }
                }

                // Add context
                if (userProfile.jtbd) {
                    prompt += `\n\nç”¨æˆ·çš„ JTBDï¼š${userProfile.jtbd}`;
                }
                if (userProfile.traps && userProfile.traps.length > 0) {
                    prompt += `\n\nç”¨æˆ·çš„å¿ƒæ€é™·é˜±ï¼š${userProfile.traps.join('ã€')}`;
                }
                if (firstWinTask) {
                    prompt += `\n\nå½“å‰é¦–èƒœä»»åŠ¡ï¼š${firstWinTask.task}`;
                }

                return prompt;
            }

            function buildMessages(userInput, mode = 'normal') {
                const systemPrompt = buildSystemPrompt(mode);
                const messages = [{ role: 'system', content: systemPrompt }];

                // Add recent conversation history (last 10 exchanges)
                const recentHistory = conversationHistory.slice(-20);
                for (const msg of recentHistory) {
                    messages.push({
                        role: msg.role === 'coach' ? 'assistant' : 'user',
                        content: msg.content
                    });
                }

                // Add current user input
                messages.push({ role: 'user', content: userInput });

                return messages;
            }

            async function processUserInput(userInput) {
                // Add user message to history
                conversationHistory.push({
                    role: 'user',
                    content: userInput,
                    timestamp: Date.now()
                });

                // Check for step progression keywords
                checkStepProgression(userInput);

                try {
                    const messages = buildMessages(userInput);
                    const response = await aiInstance.call_ai({ messages });

                    // Add coach response to history
                    conversationHistory.push({
                        role: 'coach',
                        content: response.text,
                        timestamp: Date.now()
                    });

                    // Extract structured data from response
                    extractStructuredData(response.text);

                    saveState();

                    return {
                        success: true,
                        text: response.text,
                        currentStep
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: aiInstance.get_actionable_error(error),
                        currentStep
                    };
                }
            }

            function handleCommand(command) {
                const cmd = command.toLowerCase().trim();

                switch (cmd) {
                    case '/restart':
                        reset();
                        return { action: 'restart', message: 'å·²é‡æ–°å¼€å§‹ã€‚è®©æˆ‘ä»¬é‡æ–°è®¤è¯†ä¸€ä¸‹ï¼Ÿ' };

                    case '/diagnose':
                        currentStep = 2;
                        saveState();
                        return { action: 'diagnose', message: 'è¿›å…¥è¯Šæ–­æ¨¡å¼ã€‚è®©æˆ‘æ¥å¸®ä½ åˆ†æä¸€ä¸‹...' };

                    case '/sos':
                        return { action: 'sos', mode: 'sos', message: null };

                    case '/plan':
                        if (firstWinTask) {
                            return { action: 'plan', task: firstWinTask };
                        }
                        return { action: 'plan', message: 'ä½ è¿˜æ²¡æœ‰é¦–èƒœä»»åŠ¡ã€‚ç»§ç»­å¯¹è¯æ¥è®¾è®¡ä¸€ä¸ªå§ï¼' };

                    case '/done':
                        return { action: 'done', mode: 'done', message: null };

                    case '/stuck':
                        return { action: 'stuck', mode: 'sos', message: null };

                    default:
                        return { action: 'unknown', message: 'æœªçŸ¥å‘½ä»¤ã€‚å¯ç”¨å‘½ä»¤ï¼š/restart, /diagnose, /sos, /plan, /done, /stuck' };
                }
            }

            function checkStepProgression(userInput) {
                const input = userInput.toLowerCase();

                // Step 0 â†’ 1: User expresses learning intent
                if (currentStep === 0 && (
                    input.includes('æƒ³å­¦') ||
                    input.includes('å­¦ä¹ ') ||
                    input.includes('å¼€å§‹') ||
                    input.includes('å¥½çš„') ||
                    input.includes('æ„¿æ„')
                )) {
                    currentStep = 1;
                }

                // Other progressions handled by AI response analysis
            }

            function extractStructuredData(response) {
                // Extract JTBD
                const jtbdMatch = response.match(/ã€Œå½“æˆ‘å¤„äº(.+?)æ—¶ï¼Œæˆ‘æƒ³è¦(.+?)ï¼Œè¿™æ ·æˆ‘å°±èƒ½(.+?)ã€/);
                if (jtbdMatch) {
                    userProfile.jtbd = jtbdMatch[0];
                    if (currentStep < 2) currentStep = 2;
                }

                // Extract First Win Task
                const taskMatch = response.match(/ğŸ¯\s*ä½ çš„é¦–èƒœä»»åŠ¡[\s\S]*?é¡¹ç›®[ï¼š:]\s*(.+?)[\n\r]/);
                if (taskMatch) {
                    const deadlineMatch = response.match(/æˆªæ­¢[ï¼š:]\s*(.+?)[\n\r]/);
                    const stepsMatch = response.match(/â–¡\s*Day\s*\d+[ï¼š:]\s*(.+?)[\n\r]/g);

                    firstWinTask = {
                        task: taskMatch[1].trim(),
                        deadline: deadlineMatch ? deadlineMatch[1].trim() : '7å¤©å†…',
                        steps: stepsMatch ? stepsMatch.map(s => s.replace(/â–¡\s*Day\s*\d+[ï¼š:]\s*/, '').trim()) : [],
                        progress: 0,
                        createdAt: Date.now()
                    };

                    if (currentStep < 5) currentStep = 5;
                }

                // Detect trap mentions
                const trapKeywords = {
                    'åŸºç¡€æ‰§å¿µ': ['å…ˆæ‰“åŸºç¡€', 'ä»å¤´å­¦', 'åŸºç¡€ä¸ç‰¢'],
                    'ç³»ç»Ÿå¹»è§‰': ['ç³»ç»Ÿå­¦ä¹ ', 'å®Œæ•´è¯¾ç¨‹', 'ä½“ç³»'],
                    'è¾“å…¥ä¸Šç˜¾': ['æ”¶è—', 'ä¹°äº†å¾ˆå¤š', 'èµ„æ–™'],
                    'å®Œç¾æ‹–å»¶': ['å‡†å¤‡å¥½', 'ç­‰æˆ‘', 'è¿˜æ²¡å‡†å¤‡'],
                    'è·¯å¾„ä¾èµ–': ['ä»¥å‰å°±', 'ä¸€ç›´è¿™æ ·']
                };

                for (const [trap, keywords] of Object.entries(trapKeywords)) {
                    if (keywords.some(kw => response.includes(kw))) {
                        if (!userProfile.traps) userProfile.traps = [];
                        if (!userProfile.traps.includes(trap)) {
                            userProfile.traps.push(trap);
                        }
                    }
                }
            }

            async function getInitialMessage() {
                if (conversationHistory.length > 0) {
                    // Return last coach message for resuming
                    const lastCoach = [...conversationHistory].reverse().find(m => m.role === 'coach');
                    return lastCoach ? lastCoach.content : null;
                }

                // Generate initial message
                try {
                    const messages = buildMessages('ï¼ˆç”¨æˆ·åˆšè¿›å…¥ï¼Œè¯·ç»™å‡ºå¼€åœºç™½ï¼‰');
                    const response = await aiInstance.call_ai({ messages });

                    conversationHistory.push({
                        role: 'coach',
                        content: response.text,
                        timestamp: Date.now()
                    });

                    saveState();
                    return response.text;
                } catch (error) {
                    // Fallback message
                    return `å­¦ä¸€ä¸ªæ–°ä¸œè¥¿ï¼Œç„¶ååŠé€”è€ŒåºŸâ€”â€”è¿™ç§ç»å†ä½ æœ‰è¿‡å‡ æ¬¡äº†ï¼Ÿ

åˆ«æ‹…å¿ƒï¼Œè¿™ä¸æ˜¯ä½ çš„é—®é¢˜ã€‚æ˜¯æ–¹æ³•é”™äº†ã€‚

å­¦æ ¡æ•™ä½ çš„é‚£å¥—ã€Œå…ˆæ‰“åŸºç¡€ã€ç³»ç»Ÿå­¦ä¹ ã€çš„æ–¹æ³•ï¼Œåœ¨æˆäººä¸–ç•Œé‡Œå‡ ä¹æ³¨å®šå¤±è´¥ã€‚å› ä¸ºæ²¡äººé€¼ä½ ï¼Œä½ ä¹Ÿæ²¡é‚£ä¹ˆå¤šæ—¶é—´ã€‚

æˆ‘æƒ³ç”¨ä¸€ç§å®Œå…¨ä¸åŒçš„æ–¹å¼å¸®ä½ ã€‚ä½ æœ€è¿‘æœ‰ä»€ä¹ˆæƒ³å­¦çš„å—ï¼Ÿ`;
                }
            }

            function reset() {
                currentStep = 0;
                conversationHistory = [];
                userProfile = {};
                firstWinTask = null;

                localStorage.removeItem(STORAGE_KEYS.profile);
                localStorage.removeItem(STORAGE_KEYS.conversation);
                localStorage.removeItem(STORAGE_KEYS.firstWin);
            }

            return { init, getInitialMessage };
        })();



        /******************************
         * UI Controller
         ******************************/
        const UI = (() => {
            let coach = null;
            let aiModule = null;

            // DOM Elements
            const elements = {};

            function init() {
                cacheElements();
                initAIModule();
                initCoach();
                bindEvents();
                applyTheme();
            }

            function cacheElements() {
                elements.chatArea = document.getElementById('chatArea');
                elements.welcomeScreen = document.getElementById('welcomeScreen');
                elements.inputArea = document.getElementById('inputArea');
                elements.inputField = document.getElementById('inputField');
                elements.sendBtn = document.getElementById('sendBtn');
                elements.startBtn = document.getElementById('startBtn');
                elements.settingsBtn = document.getElementById('settingsBtn');
                elements.settingsPanel = document.getElementById('settingsPanel');
                elements.closeSettings = document.getElementById('closeSettings');
                elements.overlay = document.getElementById('overlay');
                elements.progressBar = document.getElementById('progressBar');
                elements.statusPill = document.getElementById('statusPill');
                elements.aiSettingsMount = document.getElementById('aiSettingsMount');
                elements.coachStyleSelect = document.getElementById('coachStyleSelect');
                elements.exportDataBtn = document.getElementById('exportDataBtn');
                elements.clearDataBtn = document.getElementById('clearDataBtn');
            }

            function initAIModule() {
                aiModule = AI_MODULE.mount_ai_settings({
                    mount_el: elements.aiSettingsMount,
                    default_provider_id: 'siliconflow',
                    on_state_change: (state) => {
                        updateStatusPill(state);
                    }
                });
                updateStatusPill(aiModule.get_state());
            }

            function initCoach() {
                coach = LearningCoach.init(aiModule);

                // Check for existing conversation
                const history = coach.getConversationHistory();
                if (history.length > 0) {
                    showChatMode();
                    restoreConversation(history);
                    updateProgress(coach.getCurrentStep());
                }
            }

            function bindEvents() {
                // Start button
                elements.startBtn.addEventListener('click', startConversation);

                // Send message
                elements.sendBtn.addEventListener('click', sendMessage);
                elements.inputField.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                // Auto-resize textarea
                elements.inputField.addEventListener('input', () => {
                    elements.inputField.style.height = 'auto';
                    elements.inputField.style.height = Math.min(elements.inputField.scrollHeight, 150) + 'px';
                });

                // Settings panel
                elements.settingsBtn.addEventListener('click', openSettings);
                elements.closeSettings.addEventListener('click', closeSettings);
                elements.overlay.addEventListener('click', closeSettings);

                // Coach style
                elements.coachStyleSelect.addEventListener('change', () => {
                    if (coach) coach.setCoachStyle(elements.coachStyleSelect.value);
                });

                // Command hints
                document.querySelectorAll('.command-hint').forEach(hint => {
                    hint.addEventListener('click', () => {
                        const cmd = hint.dataset.cmd;
                        elements.inputField.value = cmd;
                        sendMessage();
                    });
                });

                // Export/Clear data
                elements.exportDataBtn.addEventListener('click', exportData);
                elements.clearDataBtn.addEventListener('click', clearData);
            }

            function updateStatusPill(state) {
                if (state.networking_enabled && state.key_status.has_key) {
                    elements.statusPill.className = 'pill good';
                    elements.statusPill.textContent = 'ğŸŸ¢ AI å·²è¿æ¥';
                } else if (state.networking_enabled) {
                    elements.statusPill.className = 'pill warn';
                    elements.statusPill.textContent = 'âš ï¸ ç¼ºå°‘å¯†é’¥';
                } else {
                    elements.statusPill.className = 'pill info';
                    elements.statusPill.textContent = 'ç¦»çº¿æ¨¡å¼';
                }
            }

            async function startConversation() {
                showChatMode();

                // Show typing indicator
                showTyping();

                try {
                    const initialMessage = await LearningCoach.getInitialMessage();
                    hideTyping();
                    addMessage('coach', initialMessage);
                    updateProgress(0);
                } catch (e) {
                    hideTyping();
                    addMessage('coach', `å‡ºé”™äº†ï¼š${e.message}\n\nè¯·æ£€æŸ¥ AI è®¾ç½®æ˜¯å¦æ­£ç¡®é…ç½®ã€‚`);
                }
            }

            function showChatMode() {
                elements.welcomeScreen.style.display = 'none';
                elements.inputArea.style.display = 'block';
                elements.inputField.focus();
            }

            function restoreConversation(history) {
                // Clear chat area except welcome screen
                elements.chatArea.innerHTML = '';

                for (const msg of history) {
                    addMessage(msg.role, msg.content, false);
                }

                scrollToBottom();
            }

            async function sendMessage() {
                const input = elements.inputField.value.trim();
                if (!input) return;

                elements.inputField.value = '';
                elements.inputField.style.height = 'auto';

                // Check for commands
                if (input.startsWith('/')) {
                    const result = coach.handleCommand(input);
                    handleCommandResult(result, input);
                    return;
                }

                // Add user message
                addMessage('user', input);

                // Show typing
                showTyping();

                // Process with AI
                const result = await coach.processUserInput(input);

                hideTyping();

                if (result.success) {
                    addMessage('coach', result.text);
                    updateProgress(result.currentStep);
                } else {
                    addMessage('coach', `æŠ±æ­‰ï¼Œå‡ºäº†ç‚¹é—®é¢˜ï¼š\n\n${result.error}\n\nä½ å¯ä»¥é‡è¯•ï¼Œæˆ–è€…æ£€æŸ¥ä¸€ä¸‹è®¾ç½®ã€‚`);
                }
            }

            async function handleCommandResult(result, originalInput) {
                switch (result.action) {
                    case 'restart':
                        elements.chatArea.innerHTML = '';
                        startConversation();
                        break;

                    case 'plan':
                        if (result.task) {
                            addMessage('coach', renderFirstWinCard(result.task));
                        } else {
                            addMessage('coach', result.message);
                        }
                        break;

                    case 'sos':
                    case 'done':
                    case 'stuck':
                        addMessage('user', originalInput);
                        showTyping();
                        const response = await coach.processUserInput(originalInput);
                        hideTyping();
                        if (response.success) {
                            addMessage('coach', response.text);
                        } else {
                            addMessage('coach', response.error);
                        }
                        break;

                    default:
                        addMessage('coach', result.message);
                }
            }

            function addMessage(role, content, animate = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                if (!animate) messageDiv.style.animation = 'none';

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = role === 'coach' ? 'ğŸ§­' : 'ğŸ‘¤';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = formatMessage(content);

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);

                elements.chatArea.appendChild(messageDiv);
                scrollToBottom();
            }

            function formatMessage(text) {
                // Basic markdown-like formatting
                return text
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.+?)\*/g, '<em>$1</em>')
                    .replace(/`(.+?)`/g, '<code>$1</code>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
            }

            function renderFirstWinCard(task) {
                const stepsHtml = task.steps.map((step, i) => `
            <li>
                <div class="step-checkbox ${i < task.progress ? 'completed' : ''}" data-step="${i}">
                    ${i < task.progress ? 'âœ“' : ''}
                </div>
                <span>${step}</span>
            </li>
        `).join('');

                return `
            <div class="first-win-card">
                <h4>ğŸ¯ ä½ çš„é¦–èƒœä»»åŠ¡</h4>
                <div class="first-win-task">${task.task}</div>
                <div class="first-win-deadline">â° æˆªæ­¢ï¼š${task.deadline}</div>
                <ul class="first-win-steps">
                    ${stepsHtml}
                </ul>
            </div>
            <p style="margin-top: 12px;">è¿™æ˜¯ä½ çš„é¦–èƒœä»»åŠ¡å¡ï¼è®°ä½ï¼šå®Œæˆæ¯”å®Œç¾é‡è¦ 1000 å€ã€‚é‡åˆ°é—®é¢˜éšæ—¶è¾“å…¥ <code>/stuck</code> å‘Šè¯‰æˆ‘ã€‚</p>
        `;
            }

            function showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message coach';
                typingDiv.id = 'typingIndicator';

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'ğŸ§­';

                const indicator = document.createElement('div');
                indicator.className = 'typing-indicator';
                indicator.innerHTML = `
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        `;

                typingDiv.appendChild(avatar);
                typingDiv.appendChild(indicator);
                elements.chatArea.appendChild(typingDiv);
                scrollToBottom();
            }

            function hideTyping() {
                const typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
            }

            function scrollToBottom() {
                elements.chatArea.scrollTop = elements.chatArea.scrollHeight;
            }

            function updateProgress(step) {
                const steps = elements.progressBar.querySelectorAll('.progress-step');
                const connectors = elements.progressBar.querySelectorAll('.progress-connector');

                steps.forEach((stepEl, i) => {
                    stepEl.classList.remove('active', 'completed');
                    if (i < step) {
                        stepEl.classList.add('completed');
                    } else if (i === step) {
                        stepEl.classList.add('active');
                    }
                });

                connectors.forEach((conn, i) => {
                    conn.classList.remove('completed');
                    if (i < step) {
                        conn.classList.add('completed');
                    }
                });
            }

            function openSettings() {
                elements.settingsPanel.classList.add('open');
                elements.overlay.classList.add('visible');
            }

            function closeSettings() {
                elements.settingsPanel.classList.remove('open');
                elements.overlay.classList.remove('visible');
            }

            function applyTheme() {
                const savedTheme = localStorage.getItem('lc_theme');
                if (savedTheme) {
                    document.documentElement.dataset.theme = savedTheme;
                }
            }

            function exportData() {
                const data = {
                    exported_at: new Date().toISOString(),
                    version: '1.0.0',
                    conversation: coach.getConversationHistory(),
                    profile: coach.getState().userProfile,
                    firstWin: coach.getFirstWinTask()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `learning-coach-export-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            function clearData() {
                if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤ä½ çš„å¯¹è¯è®°å½•å’Œé¦–èƒœä»»åŠ¡ã€‚')) {
                    coach.reset();
                    elements.chatArea.innerHTML = '';
                    elements.welcomeScreen.style.display = 'flex';
                    elements.inputArea.style.display = 'none';
                    updateProgress(0);
                    closeSettings();
                }
            }

            return { init };
        })();



        /******************************
         * Initialize App
         ******************************/
        document.addEventListener('DOMContentLoaded', () => {
            UI.init();
        });
    </script>

</body>

</html>