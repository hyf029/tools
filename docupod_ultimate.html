<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’­å®¢ç”Ÿæˆå™¨ (å…¨èƒ½ç½‘é¡µç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>

    <style>
        :root {
            --bg: #f6f7fb;
            --bg2: #fff;
            --text: #0f172a;
            --accent: #2563eb;
            --border: rgba(15, 23, 42, 0.1);
            --panel: rgba(255, 255, 255, 0.9);
            --good: #059669;
            --bad: #e11d48;
        }

        body {
            margin: 0;
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 100px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        h1,
        h2,
        h3 {
            margin-top: 0;
            font-weight: 800;
        }

        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid var(--border);
        }

        .btn.magic {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            border: none;
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .field {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 600;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #f8fafc;
            font-family: inherit;
            box-sizing: border-box;
        }

        .file-drop {
            border: 2px dashed var(--accent);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: rgba(37, 99, 235, 0.04);
            cursor: pointer;
            transition: 0.2s;
        }

        .file-drop:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        .chat-box {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .msg-content {
            flex: 1;
        }

        .msg-name {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 4px;
        }

        .msg-text {
            background: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            line-height: 1.6;
            font-size: 15px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        .playing .msg-text {
            border-color: var(--accent);
            background: #eff6ff;
        }

        /* æ’­æ”¾å™¨æ§åˆ¶æ  */
        .player-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
            }

            to {
                transform: translate(-50%, 0);
            }
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
            background: #e2e8f0;
            color: #64748b;
        }

        .badge.magic {
            background: #f3e8ff;
            color: #7e22ce;
            border: 1px solid #d8b4fe;
        }
    </style>

    <script type="application/json" id="tool_meta">
    {
      "tool_id": "docupod-ultimate",
      "tool_name": "æ’­å®¢ç”Ÿæˆå™¨",
      "version": "3.0.0",
      "description": "é›†æˆä¸‰ç§ TTS å¼•æ“çš„ PDF è½¬æ’­å®¢å·¥å…·",
      "capabilities": {"ai": true, "audio": true, "networking": true},
      "ai_integration": { "uses_key_manager": true }
    }
    </script>
</head>

<body>

    <div class="container">
        <header style="text-align:center; margin-bottom:30px;">
            <h1>ğŸ§ æ’­å®¢ç”Ÿæˆå™¨</h1>
            <p style="color:#64748b;">Hack 02: æ–‡æ¡£è½¬æ’­å®¢ Â· çº¯æµè§ˆå™¨ Â· é»‘é­”æ³•åŠ æŒ</p>
        </header>

        <section class="card">
            <details open>
                <summary style="font-weight:800; cursor:pointer;">âš™ï¸ æ ¸å¿ƒé…ç½® (Config)</summary>
                <div style="margin-top:20px;">
                    <div id="aiSettingsMount"></div>

                    <hr style="margin:20px 0; border:none; border-top:1px dashed #cbd5e1;">

                    <h3 style="font-size:14px; margin-bottom:10px;">ğŸ™ï¸ å£°å­¦çŸ©é˜µ (TTS Engine)</h3>
                    <div class="row">
                        <div class="field">
                            <label>é€‰æ‹©è¯­éŸ³æ–¹æ¡ˆ</label>
                            <select id="ttsEngineSelect">
                                <option value="native">æ–¹æ¡ˆ A: æµè§ˆå™¨åŸç”Ÿ (å…è´¹/ç¨³å®š/æœºæ¢°éŸ³)</option>
                                <option value="openai">æ–¹æ¡ˆ B: OpenAI API (ä»˜è´¹/Sçº§éŸ³è´¨)</option>
                                <option value="siliconflow">æ–¹æ¡ˆ C: CosyVoice2 (ç¡…åŸºæµåŠ¨/Açº§éŸ³è´¨/å¯ä¸‹è½½)</option>
                            </select>
                        </div>
                    </div>

                    <div id="ttsConfigPanel"
                        style="background:#f1f5f9; padding:12px; border-radius:8px; font-size:13px; color:#475569;">
                    </div>
                </div>
            </details>
        </section>

        <section class="card">
            <div class="row" style="justify-content:space-between;">
                <h2>ğŸ“„ å‰§æœ¬ç‚¼é‡‘å°</h2>
                <div id="statusBadge" class="badge">å°±ç»ª</div>
            </div>

            <div class="file-drop" id="dropZone">
                <div style="font-size:24px; margin-bottom:10px;">ğŸ“‚</div>
                <p style="margin:0;">æ‹–å…¥ PDF æ–‡ä»¶ æˆ– ç‚¹å‡»ä¸Šä¼ </p>
                <input type="file" id="fileInput" accept="application/pdf" style="display:none;">
                <div id="fileName" style="margin-top:10px; color:var(--accent); font-weight:700;"></div>
            </div>

            <textarea id="rawText" style="display:none;"></textarea>

            <div style="margin-top:20px; text-align:center;">
                <button id="btnGenerate" class="btn" disabled>ğŸš€ Step 1: æå–æ–‡æœ¬å¹¶ç”Ÿæˆå‰§æœ¬</button>
            </div>
        </section>

        <section class="card" id="scriptSection" style="display:none;">
            <div class="row" style="justify-content:space-between;">
                <h2>ğŸ“ å¯¹è¯å‰§æœ¬</h2>
                <button id="btnPlayScript" class="btn magic">â–¶ï¸ Step 2: å…¨æ–‡åˆæˆæ’­æ”¾</button>
            </div>
            <div id="scriptContainer" class="chat-box"></div>
        </section>

        <div id="playerBar" class="player-bar" style="display:none;">
            <div style="display:flex; align-items:center; gap:15px; flex:1; overflow:hidden;">
                <div id="playerAvatar" class="avatar" style="background:#e2e8f0; font-size:14px;">â–¶ï¸</div>
                <div style="overflow:hidden;">
                    <div style="font-weight:700; font-size:13px;">æ­£åœ¨æ’­æ”¾</div>
                    <div id="playerText"
                        style="font-size:12px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                        ...</div>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btnStop" class="btn secondary" style="padding:6px 12px; font-size:12px;">â¹ï¸ åœæ­¢</button>
                <button id="btnDownload" class="btn" style="padding:6px 12px; font-size:12px; display:none;">ğŸ’¾ ä¸‹è½½
                    MP3</button>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // æ¨¡å— 1: AI Module v2 (é›†æˆ Key Manager)
        // ==========================================
        const AI_MODULE = (() => {
            const KM_PROVIDER_OVERRIDES_KEY = "km_provider_overrides_v1";
            const AI_PROVIDERS = {
                "siliconflow": {
                    name: "ç¡…åŸºæµåŠ¨ (SiliconFlow)",
                    keyName: "siliconflow_key",
                    baseUrl: "https://api.siliconflow.cn/v1",
                    models: [
                        { id: "Qwen/Qwen2.5-7B-Instruct", name: "Qwen 2.5 7Bï¼ˆFastï¼‰" },
                        { id: "deepseek-ai/DeepSeek-V3", name: "DeepSeek V3" },
                        { id: "Pro/zai-org/GLM-4.7", name: "GLM-4.7" },
                        { id: "Pro/moonshotai/Kimi-K2-Thinking", name: "Kimi K2ï¼ˆThinkingï¼‰" },
                        { id: "Qwen/Qwen3-VL-32B-Thinking", name: "Qwen 3 VL 32Bï¼ˆThinkingï¼‰" }
                    ]
                },
                "openrouter": {
                    name: "OpenRouter",
                    keyName: "openrouter_key",
                    baseUrl: "https://openrouter.ai/api/v1",
                    models: [
                        { id: "openai/gpt-4o", name: "GPT-4o" },
                        { id: "google/gemini-pro", name: "Gemini Pro" },
                        { id: "anthropic/claude-opus-4.5", name: "Claude Opus 4.5" },
                        { id: "openai/gpt-5.2-pro", name: "GPT-5.2 Pro" },
                        { id: "google/gemini-3-pro-preview", name: "Gemini 3 Pro Preview" }
                    ]
                },
                "deepseek": {
                    name: "DeepSeek Official",
                    keyName: "deepseek_key",
                    baseUrl: "https://api.deepseek.com",
                    models: [
                        { id: "deepseek-chat", name: "DeepSeek V3" }
                    ]
                },
                "custom": {
                    name: "è‡ªå®šä¹‰ / æœ¬åœ°ï¼ˆOllamaï¼‰",
                    keyName: "custom_key",
                    baseUrl: "http://localhost:11434/v1",
                    models: []
                }
            };

            function safeJsonParse(str) {
                try { return { ok: true, value: JSON.parse(str) }; }
                catch (e) { return { ok: false, error: String(e) }; }
            }
            function getOverrides() {
                const raw = localStorage.getItem(KM_PROVIDER_OVERRIDES_KEY);
                if (!raw) return {};
                const parsed = safeJsonParse(raw);
                if (!parsed.ok || !parsed.value || typeof parsed.value !== "object") return {};
                return parsed.value;
            }
            function normalizeBaseUrl(baseUrl) {
                const s = String(baseUrl || "").trim();
                return s.replace(/\/+$/, "");
            }
            function joinUrl(baseUrl, path) {
                const b = normalizeBaseUrl(baseUrl);
                const p = String(path || "").trim().replace(/^\/+/, "");
                return `${b}/${p}`;
            }
            function getProvider(providerId) { return AI_PROVIDERS[providerId]; }

            function getMergedProviderConfig(providerId) {
                const p = getProvider(providerId);
                if (!p) throw new Error(`æœªçŸ¥ provider_id: ${providerId}`);
                const overrides = getOverrides();
                const o = overrides[providerId] || {};
                const customModels = Array.isArray(o.custom_models) ? o.custom_models : [];
                const mergedModels = [
                    ...(Array.isArray(p.models) ? p.models : []),
                    ...customModels
                        .filter(m => m && typeof m === "object" && m.id)
                        .map(m => ({ id: String(m.id), name: m.name ? String(m.name) : String(m.id), _custom: true }))
                ];
                const baseUrl = o.base_url_override ? String(o.base_url_override) : p.baseUrl;
                const modelId = o.model_id_override ? String(o.model_id_override) : (mergedModels[0]?.id || "");
                return { provider_id: providerId, name: p.name, key_name: p.keyName, base_url: baseUrl, models: mergedModels, model_id: modelId };
            }

            function getKeyStatus(providerId) {
                const p = getProvider(providerId);
                if (!p) return { ok: false, has_key: false, key_name: "" };
                const keyName = p.keyName;
                const key = localStorage.getItem(keyName);
                return { ok: true, has_key: Boolean(key), key_name: keyName };
            }

            function classifyFetchError(err) {
                const msg = String(err?.message || err || "");
                const lower = msg.toLowerCase();
                if (lower.includes("abort")) return { kind: "ç¯å¢ƒé”™è¯¯", msg: "è¯·æ±‚è¶…æ—¶/è¢«å–æ¶ˆ" };
                if (lower.includes("failed to fetch") || lower.includes("network") || lower.includes("cors")) {
                    return { kind: "ç¯å¢ƒé”™è¯¯", msg: msg };
                }
                return { kind: "å†…éƒ¨é”™è¯¯", msg: msg };
            }

            function actionableErrorMessage(kind, msg) {
                if (kind === "ç¯å¢ƒé”™è¯¯") return `ç¯å¢ƒé”™è¯¯ï¼š${msg}\næ£€æŸ¥ç½‘ç»œ/CORS/æ··åˆå†…å®¹ã€‚`;
                if (kind === "å¹³å°é”™è¯¯") return `å¹³å°é”™è¯¯ï¼š${msg}\næ£€æŸ¥ keyã€é™æµã€æ¨¡å‹ IDã€‚`;
                return `å†…éƒ¨é”™è¯¯ï¼š${msg}`;
            }

            async function corsProbe(baseUrl, timeoutMs = 8000) {
                const url = String(baseUrl || "").trim();
                if (!url) return { ok: false, result: "ç©º URL" };
                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const resp = await fetch(url, { method: "GET", mode: "cors", cache: "no-store", signal: controller.signal });
                    return { ok: true, result: `CORS å¯ç”¨ (${resp.status})` };
                } catch (e) {
                    return { ok: false, result: "å¯èƒ½è¢« CORS/ç½‘ç»œæ‹¦æˆª" };
                } finally { clearTimeout(timer); }
            }

            async function call_llm_unified({ provider_id, base_url, api_key, model_id, messages, temperature = 0.7, max_tokens = 2000, timeout_ms = 60000 }) {
                if (!api_key) { const e = new Error("å¹³å°é”™è¯¯: ç¼ºå°‘ API Keyï¼ˆè¯·å…ˆåœ¨ key-manager.html è®¾ç½®ï¼‰"); e._kind = "å¹³å°é”™è¯¯"; throw e; }
                const url = joinUrl(base_url, "/chat/completions");
                const headers = { "Authorization": `Bearer ${api_key}`, "Content-Type": "application/json" };
                const body = { model: model_id, messages, temperature, max_tokens, response_format: { type: "json_object" } };
                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeout_ms);
                try {
                    const resp = await fetch(url, { method: "POST", mode: "cors", headers, body: JSON.stringify(body), signal: controller.signal });
                    const text = await resp.text();
                    const parsed = safeJsonParse(text);
                    if (!resp.ok) { const e = new Error(`å¹³å°é”™è¯¯: HTTP ${resp.status}\n${text.slice(0, 500)}`); e._kind = "å¹³å°é”™è¯¯"; throw e; }
                    return parsed.ok ? parsed.value.choices[0].message.content : text;
                } catch (e) {
                    if (e && e._kind) throw e;
                    const info = classifyFetchError(e);
                    const err = new Error(`${info.kind}: ${info.msg}`); err._kind = info.kind; throw err;
                } finally { clearTimeout(timer); }
            }

            function render_ai_settings_html() {
                const providerOptions = Object.keys(AI_PROVIDERS).map(pid => `<option value="${pid}">${AI_PROVIDERS[pid].name}</option>`).join("");
                return `
            <h3 style="font-size:14px; margin-bottom:10px;">ğŸ¤– AI é…ç½®ï¼ˆè‡ªåŠ¨ä» Key Manager åŒæ­¥ï¼‰</h3>
            <div class="hint" style="margin-bottom:10px; font-size:12px; color:#64748b;">
                è¯·å…ˆåœ¨ <a href="key-manager.html" target="_blank">key-manager.html</a> è®¾ç½®å¯†é’¥ï¼Œæœ¬é¡µä¼šè‡ªåŠ¨è¯»å–ã€‚
            </div>
            <div class="row" style="margin-bottom:10px;">
                <span class="badge" style="background:#fef3c7; color:#92400e; border:1px solid #fcd34d;">
                    <input id="aiNetworkingToggle" type="checkbox" style="margin-right:4px;" />
                    å…è®¸è”ç½‘ï¼ˆé»˜è®¤å…³é—­ï¼‰
                </span>
                <span class="badge" id="aiKeyStatusPill">å¯†é’¥çŠ¶æ€ï¼šæœªæ£€æŸ¥</span>
            </div>
            <div class="row">
                <div class="field"><label>å¹³å°ï¼ˆProviderï¼‰</label><select id="aiProviderSelect">${providerOptions}</select></div>
                <div class="field"><label>æ¨¡å‹é¢„è®¾</label><select id="aiModelPresetSelect"></select></div>
            </div>
            <div class="row">
                <div class="field"><label>Base URL</label><input type="text" id="aiBaseUrlInput" /></div>
                <div class="field"><label>æ¨¡å‹ ID</label><input type="text" id="aiModelIdInput" /></div>
            </div>
            <div class="row" style="margin-top:10px;">
                <button class="btn secondary" id="aiSyncBtn" type="button" style="font-size:12px;">ä» Key Manager åŒæ­¥</button>
                <button class="btn secondary" id="aiCorsProbeBtn" type="button" style="font-size:12px;">CORS æ¢æµ‹</button>
            </div>
            <div id="aiLog" style="margin-top:10px; font-size:11px; color:#64748b; font-family:monospace; background:#f1f5f9; padding:8px; border-radius:6px;">AI æ¨¡å—å°±ç»ªã€‚</div>
        `;
            }

            function mount_ai_settings({ mount_el, default_provider_id = "siliconflow", on_state_change = null }) {
                mount_el.innerHTML = render_ai_settings_html();
                const $ = (id) => mount_el.querySelector(id);
                const aiNetworkingToggle = $("#aiNetworkingToggle");
                const aiProviderSelect = $("#aiProviderSelect");
                const aiBaseUrlInput = $("#aiBaseUrlInput");
                const aiModelPresetSelect = $("#aiModelPresetSelect");
                const aiModelIdInput = $("#aiModelIdInput");
                const aiKeyStatusPill = $("#aiKeyStatusPill");
                const aiLog = $("#aiLog");
                const aiSyncBtn = $("#aiSyncBtn");
                const aiCorsProbeBtn = $("#aiCorsProbeBtn");

                const state = { networking_enabled: false, provider_id: default_provider_id, base_url: "", model_id: "", temperature: 0.7, max_tokens: 2000, timeout_ms: 60000 };

                function emit() { on_state_change && on_state_change(get_state()); }

                function setKeyStatusPill(providerId) {
                    const ks = getKeyStatus(providerId);
                    if (ks.has_key) {
                        aiKeyStatusPill.style.background = "#d1fae5"; aiKeyStatusPill.style.color = "#065f46"; aiKeyStatusPill.style.border = "1px solid #6ee7b7";
                        aiKeyStatusPill.textContent = `âœ… å·²è®¾ç½®ï¼ˆ${ks.key_name}ï¼‰`;
                    } else {
                        aiKeyStatusPill.style.background = "#fee2e2"; aiKeyStatusPill.style.color = "#991b1b"; aiKeyStatusPill.style.border = "1px solid #fca5a5";
                        aiKeyStatusPill.textContent = `âŒ æœªè®¾ç½®ï¼ˆ${ks.key_name}ï¼‰`;
                    }
                }

                function rebuildModelPresetOptions(providerId, preferModelId = "") {
                    const cfg = getMergedProviderConfig(providerId);
                    const models = cfg.models || [];
                    const options = [...models.map(m => `<option value="${String(m.id)}">${String(m.name || m.id)}${m._custom ? "ï¼ˆè‡ªå®šä¹‰ï¼‰" : ""}</option>`), `<option value="__custom__">æ‰‹åŠ¨è¾“å…¥æ¨¡å‹ ID</option>`].join("");
                    aiModelPresetSelect.innerHTML = options;
                    const effectiveModelId = preferModelId || cfg.model_id || "";
                    const hasPreset = models.some(m => String(m.id) === String(effectiveModelId));
                    aiModelPresetSelect.value = hasPreset ? String(effectiveModelId) : "__custom__";
                }

                function syncFromKeyManager(providerId) {
                    const cfg = getMergedProviderConfig(providerId);
                    state.base_url = String(cfg.base_url || "");
                    state.model_id = String(cfg.model_id || "");
                    aiBaseUrlInput.value = state.base_url;
                    aiModelIdInput.value = state.model_id;
                    rebuildModelPresetOptions(providerId, state.model_id);
                    setKeyStatusPill(providerId);
                    aiLog.textContent = `å·²åŒæ­¥ï¼š${cfg.name} | ${state.model_id}`;
                    emit();
                }

                aiProviderSelect.value = default_provider_id;
                syncFromKeyManager(default_provider_id);

                aiNetworkingToggle.addEventListener("change", () => { state.networking_enabled = Boolean(aiNetworkingToggle.checked); aiLog.textContent = state.networking_enabled ? "å·²å…è®¸è”ç½‘" : "å·²å…³é—­è”ç½‘"; emit(); });
                aiProviderSelect.addEventListener("change", () => { state.provider_id = aiProviderSelect.value; syncFromKeyManager(state.provider_id); });
                aiBaseUrlInput.addEventListener("change", () => { state.base_url = String(aiBaseUrlInput.value || "").trim(); emit(); });
                aiModelPresetSelect.addEventListener("change", () => { const v = aiModelPresetSelect.value; if (v !== "__custom__") { aiModelIdInput.value = v; state.model_id = v; emit(); } });
                aiModelIdInput.addEventListener("change", () => { state.model_id = String(aiModelIdInput.value || "").trim(); emit(); });
                aiSyncBtn.addEventListener("click", () => syncFromKeyManager(state.provider_id));
                aiCorsProbeBtn.addEventListener("click", async () => { aiLog.textContent = "CORS æ¢æµ‹ä¸­..."; const res = await corsProbe(aiBaseUrlInput.value); aiLog.textContent = res.result; });

                function get_state() { return { ...state, key_status: getKeyStatus(state.provider_id) }; }

                async function call_ai({ messages }) {
                    const s = get_state();
                    if (!s.networking_enabled) { const e = new Error("ç¯å¢ƒé”™è¯¯: è¯·å…ˆå‹¾é€‰ã€å…è®¸è”ç½‘ã€‘"); e._kind = "ç¯å¢ƒé”™è¯¯"; throw e; }
                    const p = getProvider(s.provider_id);
                    const apiKey = localStorage.getItem(p.keyName) || "";
                    return await call_llm_unified({ provider_id: s.provider_id, base_url: s.base_url, api_key: apiKey, model_id: s.model_id, messages, temperature: s.temperature, max_tokens: s.max_tokens, timeout_ms: s.timeout_ms });
                }

                function get_actionable_error(err) { return actionableErrorMessage(err?._kind || "å†…éƒ¨é”™è¯¯", String(err?.message || err || "")); }

                return { get_state, call_ai, get_actionable_error, sync: () => syncFromKeyManager(state.provider_id) };
            }

            return { mount_ai_settings, getMergedProviderConfig, getKeyStatus, corsProbe, call_llm_unified, actionableErrorMessage };
        })();

        // AI æ¨¡å—å®ä¾‹
        let aiInstance = null;

        // ==========================================
        // æ¨¡å— 2: TTS å¼•æ“çŸ©é˜µ (æ ¸å¿ƒ)
        // ==========================================
        const TTS_ENGINE = (() => {
            // æ–¹æ¡ˆ A: æµè§ˆå™¨åŸç”Ÿ
            function speakNative(text, role) {
                return new Promise((resolve) => {
                    const u = new SpeechSynthesisUtterance(text);
                    const voices = speechSynthesis.getVoices();
                    // ç®€å•åˆ†é…ï¼šBobç”¨ç¬¬ä¸€ä¸ªç”·å£°/ä½æ²‰ï¼ŒAliceç”¨ç¬¬ä¸€ä¸ªå¥³å£°/é«˜éŸ³
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼ŒAlice è¯­é€Ÿå¿«ä¸€ç‚¹ï¼ŒéŸ³è°ƒé«˜ä¸€ç‚¹
                    if (role === 'Alice') { u.pitch = 1.1; u.rate = 1.1; }
                    else { u.pitch = 0.9; u.rate = 0.95; }

                    u.lang = 'zh-CN';
                    u.onend = resolve;
                    speechSynthesis.speak(u);
                });
            }

            // æ–¹æ¡ˆ B: OpenAI API
            async function speakOpenAI(text, role) {
                // ä» key-manager è·å– OpenAI å®˜æ–¹ Key
                const key = localStorage.getItem('openai_key') || '';

                const voice = role === 'Alice' ? 'nova' : 'onyx';

                if (!key) throw new Error("OpenAI TTS éœ€è¦åœ¨ key-manager è®¾ç½® OpenAI å®˜æ–¹ Key (openai_key)");

                const resp = await fetch("https://api.openai.com/v1/audio/speech", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "tts-1", input: text, voice: voice })
                });

                if (!resp.ok) throw new Error("TTS API Error");
                const blob = await resp.blob();
                AUDIO_RECORDER.add(blob); // æ”¶é›†éŸ³é¢‘ç”¨äºä¸‹è½½
                const audio = new Audio(URL.createObjectURL(blob));
                return new Promise(r => { audio.onended = r; audio.play(); });
            }

            // æ–¹æ¡ˆ C: ç¡…åŸºæµåŠ¨ CosyVoice2 TTS
            async function speakSiliconFlow(text, role) {
                // å…¼å®¹ localStorage å’Œ sessionStorageï¼ˆkey-manager æœ‰å¤šç§å­˜å‚¨æ¨¡å¼ï¼‰
                const key = localStorage.getItem('siliconflow_key') || sessionStorage.getItem('siliconflow_key') || '';
                if (!key) {
                    console.error('[TTS] siliconflow_key æœªæ‰¾åˆ°ï¼è¯·æ£€æŸ¥ key-manager è®¾ç½®');
                    throw new Error("è¯·åœ¨ key-manager è®¾ç½® siliconflow_keyï¼ˆç¡®ä¿å­˜å‚¨æ¨¡å¼ä¸º localStorage æˆ–å‹¾é€‰å…¼å®¹æ¨¡å¼ï¼‰");
                }

                // Alice: bella (å¥³å£°), Bob: alex (ç”·å£°)
                const voice = role === 'Alice'
                    ? 'FunAudioLLM/CosyVoice2-0.5B:bella'
                    : 'FunAudioLLM/CosyVoice2-0.5B:alex';

                const MAX_RETRIES = 2;
                const TIMEOUT_MS = 20000; // å¢åŠ åˆ° 20 ç§’
                let lastError = null;

                console.log(`[TTS] å¼€å§‹åˆæˆ: ${role} - "${text.slice(0, 30)}..."`);

                for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
                    try {
                        // ä½¿ç”¨ Promise.race å®ç°å®Œæ•´è¶…æ—¶ï¼ˆè¦†ç›– fetch + blobï¼‰
                        const fetchWithFullTimeout = async () => {
                            const controller = new AbortController();

                            const resp = await fetch("https://api.siliconflow.cn/v1/audio/speech", {
                                method: "POST",
                                headers: {
                                    "Authorization": `Bearer ${key}`,
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    model: "FunAudioLLM/CosyVoice2-0.5B",
                                    input: text,
                                    voice: voice,
                                    response_format: "mp3",
                                    stream: false  // å…³é”®ï¼šç¦ç”¨æµå¼ï¼Œç¡®ä¿å®Œæ•´è¿”å›
                                }),
                                signal: controller.signal
                            });

                            // å¤„ç† 429/503/504 é‡è¯•
                            if (resp.status === 429 || resp.status === 503 || resp.status === 504) {
                                throw { retryable: true, status: resp.status };
                            }

                            if (!resp.ok) {
                                const errText = await resp.text();
                                throw new Error(`CosyVoice2 é”™è¯¯ (${resp.status}): ${errText.slice(0, 100)}`);
                            }

                            console.log(`[TTS] API å“åº”æˆåŠŸï¼Œæ­£åœ¨ä¸‹è½½éŸ³é¢‘...`);
                            const blob = await resp.blob();
                            console.log(`[TTS] éŸ³é¢‘ä¸‹è½½å®Œæˆ: ${(blob.size / 1024).toFixed(1)} KB`);

                            if (blob.size === 0) throw new Error("API è¿”å›ç©ºéŸ³é¢‘");
                            return blob;
                        };

                        const timeout = new Promise((_, reject) =>
                            setTimeout(() => reject(new Error("è¯·æ±‚è¶…æ—¶ (20s)")), TIMEOUT_MS)
                        );

                        const blob = await Promise.race([fetchWithFullTimeout(), timeout]);

                        AUDIO_RECORDER.add(blob);
                        const audio = new Audio(URL.createObjectURL(blob));

                        // å¸¦é”™è¯¯å¤„ç†çš„æ’­æ”¾
                        return new Promise((resolve, reject) => {
                            audio.onended = () => { console.log(`[TTS] æ’­æ”¾å®Œæˆ: ${role}`); resolve(); };
                            audio.onerror = (e) => reject(new Error("éŸ³é¢‘æ’­æ”¾å¤±è´¥"));
                            audio.play().catch(reject);
                        });

                    } catch (e) {
                        if (e.retryable) {
                            lastError = new Error(`API ç¹å¿™ (${e.status})ï¼Œé‡è¯•ä¸­...`);
                            console.warn(`[TTS] ç¬¬ ${attempt + 1} æ¬¡å°è¯•: ${e.status}ï¼Œç­‰å¾…é‡è¯•`);
                        } else {
                            lastError = e;
                            console.warn(`[TTS] ç¬¬ ${attempt + 1} æ¬¡å°è¯•å¤±è´¥:`, e.message);
                        }
                        if (attempt < MAX_RETRIES) {
                            await new Promise(r => setTimeout(r, 1500 * (attempt + 1))); // é€’å¢ç­‰å¾…
                        }
                    }
                }
                throw lastError || new Error("TTS è¯·æ±‚å¤±è´¥");
            }

            return { speakNative, speakOpenAI, speakSiliconFlow };
        })();

        // ==========================================
        // æ¨¡å— 2.5: éŸ³é¢‘å½•åˆ¶å™¨ (Audio Recorder)
        // ==========================================
        const AUDIO_RECORDER = (() => {
            let chunks = [];
            let isRecording = false;
            const MAX_CHUNKS = 150; // æœ€å¤š150æ®µï¼Œçº¦25åˆ†é’Ÿ

            function start() { chunks = []; isRecording = true; console.log('[AUDIO_RECORDER] å¼€å§‹å½•åˆ¶'); }
            function stop() { isRecording = false; console.log('[AUDIO_RECORDER] åœæ­¢å½•åˆ¶ï¼Œå…±', chunks.length, 'æ®µ'); }
            function add(blob) {
                if (isRecording && chunks.length < MAX_CHUNKS) {
                    chunks.push(blob);
                    console.log('[AUDIO_RECORDER] æ·»åŠ ç¬¬', chunks.length, 'æ®µ');
                }
            }
            function canDownload() { return chunks.length > 0; }
            function getCount() { return chunks.length; }

            async function download(filename = 'podcast.mp3') {
                if (chunks.length === 0) { alert('æš‚æ— å¯ä¸‹è½½çš„éŸ³é¢‘'); return; }

                // åˆå¹¶æ‰€æœ‰éŸ³é¢‘ç‰‡æ®µ
                const merged = new Blob(chunks, { type: 'audio/mpeg' });
                const url = URL.createObjectURL(merged);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('[AUDIO_RECORDER] ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°:', (merged.size / 1024 / 1024).toFixed(2), 'MB');
            }

            return { start, stop, add, canDownload, getCount, download };
        })();

        // ==========================================
        // æ¨¡å— 3: ä¸šåŠ¡ç¼–æ’ (Controller)
        // ==========================================

        // åˆå§‹åŒ– AI æ¨¡å—
        aiInstance = AI_MODULE.mount_ai_settings({
            mount_el: document.getElementById('aiSettingsMount'),
            default_provider_id: 'siliconflow',
            on_state_change: (s) => console.log('[DocuPod AI State]', s)
        });
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOM å¼•ç”¨
        const ui = {
            fileIn: document.getElementById('fileInput'),
            drop: document.getElementById('dropZone'),
            rawText: document.getElementById('rawText'),
            btnGen: document.getElementById('btnGenerate'),
            ttsSel: document.getElementById('ttsEngineSelect'),
            ttsPanel: document.getElementById('ttsConfigPanel'),
            scriptBox: document.getElementById('scriptContainer'),
            scriptSec: document.getElementById('scriptSection'),
            playerBar: document.getElementById('playerBar'),
            playerText: document.getElementById('playerText'),
            badge: document.getElementById('statusBadge')
        };

        // TTS è¯´æ˜é¢æ¿æ›´æ–°
        ui.ttsSel.onchange = () => {
            const val = ui.ttsSel.value;
            const tips = {
                'native': "â„¹ï¸ ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦è¯­éŸ³åˆæˆã€‚æ— éœ€è”ç½‘ï¼Œæ— éœ€ Keyã€‚ç¼ºç‚¹æ˜¯å£°éŸ³æ¯”è¾ƒæœºæ¢°ã€‚",
                'openai': "â„¹ï¸ ä½¿ç”¨ OpenAI å®˜æ–¹ TTSã€‚éœ€è¦åœ¨ <a href='key-manager.html' target='_blank'>key-manager</a> è®¾ç½® OpenAI å®˜æ–¹ Keyã€‚æ¯ 1000 å­—ç¬¦çº¦ $0.015ã€‚",
                'siliconflow': "â„¹ï¸ ä½¿ç”¨ç¡…åŸºæµåŠ¨ CosyVoice2ã€‚éœ€è¦åœ¨ <a href='key-manager.html' target='_blank'>key-manager</a> è®¾ç½® siliconflow_keyã€‚Â¥50/M å­—ç¬¦ã€‚æ”¯æŒéŸ³é¢‘ä¸‹è½½ã€‚"
            };
            ui.ttsPanel.innerHTML = tips[val];
        };
        ui.ttsSel.dispatchEvent(new Event('change')); // init

        // æ–‡ä»¶ä¸Šä¼ é€»è¾‘
        ui.drop.onclick = () => ui.fileIn.click();
        ui.fileIn.onchange = async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            document.getElementById('fileName').innerText = f.name;
            ui.badge.innerText = "è§£æä¸­...";

            const ab = await f.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(ab).promise;
            let txt = "";
            for (let i = 1; i <= Math.min(pdf.numPages, 200); i++) { // é™åˆ¶å‰200é¡µ
                const p = await pdf.getPage(i);
                txt += (await p.getTextContent()).items.map(s => s.str).join(" ");
            }
            ui.rawText.value = txt;
            ui.badge.innerText = `å·²æå– ${txt.length} å­—`;
            ui.btnGen.disabled = false;
        };

        // å‰§æœ¬ç”Ÿæˆé€»è¾‘
        let globalScript = null;
        ui.btnGen.onclick = async () => {
            const txt = ui.rawText.value;
            if (!txt) return alert("æ— æ–‡æœ¬");

            ui.btnGen.disabled = true;
            ui.badge.innerText = "AI æ€è€ƒä¸­...";

            try {
                const prompt = `
# Role
ä½ æ˜¯ç”± Google DeepMind æ¶æ„ç†å¿µè®¾è®¡çš„ "Knowledge Alchemist" (çŸ¥è¯†ç‚¼é‡‘æœ¯å£«)ã€‚
ä½ çš„ä»»åŠ¡æ˜¯å°†è¾“å…¥çš„ **[åŸå§‹æ–‡æ¡£]** (å¯èƒ½å› é•¿åº¦é™åˆ¶è¢«æˆªæ–­) æ·±åº¦é‡æ„ä¸ºä¸€æ¡£**é«˜ä¿¡å™ªæ¯”ã€å¯Œæœ‰æ´å¯ŸåŠ›**çš„ **[åŒäººæ’­å®¢å‰§æœ¬]**ã€‚


# Constraints & Safety
1. **çœŸå®æ€§åŸåˆ™**: åŸºäºæ–‡æ¡£çœŸå®å†…å®¹ï¼Œä¸ç¼–é€ ã€‚
2. **è¯­è¨€**: å¿…é¡»ä½¿ç”¨**ä¸­æ–‡**ã€‚
3. âš ï¸ **é˜²è¶…æ—¶é“å¾‹**: å•ä¸ªå¯¹è¯å›åˆ(turn) **ä¸¥ç¦è¶…è¿‡ 150 å­—**ã€‚
4. âš ï¸ **æ·±åº¦è¦æ±‚**: è™½ç„¶å•å¥è¦çŸ­ï¼Œä½†**æ€»å¯¹è¯è½®æ¬¡(Turns)å¿…é¡»å¤š**ã€‚ä¸è¦åŒ†å¿™ç»“æŸï¼Œè¦å±‚å±‚é€’è¿›ã€‚

# Core Philosophy (æ ¸å¿ƒå¿ƒæ³•)
æ‹’ç»å¹³é“ºç›´å™çš„æ‘˜è¦ã€‚æˆ‘ä»¬è¦çš„æ˜¯**"Aha Moments" (é¡¿æ‚Ÿæ—¶åˆ»)**ã€‚
æ¯ä¸€æ®µå¯¹è¯éƒ½å¿…é¡»å›ç­”ç”¨æˆ·æ½œæ„è¯†é‡Œçš„é—®é¢˜ï¼š"So What? (è¿™ä¸æˆ‘ä½•å¹²?)" å’Œ "Why Now? (ä¸ºä»€ä¹ˆæ˜¯ç°åœ¨?)"ã€‚

# Character Design (è§’è‰²é‡å¡‘)
- **Host A (Alice)**: 
  - **äººè®¾**: ç„¦è™‘çš„é«˜çŸ¥èŒåœºäººï¼Œä»£è¡¨å¬ä¼—çš„ç—›ç‚¹ã€‚
  - **é£æ ¼**: æ€€ç–‘è®ºè€…ã€‚å¥¹ä¸ç›¸ä¿¡æœ¯è¯­ï¼Œåªå…³å¿ƒè½åœ°ã€‚å¥¹ä¼šé—®ï¼š"ä½†è¿™ä¸å°±æ˜¯ä»¥å‰çš„è‡ªåŠ¨åŒ–å—ï¼Ÿæœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ" æˆ– "å¬èµ·æ¥å¾ˆè´µï¼Œå€¼å¾—å—ï¼Ÿ"
  - **åŠŸèƒ½**: æŒ–æ˜å†²çªï¼Œæ›¿å¬ä¼—æ‰“ç ´ç ‚é”…é—®åˆ°åº•ã€‚

- **Host B (Bob)**: 
  - **äººè®¾**: æ‹¥æœ‰ä¸Šå¸è§†è§’çš„ç§‘æŠ€å“²å­¦å®¶ï¼Œå†·é™ã€çŠ€åˆ©ã€‚
  - **é£æ ¼**: æ“…é•¿**é™ç»´æ‰“å‡»**ã€‚ä»–ä¸ç”¨æœ¯è¯­è§£é‡Šæœ¯è¯­ï¼Œè€Œæ˜¯ç”¨**ç²¾å¦™çš„æ¯”å–» (Analogy)** å’Œ **åº•å±‚é€»è¾‘ (First Principles)** æ¥è§£é‡Šå¤æ‚æ¦‚å¿µã€‚
  - **åŠŸèƒ½**: å°†æ¯ç‡¥çš„æŠ€æœ¯æ–‡æ¡£å‡åä¸ºå•†ä¸šæ™ºæ…§ã€‚

# Script Structure (å™äº‹ç»“æ„)
1. **The Hook (ç—›ç‚¹åˆ‡å…¥)**: 
   - ç¦æ­¢å¯’æš„ï¼ç›´æ¥ä»æ–‡æ¡£ä¸­æœ€åç›´è§‰çš„ä¸€ä¸ªæ•°æ®æˆ–ä¸€ä¸ªåœºæ™¯åˆ‡å…¥ã€‚
   - ä¾‹å¦‚ï¼š"ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œä½ æ¯å¤©æœ‰ 30% çš„æ—¶é—´å…¶å®æ˜¯åœ¨åšæœºå™¨äººçš„å·¥ä½œï¼Ÿ"
2. **The Deep Dive (æ·±åº¦æ‹†è§£)**: 
   - é€‰å–æ–‡æ¡£ä¸­ 3-5 ä¸ªæ ¸å¿ƒ Hack/æ¡ˆä¾‹è¿›è¡Œæ·±åº¦å‰–æã€‚
   - **æ¯ä¸ªçŸ¥è¯†ç‚¹è‡³å°‘è¿›è¡Œ 4-5 è½®çš„æ¥å›æ¢è®¨**ã€‚
   - Host A å¿…é¡»å……å½“"æ ç²¾"ï¼Œæå‡ºè´¨ç–‘ï¼Œé€¼ Host B è§£é‡Šå¾—æ›´é€å½»ã€‚
   - **å¿…é¡»ä½¿ç”¨æ¯”å–»**ï¼šä¾‹å¦‚å°† "Multimodal Search" æ¯”ä½œ "ç»™å…¬å¸çš„å¤§è„‘è£…ä¸Šäº†è§†ç¥ç»"ã€‚
   - **å¼•å…¥å†²çª**ï¼šAlice è´¨ç–‘ -> Bob æŠ›å‡ºé¢ è¦†æ€§è§‚ç‚¹ -> Alice æç„¶å¤§æ‚Ÿã€‚
3. **The Escalation (ä»·å€¼å‡ç»´)**: 
   - è®¨è®ºè¿™äº›ä¿¡æ¯å¯¹æ™®é€šäºº/è¡Œä¸šçš„æ·±å±‚å½±å“ã€‚è®¨è®ºè¿™ä¸ä»…ä»…æ˜¯å·¥å…·ï¼Œæ›´æ˜¯"ç”Ÿäº§å…³ç³»çš„å˜é©" (ä» Doer å˜æˆ Manager)ã€‚
4. **The Takeaway (è¡ŒåŠ¨æŒ‡å—)**: 
   - ç»“å°¾ç»™å‡º3ä¸ªå…·ä½“çš„ã€æ˜å¤©å°±èƒ½ç”¨çš„å»ºè®®ã€‚

# Constraints & Safety (ç¡¬æ€§çº¦æŸ)
1. **çœŸå®æ€§**: åŸºäºæ–‡æ¡£å†…å®¹ï¼Œä¸¥ç¦ç¼–é€ æ•°æ®ã€‚
2. **è¯­è¨€**: å¿…é¡»ä½¿ç”¨**ä¸­æ–‡**è¿›è¡Œå¯¹è¯ï¼Œå£è¯­åŒ–ï¼Œè‡ªç„¶æµç•…ã€‚
3. **é˜²è¶…æ—¶æœºåˆ¶**: âš ï¸ **å…³é”®**: ä¸ºäº†é˜²æ­¢ TTS ç”Ÿæˆå¤±è´¥ï¼Œ**æ¯ä¸€è½®å¯¹è¯ (Turn) ä¸¥ç¦è¶…è¿‡ 100 å­—**ã€‚å¦‚æœè§£é‡Šå¾ˆé•¿ï¼Œå¿…é¡»è®© Alice æ’è¯æ‰“æ–­ï¼Œæˆ–è€… Bob ä¹Ÿå°±æ˜¯åœé¡¿ä¸€ä¸‹åˆ†æ®µè¯´ã€‚
4. **æ‹’ç»è¯´æ•™**: ä¸è¦åƒè®²è¯¾ï¼Œè¦åƒä¸¤ä¸ªèªæ˜äººåœ¨å’–å•¡é¦†çš„æ·±åº¦å¯¹è°ˆã€‚

# Output Format (Strict JSON)
{
  "dialogue": [
    {"speaker": "Alice", "text": "è¯´å®è¯ï¼Œçœ‹å®Œè¿™ä»½ Google çš„æŠ¥å‘Šï¼Œæˆ‘æœ‰ç‚¹èƒŒè„Šå‘å‡‰..."},
    {"speaker": "Bob", "text": "ä½ æ˜¯è¯´é‚£ä¸ªé¢„æµ‹ 2028 å¹´ 33% çš„è½¯ä»¶éƒ½å°†æ‹¥æœ‰è‡ªä¸»æ„è¯†çš„æ•°æ®å—ï¼Ÿ"},
    {"speaker": "Alice", "text": "å¯¹ï¼è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿæˆ‘ä»¬éƒ½è¦å¤±ä¸šäº†ï¼Ÿ"},
    {"speaker": "Bob", "text": "æ°æ°ç›¸åã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å°†è¿æ¥'è®¤çŸ¥å¸è½½'çš„æ—¶ä»£ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰äº†ä¸€ä¸ªä¸çŸ¥ç–²å€¦çš„æ•°å­—åˆ†èº«..."}
  ]
}
                `;

                // ä½¿ç”¨æ–°çš„ AI æ¨¡å— API
                const res = await aiInstance.call_ai({
                    messages: [
                        { role: "system", content: prompt },
                        { role: "user", content: txt.slice(0, 300000) } // æˆªæ–­
                    ]
                });

                const json = JSON.parse(res.replace(/```json|```/g, ""));
                globalScript = json.dialogue;
                renderScript(globalScript);
                ui.scriptSec.style.display = 'block';
                ui.badge.innerText = "å‰§æœ¬å°±ç»ª";

            } catch (e) {
                alert("ç”Ÿæˆå¤±è´¥: " + e.message);
                ui.badge.innerText = "å‡ºé”™";
            } finally {
                ui.btnGen.disabled = false;
            }
        };

        function renderScript(lines) {
            ui.scriptBox.innerHTML = lines.map(l => {
                const isA = l.speaker === 'Alice';
                return `
            <div class="message" style="flex-direction:${isA ? 'row' : 'row-reverse'}">
                <div class="avatar" style="background:${isA ? '#dbeafe' : '#fae8ff'}">${isA ? 'ğŸ‘©' : 'ğŸ‘¨'}</div>
                <div class="msg-content">
                    <div class="msg-name" style="text-align:${isA ? 'left' : 'right'}">${l.speaker}</div>
                    <div class="msg-text">${l.text}</div>
                </div>
            </div>
        `;
            }).join("");
        }

        // æ’­æ”¾æ§åˆ¶é€»è¾‘ (The Orchestrator)
        let isStopping = false;
        const btnDownload = document.getElementById('btnDownload');

        document.getElementById('btnPlayScript').onclick = async () => {
            if (!globalScript) return;
            const engine = ui.ttsSel.value;

            ui.playerBar.style.display = 'flex';
            btnDownload.style.display = 'none'; // éšè—ä¸‹è½½æŒ‰é’®
            isStopping = false;

            // OpenAI å’Œ SiliconFlow TTS æ”¯æŒå½•åˆ¶
            if (engine === 'openai' || engine === 'siliconflow') AUDIO_RECORDER.start();

            const messages = document.querySelectorAll('.message');

            for (let i = 0; i < globalScript.length; i++) {
                if (isStopping) break;

                const line = globalScript[i];

                // UI æ›´æ–°
                messages.forEach(m => m.classList.remove('playing'));
                if (messages[i]) {
                    messages[i].classList.add('playing');
                    messages[i].scrollIntoView({ behavior: "smooth", block: "center" });
                }

                // æ˜¾ç¤ºæ­£åœ¨åˆæˆçŠ¶æ€ï¼ˆå…³é”®ï¼è®©ç”¨æˆ·çŸ¥é“åœ¨å·¥ä½œï¼‰
                ui.playerText.innerText = `â³ æ­£åœ¨åˆæˆ... ${line.speaker}: ${line.text.slice(0, 30)}...`;
                ui.playerText.style.color = '#f59e0b'; // æ©™è‰²è¡¨ç¤ºå¤„ç†ä¸­

                try {
                    if (engine === 'native') await TTS_ENGINE.speakNative(line.text, line.speaker);
                    else if (engine === 'openai') await TTS_ENGINE.speakOpenAI(line.text, line.speaker);
                    else if (engine === 'siliconflow') await TTS_ENGINE.speakSiliconFlow(line.text, line.speaker);

                    // æˆåŠŸåæ¢å¤æ­£å¸¸é¢œè‰²
                    ui.playerText.style.color = '';
                } catch (e) {
                    // é”™è¯¯ï¼šä½¿ç”¨ alert ç¡®ä¿ç”¨æˆ·çœ‹åˆ°
                    ui.playerText.innerText = `âŒ é”™è¯¯: ${e.message}`;
                    ui.playerText.style.color = '#ef4444'; // çº¢è‰²
                    console.error('[TTS] æ’­æ”¾å‡ºé”™:', e.message);
                    alert(`TTS é”™è¯¯: ${e.message}\n\nè¯·æ£€æŸ¥:\n1. key-manager æ˜¯å¦å·²è®¾ç½® siliconflow_key\n2. å­˜å‚¨æ¨¡å¼æ˜¯å¦ä¸º localStorage`);
                    isStopping = true;
                    ui.playerBar.style.display = 'none';
                    break;
                }

                // åœé¡¿æ„Ÿ
                await new Promise(r => setTimeout(r, 500));
            }

            // æ’­æ”¾å®Œæˆï¼Œæ˜¾ç¤ºä¸‹è½½æŒ‰é’®ï¼ˆOpenAI å’Œ SiliconFlowï¼‰
            if (!isStopping && (engine === 'openai' || engine === 'siliconflow')) {
                AUDIO_RECORDER.stop();
                if (AUDIO_RECORDER.canDownload()) {
                    btnDownload.style.display = 'inline-block';
                    ui.playerText.innerText = `æ’­æ”¾å®Œæˆï¼å…± ${AUDIO_RECORDER.getCount()} æ®µï¼Œå¯ä¸‹è½½`;
                }
            } else {
                ui.playerBar.style.display = 'none';
            }
        };

        document.getElementById('btnStop').onclick = () => {
            isStopping = true;
            speechSynthesis.cancel();
            // åœæ­¢æ—¶ä¹Ÿå¯ä»¥ä¸‹è½½å·²æ’­æ”¾éƒ¨åˆ†
            if (AUDIO_RECORDER.canDownload()) {
                AUDIO_RECORDER.stop();
                btnDownload.style.display = 'inline-block';
                ui.playerText.innerText = `å·²åœæ­¢ï¼Œå…± ${AUDIO_RECORDER.getCount()} æ®µå¯ä¸‹è½½`;
            } else {
                ui.playerBar.style.display = 'none';
            }
        };

        // ä¸‹è½½æŒ‰é’®äº‹ä»¶
        btnDownload.onclick = () => {
            AUDIO_RECORDER.download('docupod_podcast.mp3');
        };

    </script>
</body>

</html>