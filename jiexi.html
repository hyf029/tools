<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç»´æ·±åº¦è§£æå™¨ v6.0 (Logic Chain)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script type="application/json" id="tool_meta">
    {
        "tool_id": "ai-insight-refractor-v6",
        "tool_name": "å…¨ç»´æ·±åº¦è§£æå™¨ (é€»è¾‘é“¾ç‰ˆ)",
        "tool_version": "6.0.0",
        "capabilities": { "networking": true, "ai": true, "download_output": true },
        "ai_integration": {
            "uses_key_manager": true,
            "providers": ["siliconflow", "openrouter", "deepseek", "custom"]
        }
    }
    </script>

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .markdown-body {
            font-size: 0.95rem;
            line-height: 1.75;
            color: #334155;
        }

        .markdown-body h1,
        .markdown-body h2 {
            font-weight: 800;
            color: #0f172a;
            margin: 1.2em 0 0.6em;
            font-size: 1.1em;
            letter-spacing: -0.01em;
        }

        .markdown-body strong {
            color: #1e40af;
            font-weight: 700;
            background: rgba(59, 130, 246, 0.05);
            padding: 0 3px;
            border-radius: 2px;
        }

        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.4em;
            margin-bottom: 0.8em;
        }

        .markdown-body li {
            margin-bottom: 0.25em;
        }

        /* ä¿®å¤ç§»åŠ¨ç«¯ä»£ç å—æº¢å‡º */
        .markdown-body pre {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            /* å…³é”®ä¿®å¤ */
            margin: 1em 0;
        }

        .markdown-body code {
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            background-color: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            color: #db2777;
        }

        .markdown-body pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }

        .markdown-body img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        /* é˜¶æ®µæ ‡è¯†å¾½ç«  */
        .stage-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .stage-1 {
            background: #e0f2fe;
            color: #0369a1;
            border: 1px solid #bae6fd;
        }

        .stage-2 {
            background: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        .stage-3 {
            background: #faf5ff;
            color: #7e22ce;
            border: 1px solid #e9d5ff;
        }

        /* æ¸è¿›å¼æ˜¾ç¤ºåŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* === æ²‰æµ¸é˜…è¯»å™¨æ ·å¼ Pro === */
        #reading-modal {
            transition: opacity 0.3s ease;
        }

        #reading-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #reading-modal:not(.hidden) {
            opacity: 1;
            pointer-events: auto;
        }

        /* é˜…è¯»å™¨å†…éƒ¨æ’ç‰ˆå¢å¼º */
        .prose-focus {
            font-size: 1.05rem;
            line-height: 1.8;
            color: #374151;
            max-width: 100%;
        }

        .prose-focus p {
            margin-bottom: 1.2em;
            text-align: justify;
        }

        .prose-focus h1,
        .prose-focus h2 {
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            padding-bottom: 0.3em;
            border-bottom: 2px solid #e2e8f0;
            color: #1e293b;
            font-size: 1.4em;
        }

        .prose-focus h3 {
            margin-top: 1.2em;
            margin-bottom: 0.5em;
            font-size: 1.2em;
            color: #334155;
            font-weight: 700;
        }

        .prose-focus blockquote {
            background: #f8fafc;
            border-left: 4px solid #6366f1;
            padding: 1em 1.2em;
            margin: 1.5em 0;
            font-style: italic;
            color: #475569;
            border-radius: 0 8px 8px 0;
        }

        .prose-focus ul,
        .prose-focus ol {
            padding-left: 1.6em;
            margin-bottom: 1.2em;
        }

        .prose-focus li {
            margin-bottom: 0.5em;
        }

        .prose-focus li::marker {
            color: #6366f1;
            font-weight: bold;
        }

        .prose-focus strong {
            color: #1e40af;
            background: rgba(99, 102, 241, 0.1);
            padding: 0 4px;
        }

        .prose-focus code {
            font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
            background-color: #f1f5f9;
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            color: #db2777;
        }

        .prose-focus pre {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5em 0;
        }

        .prose-focus pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        <header
            class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6 border-b border-slate-200 pb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-3">
                    å…¨ç»´æ·±åº¦è§£æå™¨
                    <span class="text-white text-xs align-top font-mono bg-indigo-600 px-2 py-1 rounded shadow-sm">v6.0
                        Logic Chain</span>
                </h1>
                <p class="text-slate-500 mt-2 text-sm">3-Stage Waterfall Analysis: Roots â†’ Trunk â†’ Branches</p>
            </div>
            <div class="flex gap-2">
                <button onclick="app.copyAllMD()"
                    class="text-xs bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-medium py-2 px-3 rounded shadow-sm flex items-center gap-1">
                    ğŸ“‹ å¤åˆ¶å…¨éƒ¨ MD
                </button>
                <button onclick="app.downloadAllPDF()"
                    class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-3 rounded shadow-sm flex items-center gap-1">
                    ğŸ“„ ä¸‹è½½å…¨éƒ¨ PDF
                </button>
            </div>
        </header>

        <div id="aiSettingsMount" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6"></div>

        <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 transition-all hover:shadow-xl relative">
            <div class="flex justify-between items-baseline mb-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">åŸå§‹ç´ æ (Raw Context)</label>
                <div class="flex gap-3">
                    <input type="file" id="file-upload" class="hidden" accept=".pdf,.docx,.txt"
                        onchange="app.handleFileUpload(this.files[0])">
                    <button onclick="document.getElementById('file-upload').click()"
                        class="text-xs text-indigo-600 hover:text-indigo-800 font-bold flex items-center gap-1 transition-colors">
                        ğŸ“‚ å¯¼å…¥æ–‡æ¡£ (PDF/Word)
                    </button>
                    <button onclick="document.getElementById('input-text').value=''"
                        class="text-xs text-slate-400 hover:text-red-500 transition-colors">CLEAR</button>
                </div>
            </div>
            <textarea id="input-text" rows="5"
                class="w-full bg-slate-50 border border-slate-300 rounded-lg p-4 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono transition-all resize-y"
                placeholder="åœ¨æ­¤ç²˜è´´å¤æ‚çš„å•†ä¸šæ€è€ƒã€ä¼šè®®è®°å½•æˆ–è¡Œä¸šæŠ¥å‘Š..."></textarea>

            <button onclick="app.runPipeline()" id="btn-analyze"
                class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md">
                <span>å¯åŠ¨é“¾å¼æ¨æ¼” (Start Pipeline)</span>
                <span id="pipeline-loader" class="loader hidden"
                    style="border-color: rgba(255,255,255,0.3); border-top-color: white;"></span>
            </button>
        </div>

        <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 pb-20">
        </div>
    </div>

    <script>
        const AI_MODULE = (() => {
            // AI Providers é…ç½®ï¼ˆä¸ key-manager åŒæ­¥ï¼‰
            const AI_PROVIDERS = {
                "siliconflow": {
                    name: "ç¡…åŸºæµåŠ¨ (SiliconFlow)",
                    keyName: "siliconflow_key",
                    baseUrl: "https://api.siliconflow.cn/v1",
                    models: [
                        { id: "Qwen/Qwen2.5-7B-Instruct", name: "Qwen 2.5 7Bï¼ˆFastï¼‰" },
                        { id: "deepseek-ai/DeepSeek-V3", name: "DeepSeek V3" },
                        { id: "Pro/zai-org/GLM-4.7", name: "GLM-4.7" },
                        { id: "Pro/moonshotai/Kimi-K2-Thinking", name: "Kimi K2ï¼ˆThinkingï¼‰" },
                        { id: "Qwen/Qwen3-VL-32B-Thinking", name: "Qwen 3 VL 32Bï¼ˆThinkingï¼‰" }
                    ]
                },
                "openrouter": {
                    name: "OpenRouter",
                    keyName: "openrouter_key",
                    baseUrl: "https://openrouter.ai/api/v1",
                    models: [
                        { id: "openai/gpt-4o", name: "GPT-4o" },
                        { id: "google/gemini-pro", name: "Gemini Pro" },
                        { id: "anthropic/claude-opus-4.5", name: "Claude Opus 4.5" },
                        { id: "openai/gpt-5.2-pro", name: "GPT-5.2 Pro" },
                        { id: "google/gemini-3-pro-preview", name: "Gemini 3 Pro Preview" }
                    ]
                },
                "deepseek": {
                    name: "DeepSeek Official",
                    keyName: "deepseek_key",
                    baseUrl: "https://api.deepseek.com",
                    models: [{ id: "deepseek-chat", name: "DeepSeek V3" }]
                },
                "custom": {
                    name: "è‡ªå®šä¹‰ / æœ¬åœ°ï¼ˆOllamaï¼‰",
                    keyName: "custom_key",
                    baseUrl: "http://localhost:11434/v1",
                    models: []
                }
            };

            // è·å– Keyï¼ˆå…¼å®¹ localStorage å’Œ sessionStorageï¼‰
            function getKey(keyName) {
                return localStorage.getItem(keyName) || sessionStorage.getItem(keyName) || '';
            }

            function getHostname(u) { try { return new URL(u).hostname } catch { return "" } }

            function checkDomain(u) {
                const h = getHostname(u);
                const allow = ["api.siliconflow.cn", "openrouter.ai", "api.deepseek.com", "api.openai.com", "localhost", "127.0.0.1"];
                if (!allow.includes(h)) {
                    const k = "ai_domain_consent_v1", s = localStorage.getItem(k) || "{}", o = JSON.parse(s);
                    if (!o[h] && !confirm(`å…è®¸è¯·æ±‚åŸŸå ${h}?`)) throw new Error("åŸŸåæœªæˆæƒ");
                    o[h] = true; localStorage.setItem(k, JSON.stringify(o));
                }
            }

            async function callAI({ base, key, model, msgs }) {
                checkDomain(base);
                if (!key) throw new Error("Missing API Key. è¯·åœ¨ key-manager è®¾ç½®å¯¹åº” Key");
                const res = await fetch(`${base.replace(/\/+$/, "")}/chat/completions`, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json", "HTTP-Referer": window.location.href },
                    body: JSON.stringify({ model, messages: msgs, temperature: 0.7, max_tokens: 2000 })
                });
                if (!res.ok) throw new Error(`API Error ${res.status}`);
                const data = await res.json();
                return data.choices?.[0]?.message?.content || "";
            }

            return {
                mount: (el) => {
                    let s = { p: "siliconflow", u: "", m: "", net: false };
                    const render = () => {
                        const p = AI_PROVIDERS[s.p];
                        const key = getKey(p.keyName);
                        const keyStatus = key ? "âœ… Ready" : "âŒ No Key";
                        const modelOptions = p.models.map(m =>
                            `<option value="${m.id}" ${m.id === (s.m || p.models[0]?.id) ? 'selected' : ''}>${m.name}</option>`
                        ).join("");

                        el.innerHTML = `
                            <details class="text-xs border p-3 rounded-lg bg-slate-50" open>
                                <summary class="font-bold cursor-pointer text-slate-700">âš™ï¸ AI è®¾ç½® (${p.name}) - ${keyStatus}</summary>
                                <div class="mt-3 grid gap-3">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" id="net" ${s.net ? 'checked' : ''} class="w-4 h-4">
                                        <label for="net" class="text-slate-600">å¯ç”¨ç½‘ç»œè°ƒç”¨</label>
                                        <a href="key-manager.html" target="_blank" class="ml-auto text-blue-500 hover:underline">ğŸ”‘ ç®¡ç† Key</a>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <select id="prov" class="border p-2 rounded bg-white">
                                            ${Object.keys(AI_PROVIDERS).map(k => `<option value="${k}" ${k === s.p ? 'selected' : ''}>${AI_PROVIDERS[k].name}</option>`).join("")}
                                        </select>
                                        <select id="mod" class="border p-2 rounded bg-white">
                                            ${modelOptions}
                                            <option value="">-- è‡ªå®šä¹‰ --</option>
                                        </select>
                                        <input id="modCustom" class="border p-2 rounded ${s.m && !p.models.find(m => m.id === s.m) ? '' : 'hidden'}" value="${s.m}" placeholder="Model ID">
                                    </div>
                                    <input id="base" class="border p-2 rounded" value="${s.u || p.baseUrl}" placeholder="Base URL">
                                </div>
                            </details>`;

                        el.querySelector('#prov').onchange = e => { s.p = e.target.value; s.u = ""; s.m = ""; render() };
                        el.querySelector('#base').onchange = e => s.u = e.target.value;
                        el.querySelector('#mod').onchange = e => {
                            s.m = e.target.value;
                            el.querySelector('#modCustom').classList.toggle('hidden', !!e.target.value);
                        };
                        el.querySelector('#modCustom').onchange = e => s.m = e.target.value;
                        el.querySelector('#net').onchange = e => s.net = e.target.checked;
                        if (!s.u) s.u = p.baseUrl;
                        if (!s.m) s.m = p.models[0]?.id || "";
                    };
                    render();
                    return {
                        call: (msgs) => {
                            if (!s.net) throw new Error("è¯·å…ˆå‹¾é€‰ã€Œå¯ç”¨ç½‘ç»œè°ƒç”¨ã€");
                            const p = AI_PROVIDERS[s.p];
                            return callAI({ base: s.u, key: getKey(p.keyName), model: s.m, msgs });
                        }
                    }
                }
            };
        })();

        /**
         * v6.0 App Logic: The Logic Chain
         */
        const app = (() => {
            // å®šä¹‰ DAG (æœ‰å‘æ— ç¯å›¾) ç»“æ„
            // dependency æŒ‡å‘çš„æ˜¯ä¸Šæ¸¸ Agent ID
            const AGENTS = [
                // ================================
                // STAGE 1: ROOTS (å®šæ€§ä¸è§£æ„)
                // ================================
                {
                    id: 'strategy', stage: 1,
                    title: 'æˆ˜ç•¥æ´å¯Ÿ (Strategy)', icon: 'â™Ÿï¸', color: 'border-blue-500',
                    desc: "å®šä¹‰æ ¸å¿ƒä»·å€¼ä¸æ–¹å‘",
                    // æ»¡è¡€ç‰ˆ Promptï¼šå¼•å…¥ MECE å’Œ SCQA
                    prompt: `ä½ æ˜¯ç”±éº¦è‚¯é”¡å‰å…¨çƒåˆä¼™äººä¸çº¢æ‰èµ„æœ¬æŠ•èµ„äººç»„æˆçš„æ™ºå›Šå›¢ã€‚
è¯·é˜…è¯»ç”¨æˆ·æä¾›çš„ [åŸå§‹ç´ æ]ï¼Œè¿ç”¨ **MECEåŸåˆ™** å’Œ **SCQAæ¨¡å‹**ï¼Œæ·±åº¦è§£æ„å…¶èƒŒåçš„æˆ˜ç•¥ä»·å€¼ã€‚

è¯·è¾“å‡º 5 ä¸ªæœ€é«˜ä»·å€¼çš„æˆ˜ç•¥æ´å¯Ÿï¼Œæ¯ä¸ªæ´å¯Ÿä¸¥æ ¼åŒ…å«ï¼š
1. **æ´å¯Ÿå†…æ ¸**ï¼šä¸€å¥åç›´è§‰çš„æ€»ç»“ã€‚
2. **å†³ç­–æ˜ å°„**ï¼šå…·ä½“æŒ‡å¯¼äº†å“ªä¸€é¡¹å•†ä¸šå†³ç­–ï¼Ÿï¼ˆæ‰©å¼ /æ”¶ç¼©/è‡ªç ”/å¤–åŒ…ï¼Ÿï¼‰
3. **äºŒé˜¶æ•ˆåº”**ï¼šé•¿æœŸæ¥çœ‹ï¼ˆ3-5å¹´ï¼‰ä¼šäº§ç”Ÿä»€ä¹ˆè¿é”ååº”ï¼Ÿ

[çº¦æŸ]ï¼šæ‹’ç»ç½—åˆ—æ‘˜è¦ï¼Œå¿…é¡»è¾“å‡ºç»è¿‡åŠ å·¥çš„â€œæ´å¯Ÿâ€ã€‚`
                },
                {
                    id: 'system', stage: 1,
                    title: 'ç³»ç»Ÿæ¨¡å‹ (System)', icon: 'ğŸ—ï¸', color: 'border-blue-500',
                    desc: "æŠ½è±¡åº•å±‚ IPO é€»è¾‘",
                    // æ»¡è¡€ç‰ˆ Promptï¼šå¼•å…¥ IPO æ¨¡å‹
                    prompt: `ä½ æ˜¯æ‹¥æœ‰20å¹´ç»éªŒçš„ç³»ç»Ÿæ¶æ„å¸ˆã€‚è¯·å¿½ç•¥æƒ…ç»ªå’Œä¿®è¾ï¼Œæå– [åŸå§‹ç´ æ] åº•å±‚çš„ **IPO æ¨¡å‹**ã€‚

è¯·æ„å»ºç³»ç»Ÿæ¨¡å‹ï¼š
- **ğŸ“¦ è¾“å…¥ (Input)**ï¼šå¯åŠ¨ç³»ç»Ÿéœ€è¦ä»€ä¹ˆåŸææ–™ï¼Ÿï¼ˆèµ„é‡‘/æ•°æ®/è®¤çŸ¥ï¼Ÿï¼‰
- **âš™ï¸ é»‘ç›’é€»è¾‘ (Process)**ï¼šæ ¸å¿ƒå¤„ç†æ­¥éª¤æ˜¯ä»€ä¹ˆï¼Ÿè¯·ç”¨ä¼ªä»£ç æˆ–æµç¨‹å›¾é€»è¾‘æè¿°ã€‚
- **ğŸ è¾“å‡º (Output)**ï¼šäº§å‡ºä»€ä¹ˆæ ‡å‡†åŒ–ç»“æœï¼Ÿ
- **ğŸ”„ å¢å¼ºå›è·¯ (Feedback)**ï¼šå¦‚ä½•è®¾è®¡åé¦ˆæœºåˆ¶ï¼Œè®©ç³»ç»Ÿäº§ç”Ÿé£è½®æ•ˆåº”ï¼Ÿ`
                },

                // ================================
                // STAGE 2: TRUNK (è½¬åŒ–ä¸åº”ç”¨)
                // ================================
                {
                    id: 'action', stage: 2, dependency: ['strategy'],
                    title: 'æ‰§è¡Œè½åœ° (Action)', icon: 'ğŸš€', color: 'border-green-500',
                    desc: "åŸºäºæˆ˜ç•¥åˆ¶å®šè®¡åˆ’",
                    // ä¼˜åŒ–ç‚¹ï¼šé™æ€ Prompt å®šä¹‰è§’è‰²ï¼ŒContext è´Ÿè´£æ³¨å…¥æŒ‡ä»¤
                    prompt: `ä½ æ˜¯å­—èŠ‚è·³åŠ¨é£æ ¼çš„é«˜çº§é¡¹ç›®ç»ç†ï¼ˆPMOï¼‰ã€‚ä½ çš„ä¿¡æ¡æ˜¯â€œæ²¡æœ‰è½åœ°ï¼Œæˆ˜ç•¥å°±æ˜¯å¹»è§‰â€ã€‚
ä½ å°†æ¥æ”¶ä¸€ä»½ [æˆ˜ç•¥æ´å¯ŸæŠ¥å‘Š] å’Œ [åŸå§‹ç´ æ]ã€‚

ä»»åŠ¡ï¼šå°†â€œæˆ˜ç•¥â€é™ç»´ä¸ºâ€œåŠ¨ä½œâ€ã€‚
è¾“å‡ºï¼š5æ­¥èµ°çš„ **Action Plan**ã€‚æ¯ä¸€æ­¥åŒ…å«ï¼š
1. **Action**ï¼šåŠ¨è¯å¼€å¤´ã€‚
2. **Owner**ï¼šå…·ä½“è´£ä»»è§’è‰²ã€‚
3. **KPI/äº¤ä»˜ç‰©**ï¼šå¦‚ä½•è¯æ˜åšå®Œäº†ï¼Ÿ
4. **Quick Win**ï¼š24å°æ—¶å†…å¯è§çš„é€Ÿèƒœç‚¹ã€‚`,
                    // åŠ¨æ€æ³¨å…¥é€»è¾‘
                    contextPrompt: (res) => `ã€é‡è¦æŒ‡ä»¤ã€‘ï¼šè¯·å¿½ç•¥åŸå§‹ç´ æä¸­çš„æ¬¡è¦ä¿¡æ¯ï¼Œ**å¿…é¡»**èšç„¦äºå®ç°ä»¥ä¸‹æˆ˜ç•¥æ–¹å‘ï¼š\n"""\n${res.strategy}\n"""\n\nè¯·åŸºäºæ­¤æˆ˜ç•¥åˆ¶å®šæ‰§è¡Œè®¡åˆ’ã€‚`
                },
                {
                    id: 'leverage', stage: 2, dependency: ['system'],
                    title: 'æ æ†æ”¯ç‚¹ (Leverage)', icon: 'ğŸ”§', color: 'border-green-500',
                    desc: "åŸºäºç³»ç»Ÿå¯»æ‰¾ç“¶é¢ˆ",
                    prompt: `ä½ æ˜¯ä¸€åâ€œæ æ†ç‡å¤§å¸ˆâ€ã€‚ä½ ç›¸ä¿¡â€œå››ä¸¤æ‹¨åƒæ–¤â€ã€‚
ä½ å°†æ¥æ”¶ä¸€ä»½ [ç³»ç»Ÿæ¶æ„å›¾] å’Œ [åŸå§‹ç´ æ]ã€‚

ä»»åŠ¡ï¼šåœ¨è¿™ä¸ªç³»ç»Ÿä¸­æ‰¾å‡ºé«˜å›æŠ¥ç‚¹ã€‚
è¾“å‡ºï¼š
1. **âš™ï¸ å…³é”®é½¿è½®**ï¼šä¼˜åŒ–10%å¸¦æ¥50%æå‡çš„å¾®å°ç¯èŠ‚ã€‚
2. **â³ å…³é”®ç“¶é¢ˆ**ï¼šé™åˆ¶ç³»ç»Ÿé€Ÿåº¦çš„å•ä¸€å› ç´ ã€‚
3. **ğŸ¡ å¤šç±³è¯ºéª¨ç‰Œ**ï¼šæ¨å€’å“ªä¸€å—ï¼Œå¯è§¦å‘è¿é”æˆåŠŸï¼Ÿ`,
                    contextPrompt: (res) => `ã€é‡è¦æŒ‡ä»¤ã€‘ï¼šè¯·æ·±å…¥åˆ†æä»¥ä¸‹ç³»ç»Ÿæ¨¡å‹ï¼š\n"""\n${res.system}\n"""\n\nè¯·æŒ‡å‡ºè¿™ä¸ªå…·ä½“æ¨¡å‹çš„â€œä¸ƒå¯¸â€åœ¨å“ªé‡Œï¼Ÿ`
                },
                {
                    id: 'persona', stage: 2, dependency: ['strategy'],
                    title: 'åˆ©ç›Šç›¸å…³è€… (Persona)', icon: 'ğŸ©', color: 'border-green-500',
                    desc: "åŸºäºæˆ˜ç•¥è¯„ä¼°ååº”",
                    prompt: `ä½ æ˜¯ç²¾é€šç»„ç»‡è¡Œä¸ºå­¦çš„å’¨è¯¢é¡¾é—®ã€‚
ä½ å°†æ¥æ”¶ä¸€ä»½ [æˆ˜ç•¥æ–¹å‘] å’Œ [åŸå§‹ç´ æ]ã€‚

ä»»åŠ¡ï¼šæ¨¡æ‹Ÿä»¥ä¸‹è§’è‰²å¯¹è¯¥æˆ˜ç•¥çš„çœŸå®å¿ƒç†ååº”ï¼ˆæ½œå°è¯ä¸ææƒ§ï¼‰ï¼š
1. **ğŸ¦ å¢é•¿é»‘å®¢**ï¼šåªå…³å¿ƒæµé‡ã€CACã€LTVã€‚ä»–è§‰å¾—è¿™èƒ½å˜ç°å—ï¼Ÿ
2. **ğŸ¦‰ CFO**ï¼šåªå…³å¿ƒROIå’Œé£é™©ã€‚ä»–æ‹…å¿ƒé¢„ç®—å¤±æ§å—ï¼Ÿ
3. **ğŸ¢ æŠ€æœ¯è´Ÿè´£äºº**ï¼šåªå…³å¿ƒå¯è¡Œæ€§å’ŒæŠ€æœ¯å€ºã€‚ä»–è§‰å¾—è¿™æ˜¯ä¼ªéœ€æ±‚å—ï¼Ÿ`,
                    contextPrompt: (res) => `ã€é‡è¦æŒ‡ä»¤ã€‘ï¼šå‡è®¾å…¬å¸å†³å®šå…¨æ ¼æ‰§è¡Œä»¥ä¸‹æˆ˜ç•¥ï¼š\n"""\n${res.strategy}\n"""\n\nè¯·åˆ†æä¸Šè¿°ä¸‰ä½é«˜ç®¡ä¼šå¦‚ä½• challengeï¼ˆæŒ‘æˆ˜ï¼‰è¿™ä¸ªæˆ˜ç•¥ï¼Ÿ`
                },

                // ================================
                // STAGE 3: BRANCHES (æ‰¹åˆ¤ä¸åæ€)
                // ================================
                {
                    id: 'assumption', stage: 3, dependency: ['strategy', 'action'],
                    title: 'çº¢é˜Ÿæµ‹è¯• (Red Team)', icon: 'ğŸ”', color: 'border-purple-500',
                    desc: "æ”»å‡»æˆ˜ç•¥ä¸æ‰§è¡Œ",
                    prompt: `ä½ æ˜¯â€œçº¢é˜Ÿæµ‹è¯•â€æŒ‡æŒ¥å®˜ã€‚ä½ çš„ä»»åŠ¡ä¸æ˜¯èµåŒï¼Œè€Œæ˜¯**æ”»å‡»**ã€‚
ä½ å°†çœ‹åˆ°å®Œæ•´çš„ [æˆ˜ç•¥] å’Œ [æ‰§è¡Œè®¡åˆ’]ã€‚

ä»»åŠ¡ï¼šè¿›è¡Œâ€œäº‹å‰éªŒå°¸ï¼ˆPre-mortemï¼‰â€ã€‚
è¾“å‡ºï¼š
1. **è‡´å‘½éšæ€§å‡è®¾**ï¼šæ•´ä¸ªè®¡åˆ’å»ºç«‹åœ¨ä»€ä¹ˆï¼ˆå¯èƒ½ä¸å­˜åœ¨çš„ï¼‰å‰æä¸Šï¼Ÿ
2. **å´©å¡Œæ¨æ¼”**ï¼šå¦‚æœè¯¥å‡è®¾é”™è¯¯ï¼Œè®¡åˆ’å¦‚ä½•å¤±è´¥ï¼Ÿ
3. **é˜²å¾¡å»ºè®®**ï¼šå¦‚ä½•è®¾è®¡ä½æˆæœ¬å®éªŒéªŒè¯å‡è®¾ï¼Ÿ`,
                    contextPrompt: (res) => `ã€æ”»å‡»ç›®æ ‡ã€‘ï¼š\næˆ˜ç•¥å±‚ï¼š\n${res.strategy}\n\næ‰§è¡Œå±‚ï¼š\n${res.action}\n\nè¯·æ‰¾å‡ºä¸Šè¿°æ–¹æ¡ˆé€»è¾‘é“¾æ¡ä¸­çš„æ–­è£‚ç‚¹ã€‚`
                },
                {
                    id: 'debate', stage: 3, dependency: ['strategy'],
                    title: 'è§‚ç‚¹å¯¹æ ‡ (Debate)', icon: 'âš–ï¸', color: 'border-purple-500',
                    desc: "å¯»æ‰¾å¯¹ç«‹é¢",
                    prompt: `ä½ æ˜¯ä¸–ç•Œçº§è¾©è®ºèµ›ä¸»å¸­ã€‚
ä»»åŠ¡ï¼šå¼•å…¥ç«äº‰æ€§è§‚ç‚¹ï¼Œæ‰“ç ´ä¿¡æ¯èŒ§æˆ¿ã€‚

è¾“å‡ºï¼š
1. **æ­£æ–¹ (åŸæ–‡æˆ˜ç•¥)**ï¼šé€‚ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ
2. **åæ–¹ (ç«äº‰è§‚ç‚¹)**ï¼šè°ä¼šå¼ºçƒˆåå¯¹è¯¥æˆ˜ç•¥ï¼Ÿç†ç”±æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆéç¨»è‰äººæ”»å‡»ï¼‰ã€‚
3. **åˆé¢˜ (Synthesis)**ï¼šåœ¨ä»€ä¹ˆèƒŒæ™¯ä¸‹Aæ›´å¥½ï¼Ÿä»€ä¹ˆèƒŒæ™¯ä¸‹Bæ›´å¥½ï¼Ÿ`,
                    contextPrompt: (res) => `ã€è¾©é¢˜æ ¸å¿ƒã€‘ï¼š\n${res.strategy}\n\nè¯·é’ˆå¯¹ä¸Šè¿°æ ¸å¿ƒè§‚ç‚¹ï¼Œå¯»æ‰¾å…¶é€»è¾‘å¯¹ç«‹é¢ã€‚`
                },
                {
                    id: 'contrarian', stage: 3, dependency: ['system', 'strategy'],
                    title: 'é€†å‘æ€ç»´ (Contrarian)', icon: 'âš¡', color: 'border-purple-500',
                    desc: "å¯»æ‰¾åå…±è¯†",
                    prompt: `ä½ æ˜¯ Peter Thiel çš„ AI åˆ†èº«ã€‚ä½ å¯»æ‰¾è¢«å¿½è§†çš„çœŸç†ã€‚
ä»»åŠ¡ï¼šåŸºäº [ç³»ç»Ÿ] å’Œ [æˆ˜ç•¥]ï¼Œå›ç­”â€œåœ¨ä»€ä¹ˆé‡è¦é—®é¢˜ä¸Šï¼Œä½ ä¸å¤§å¤šæ•°äººçœ‹æ³•ä¸åŒï¼Ÿâ€

è¾“å‡ºï¼š
1. **å¹³åº¸çš„å…±è¯†**ï¼šåŸºäºä¸Šè¿°ææ–™ï¼Œå¤§å¤šæ•°äººä¼šå¾—å‡ºçš„ç»“è®ºæ˜¯ä»€ä¹ˆï¼Ÿ
2. **åå…±è¯†çœŸç†**ï¼šå“ªä¸ªè¢«å¿½è§†çš„è§†è§’æ‰æ˜¯çœŸç›¸ï¼Ÿ
3. **ä»·å€¼éªŒè¯**ï¼šä¸ºä»€ä¹ˆåå…±è¯†æ‰èƒ½å¸¦æ¥è¶…é¢å›æŠ¥ï¼Ÿ`,
                    contextPrompt: (res) => `ã€åˆ†æå¯¹è±¡ã€‘ï¼š\nç³»ç»Ÿæ¨¡å‹ï¼š${res.system}\næˆ˜ç•¥æ–¹å‘ï¼š${res.strategy}\n\nè¯·æŒ–æ˜éšè—åœ¨ä¸Šè¿°æ˜¾æ€§ä¿¡æ¯èƒŒåçš„åç›´è§‰æ´å¯Ÿã€‚`
                }
            ];

            let ai = null;
            const resultsStore = {}; // å­˜å‚¨æ‰€æœ‰ Agent çš„è¾“å‡ºç»“æœ

            // Stage æ ‡é¢˜é…ç½®
            const STAGE_TITLES = {
                1: { name: 'ROOTS (æ ¹åŸºæ€è€ƒ)', icon: 'ğŸŒ³', desc: 'æˆ˜ç•¥ä¸ç³»ç»Ÿçš„åº•å±‚é€»è¾‘' },
                2: { name: 'TRUNK (ä¸»å¹²å»¶ä¼¸)', icon: 'ğŸŒ¿', desc: 'åŸºäºæ ¹åŸºå±•å¼€æ‰§è¡Œä¸æ æ†' },
                3: { name: 'BRANCHES (åˆ†æ”¯éªŒè¯)', icon: 'ğŸƒ', desc: 'æ‰¹åˆ¤æ€§æ€ç»´ä¸åå‘éªŒè¯' }
            };

            function init() {
                // é…ç½® PDF.js Worker
                if (window.pdfjsLib) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }

                ai = AI_MODULE.mount(document.getElementById("aiSettingsMount"));
                // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºç©ºç™½æç¤º
                const grid = document.getElementById('results-grid');
                grid.innerHTML = `<div class="col-span-full text-center text-slate-400 py-20">
                    <p class="text-lg">ğŸ‘† è¾“å…¥æ–‡æœ¬åç‚¹å‡»ã€Œå¯åŠ¨é“¾å¼æ¨æ¼”ã€å¼€å§‹åˆ†æ</p>
                </div>`;

                // æ‹–æ‹½æ–‡ä»¶æ”¯æŒ
                const dropZone = document.getElementById('input-text');
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });

                function highlight(e) {
                    dropZone.classList.add('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');
                }

                function unhighlight(e) {
                    dropZone.classList.remove('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');
                }

                dropZone.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length) handleFileUpload(files[0]);
                }
            }

            // æ¸…ç©º Grid
            function clearGrid() {
                document.getElementById('results-grid').innerHTML = '';
            }

            // æ¸²æŸ“æŒ‡å®š Stage çš„å¡ç‰‡
            function renderStage(stageNum) {
                const grid = document.getElementById('results-grid');
                const stageAgents = AGENTS.filter(a => a.stage === stageNum);
                const stageInfo = STAGE_TITLES[stageNum];

                // æ·»åŠ  Stage æ ‡é¢˜
                grid.insertAdjacentHTML('beforeend', `
                    <div class="col-span-full mt-6 mb-3 stage-section animate-fadeIn">
                        <div class="flex items-center gap-3 mb-1">
                            <span class="text-2xl">${stageInfo.icon}</span>
                            <h2 class="text-lg font-bold text-slate-700">Stage ${stageNum}: ${stageInfo.name}</h2>
                        </div>
                        <p class="text-xs text-slate-400 ml-9">${stageInfo.desc}</p>
                    </div>
                `);

                // æ·»åŠ è¯¥ Stage çš„ Agent å¡ç‰‡
                stageAgents.forEach(a => {
                    grid.insertAdjacentHTML('beforeend', `
                        <div class="bg-white rounded-lg shadow border-t-4 ${a.color} p-5 flex flex-col min-h-[12rem] h-auto md:h-96 hover:shadow-lg transition-all relative animate-fadeIn">
                            <div class="absolute top-2 right-2 flex gap-1">
                                <button onclick="app.retryAgent('${a.id}')" title="é‡è¯•ç”Ÿæˆ" 
                                    class="text-[10px] p-1.5 md:px-1.5 md:py-0.5 bg-orange-50 hover:bg-orange-100 text-orange-600 rounded cursor-pointer transition-colors font-bold">ğŸ”„</button>
                                <button onclick="app.openReader('${a.id}')" title="æ²‰æµ¸é˜…è¯»" 
                                    class="text-[10px] p-1.5 md:px-1.5 md:py-0.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded cursor-pointer transition-colors font-bold">ğŸ”</button>
                                <button onclick="app.copySingleMD('${a.id}')" title="å¤åˆ¶ MD" 
                                    class="text-[10px] p-1.5 md:px-1.5 md:py-0.5 bg-slate-100 hover:bg-slate-200 rounded cursor-pointer transition-colors">ğŸ“‹</button>
                                <button onclick="app.downloadSinglePDF('${a.id}')" title="ä¸‹è½½ PDF"
                                    class="text-[10px] p-1.5 md:px-1.5 md:py-0.5 bg-slate-100 hover:bg-slate-200 rounded cursor-pointer transition-colors">ğŸ“„</button>
                                <span class="stage-badge stage-${a.stage}">Stage ${a.stage}</span>
                            </div>
                            <div class="flex flex-col mb-3 pb-2 border-b border-slate-100">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2 text-base">${a.icon} ${a.title}</h3>
                                <p class="text-[10px] text-slate-400 mt-1">${a.desc}</p>
                            </div>
                            <div id="status-${a.id}" class="text-[10px] font-mono text-slate-400 mb-2">â³ ç­‰å¾…ä¸­...</div>
                            <div id="content-${a.id}" class="flex-1 md:overflow-y-auto overflow-y-visible markdown-body custom-scrollbar pr-1 text-sm bg-slate-50 rounded p-2 border border-slate-100">
                                <div class="h-full flex items-center justify-center text-slate-300 italic text-xs text-center py-8 md:py-0">
                                    å‡†å¤‡åˆ†æ...
                                </div>
                            </div>
                        </div>
                    `);
                });

                // æ»šåŠ¨åˆ°æ–°æ¸²æŸ“çš„ Stage
                const sections = grid.querySelectorAll('.stage-section');
                if (sections.length > 0) {
                    sections[sections.length - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            // ä¿ç•™æ—§å‡½æ•°ï¼ˆå…¼å®¹ï¼‰
            function renderGrid() {
                clearGrid();
                [1, 2, 3].forEach(s => renderStage(s));
            }

            function updateStatus(id, type, msg) {
                const el = document.getElementById(`status-${id}`);
                if (!el) return;
                if (type === 'run') { el.className = "text-blue-600 font-bold animate-pulse text-xs"; el.innerText = "âš™ï¸ " + msg; }
                if (type === 'wait') { el.className = "text-slate-400 text-xs"; el.innerText = "â³ " + msg; }
                if (type === 'done') { el.className = "text-green-600 font-bold text-xs"; el.innerText = "âœ… DONE"; }
                if (type === 'err') { el.className = "text-red-500 font-bold text-xs"; el.innerText = "âŒ ERROR"; }
            }

            function updateContent(id, html) {
                document.getElementById(`content-${id}`).innerHTML = html;
            }

            // --- æ ¸å¿ƒï¼šæµæ°´çº¿è°ƒåº¦å¼•æ“ ---
            async function runPipeline() {
                const rawText = document.getElementById('input-text').value.trim();
                if (!rawText) return alert("è¯·å…ˆè¾“å…¥æ–‡æœ¬");

                const btn = document.getElementById('btn-analyze');
                const loader = document.getElementById('pipeline-loader');
                btn.disabled = true; btn.classList.add('opacity-75'); loader.classList.remove('hidden');

                // æ¸…ç©ºæ—§ç»“æœ
                for (let key in resultsStore) delete resultsStore[key];
                clearGrid();

                try {
                    // STAGE 1: ROOTS (å¹¶è¡Œ)
                    renderStage(1);  // å…ˆæ¸²æŸ“ Stage 1 å¡ç‰‡
                    await runStage(1, rawText);

                    // STAGE 2: TRUNK (å¹¶è¡Œï¼Œä½†ä¾èµ– S1)
                    renderStage(2);  // Stage 1 å®Œæˆåæ¸²æŸ“ Stage 2
                    await runStage(2, rawText);

                    // STAGE 3: BRANCHES (å¹¶è¡Œï¼Œä½†ä¾èµ– S1+S2)
                    renderStage(3);  // Stage 2 å®Œæˆåæ¸²æŸ“ Stage 3
                    await runStage(3, rawText);

                } catch (e) {
                    console.error("Pipeline Fatal Error", e);
                    alert("æµæ°´çº¿æ„å¤–ä¸­æ–­ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–ç½‘ç»œ");
                } finally {
                    btn.disabled = false; btn.classList.remove('opacity-75'); loader.classList.add('hidden');
                }
            }

            async function runStage(stageNum, rawText) {
                const stageAgents = AGENTS.filter(a => a.stage === stageNum);
                console.log(`--- Starting Stage ${stageNum} ---`);

                // Promise.all å®ç°åŒçº§å¹¶è¡Œ
                await Promise.all(stageAgents.map(async (agent) => {
                    updateStatus(agent.id, 'run', 'ANALYZING...');

                    try {
                        // 1. æ„å»º & è°ƒç”¨ (ä½¿ç”¨ç»Ÿä¸€é€»è¾‘)
                        const messages = constructMessages(agent, rawText, resultsStore);
                        const output = await ai.call(messages);

                        // 3. å­˜å‚¨ç»“æœ (ä¾›ä¸‹æ¸¸ä½¿ç”¨) & æ¸²æŸ“
                        resultsStore[agent.id] = output;
                        updateContent(agent.id, marked.parse(output));
                        updateStatus(agent.id, 'done');

                    } catch (e) {
                        console.error(`Agent ${agent.id} failed:`, e);
                        updateContent(agent.id, `<div class="text-red-500 text-xs">${e.message}</div>`);
                        updateStatus(agent.id, 'err');
                        // å³ä½¿å¤±è´¥ï¼Œä¹Ÿä¸è¦æŠŠ resultsStore å¡«ç©ºï¼Œè¿™æ ·ä¸‹æ¸¸ä¼šè§¦å‘â€œä¾èµ–ç¼ºå¤±â€çš„é™çº§é€»è¾‘
                    }
                }));
            }

            // === å¯¼å‡ºå·¥å…·å‡½æ•° ===

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            async function copyToClipboard(text, successMsg = "å·²å¤åˆ¶") {
                try {
                    await navigator.clipboard.writeText(text);
                    alert(successMsg);
                } catch (e) {
                    // é™çº§æ–¹æ¡ˆ
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    alert(successMsg);
                }
            }

            // å•é¡¹å¤åˆ¶ MD
            function copySingleMD(agentId) {
                const agent = AGENTS.find(a => a.id === agentId);
                if (!resultsStore[agentId]) return alert("è¯¥é¡¹æ— æ•°æ®");
                const md = `## ${agent.icon} ${agent.title}\n\n${resultsStore[agentId]}`;
                copyToClipboard(md, `${agent.title} å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`);
            }

            // å•é¡¹ä¸‹è½½ PDF
            function downloadSinglePDF(agentId) {
                const agent = AGENTS.find(a => a.id === agentId);
                if (!resultsStore[agentId]) return alert("è¯¥é¡¹æ— æ•°æ®");
                const el = document.getElementById(`content-${agentId}`);
                const opt = {
                    margin: 10,
                    filename: `${agent.title.replace(/[^\w\u4e00-\u9fa5]/g, '')}_${new Date().toISOString().slice(0, 10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(el).save();
            }

            // æ‰¹é‡å¤åˆ¶ MD
            function copyAllMD() {
                if (Object.keys(resultsStore).length === 0) return alert("æ— æ•°æ®");
                let md = "# å…¨ç»´æ·±åº¦è§£ææŠ¥å‘Š\n\n";
                AGENTS.forEach(a => {
                    if (resultsStore[a.id]) {
                        md += `## ${a.icon} ${a.title}\n\n${resultsStore[a.id]}\n\n---\n\n`;
                    }
                });
                copyToClipboard(md, "å…¨éƒ¨ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
            }

            // æ‰¹é‡ä¸‹è½½ PDF
            function downloadAllPDF() {
                if (Object.keys(resultsStore).length === 0) return alert("æ— æ•°æ®");

                // åˆ›å»ºä¸´æ—¶å®¹å™¨
                const container = document.createElement('div');
                container.style.padding = '20px';
                container.style.fontFamily = 'sans-serif';
                container.innerHTML = `<h1 style="font-size:24px;margin-bottom:20px;color:#1e293b;">å…¨ç»´æ·±åº¦è§£ææŠ¥å‘Š</h1>`;

                AGENTS.forEach(a => {
                    if (resultsStore[a.id]) {
                        container.innerHTML += `
                            <div style="margin-bottom:30px;page-break-inside:avoid;">
                                <h2 style="font-size:16px;color:#334155;border-bottom:1px solid #e2e8f0;padding-bottom:8px;margin-bottom:12px;">
                                    ${a.icon} ${a.title}
                                </h2>
                                <div style="font-size:13px;line-height:1.7;color:#475569;">${marked.parse(resultsStore[a.id])}</div>
                            </div>`;
                    }
                });

                const opt = {
                    margin: 10,
                    filename: `å…¨ç»´è§£ææŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(container).save();
            }

            // æ—§ç‰ˆå¯¼å‡ºï¼ˆä¿ç•™å…¼å®¹ï¼‰
            function exportReport() {
                if (Object.keys(resultsStore).length === 0) return alert("æ— æ•°æ®");
                let md = "# å…¨ç»´æ·±åº¦è§£ææŠ¥å‘Š (v6.0)\n\n";
                AGENTS.forEach(a => {
                    if (resultsStore[a.id]) {
                        md += `## ${a.icon} ${a.title}\n\n${resultsStore[a.id]}\n\n---\n\n`;
                    }
                });
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `Insight_Report_v6_${new Date().toISOString().slice(0, 10)}.md`;
                a.click();
            }

            // æ²‰æµ¸é˜…è¯»æ¨¡å¼é€»è¾‘
            function openReader(agentId) {
                const agent = AGENTS.find(a => a.id === agentId);
                if (!resultsStore[agentId]) return alert("è¯¥é¡¹æ— æ•°æ®");

                const modal = document.getElementById('reading-modal');
                const container = document.getElementById('reader-content');

                // æ¸²æŸ“å†…å®¹
                container.innerHTML = `
                    <h1>${agent.icon} ${agent.title}</h1>
                    <div class="text-slate-500 text-sm mb-8 font-mono">Stage ${agent.stage}: ${STAGE_TITLES[agent.stage].name}</div>
                    ${marked.parse(resultsStore[agentId])}
                `;

                // æ˜¾ç¤º Modal
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // é”å®šèƒŒæ™¯æ»šåŠ¨
            }

            function closeReader() {
                const modal = document.getElementById('reading-modal');
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            }

            // === æ–‡ä»¶å¤„ç†é€»è¾‘ ===
            async function handleFileUpload(file) {
                if (!file) return;

                const btn = document.querySelector('button[onclick*="file-upload"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="loader" style="width:12px;height:12px;border-width:2px;"></span> è§£æä¸­...`;
                btn.disabled = true;

                try {
                    let text = "";
                    if (file.type === "application/pdf") {
                        text = await parsePDF(file);
                    } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                        text = await parseDOCX(file);
                    } else if (file.type === "text/plain") {
                        text = await file.text();
                    } else {
                        throw new Error("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ (ä»…æ”¯æŒ PDF, DOCX, TXT)");
                    }

                    if (!text.trim()) throw new Error("æ— æ³•ä»æ–‡ä»¶ä¸­æå–æ–‡æœ¬");

                    // å¡«å…¥è¾“å…¥æ¡†
                    const textarea = document.getElementById('input-text');
                    const separator = textarea.value.trim() ? "\n\n--- [Uploaded File Content] ---\n\n" : "";
                    textarea.value += separator + text;

                    // é—ªçƒæç¤º
                    textarea.classList.add('bg-indigo-50');
                    setTimeout(() => textarea.classList.remove('bg-indigo-50'), 500);

                } catch (e) {
                    console.error(e);
                    alert("æ–‡ä»¶è§£æå¤±è´¥: " + e.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    document.getElementById('file-upload').value = ''; // é‡ç½® file input
                }
            }

            async function parsePDF(file) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + "\n\n";
                }
                return fullText;
            }

            async function parseDOCX(file) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                return result.value;
            }

            // ç»Ÿä¸€ Prompt æ„å»ºé€»è¾‘
            function constructMessages(agent, rawText, store) {
                let systemPrompt = agent.prompt;

                // åŠ¨æ€ Context æ³¨å…¥
                if (agent.contextPrompt) {
                    const missingDeps = (agent.dependency || []).filter(d => !store[d]);

                    if (missingDeps.length === 0) {
                        // ä¾èµ–å…¨é½
                        const contextInstruction = agent.contextPrompt(store);
                        systemPrompt = `${agent.prompt}\n\n=== ä¸Šä¸‹æ–‡æ³¨å…¥ (CONTEXT INJECTION) ===\n${contextInstruction}`;
                    } else {
                        // ä¾èµ–ç¼ºå¤±
                        systemPrompt += `\n\n(æ³¨æ„ï¼šä¸Šæ¸¸åˆ†æç¼ºå¤±ï¼Œè¯·ä»…åŸºäºåŸå§‹ç´ æè¿›è¡Œåˆ†æ)`;
                    }
                }

                return [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `åŸå§‹ç´ æ (Raw Material):\n"""\n${rawText}\n"""` }
                ];
            }

            // å•ç‚¹é‡è¯•é€»è¾‘
            async function retryAgent(agentId) {
                const agent = AGENTS.find(a => a.id === agentId);
                if (!agent) return;

                // æ£€æŸ¥ä¾èµ–
                const missingDeps = (agent.dependency || []).filter(depId => !resultsStore[depId]);
                if (missingDeps.length > 0) {
                    return alert(`å‰ç½®ä¾èµ–æœªå°±ç»ª: ${missingDeps.join(', ')}ã€‚è¯·å…ˆè¿è¡Œä¸Šæ¸¸ Stageã€‚`);
                }

                const rawText = document.getElementById('input-text').value;
                if (!rawText.trim()) return alert("è¯·è¾“å…¥åŸå§‹ç´ æ");

                const statusEl = document.getElementById(`status-${agentId}`);
                const contentEl = document.getElementById(`content-${agentId}`);

                // UI Loading
                statusEl.innerHTML = `<span class="loader" style="width:10px;height:10px;"></span> é‡æ–°æ€è€ƒä¸­...`;
                statusEl.className = "text-xs font-mono text-indigo-600 font-bold mb-2 animate-pulse";
                contentEl.classList.add("opacity-50");

                try {
                    // ä½¿ç”¨ç»Ÿä¸€é€»è¾‘æ„å»ºæ¶ˆæ¯
                    const messages = constructMessages(agent, rawText, resultsStore);

                    // è°ƒç”¨ AI
                    const output = await ai.call(messages);

                    // æ›´æ–°ç»“æœ
                    resultsStore[agentId] = output;
                    updateContent(agentId, output);
                    statusEl.innerHTML = `âœ… å·²é‡è¯• (${new Date().toLocaleTimeString()})`;
                    statusEl.className = "text-[10px] font-mono text-green-600 mb-2";

                } catch (e) {
                    console.error(e);
                    statusEl.innerHTML = `âŒ é‡è¯•å¤±è´¥: ${e.message}`;
                    statusEl.className = "text-[10px] font-mono text-red-500 mb-2";
                } finally {
                    contentEl.classList.remove("opacity-50");
                }
            }

            // ESC å…³é—­ç›‘å¬
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeReader();
            });

            return { init, runPipeline, exportReport, copySingleMD, downloadSinglePDF, copyAllMD, downloadAllPDF, openReader, closeReader, handleFileUpload, retryAgent };
        })();

        window.onload = app.init;
    </script>
    <!-- æ²‰æµ¸é˜…è¯»æ¨¡æ€æ¡† -->
    <div id="reading-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-white/98">
        <div class="w-full h-full max-w-3xl mx-auto flex flex-col relative">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="flex justify-end p-4 md:p-6 absolute top-0 right-0 z-10">
                <button onclick="app.closeReader()"
                    class="text-slate-400 hover:text-slate-800 transition-colors p-2 rounded-full hover:bg-slate-100">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <!-- é˜…è¯»å®¹å™¨ -->
            <div class="flex-1 overflow-y-auto custom-scrollbar px-6 md:px-12 py-16 md:py-24">
                <div id="reader-content" class="prose-focus mx-auto">
                    <!-- å†…å®¹åŠ¨æ€æ³¨å…¥ -->
                </div>
            </div>
        </div>
    </div>
</body>

</html>