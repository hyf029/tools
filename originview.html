<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>源流 Origin - 认知校准系统</title>
    <style>
        /* =========================
           Theme / Tokens
        ========================= */
        :root {
            --bg: #f6f7fb;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, 0.86);
            --panel2: rgba(255, 255, 255, 0.72);
            --text: #0f172a;
            --muted: #475569;
            --border: rgba(15, 23, 42, 0.14);
            --accent: #2563eb;
            --accent2: #7c3aed;
            --good: #059669;
            --bad: #e11d48;
            --warn: #d97706;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 10px 40px rgba(2, 6, 23, 0.08);
            --shadow-lg: 0 20px 60px rgba(2, 6, 23, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0f19;
                --bg2: #0b1020;
                --panel: rgba(17, 24, 39, 0.86);
                --panel2: rgba(15, 23, 42, 0.72);
                --text: #e5e7eb;
                --muted: #9ca3af;
                --border: rgba(255, 255, 255, 0.14);
                --accent: #60a5fa;
                --accent2: #a78bfa;
                --good: #34d399;
                --bad: #fb7185;
                --warn: #fbbf24;
                --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
                --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
            }
        }

        html[data-theme="light"] {
            --bg: #f6f7fb;
            --bg2: #ffffff;
            --panel: rgba(255, 255, 255, 0.86);
            --panel2: rgba(255, 255, 255, 0.72);
            --text: #0f172a;
            --muted: #475569;
            --border: rgba(15, 23, 42, 0.14);
            --accent: #2563eb;
            --accent2: #7c3aed;
            --good: #059669;
            --bad: #e11d48;
            --warn: #d97706;
            --shadow: 0 10px 40px rgba(2, 6, 23, 0.08);
        }

        html[data-theme="dark"] {
            --bg: #0b0f19;
            --bg2: #0b1020;
            --panel: rgba(17, 24, 39, 0.86);
            --panel2: rgba(15, 23, 42, 0.72);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.14);
            --accent: #60a5fa;
            --accent2: #a78bfa;
            --good: #34d399;
            --bad: #fb7185;
            --warn: #fbbf24;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
        }

        /* =========================
           Base
        ========================= */
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--sans);
            color: var(--text);
            background:
                radial-gradient(ellipse 900px 600px at 20% 10%, color-mix(in srgb, var(--accent) 15%, transparent), transparent 60%),
                radial-gradient(ellipse 800px 500px at 80% 5%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 55%),
                radial-gradient(ellipse 600px 400px at 50% 90%, color-mix(in srgb, var(--good) 8%, transparent), transparent 50%),
                var(--bg);
            min-height: 100vh;
            line-height: 1.6;
        }

        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px 16px 80px; }

        /* =========================
           Header
        ========================= */
        header {
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 16px;
        }

        .brand { display: flex; align-items: center; gap: 12px; }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            font-weight: 900;
        }

        .brand-text h1 {
            font-size: 22px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .brand-text p { font-size: 13px; color: var(--muted); margin-top: 2px; }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        /* =========================
           Common Components
        ========================= */
        .btn {
            background: color-mix(in srgb, var(--accent) 14%, transparent);
            color: var(--text);
            border: 1px solid color-mix(in srgb, var(--accent) 32%, transparent);
            border-radius: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .btn:hover { background: color-mix(in srgb, var(--accent) 22%, transparent); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn.secondary { background: color-mix(in srgb, var(--text) 6%, transparent); border-color: var(--border); }
        .btn.primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; border: none; }
        .btn.primary:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
        }

        .pill.good { border-color: color-mix(in srgb, var(--good) 40%, transparent); color: var(--good); background: color-mix(in srgb, var(--good) 10%, transparent); }
        .pill.bad { border-color: color-mix(in srgb, var(--bad) 40%, transparent); color: var(--bad); background: color-mix(in srgb, var(--bad) 10%, transparent); }
        .pill.warn { border-color: color-mix(in srgb, var(--warn) 40%, transparent); color: var(--warn); background: color-mix(in srgb, var(--warn) 10%, transparent); }
        .pill.accent { border-color: color-mix(in srgb, var(--accent) 40%, transparent); color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, transparent); }

        select, input[type="text"], textarea {
            background: color-mix(in srgb, var(--bg2) 90%, transparent);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        select:focus, input:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 15%, transparent);
        }

        .hint { color: var(--muted); font-size: 12px; line-height: 1.5; }

        .log {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--muted);
            background: color-mix(in srgb, var(--bg2) 60%, transparent);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 240px;
            overflow-y: auto;
        }

        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

        .field { display: flex; flex-direction: column; gap: 6px; }
        .field label { font-size: 12px; font-weight: 600; color: var(--muted); }

        .grid { display: grid; gap: 16px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 900px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }

        .empty-state { text-align: center; padding: 24px 16px; color: var(--muted); }
        .empty-state-title { font-size: 16px; font-weight: 800; color: var(--text); margin-bottom: 6px; }

        /* Card system */
        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        .card h2 {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Details */
        details {
            border: 1px dashed color-mix(in srgb, var(--border) 80%, transparent);
            border-radius: 14px;
            padding: 12px 14px;
            background: color-mix(in srgb, var(--bg2) 50%, transparent);
        }
        details summary {
            cursor: pointer;
            font-weight: 800;
            font-size: 14px;
        }
        details[open] summary { margin-bottom: 12px; }

        /* =========================
           Layout
        ========================= */
        .main-grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
        @media (max-width: 1000px) { .main-grid { grid-template-columns: 1fr; } }

        /* Input Section */
        .input-section {
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .input-box input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            border-radius: 16px;
            border: 2px solid var(--border);
            background: var(--bg2);
        }

        .input-box input:focus { border-color: var(--accent); }

        .quick-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .quick-tag {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--bg2) 80%, transparent);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quick-tag:hover { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, transparent); }

        .mode-selector { display: flex; gap: 8px; margin: 16px 0; flex-wrap: wrap; }

        .mode-btn {
            flex: 1;
            min-width: 140px;
            padding: 14px 16px;
            border-radius: 14px;
            border: 2px solid var(--border);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .mode-btn:hover { border-color: color-mix(in srgb, var(--accent) 50%, transparent); }
        .mode-btn.active { border-color: var(--accent); background: color-mix(in srgb, var(--accent) 10%, transparent); }

        .mode-btn .mode-icon { font-size: 16px; margin-bottom: 4px; font-weight: 900; }
        .mode-btn .mode-title { font-weight: 700; font-size: 14px; }
        .mode-btn .mode-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }

        /* Results */
        .results-section { margin-top: 20px; }

        .result-card {
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .result-card.master-card { border-left: 4px solid var(--accent); }

        .master-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 12px; flex-wrap: wrap; }
        .master-name { font-size: 18px; font-weight: 800; }
        .master-domain { font-size: 13px; color: var(--muted); margin-top: 2px; }
        .master-coords { display: flex; gap: 6px; flex-wrap: wrap; }

        .coord-tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            background: color-mix(in srgb, var(--accent) 12%, transparent);
            color: var(--accent);
        }

        .master-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
        .master-section-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .variation-card {
            padding: 14px;
            border-radius: 12px;
            background: color-mix(in srgb, var(--bg2) 60%, transparent);
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }

        .variation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .variation-name { font-weight: 700; font-size: 14px; }
        .variation-distance {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            background: color-mix(in srgb, var(--accent) 12%, transparent);
            color: var(--accent);
        }

        .variation-example {
            padding: 12px;
            border-radius: 10px;
            background: color-mix(in srgb, var(--text) 5%, transparent);
            font-size: 13px;
            line-height: 1.6;
            margin-top: 8px;
            border-left: 3px solid var(--accent);
        }

        /* Sidebar */
        .sidebar .card { margin-bottom: 16px; }

        .compass-visual {
            width: 100%;
            aspect-ratio: 1;
            background: color-mix(in srgb, var(--bg2) 60%, transparent);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 12px;
            padding: 10px;
        }

        .master-list { display: flex; flex-direction: column; gap: 8px; }
        .master-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 10px;
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            border: 1px solid var(--border);
            font-size: 13px;
        }
        .master-item-name { font-weight: 600; }
        .master-item-source { font-size: 11px; color: var(--muted); }

        .remove-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
        }
        .remove-btn:hover { color: var(--bad); }

        .skill-list { display: flex; flex-direction: column; gap: 6px; }
        .skill-item {
            padding: 10px 12px;
            border-radius: 10px;
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            border: 1px solid var(--border);
        }
        .skill-item-name { font-weight: 600; font-size: 13px; }
        .skill-item-from { font-size: 11px; color: var(--muted); margin-top: 2px; }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--muted);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            border-radius: 12px;
            background: var(--bg2);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--good); color: var(--good); }
        .toast.error { border-color: var(--bad); color: var(--bad); }

        /* =========================
           Stepper (B档)
        ========================= */
        #flowStepper .flow-stepper { display: flex; gap: 10px; flex-wrap: wrap; align-items: stretch; }
        #flowStepper .flow-step {
            flex: 1;
            min-width: 160px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            display: flex;
            gap: 10px;
            align-items: flex-start;
            cursor: pointer;
        }
        #flowStepper .flow-step-badge {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-weight: 900;
            font-size: 12px;
            background: color-mix(in srgb, var(--text) 8%, transparent);
            border: 1px solid var(--border);
            flex-shrink: 0;
        }
        #flowStepper .flow-step-title { font-weight: 800; font-size: 13px; line-height: 1.2; }
        #flowStepper .flow-step-desc { margin-top: 4px; font-size: 12px; color: var(--muted); line-height: 1.4; }

        #flowStepper .flow-step.is-active {
            border-color: color-mix(in srgb, var(--accent) 55%, transparent);
            background: color-mix(in srgb, var(--accent) 10%, transparent);
        }
        #flowStepper .flow-step.is-active .flow-step-badge {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
            border: none;
        }

        #flowStepper .flow-step.is-done {
            border-color: color-mix(in srgb, var(--good) 40%, transparent);
            background: color-mix(in srgb, var(--good) 10%, transparent);
        }
        #flowStepper .flow-step.is-done .flow-step-badge {
            background: color-mix(in srgb, var(--good) 25%, transparent);
            color: var(--good);
            border-color: color-mix(in srgb, var(--good) 35%, transparent);
        }

        #flowStepper .flow-step.is-blocked { opacity: 0.75; }
        #flowStepper .flow-step.is-blocked .flow-step-badge {
            background: color-mix(in srgb, var(--warn) 10%, transparent);
            color: var(--warn);
            border-color: color-mix(in srgb, var(--warn) 25%, transparent);
        }

        /* =========================
           Morning (content + journal)
        ========================= */
        #morningCard #morningContent { margin-top: 12px; }

        #morningCard .morning-wrap {
            border: 1px solid var(--border);
            border-radius: 16px;
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            padding: 14px;
        }

        #morningCard .morning-section-title {
            font-size: 12px;
            font-weight: 900;
            color: var(--muted);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        #morningCard .morning-quote {
            font-size: 13px;
            line-height: 1.85;
            color: color-mix(in srgb, var(--text) 85%, var(--muted));
            padding: 10px 12px;
            border-radius: 12px;
            background: color-mix(in srgb, var(--text) 5%, transparent);
            border-left: 3px solid var(--accent);
        }

        #morningCard .morning-list {
            margin-top: 10px;
            padding: 0;
            margin-left: 18px;
            color: var(--muted);
        }
        #morningCard .morning-list li {
            margin: 6px 0;
            line-height: 1.7;
        }

        #morningCard .morning-practice {
            margin-top: 12px;
            padding: 12px 12px;
            border-radius: 14px;
            background: color-mix(in srgb, var(--accent) 10%, transparent);
            border: 1px solid color-mix(in srgb, var(--accent) 25%, transparent);
        }
        #morningCard .morning-practice .morning-practice-text {
            font-size: 13px;
            line-height: 1.75;
            color: var(--text);
        }

        #morningCard .morning-meta-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        #morningCard .morning-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--muted);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
        }

        #morningJournal .journal-entry {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }
        #morningJournal .journal-head {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: baseline;
            flex-wrap: wrap;
        }
        #morningJournal .journal-title { font-weight: 800; color: var(--text); }
        #morningJournal .journal-time { font-size: 11px; color: var(--muted); }
        #morningJournal .journal-body {
            margin-top: 10px;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
        }

        /* =========================
           Results action bar (Export/Copy)
        ========================= */
        #resultsActionBar {
            margin-bottom: 12px;
        }

        /* =========================
           Assets Drawer (Phase 2)
        ========================= */
        #assetsOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(2px);
            z-index: 1200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        #assetsOverlay.is-open {
            opacity: 1;
            pointer-events: auto;
        }

        #assetsDrawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(420px, 92vw);
            z-index: 1300;

            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border-left: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(12px);

            transform: translateX(110%);
            transition: transform 0.22s ease;
            display: flex;
            flex-direction: column;
        }
        #assetsDrawer.is-open {
            transform: translateX(0);
        }

        #assetsDrawer .drawer-header {
            padding: 16px 16px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }
        #assetsDrawer .drawer-title {
            font-weight: 900;
            font-size: 16px;
        }
        #assetsDrawer .drawer-subtitle {
            margin-top: 4px;
            font-size: 12px;
            color: var(--muted);
        }
        #assetsDrawer .drawer-close {
            background: none;
            border: 1px solid var(--border);
            border-radius: 10px;
            width: 34px;
            height: 34px;
            cursor: pointer;
            color: var(--muted);
            font-weight: 900;
        }
        #assetsDrawer .drawer-close:hover {
            border-color: color-mix(in srgb, var(--accent) 45%, transparent);
            color: var(--text);
        }

        #assetsDrawer .drawer-tabs {
            padding: 10px 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid var(--border);
        }
        #assetsDrawer .assets-tab {
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            font-size: 12px;
            cursor: pointer;
            user-select: none;
            color: var(--muted);
            font-weight: 800;
        }
        #assetsDrawer .assets-tab.is-active {
            border-color: var(--accent);
            background: color-mix(in srgb, var(--accent) 10%, transparent);
            color: var(--text);
        }

        #assetsDrawer .drawer-body {
            padding: 12px 12px 10px;
            overflow: auto;
            flex: 1;
        }

        #assetsDrawer .drawer-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        #assetsDrawer .asset-search {
            width: 100%;
            margin-bottom: 10px;
        }

        #assetsDrawer .asset-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        #assetsDrawer .asset-item {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: color-mix(in srgb, var(--bg2) 70%, transparent);
            margin-bottom: 10px;
        }
        #assetsDrawer .asset-item-title {
            font-weight: 900;
            font-size: 13px;
            color: var(--text);
        }
        #assetsDrawer .asset-item-meta {
            margin-top: 4px;
            font-size: 12px;
            color: var(--muted);
        }
        #assetsDrawer .asset-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        #assetsDrawer .asset-actions .btn {
            padding: 8px 12px;
        }

        #assetsDrawer .drawer-note {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: color-mix(in srgb, var(--accent) 8%, transparent);
        }

        /* =========================
           Responsive
        ========================= */
        @media (max-width: 420px) {
            #flowStepper .flow-step { min-width: 100%; }
            .container { padding: 14px 12px 60px; }
            header { padding: 16px; border-radius: 16px; }
            .input-section { padding: 16px; border-radius: 16px; }
            .mode-btn { min-width: 120px; padding: 12px; }
            .input-box input { padding: 14px 14px; font-size: 15px; }
            .toast { left: 12px; right: 12px; bottom: 14px; width: auto; }
            #assetsDrawer { width: 100vw; }
        }
    </style>
</head>
<body>
<script type="application/json" id="tool_meta">
{
    "tool_id": "origin-cognitive-calibration",
    "tool_name": "源流 Origin - 认知校准系统",
    "tool_version": "1.2.0",
    "description": "从源头参照系学习，建立个人审美坐标系（本地资产化：可导出/导入/Markdown/PDF打印）"
}
</script>

<div class="container">
    <header>
        <div class="header-top">
            <div class="brand">
                <div class="logo">源</div>
                <div class="brand-text">
                    <h1>源流 Origin</h1>
                    <p>超级个体的认知校准系统</p>
                </div>
            </div>
            <div class="header-controls">
                <span class="pill" id="keyStatusPill">检查中...</span>

                <button class="btn secondary" id="openAssetsBtn" type="button">我的资产</button>

                <a href="key-manager.html" target="_blank" class="btn secondary">管理 API Key</a>
                <select id="themeSelect" style="padding: 8px 12px;">
                    <option value="auto">跟随系统</option>
                    <option value="light">浅色</option>
                    <option value="dark">深色</option>
                </select>
            </div>
        </div>
    </header>

    <div class="main-grid">
        <div class="main-content">
            <div class="input-section">
                <h2 style="margin-bottom: 16px; font-size: 18px;">你今天想探索什么？</h2>

                <div class="input-box">
                    <input type="text" id="mainInput" placeholder="输入你想学的学科 / 领域 / 技能..." />
                </div>

                <div id="flowStepper" style="margin-top: 12px;"></div>

                <div id="modeHintBox" style="margin-top: 10px; padding: 10px 12px; border-radius: 14px; border: 1px solid var(--border); background: color-mix(in srgb, var(--bg2) 70%, transparent);">
                    <div style="font-weight: 800; font-size: 12px; color: var(--muted); margin-bottom: 6px;">当前模式怎么用</div>
                    <div class="hint" id="modeHintText"></div>
                    <div class="quick-tags" id="modeHintExamples" style="margin-top: 10px;"></div>
                </div>

                <div class="mode-selector">
                    <div class="mode-btn active" data-mode="source">
                        <div class="mode-icon">S</div>
                        <div class="mode-title">源头探测</div>
                        <div class="mode-desc">构建源头参照系（人/书/文/课）</div>
                    </div>
                    <div class="mode-btn" data-mode="deconstruct">
                        <div class="mode-icon">D</div>
                        <div class="mode-title">四层拆解</div>
                        <div class="mode-desc">分析大师技法</div>
                    </div>
                    <div class="mode-btn" data-mode="transfer">
                        <div class="mode-icon">T</div>
                        <div class="mode-title">迁移实验室</div>
                        <div class="mode-desc">把技法用到你的场景</div>
                    </div>
                    <div class="mode-btn" data-mode="navigate">
                        <div class="mode-icon">N</div>
                        <div class="mode-title">作品导航</div>
                        <div class="mode-desc">设计学习路径（先修/章节/练习）</div>
                    </div>
                    <div class="mode-btn" data-mode="diagnose">
                        <div class="mode-icon">C</div>
                        <div class="mode-title">审美诊断</div>
                        <div class="mode-desc">分析你的坐标系</div>
                    </div>
                </div>

                <div id="transferAssist" style="display:none; margin-top: 12px; padding: 12px; border-radius: 16px; border: 1px solid var(--border); background: color-mix(in srgb, var(--bg2) 65%, transparent);">
                    <div style="font-weight: 900; margin-bottom: 10px;">迁移输入（推荐）</div>

                    <div class="grid grid-2" style="gap: 10px;">
                        <div class="field">
                            <label for="transferTechniqueSelect">技法（优先从已保存技法选）</label>
                            <select id="transferTechniqueSelect"></select>
                        </div>

                        <div class="field">
                            <label for="transferMasterSelect">来源大师（可选）</label>
                            <select id="transferMasterSelect"></select>
                        </div>
                    </div>

                    <div class="field" style="margin-top: 10px;">
                        <label for="transferScenarioInput">目标场景（必填）</label>
                        <input id="transferScenarioInput" type="text" placeholder="如：小红书笔记 / 60秒口播 / 产品发布稿..." />
                    </div>

                    <div class="field" style="margin-top: 10px;">
                        <label for="transferConstraintsInput">约束（可选）</label>
                        <input id="transferConstraintsInput" type="text" placeholder="如：500字以内 / 需要CTA / 口语化..." />
                    </div>

                    <div class="hint" style="margin-top: 10px;">
                        也可在上方输入框用“技法 -> 场景”快速输入；表单会更稳定。
                    </div>
                </div>

                <div class="row" style="margin-top: 16px;">
                    <button class="btn primary" id="submitBtn" style="flex: 1;">开始探索</button>
                </div>

                <div id="aiSettingsMount" style="margin-top: 16px;"></div>
                <div id="searchSettingsMount" style="margin-top: 10px;"></div>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="empty-state">
                    <div class="empty-state-title">溯源而上，找到源头参照系</div>
                    <p class="hint">适用于：学科学习、专业技能、创作能力（输入任意关键词即可）。建议先看右侧“晨间校准”，再选择任务并产出。</p>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="card">
                <h2>我的审美坐标系</h2>
                <div class="compass-visual" id="compassVisual">
                    <span>探索更多大师来填充坐标系</span>
                </div>
                <div id="compassSummary" class="hint" style="margin: 10px 0 12px;"></div>
                <div id="compassBlindspots" style="display:none; margin-bottom: 12px; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: color-mix(in srgb, var(--warn) 10%, transparent);">
                    <div style="font-weight: 800; font-size: 12px; color: var(--warn); margin-bottom: 6px;">盲区提示</div>
                    <div class="hint" id="compassBlindspotsText"></div>
                </div>
                <div class="row" style="margin-bottom: 12px;">
                    <span class="pill">温度</span>
                    <span class="pill">密度</span>
                    <span class="pill">攻击性</span>
                    <span class="pill">结构感</span>
                </div>
                <button class="btn secondary" style="width: 100%;" id="exportCompassBtn">导出坐标系</button>
            </div>

            <div class="card" id="morningCard">
                <h2>晨间校准</h2>
                <div class="hint" id="morningMeta">每天一口好东西，30 秒即可。</div>

                <div id="morningContent">
                    <div class="hint">准备中…</div>
                </div>

                <div class="row" style="margin-top: 12px;">
                    <button class="btn secondary" id="refreshMorningBtn" type="button" style="flex: 1;">刷新今日</button>
                    <button class="btn primary" id="saveMorningBtn" type="button" style="flex: 1;" disabled>存入审美日记</button>
                </div>

                <div class="row" style="margin-top: 10px;">
                    <button class="btn secondary" id="copyMorningBtn" type="button" style="width: 100%;" disabled>复制今日内容</button>
                </div>

                <details style="margin-top: 10px;">
                    <summary>历史（日记）</summary>
                    <div id="morningJournal" class="hint" style="margin-top: 10px;">暂无记录</div>
                </details>
            </div>

            <div class="card">
                <h2>我的大师图谱</h2>
                <div class="master-list" id="masterList">
                    <div class="hint">还没有收藏大师</div>
                </div>
            </div>

            <div class="card">
                <h2>已解锁的技法</h2>
                <div class="skill-list" id="skillList">
                    <div class="hint">还没有技法</div>
                </div>
            </div>

            <div class="card">
                <h2>创作检查清单</h2>
                <div id="checklistSection">
                    <div class="field">
                        <label for="checklistDomain">创作载体</label>
                        <select id="checklistDomain">
                            <option value="公众号文章">公众号文章</option>
                            <option value="小红书笔记">小红书笔记</option>
                            <option value="短视频口播">短视频口播</option>
                            <option value="演讲稿">演讲稿</option>
                            <option value="产品文案">产品文案</option>
                            <option value="通用写作">通用写作</option>
                            <option value="__custom__">自定义…</option>
                        </select>
                    </div>

                    <!-- 自定义载体输入：默认隐藏 -->
                    <div id="checklistCustomWrap" style="display:none; margin-top: 10px;">
                        <div class="field">
                            <label for="checklistCustomDomain">自定义载体</label>
                            <input id="checklistCustomDomain" type="text" placeholder="例如：本科线性代数作业讲解 / 电磁学复习笔记 / 材料科学论文综述" />
                            <div class="hint" style="margin-top: 6px;">
                                提示：自定义载体会直接作为清单生成的“user_domain”，建议写清楚场景与受众。
                            </div>
                        </div>
                    </div>

                    <div class="field" style="margin-top: 10px;">
                        <label for="checklistConstraints">约束（可选）</label>
                        <input id="checklistConstraints" type="text" placeholder="如：500字以内 / 60秒口播 / 三段式 / 需含CTA" />
                    </div>

                    <div class="row" style="margin-top: 10px;">
                        <button class="btn secondary" id="generateChecklistLocalBtn" type="button" style="flex: 1;">本地快速生成</button>
                        <button class="btn primary" id="generateChecklistAiBtn" type="button" style="flex: 1;">AI 生成</button>
                    </div>

                    <div class="hint" style="margin-top: 8px;">
                        本地生成不联网；AI 生成会基于你已保存的技法做个性化清单。
                    </div>

                    <div id="checklistOutput" style="margin-top: 12px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drawer overlay + drawer -->
<div id="assetsOverlay"></div>
<aside id="assetsDrawer" aria-hidden="true">
    <div class="drawer-header">
        <div>
            <div class="drawer-title">我的资产</div>
            <div class="drawer-subtitle" id="assetsSubtitle">本地存储：检查中…</div>
        </div>
        <button class="drawer-close" id="closeAssetsBtn" type="button" aria-label="close">×</button>
    </div>

    <div class="drawer-tabs" id="assetsTabs"></div>

    <div class="drawer-body">
        <input class="asset-search" id="assetsSearchInput" type="text" placeholder="搜索（大师/技法/日记）…" />
        <div id="assetsBody"></div>
        <div class="drawer-note hint" id="assetsNote">
            本工具不使用后台数据库：数据默认保存在本地浏览器（localStorage）。建议在“备份”中导出 JSON 以防清缓存丢失。
        </div>
    </div>

    <div class="drawer-footer" id="assetsFooter"></div>

    <input id="assetsImportFile" type="file" accept="application/json" style="display:none;" />
</aside>

<div class="toast" id="toast"></div>

<script>
/* -----------------------------
 * 0) Storage check
 * ----------------------------- */
function storageAvailable() {
    try {
        const k = "__origin_test__";
        localStorage.setItem(k, "1");
        localStorage.removeItem(k);
        return true;
    } catch {
        return false;
    }
}

/* -----------------------------
 * 1) AI Module (UNCHANGED)
 * ----------------------------- */
const AI_MODULE = (() => {
    const KM_PROVIDER_OVERRIDES_KEY = "km_provider_overrides_v1";

    const AI_PROVIDERS = {
        "siliconflow": {
            name: "硅基流动 (SiliconFlow)",
            keyName: "siliconflow_key",
            baseUrl: "https://api.siliconflow.cn/v1",
            models: [
                { id: "Qwen/Qwen2.5-72B-Instruct", name: "Qwen 2.5 72B" },
                { id: "deepseek-ai/DeepSeek-V3", name: "DeepSeek V3" },
                { id: "Qwen/Qwen2.5-7B-Instruct", name: "Qwen 2.5 7B (Fast)" },
                { id: "Pro/zai-org/GLM-4.7", name: "GLM-4.7 (Pro)" },
                { id: "Pro/moonshotai/Kimi-K2-Thinking", name: "Kimi K2 Thinking (Pro)" },
                { id: "Qwen3-VL-32B-Thinking", name: "Qwen3 VL 32B Thinking" }
            ]
        },
        "openrouter": {
            name: "OpenRouter",
            keyName: "openrouter_key",
            baseUrl: "https://openrouter.ai/api/v1",
            models: [
                { id: "anthropic/claude-3.5-sonnet", name: "Claude 3.5 Sonnet" },
                { id: "openai/gpt-4o", name: "GPT-4o" },
                { id: "google/gemini-pro-1.5", name: "Gemini Pro 1.5" },
                { id: "anthropic/claude-opus-4.5", name: "Claude Opus 4.5" },
                { id: "openai/gpt-5.2-pro", name: "GPT-5.2 Pro" },
                { id: "google/gemini-3-pro-preview", name: "Gemini 3 Pro Preview" }
            ]
        },
        "deepseek": {
            name: "DeepSeek Official",
            keyName: "deepseek_key",
            baseUrl: "https://api.deepseek.com",
            models: [
                { id: "deepseek-chat", name: "DeepSeek V3" },
                { id: "deepseek-reasoner", name: "DeepSeek R1" }
            ]
        },
        "custom": {
            name: "自定义 / 本地（Ollama）",
            keyName: "custom_key",
            baseUrl: "http://localhost:11434/v1",
            models: []
        }
    };

    function safeJsonParse(str) {
        try { return { ok: true, value: JSON.parse(str) }; }
        catch (e) { return { ok: false, error: String(e) }; }
    }

    function getOverrides() {
        const raw = localStorage.getItem(KM_PROVIDER_OVERRIDES_KEY);
        if (!raw) return {};
        const parsed = safeJsonParse(raw);
        if (!parsed.ok || !parsed.value || typeof parsed.value !== "object") return {};
        return parsed.value;
    }

    function normalizeBaseUrl(baseUrl) {
        const s = String(baseUrl || "").trim();
        return s.replace(/\/+$/, "");
    }

    function joinUrl(baseUrl, path) {
        const b = normalizeBaseUrl(baseUrl);
        const p = String(path || "").trim().replace(/^\/+/, "");
        return `${b}/${p}`;
    }

    function getProvider(providerId) { return AI_PROVIDERS[providerId]; }

    function getMergedProviderConfig(providerId) {
        const p = getProvider(providerId);
        if (!p) throw new Error(`未知 provider_id: ${providerId}`);

        const overrides = getOverrides();
        const o = overrides[providerId] || {};

        const customModels = Array.isArray(o.custom_models) ? o.custom_models : [];
        const mergedModels = [
            ...(Array.isArray(p.models) ? p.models : []),
            ...customModels
                .filter(m => m && typeof m === "object" && m.id)
                .map(m => ({ id: String(m.id), name: m.name ? String(m.name) : String(m.id), _custom: true }))
        ];

        const baseUrl = o.base_url_override ? String(o.base_url_override) : p.baseUrl;
        const modelId = o.model_id_override ? String(o.model_id_override) : (mergedModels[0]?.id || "");

        return {
            provider_id: providerId,
            name: p.name,
            key_name: p.keyName,
            base_url_default: p.baseUrl,
            base_url: baseUrl,
            models: mergedModels,
            model_id_default: mergedModels[0]?.id || "",
            model_id: modelId
        };
    }

    function getKeyStatus(providerId) {
        const p = getProvider(providerId);
        if (!p) return { ok: false, has_key: false, key_name: "" };
        const keyName = p.keyName;
        const key = localStorage.getItem(keyName);
        return { ok: true, has_key: Boolean(key), key_name: keyName };
    }

    function classifyFetchError(err) {
        const msg = String(err?.message || err || "");
        const lower = msg.toLowerCase();
        if (lower.includes("abort")) return { kind: "环境错误", msg: "请求超时/被取消（Abort）" };
        if (lower.includes("failed to fetch") || lower.includes("network") || lower.includes("cors")) {
            return { kind: "环境错误", msg: msg };
        }
        return { kind: "内部错误", msg: msg };
    }

    function actionableErrorMessage(kind, msg) {
        if (kind === "用户输入错误") {
            return `用户输入错误：\n- 发生了什么：${msg}\n- 怎么修复：检查 Base URL / Model ID / 输入内容是否为空。`;
        }
        if (kind === "环境错误") {
            return `环境错误：\n- 发生了什么：${msg}\n- 怎么修复：检查网络/CORS/是否 https 页面访问 http。`;
        }
        if (kind === "平台错误") {
            return `平台错误：\n- 发生了什么：${msg}\n- 怎么修复：检查 key 是否有效、是否限流、模型 ID 是否存在。`;
        }
        return `内部错误：\n- 发生了什么：${msg}`;
    }

    function getHostname(url) {
        try { return new URL(String(url || "").trim()).hostname; }
        catch { return ""; }
    }

    function isDomainAllowed(hostname, allowlist) {
        if (!hostname) return false;
        return (allowlist || []).includes(hostname);
    }

    function ensureDomainConsentOrThrow(hostname, consentKey = "ai_domain_consent_v1") {
        const raw = localStorage.getItem(consentKey) || "{}";
        let obj = {};
        try { obj = JSON.parse(raw); } catch { obj = {}; }

        if (obj[hostname] === true) return true;

        const ok = confirm(
            `你即将把请求（包含密钥）发送到域名：${hostname}\n\n` +
            `确认要允许吗？\n` +
            `如果这个域名不是你信任的平台，请点取消。`
        );
        if (!ok) throw new Error("环境错误: 用户取消了域名授权");

        obj[hostname] = true;
        localStorage.setItem(consentKey, JSON.stringify(obj));
        return true;
    }

    async function corsProbe(baseUrl, timeoutMs = 8000) {
        const now = new Date().toISOString();
        const url = String(baseUrl || "").trim();
        if (!url) return { ok: false, kind: "用户输入错误", result: "空 URL", details: { now, url } };

        let u;
        try { u = new URL(url); }
        catch (e) {
            return { ok: false, kind: "用户输入错误", result: "URL 无效", details: { now, url, error: String(e) } };
        }

        if (location.protocol === "https:" && u.protocol === "http:") {
            return { ok: false, kind: "环境错误", result: "混合内容（https 页面不能访问 http）", details: { now, url } };
        }

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const resp = await fetch(url, { method: "GET", mode: "cors", cache: "no-store", signal: controller.signal });
            return { ok: true, kind: "OK", result: "能拿到响应", details: { now, url, status: resp.status } };
        } catch (e) {
            const info = classifyFetchError(e);
            return { ok: false, kind: info.kind, result: "可能被 CORS/网络拦截", details: { now, url, error: info.msg } };
        } finally {
            clearTimeout(timer);
        }
    }

    async function call_llm_unified({
        provider_id,
        base_url,
        api_key,
        model_id,
        messages,
        temperature = 0.7,
        max_tokens = 4096,
        timeout_ms = 60000,
        extra_headers = {},
        extra_body = {}
    }) {
        if (!provider_id) throw new Error("用户输入错误: provider_id 为空");
        if (!base_url) throw new Error("用户输入错误: base_url 为空");
        if (!model_id) throw new Error("用户输入错误: model_id 为空");
        if (!Array.isArray(messages) || messages.length === 0) throw new Error("用户输入错误: messages 为空");

        if (!api_key) {
            const e = new Error("平台错误: 缺少 API Key（请先在 key-manager.html 设置）");
            e._kind = "平台错误";
            throw e;
        }

        const url = joinUrl(base_url, "/chat/completions");
        const headers = {
            "Authorization": `Bearer ${api_key}`,
            "Content-Type": "application/json",
            ...extra_headers
        };

        const body = { model: model_id, messages, temperature, max_tokens, ...extra_body };

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeout_ms);

        try {
            const resp = await fetch(url, {
                method: "POST",
                mode: "cors",
                headers: headers,
                body: JSON.stringify(body),
                signal: controller.signal
            });

            const text = await resp.text();
            let json = null;
            try { json = JSON.parse(text); } catch {}

            if (!resp.ok) {
                const e = new Error(`平台错误: HTTP ${resp.status} ${resp.statusText}\n${text.slice(0, 800)}`);
                e._kind = "平台错误";
                throw e;
            }

            const outText = json?.choices?.[0]?.message?.content ?? "";
            if (!outText) {
                const e = new Error("平台错误: 响应中未找到可用文本");
                e._kind = "平台错误";
                throw e;
            }

            return { text: String(outText), raw: json };
        } catch (e) {
            if (e && e._kind) throw e;
            const info = classifyFetchError(e);
            const err = new Error(`${info.kind}: ${info.msg}`);
            err._kind = info.kind;
            throw err;
        } finally {
            clearTimeout(timer);
        }
    }

    function render_ai_settings_html() {
        const providerOptions = Object.keys(AI_PROVIDERS)
            .map(pid => `<option value="${pid}">${AI_PROVIDERS[pid].name}</option>`)
            .join("");

        return `
            <details id="aiSettings">
                <summary style="font-weight:800;">AI 设置</summary>
                <div style="margin-top:12px;">
                    <div class="hint" style="margin-bottom: 12px;">
                        默认不联网；需要先在 <a href="key-manager.html" target="_blank">key-manager.html</a> 设置密钥，然后勾选“允许联网”。
                    </div>

                    <div class="row" style="margin-bottom: 12px;">
                        <span class="pill warn">
                            <input id="aiNetworkingToggle" type="checkbox" style="transform: translateY(1px);" />
                            <span>允许联网（默认关闭）</span>
                        </span>
                        <span class="pill" id="aiKeyStatusPill">密钥状态：未检查</span>
                    </div>

                    <div class="grid grid-2" style="gap: 12px;">
                        <div class="field">
                            <label for="aiProviderSelect">平台（Provider）</label>
                            <select id="aiProviderSelect">${providerOptions}</select>
                        </div>
                        <div class="field">
                            <label for="aiModelPresetSelect">模型</label>
                            <select id="aiModelPresetSelect"></select>
                        </div>
                    </div>

                    <details style="margin-top: 12px;">
                        <summary>高级设置</summary>
                        <div class="grid grid-2" style="gap: 12px; margin-top: 10px;">
                            <div class="field">
                                <label for="aiBaseUrlInput">Base URL</label>
                                <input id="aiBaseUrlInput" type="text" placeholder="https://api.xxx.com/v1" />
                            </div>
                            <div class="field">
                                <label for="aiModelIdInput">模型 ID</label>
                                <input id="aiModelIdInput" type="text" placeholder="model-id" />
                            </div>
                            <div class="field">
                                <label for="aiTemperature">Temperature</label>
                                <input id="aiTemperature" type="text" value="0.7" />
                            </div>
                            <div class="field">
                                <label for="aiMaxTokens">Max Tokens</label>
                                <input id="aiMaxTokens" type="text" value="4096" />
                            </div>
                        </div>
                    </details>

                    <div class="row" style="margin-top: 12px;">
                        <button class="btn secondary" id="aiSyncBtn" type="button">从 Key Manager 同步</button>
                        <button class="btn secondary" id="aiCorsProbeBtn" type="button">CORS 探测</button>
                    </div>

                    <div class="log" id="aiLog" style="margin-top: 12px;">AI 模块就绪。</div>
                </div>
            </details>
        `;
    }

    function mount_ai_settings({ mount_el, default_provider_id = "siliconflow", on_state_change = null }) {
        if (!mount_el) throw new Error("mount_el is required");

        mount_el.innerHTML = render_ai_settings_html();
        const $ = (id) => mount_el.querySelector(id);

        const aiNetworkingToggle = $("#aiNetworkingToggle");
        const aiProviderSelect = $("#aiProviderSelect");
        const aiBaseUrlInput = $("#aiBaseUrlInput");
        const aiModelPresetSelect = $("#aiModelPresetSelect");
        const aiModelIdInput = $("#aiModelIdInput");
        const aiKeyStatusPill = $("#aiKeyStatusPill");
        const aiTemperature = $("#aiTemperature");
        const aiMaxTokens = $("#aiMaxTokens");
        const aiLog = $("#aiLog");
        const aiSyncBtn = $("#aiSyncBtn");
        const aiCorsProbeBtn = $("#aiCorsProbeBtn");

        const state = {
            networking_enabled: false,
            provider_id: default_provider_id,
            base_url: "",
            model_id: "",
            temperature: 0.7,
            max_tokens: 4096,
            timeout_ms: 120000
        };

        function emit() { on_state_change && on_state_change(get_state()); }

        function setKeyStatusPill(providerId) {
            const ks = getKeyStatus(providerId);
            if (!ks.ok) {
                aiKeyStatusPill.className = "pill bad";
                aiKeyStatusPill.textContent = "密钥状态：未知";
                return;
            }
            if (ks.has_key) {
                aiKeyStatusPill.className = "pill good";
                aiKeyStatusPill.textContent = "密钥状态：已设置";
            } else {
                aiKeyStatusPill.className = "pill bad";
                aiKeyStatusPill.textContent = "密钥状态：未设置";
            }
        }

        function rebuildModelPresetOptions(providerId, preferModelId = "") {
            const cfg = getMergedProviderConfig(providerId);
            const models = cfg.models || [];
            const options = [
                ...models.map(m => `<option value="${String(m.id)}">${String(m.name || m.id)}${m._custom ? "（自定义）" : ""}</option>`),
                `<option value="__custom__">手动输入模型 ID</option>`
            ].join("");
            aiModelPresetSelect.innerHTML = options;

            const effectiveModelId = preferModelId || cfg.model_id || cfg.model_id_default || "";
            const hasPreset = models.some(m => String(m.id) === String(effectiveModelId));
            aiModelPresetSelect.value = hasPreset ? String(effectiveModelId) : "__custom__";
        }

        function syncFromKeyManager(providerId) {
            const cfg = getMergedProviderConfig(providerId);
            state.base_url = String(cfg.base_url || "");
            state.model_id = String(cfg.model_id || "");
            aiBaseUrlInput.value = state.base_url;
            aiModelIdInput.value = state.model_id;

            rebuildModelPresetOptions(providerId, state.model_id);
            setKeyStatusPill(providerId);

            aiLog.textContent = `已同步：${cfg.name}\nbase_url: ${state.base_url}\nmodel_id: ${state.model_id}`;
            emit();
        }

        aiProviderSelect.value = default_provider_id;
        syncFromKeyManager(default_provider_id);

        aiNetworkingToggle.addEventListener("change", () => {
            state.networking_enabled = Boolean(aiNetworkingToggle.checked);
            aiLog.textContent = state.networking_enabled
                ? "已允许联网：AI 功能可用。"
                : "已关闭联网：不会发起任何 AI 请求。";
            emit();
        });

        aiProviderSelect.addEventListener("change", () => {
            state.provider_id = aiProviderSelect.value;
            syncFromKeyManager(state.provider_id);
        });

        aiBaseUrlInput.addEventListener("change", () => {
            state.base_url = String(aiBaseUrlInput.value || "").trim();
            emit();
        });

        aiModelPresetSelect.addEventListener("change", () => {
            const chosen = aiModelPresetSelect.value;
            if (chosen === "__custom__") { aiModelIdInput.focus(); return; }
            aiModelIdInput.value = chosen;
            state.model_id = chosen;
            emit();
        });

        aiModelIdInput.addEventListener("change", () => {
            state.model_id = String(aiModelIdInput.value || "").trim();
            emit();
        });

        aiTemperature.addEventListener("change", () => {
            const v = Number(aiTemperature.value);
            state.temperature = Number.isFinite(v) ? v : 0.7;
            emit();
        });

        aiMaxTokens.addEventListener("change", () => {
            const v = Number(aiMaxTokens.value);
            state.max_tokens = Number.isFinite(v) ? Math.max(1, Math.floor(v)) : 4096;
            emit();
        });

        aiSyncBtn.addEventListener("click", () => syncFromKeyManager(state.provider_id));

        aiCorsProbeBtn.addEventListener("click", async () => {
            const url = String(aiBaseUrlInput.value || "").trim();
            aiLog.textContent = "CORS 探测中…";
            const res = await corsProbe(url, 8000);
            aiLog.textContent = JSON.stringify(res, null, 2);
        });

        function get_state() { return { ...state, key_status: getKeyStatus(state.provider_id) }; }

        async function call_ai({ messages }) {
            const s = get_state();
            if (!s.networking_enabled) {
                const e = new Error("环境错误: 当前未允许联网（请勾选“允许联网”）");
                e._kind = "环境错误";
                throw e;
            }

            const hostname = getHostname(s.base_url);
            const allowlist = ["api.siliconflow.cn", "openrouter.ai", "api.deepseek.com", "localhost"];
            if (!isDomainAllowed(hostname, allowlist)) {
                ensureDomainConsentOrThrow(hostname);
            }

            const p = getProvider(s.provider_id);
            const apiKey = localStorage.getItem(p.keyName) || "";

            return await call_llm_unified({
                provider_id: s.provider_id,
                base_url: s.base_url,
                api_key: apiKey,
                model_id: s.model_id,
                messages,
                temperature: s.temperature,
                max_tokens: s.max_tokens,
                timeout_ms: s.timeout_ms
            });
        }

        function get_actionable_error(err) {
            const kind = err?._kind || "内部错误";
            const msg = String(err?.message || err || "");
            return actionableErrorMessage(kind, msg);
        }

        return { get_state, call_ai, get_actionable_error, sync: () => syncFromKeyManager(state.provider_id) };
    }

    return {
        AI_PROVIDERS,
        mount_ai_settings,
        getMergedProviderConfig,
        getKeyStatus,
        corsProbe,
        call_llm_unified,
        actionableErrorMessage
    };
})();

/* -----------------------------
 * 1.5) SEARCH_MODULE (NEW, independent; default off)
 * ----------------------------- */
const SEARCH_MODULE = (() => {
    const SEARCH_SETTINGS_KEY = "origin_search_settings_v1";
    const SEARCH_DOMAIN_CONSENT_KEY = "origin_search_domain_consent_v1";
    const SEARCH_CACHE_KEY = "origin_search_cache_v1";

    const SEARCH_PROVIDERS = {
        tavily: {
            name: "Tavily",
            keyName: "tavily_key",
            baseUrl: "https://api.tavily.com",
            path: "/search"
        }
    };

    function safeJsonParse(str) {
        try { return { ok: true, value: JSON.parse(str) }; }
        catch (e) { return { ok: false, error: String(e) }; }
    }

    function normalizeBaseUrl(baseUrl) {
        const s = String(baseUrl || "").trim();
        return s.replace(/\/+$/, "");
    }

    function joinUrl(baseUrl, path) {
        const b = normalizeBaseUrl(baseUrl);
        const p = String(path || "").trim().replace(/^\/+/, "");
        return `${b}/${p}`;
    }

    function getHostname(url) {
        try { return new URL(String(url || "").trim()).hostname; }
        catch { return ""; }
    }

    function isDomainAllowed(hostname, allowlist) {
        if (!hostname) return false;
        return (allowlist || []).includes(hostname);
    }

    function ensureDomainConsentOrThrow(hostname, consentKey = SEARCH_DOMAIN_CONSENT_KEY) {
        const raw = localStorage.getItem(consentKey) || "{}";
        let obj = {};
        try { obj = JSON.parse(raw); } catch { obj = {}; }

        if (obj[hostname] === true) return true;

        const ok = confirm(
            `你即将发起“检索”请求（包含检索密钥）到域名：${hostname}\n\n` +
            `确认要允许吗？\n` +
            `如果这个域名不是你信任的平台，请点取消。`
        );
        if (!ok) throw new Error("环境错误: 用户取消了检索域名授权");

        obj[hostname] = true;
        localStorage.setItem(consentKey, JSON.stringify(obj));
        return true;
    }

    function classifyFetchError(err) {
        const msg = String(err?.message || err || "");
        const lower = msg.toLowerCase();
        if (lower.includes("abort")) return { kind: "环境错误", msg: "请求超时/被取消（Abort）" };
        if (lower.includes("failed to fetch") || lower.includes("network") || lower.includes("cors")) {
            return { kind: "环境错误", msg: msg };
        }
        return { kind: "内部错误", msg: msg };
    }

    function actionableErrorMessage(kind, msg) {
        if (kind === "用户输入错误") {
            return `用户输入错误：\n- 发生了什么：${msg}\n- 怎么修复：检查检索 Base URL / Query 是否为空。`;
        }
        if (kind === "环境错误") {
            return `环境错误：\n- 发生了什么：${msg}\n- 怎么修复：检查网络/CORS/是否 https 页面访问 http。`;
        }
        if (kind === "平台错误") {
            return `平台错误：\n- 发生了什么：${msg}\n- 怎么修复：检查 tavily_key 是否有效、是否限流/欠费。`;
        }
        return `内部错误：\n- 发生了什么：${msg}`;
    }

    function loadSettings() {
        const raw = localStorage.getItem(SEARCH_SETTINGS_KEY);
        if (!raw) {
            return {
                search_enabled: false,
                provider_id: "tavily",
                base_url: SEARCH_PROVIDERS.tavily.baseUrl,
                search_depth: "basic",
                max_results: 5,
                timeout_ms: 15000,
                cache_enabled: true
            };
        }
        const parsed = safeJsonParse(raw);
        const v = (parsed.ok && parsed.value && typeof parsed.value === "object") ? parsed.value : {};
        return {
            search_enabled: Boolean(v.search_enabled),
            provider_id: String(v.provider_id || "tavily"),
            base_url: String(v.base_url || SEARCH_PROVIDERS.tavily.baseUrl),
            search_depth: (v.search_depth === "advanced") ? "advanced" : "basic",
            max_results: Number.isFinite(Number(v.max_results)) ? Math.min(20, Math.max(1, Math.floor(Number(v.max_results)))) : 5,
            timeout_ms: Number.isFinite(Number(v.timeout_ms)) ? Math.min(60000, Math.max(3000, Math.floor(Number(v.timeout_ms)))) : 15000,
            cache_enabled: (v.cache_enabled !== false)
        };
    }

    function saveSettings(next) {
        localStorage.setItem(SEARCH_SETTINGS_KEY, JSON.stringify(next || {}));
        return true;
    }

    function getProvider(providerId) {
        return SEARCH_PROVIDERS[String(providerId || "")] || null;
    }

    function getKeyStatus(providerId) {
        const p = getProvider(providerId);
        if (!p) return { ok: false, has_key: false, key_name: "" };
        const key = localStorage.getItem(p.keyName);
        return { ok: true, has_key: Boolean(key), key_name: p.keyName };
    }

    async function corsProbe(url, timeoutMs = 8000) {
        const now = new Date().toISOString();
        const u = String(url || "").trim();
        if (!u) return { ok: false, kind: "用户输入错误", result: "空 URL", details: { now, url: u } };

        let parsed;
        try { parsed = new URL(u); }
        catch (e) {
            return { ok: false, kind: "用户输入错误", result: "URL 无效", details: { now, url: u, error: String(e) } };
        }

        if (location.protocol === "https:" && parsed.protocol === "http:") {
            return { ok: false, kind: "环境错误", result: "混合内容（https 页面不能访问 http）", details: { now, url: u } };
        }

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const resp = await fetch(u, { method: "GET", mode: "cors", cache: "no-store", signal: controller.signal });
            return { ok: true, kind: "OK", result: "能拿到响应", details: { now, url: u, status: resp.status } };
        } catch (e) {
            const info = classifyFetchError(e);
            return { ok: false, kind: info.kind, result: "可能被 CORS/网络拦截", details: { now, url: u, error: info.msg } };
        } finally {
            clearTimeout(timer);
        }
    }

    function render_search_settings_html() {
        const providerOptions = Object.keys(SEARCH_PROVIDERS)
            .map(pid => `<option value="${pid}">${SEARCH_PROVIDERS[pid].name}</option>`)
            .join("");

        return `
            <details id="searchSettings">
                <summary style="font-weight:800;">检索设置</summary>
                <div style="margin-top:12px;">
                    <div class="hint" style="margin-bottom: 12px;">
                        默认不检索；需要先在 <a href="key-manager.html" target="_blank">key-manager.html</a> 设置 <code>tavily_key</code>，然后勾选“允许检索”。
                    </div>

                    <div class="row" style="margin-bottom: 12px;">
                        <span class="pill warn">
                            <input id="searchNetworkingToggle" type="checkbox" style="transform: translateY(1px);" />
                            <span>允许检索（默认关闭）</span>
                        </span>
                        <span class="pill" id="searchKeyStatusPill">检索密钥：未检查</span>
                        <span class="pill accent" id="searchCachePill">缓存：开</span>
                    </div>

                    <div class="grid grid-2" style="gap: 12px;">
                        <div class="field">
                            <label for="searchProviderSelect">Provider</label>
                            <select id="searchProviderSelect">${providerOptions}</select>
                        </div>
                        <div class="field">
                            <label for="searchDepthSelect">search_depth</label>
                            <select id="searchDepthSelect">
                                <option value="basic">basic（更快/更省）</option>
                                <option value="advanced">advanced（更准/更慢）</option>
                            </select>
                        </div>
                    </div>

                    <details style="margin-top: 12px;">
                        <summary>高级设置</summary>
                        <div class="grid grid-2" style="gap: 12px; margin-top: 10px;">
                            <div class="field">
                                <label for="searchBaseUrlInput">Base URL</label>
                                <input id="searchBaseUrlInput" type="text" placeholder="https://api.tavily.com" />
                            </div>
                            <div class="field">
                                <label for="searchMaxResultsInput">max_results (1-20)</label>
                                <input id="searchMaxResultsInput" type="text" value="5" />
                            </div>
                            <div class="field">
                                <label for="searchTimeoutInput">timeout_ms</label>
                                <input id="searchTimeoutInput" type="text" value="15000" />
                            </div>
                            <div class="field">
                                <label for="searchCacheToggle">缓存</label>
                                <select id="searchCacheToggle">
                                    <option value="on">开启</option>
                                    <option value="off">关闭</option>
                                </select>
                            </div>
                        </div>
                    </details>

                    <div class="row" style="margin-top: 12px;">
                        <button class="btn secondary" id="searchSyncBtn" type="button">恢复默认</button>
                        <button class="btn secondary" id="searchCorsProbeBtn" type="button">CORS 探测</button>
                    </div>

                    <div class="log" id="searchLog" style="margin-top: 12px;">SEARCH_MODULE 就绪。</div>
                </div>
            </details>
        `;
    }

    function mount_search_settings({ mount_el, default_provider_id = "tavily", on_state_change = null }) {
        if (!mount_el) throw new Error("mount_el is required");

        mount_el.innerHTML = render_search_settings_html();
        const $ = (id) => mount_el.querySelector(id);

        const searchNetworkingToggle = $("#searchNetworkingToggle");
        const searchProviderSelect = $("#searchProviderSelect");
        const searchDepthSelect = $("#searchDepthSelect");
        const searchBaseUrlInput = $("#searchBaseUrlInput");
        const searchMaxResultsInput = $("#searchMaxResultsInput");
        const searchTimeoutInput = $("#searchTimeoutInput");
        const searchCacheToggle = $("#searchCacheToggle");

        const searchKeyStatusPill = $("#searchKeyStatusPill");
        const searchCachePill = $("#searchCachePill");

        const searchSyncBtn = $("#searchSyncBtn");
        const searchCorsProbeBtn = $("#searchCorsProbeBtn");
        const searchLog = $("#searchLog");

        let state = loadSettings();
        if (!state.provider_id) state.provider_id = default_provider_id;

        function emit() { on_state_change && on_state_change(get_state()); }

        function setKeyStatusPill(providerId) {
            const ks = getKeyStatus(providerId);
            if (!ks.ok) {
                searchKeyStatusPill.className = "pill bad";
                searchKeyStatusPill.textContent = "检索密钥：未知";
                return;
            }
            if (ks.has_key) {
                searchKeyStatusPill.className = "pill good";
                searchKeyStatusPill.textContent = "检索密钥：已设置";
            } else {
                searchKeyStatusPill.className = "pill bad";
                searchKeyStatusPill.textContent = "检索密钥：未设置";
            }
        }

        function setCachePill() {
            if (state.cache_enabled) {
                searchCachePill.className = "pill accent";
                searchCachePill.textContent = "缓存：开";
            } else {
                searchCachePill.className = "pill";
                searchCachePill.textContent = "缓存：关";
            }
        }

        function syncUI() {
            searchNetworkingToggle.checked = Boolean(state.search_enabled);
            searchProviderSelect.value = state.provider_id;
            searchDepthSelect.value = state.search_depth;
            searchBaseUrlInput.value = state.base_url;
            searchMaxResultsInput.value = String(state.max_results);
            searchTimeoutInput.value = String(state.timeout_ms);
            searchCacheToggle.value = state.cache_enabled ? "on" : "off";

            setKeyStatusPill(state.provider_id);
            setCachePill();
        }

        function persist() {
            saveSettings(state);
            emit();
        }

        // init
        syncUI();
        persist();

        searchNetworkingToggle.addEventListener("change", () => {
            state.search_enabled = Boolean(searchNetworkingToggle.checked);
            searchLog.textContent = state.search_enabled
                ? "已允许检索：将在 source/navigate 生成前尝试注入证据（失败会自动降级）。"
                : "已关闭检索：不会发起任何检索请求。";
            persist();
        });

        searchProviderSelect.addEventListener("change", () => {
            state.provider_id = String(searchProviderSelect.value || "tavily");
            const p = getProvider(state.provider_id) || SEARCH_PROVIDERS.tavily;
            if (!state.base_url) state.base_url = p.baseUrl;
            setKeyStatusPill(state.provider_id);
            persist();
        });

        searchDepthSelect.addEventListener("change", () => {
            state.search_depth = (searchDepthSelect.value === "advanced") ? "advanced" : "basic";
            persist();
        });

        searchBaseUrlInput.addEventListener("change", () => {
            state.base_url = String(searchBaseUrlInput.value || "").trim();
            persist();
        });

        searchMaxResultsInput.addEventListener("change", () => {
            const v = Math.floor(Number(searchMaxResultsInput.value));
            state.max_results = Number.isFinite(v) ? Math.min(20, Math.max(1, v)) : 5;
            searchMaxResultsInput.value = String(state.max_results);
            persist();
        });

        searchTimeoutInput.addEventListener("change", () => {
            const v = Math.floor(Number(searchTimeoutInput.value));
            state.timeout_ms = Number.isFinite(v) ? Math.min(60000, Math.max(3000, v)) : 15000;
            searchTimeoutInput.value = String(state.timeout_ms);
            persist();
        });

        searchCacheToggle.addEventListener("change", () => {
            state.cache_enabled = (searchCacheToggle.value === "on");
            setCachePill();
            persist();
        });

        searchSyncBtn.addEventListener("click", () => {
            state = {
                search_enabled: false,
                provider_id: "tavily",
                base_url: SEARCH_PROVIDERS.tavily.baseUrl,
                search_depth: "basic",
                max_results: 5,
                timeout_ms: 15000,
                cache_enabled: true
            };
            syncUI();
            persist();
            searchLog.textContent = "已恢复检索默认设置（默认关闭）。";
        });

        searchCorsProbeBtn.addEventListener("click", async () => {
            const p = getProvider(state.provider_id) || SEARCH_PROVIDERS.tavily;
            const base = String(state.base_url || p.baseUrl);
            const probeUrl = joinUrl(base, p.path);
            searchLog.textContent = "CORS 探测中…";
            const res = await corsProbe(probeUrl, 8000);
            searchLog.textContent = JSON.stringify(res, null, 2);
        });

        function get_state() {
            return {
                ...state,
                key_status: getKeyStatus(state.provider_id)
            };
        }

        function readCache() {
            const raw = localStorage.getItem(SEARCH_CACHE_KEY) || "[]";
            const parsed = safeJsonParse(raw);
            const arr = (parsed.ok && Array.isArray(parsed.value)) ? parsed.value : [];
            return arr;
        }

        function writeCache(arr) {
            const list = Array.isArray(arr) ? arr : [];
            const trimmed = list.slice(-50);
            localStorage.setItem(SEARCH_CACHE_KEY, JSON.stringify(trimmed));
            return true;
        }

        function makeCacheKey({ mode, query }) {
            const day = new Date().toISOString().slice(0, 10);
            const q = String(query || "").trim().toLowerCase().slice(0, 160);
            const m = String(mode || "").trim();
            return `${day}:${m}:${q}`;
        }

        async function call_search({ mode = "source", query = "" }) {
            const s = get_state();
            if (!s.search_enabled) {
                const e = new Error("环境错误: 当前未允许检索（请在检索设置里勾选“允许检索”）");
                e._kind = "环境错误";
                throw e;
            }

            const p = getProvider(s.provider_id);
            if (!p) {
                const e = new Error(`用户输入错误: 未知检索 provider_id: ${s.provider_id}`);
                e._kind = "用户输入错误";
                throw e;
            }

            const q = String(query || "").trim();
            if (!q) {
                const e = new Error("用户输入错误: query 为空");
                e._kind = "用户输入错误";
                throw e;
            }

            // cache hit
            if (s.cache_enabled) {
                try {
                    const ck = makeCacheKey({ mode, query: q });
                    const arr = readCache();
                    const hit = arr.find(x => x && x.key === ck && Array.isArray(x.sources));
                    if (hit && hit.sources) {
                        return hit.sources;
                    }
                } catch {}
            }

            const baseUrl = String(s.base_url || p.baseUrl).trim();
            if (!baseUrl) {
                const e = new Error("用户输入错误: base_url 为空");
                e._kind = "用户输入错误";
                throw e;
            }

            // mixed content guard
            let baseParsed;
            try { baseParsed = new URL(baseUrl); }
            catch {
                const e = new Error("用户输入错误: base_url 不是合法 URL");
                e._kind = "用户输入错误";
                throw e;
            }
            if (location.protocol === "https:" && baseParsed.protocol === "http:") {
                const e = new Error("环境错误: 混合内容（https 页面不能访问 http）");
                e._kind = "环境错误";
                throw e;
            }

            // domain allowlist + consent
            const hostname = getHostname(baseUrl);
            const allowlist = ["api.tavily.com"];
            if (!isDomainAllowed(hostname, allowlist)) {
                ensureDomainConsentOrThrow(hostname, SEARCH_DOMAIN_CONSENT_KEY);
            }

            const apiKey = localStorage.getItem(p.keyName) || "";
            if (!apiKey) {
                const e = new Error("平台错误: 缺少检索 API Key（请先在 key-manager.html 设置 tavily_key）");
                e._kind = "平台错误";
                throw e;
            }

            const url = joinUrl(baseUrl, p.path);

            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), s.timeout_ms);

            try {
                const resp = await fetch(url, {
                    method: "POST",
                    mode: "cors",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        query: q,
                        max_results: s.max_results,
                        search_depth: s.search_depth,
                        include_answer: false,
                        include_raw_content: false
                    }),
                    signal: controller.signal
                });

                const text = await resp.text();
                let json = null;
                try { json = JSON.parse(text); } catch {}

                if (!resp.ok) {
                    const e = new Error(`平台错误: HTTP ${resp.status} ${resp.statusText}\n${text.slice(0, 800)}`);
                    e._kind = "平台错误";
                    throw e;
                }

                const results = Array.isArray(json?.results) ? json.results : [];
                const sources = results
                    .filter(r => r && (r.url || r.title || r.content))
                    .map(r => ({
                        title: String(r.title || "").trim() || "（无标题）",
                        url: String(r.url || "").trim(),
                        snippet: String(r.content || "").trim(),
                        score: (typeof r.score === "number") ? r.score : null,
                        provider: s.provider_id
                    }))
                    .filter(x => x.url || x.title || x.snippet);

                if (s.cache_enabled) {
                    try {
                        const ck = makeCacheKey({ mode, query: q });
                        const arr = readCache();
                        arr.push({ key: ck, at: new Date().toISOString(), sources });
                        writeCache(arr);
                    } catch {}
                }

                return sources;
            } catch (e) {
                const info = classifyFetchError(e);
                const err = new Error(`${info.kind}: ${info.msg}`);
                err._kind = info.kind;
                throw err;
            } finally {
                clearTimeout(timer);
            }
        }

        function get_actionable_error(err) {
            const kind = err?._kind || "内部错误";
            const msg = String(err?.message || err || "");
            return actionableErrorMessage(kind, msg);
        }

        return {
            get_state,
            call_search,
            get_actionable_error
        };
    }

    return {
        SEARCH_PROVIDERS,
        mount_search_settings
    };
})();
/* -----------------------------
 * 2) App state & helpers + storage keys
 * ----------------------------- */
const STORAGE_KEYS = {
    MASTERS: "origin_masters_v1",
    SKILLS: "origin_skills_v1",
    COMPASS_SNAPSHOT: "origin_compass_snapshot_v1",
    COMPASS_HISTORY: "origin_compass_history_v1",
    THEME: "origin_theme_v1",
    CHECKLIST_LAST: "origin_checklist_last_v1",
    CHECKLIST_STATE: "origin_checklist_state_v1",
    MORNING_TODAY: "origin_morning_today_v1",
    MORNING_JOURNAL: "origin_morning_journal_v1",

    AUDIT_LOG: "origin_audit_log_v1",
    ASSET_BUNDLE_LAST: "origin_asset_bundle_last_v1",
    RESULTS_CACHE: "origin_results_cache_v1",

    // NEW (search, for unified management / rollback)
    SEARCH_SETTINGS: "origin_search_settings_v1",
    SEARCH_DOMAIN_CONSENT: "origin_search_domain_consent_v1",
    SEARCH_CACHE: "origin_search_cache_v1"
};

const LIMITS = {
    AUDIT_LOG_MAX: 300,
    MORNING_JOURNAL_MAX: 200,
    CHECKLIST_STATE_DAYS_MAX: 30
};

function escapeHtml(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
}

function showToast(message, type = "success") {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => { toast.className = "toast"; }, 2800);
}

function safeJsonParseGlobal(str) {
    try { return { ok: true, value: JSON.parse(str) }; }
    catch (e) { return { ok: false, error: String(e) }; }
}

function safeLoadJson(key, fallback) {
    try {
        if (!AppState.storage_ok) return fallback;
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = safeJsonParseGlobal(raw);
        if (!parsed.ok) return fallback;
        return parsed.value;
    } catch {
        return fallback;
    }
}

function safeSaveJson(key, value) {
    try {
        if (!AppState.storage_ok) return false;
        localStorage.setItem(key, JSON.stringify(value));
        return true;
    } catch {
        return false;
    }
}

function nowISO() { return new Date().toISOString(); }

function highlightElementById(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const old = el.style.boxShadow;
    el.style.boxShadow = "0 0 0 3px " + "color-mix(in srgb, var(--accent) 25%, transparent)";
    setTimeout(() => { el.style.boxShadow = old || ""; }, 900);
}

/* -----------------------------
 * 2.0) Balanced example pool (NEW)
 * ----------------------------- */
const EXAMPLE_POOL = {
    humanities: [
        "中国古代文学",
        "哲学入门（认识论）",
        "艺术史（现代主义）"
    ],
    socsci: [
        "微观经济学",
        "社会学研究方法",
        "国际关系理论"
    ],
    science: [
        "线性代数",
        "热力学",
        "有机化学"
    ],
    engineering_cs: [
        "编译原理",
        "操作系统",
        "机器学习"
    ],
    bio_med: [
        "人体解剖学",
        "分子生物学"
    ],
    general: [
        "写作表达",
        "公开演讲",
        "学术论文写作"
    ]
};

function pickRandom(arr) {
    if (!Array.isArray(arr) || arr.length === 0) return null;
    return arr[Math.floor(Math.random() * arr.length)];
}

function shuffleCopy(arr) {
    const a = Array.isArray(arr) ? arr.slice() : [];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = a[i];
        a[i] = a[j];
        a[j] = tmp;
    }
    return a;
}

function buildBalancedExampleList({ perGroup = 1 } = {}) {
    const groups = [
        EXAMPLE_POOL.humanities,
        EXAMPLE_POOL.socsci,
        EXAMPLE_POOL.science,
        EXAMPLE_POOL.engineering_cs,
        EXAMPLE_POOL.bio_med,
        EXAMPLE_POOL.general
    ];

    const picked = [];
    groups.forEach(g => {
        const shuffled = shuffleCopy(g);
        shuffled.slice(0, Math.max(1, Math.floor(perGroup))).forEach(x => picked.push(x));
    });
    return picked.filter(Boolean);
}

function pickExamplesForDisplay({ total = 6 } = {}) {
    // 先保证均衡覆盖：每组至少 1 个
    let base = buildBalancedExampleList({ perGroup: 1 });

    // 如果 total < base，就截断；如果 total > base，再从全池补齐
    base = shuffleCopy(base);
    if (base.length >= total) return base.slice(0, total);

    const all = []
        .concat(EXAMPLE_POOL.humanities, EXAMPLE_POOL.socsci, EXAMPLE_POOL.science, EXAMPLE_POOL.engineering_cs, EXAMPLE_POOL.bio_med, EXAMPLE_POOL.general)
        .filter(Boolean);

    const pool = shuffleCopy(all).filter(x => !base.includes(x));
    return base.concat(pool.slice(0, total - base.length));
}

/* -----------------------------
 * 2.0.1) Checklist custom domain UI helper (NEW)
 * ----------------------------- */
function updateChecklistCustomUI() {
    const sel = document.getElementById("checklistDomain");
    const wrap = document.getElementById("checklistCustomWrap");
    const input = document.getElementById("checklistCustomDomain");
    if (!sel || !wrap || !input) return;

    const isCustom = (String(sel.value) === "__custom__");
    wrap.style.display = isCustom ? "block" : "none";

    if (isCustom) {
        // 不强制清空，避免用户切换误丢；仅聚焦提示
        setTimeout(() => input.focus(), 50);
    }
}
/* -----------------------------
 * 2.1) Audit log (Phase 1/2)
 * ----------------------------- */
function auditLogAdd(evt) {
    if (!AppState.storage_ok) return false;
    const entry = {
        at: nowISO(),
        ...evt
    };
    const arr = safeLoadJson(STORAGE_KEYS.AUDIT_LOG, []);
    const next = Array.isArray(arr) ? arr : [];
    next.push(entry);
    const trimmed = next.slice(-LIMITS.AUDIT_LOG_MAX);
    return safeSaveJson(STORAGE_KEYS.AUDIT_LOG, trimmed);
}

function toastSaved({ where, count, extra = "" }) {
    const tail = (typeof count === "number") ? ` · 当前 ${count}` : "";
    const ex = extra ? ` · ${extra}` : "";
    showToast(`已保存到「${where}」${tail}${ex}`, "success");
}

function toastDeleted({ what, count }) {
    const tail = (typeof count === "number") ? ` · 当前 ${count}` : "";
    showToast(`已删除：${what}${tail}`, "warn");
}

/* -----------------------------
 * 2.2) Copy / Download helpers (Phase 3)
 * ----------------------------- */
async function copyTextWithFallback(text) {
    const s = String(text || "");
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(s);
            showToast("已复制", "success");
            return true;
        }
    } catch {}
    // fallback
    try {
        const ta = document.createElement("textarea");
        ta.value = s;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        ta.style.top = "0";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        showToast(ok ? "已复制" : "复制失败", ok ? "success" : "error");
        return ok;
    } catch {
        showToast("复制失败", "error");
        return false;
    }
}

function downloadTextFile(filename, text, mime = "text/plain;charset=utf-8") {
    try {
        const blob = new Blob([String(text || "")], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        return true;
    } catch (e) {
        console.warn("downloadTextFile failed:", e);
        return false;
    }
}

function downloadJsonFile(filename, obj) {
    return downloadTextFile(filename, JSON.stringify(obj, null, 2), "application/json;charset=utf-8");
}

function openPrintView({ title, contentText }) {
    const t = String(title || "导出");
    const bodyText = String(contentText || "");
    const w = window.open("", "_blank");
    if (!w) {
        showToast("弹窗被拦截：请允许弹窗后重试", "error");
        return false;
    }
    const html = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(t)}</title>
<style>
    @page { margin: 16mm; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#111; background:#fff; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .meta { color:#555; font-size:12px; margin-bottom: 12px; }
    pre { white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; line-height: 1.6; }
</style>
</head>
<body>
    <h1>${escapeHtml(t)}</h1>
    <div class="meta">导出时间：${escapeHtml(nowISO())}（请在系统打印对话框选择“另存为 PDF”）</div>
    <pre>${escapeHtml(bodyText)}</pre>
    <script>
        setTimeout(() => { window.print(); }, 200);
    <\/script>
</body>
</html>`;
    w.document.open();
    w.document.write(html);
    w.document.close();
    return true;
}

/* -----------------------------
 * 2.3) Last result cache (Phase 3)
 * ----------------------------- */
const LastResult = {
    mode: "",
    data: null,
    at: "",
    set(mode, data) {
        this.mode = String(mode || "");
        this.data = data;
        this.at = nowISO();
        if (AppState.storage_ok) {
            const payload = { mode: this.mode, at: this.at, data: data };
            // avoid huge cache
            const text = JSON.stringify(payload);
            if (text.length <= 180000) {
                safeSaveJson(STORAGE_KEYS.RESULTS_CACHE, payload);
            } else {
                safeSaveJson(STORAGE_KEYS.RESULTS_CACHE, { mode: this.mode, at: this.at, data: { _raw_text: "结果过大，未缓存。" } });
            }
        }
        updateResultsActionBar();
    },
    loadFromStorage() {
        const cached = safeLoadJson(STORAGE_KEYS.RESULTS_CACHE, null);
        if (cached && typeof cached === "object" && cached.mode) {
            this.mode = cached.mode;
            this.at = cached.at || "";
            this.data = cached.data ?? null;
        }
    }
};

/* -----------------------------
 * 2.4) AppState (unchanged core)
 * ----------------------------- */
const AppState = {
    masters: [],
    skills: [],
    currentMode: "source",
    storage_ok: true,
    lastRequest: null,
    setLastRequest(req) { this.lastRequest = req; },

    load() {
        if (!this.storage_ok) return;
        try {
            const masters = localStorage.getItem(STORAGE_KEYS.MASTERS);
            const skills = localStorage.getItem(STORAGE_KEYS.SKILLS);
            if (masters) this.masters = JSON.parse(masters);
            if (skills) this.skills = JSON.parse(skills);
        } catch (e) {
            console.error("Failed to load state:", e);
        }
    },

    save() {
        if (!this.storage_ok) return;
        try {
            localStorage.setItem(STORAGE_KEYS.MASTERS, JSON.stringify(this.masters));
            localStorage.setItem(STORAGE_KEYS.SKILLS, JSON.stringify(this.skills));
            auditLogAdd({ type: "save", entity: "app_state", ok: true, key: "MASTERS/SKILLS" });
        } catch (e) {
            auditLogAdd({ type: "save", entity: "app_state", ok: false, key: "MASTERS/SKILLS", error: String(e) });
            console.error("Failed to save state:", e);
        }
    },

    addMaster(master) {
        if (!this.masters.find(m => m.name === master.name)) {
            this.masters.push(master);
            this.save();
            return true;
        }
        return false;
    },

    removeMaster(name) {
        this.masters = this.masters.filter(m => m.name !== name);
        this.save();
    },

    addSkill(skill) {
        if (!this.skills.find(s => s.name === skill.name && s.from === skill.from)) {
            this.skills.push(skill);
            this.save();
            return true;
        }
        return false;
    },

    removeSkill(name, from) {
        const before = this.skills.length;
        this.skills = this.skills.filter(s => !(s.name === name && s.from === from));
        const after = this.skills.length;
        if (after !== before) this.save();
        return after !== before;
    }
};
/* -----------------------------
 * 3) PROMPTS (updated for academic + citations) + MODE_HELP
 * ----------------------------- */
const PROMPTS_JSON = {
    "source": {
        "system": "你是“源流 Origin”的源头参照系构建引擎（Academic + Skills）。你的任务：把用户输入的学科/领域/技能，转化为一个可执行、可核验、可资产化的“源头参照系”。\n\n【核心立场】\n1) 源头参照系优先：人物/学派 + 教材/经典书 + 奠基论文/综述 + 权威课程（必要时补充 standard/dataset）。\n2) 反噪音：禁止网红/付费课讲师/营销号/二道贩子。\n3) 学习闭环：给出“先修→材料→练习→自测→里程碑→下一步调用（navigate/deconstruct）”。\n4) 诚实与可核验：不确定就标注 uncertainty；不要编造书目/论文/链接。\n5) 引用原则（强约束）：\n    - 若用户提供【可引用证据】，你只能引用证据中出现过的 URL。\n    - citations 必须包含 evidence_ids（对应证据编号）。\n    - 若无证据或证据不足：url 留空，并在 uncertainty_notes 说明如何核验。\n\n【输出规则】\n- 只输出严格 JSON（不要 Markdown/解释）。\n- 字段尽量短句；但 steps/plan 可稍长以保证可执行。\n- 若用户输入过于宽泛：仍输出，但在 assumptions 与 questions_to_confirm 里写出缩小范围的方法（不要反问式闲聊）。",
        "user_template": "用户输入（学科/领域/技能）：{skill}\n\n请输出“源头参照系”，至少覆盖：\n- 人（学者/学派/里程碑人物）\n- 书（教材/经典书/讲义）\n- 文（奠基论文/综述/经典章节）\n- 课（权威课程/公开课/课程主页）\n可选：standard / dataset。\n\n只输出 JSON，Schema：\n{\n  \"skill\": \"用户输入\",\n  \"field\": \"更规范的学科表述（可与 skill 相同）\",\n  \"scope\": {\n    \"interpretation\": \"你对该输入的理解（短句）\",\n    \"level_guess\": \"入门/进阶/研究（猜测）\",\n    \"goal_guess\": \"用户可能的目标（短句）\"\n  },\n  \"assumptions\": [\"默认假设1\", \"默认假设2\"],\n  \"questions_to_confirm\": [\"用户如果愿意确认的关键问题1\", \"问题2\"],\n  \"prereq_diagnosis\": [\n    { \"topic\": \"先修点\", \"why_needed\": \"为何需要\", \"quick_check\": \"30秒自测\", \"patch_path\": \"如何补\" }\n  ],\n  \"references\": [\n    {\n      \"type\": \"person|book|paper|course|standard|dataset\",\n      \"title\": \"名称\",\n      \"why_foundational\": \"为何基础/源头（<=50字）\",\n      \"what_to_learn\": \"学什么（能力/框架/方法）\",\n      \"access_hint\": \"获取方式/版本/入口（可为空）\",\n      \"best_use\": \"用它干什么（定义/地图/训练/查证/对照）\",\n      \"level_hint\": \"入门/进阶/研究（可选）\",\n      \"language_or_region\": \"语言/地区（可选）\",\n      \"confidence\": \"高/中/低\",\n      \"url\": \"链接（可选；无证据则留空）\"\n    }\n  ],\n  \"masters\": [\n    {\n      \"name\": \"可收藏大师（若适用）\",\n      \"domain\": \"细分方向\",\n      \"era\": \"年代（可空）\",\n      \"aesthetic_coordinates\": { \"temperature\": \"冷/中/热\", \"density\": \"高/中/低\", \"aggression\": \"高/中/低\", \"structure\": \"强/中/弱\" },\n      \"why_source_level\": \"为何源头级（<=50字）\",\n      \"core_contribution\": \"一句话贡献\",\n      \"learnability_score\": 1,\n      \"learnability_note\": \"可学性说明（可得性/先修/语言）\",\n      \"masterpieces\": [\"代表作/代表材料\"],\n      \"learn_what\": \"具体学什么（能力模块）\",\n      \"learn_how\": \"怎么学（先看→再拆→再练）\",\n      \"quick_taste\": \"风格触感/片段描述\"\n    }\n  ],\n  \"mini_learning_loop\": {\n    \"today_30min\": \"30分钟最小动作\",\n    \"this_week\": \"本周目标（可执行）\",\n    \"deliverable\": \"你最终要产出的东西（作业/笔记/证明/实验报告/短文）\",\n    \"self_test\": [\"自测题/判定标准\"]\n  },\n  \"citations\": [\n    { \"title\": \"来源标题\", \"url\": \"证据链接\", \"evidence_ids\": [1], \"why_trust\": \"可信理由\", \"used_for\": \"支撑哪条结论\" }\n  ],\n  \"anti_patterns\": [ { \"type\": \"噪音源类型\", \"why\": \"为何规避\", \"examples\": [\"例\"] } ],\n  \"learning_strategy\": \"元建议（强调先看/浸泡）\",\n  \"meta_insight\": \"一句话点破本质\",\n  \"uncertainty_notes\": \"不确定/需核验清单\"\n}\n\n注意：如果你无法给出可靠 url，就留空 url，并把核验路径写在 uncertainty_notes。"
    },

    "navigate": {
        "system": "你是“源流 Origin”的学习路径（Learning Path）引擎，面向学科/技能训练。\n\n【目标】输出一条可执行的路径：先修→材料顺序→练习与作业→自测与里程碑→常见误区→复盘与资产化。\n\n【要求】\n1) 具体化：尽量具体到章节/主题/训练方式（不要只说“去看某书”）。\n2) 顺序理由：每一步要说明“为什么先做它”。\n3) 练习优先：每一步必须配练习（题/证明/实验/写作/讨论），并给评价标准。\n4) 适配不同学科：\n    - STEM：强调题型、证明模板、实验设计、误差与复现。\n    - 人文社科：强调文本细读、论证重构、史料批判、写作与引用规范。\n5) 引用原则（强约束）：若提供【可引用证据】，只能引用证据 URL；citations 必须包含 evidence_ids；不得编造链接。\n\n【输出规则】只输出严格 JSON。字段短句，但 study_plan 可适当详细以保证可执行。",
        "user_template": "【导航请求】\n主题/对象：{master}\n用户时间预算：{time_budget}\n用户当前水平：{level}\n\n只输出 JSON，Schema：\n{\n  \"master\": \"主题/对象\",\n  \"user_level\": \"用户水平\",\n  \"time_budget\": \"时间预算\",\n  \"path_rationale\": \"总的路径设计逻辑（短）\",\n  \"prerequisites\": [ { \"topic\": \"先修点\", \"why_needed\": \"为什么\", \"how_to_patch\": \"如何补\", \"check_task\": \"自测\" } ],\n  \"learning_path\": {\n    \"gateway_work\": {\n      \"title\": \"入门首选\",\n      \"type\": \"类型\",\n      \"access\": \"获取方式\",\n      \"why_start_here\": \"原因\",\n      \"time_required\": \"耗时\",\n      \"what_to_notice\": [\"注意点\"],\n      \"homework\": { \"observation\": \"观察作业\", \"practice\": \"练习作业\" },\n      \"grading_rubric\": [\"评分标准/通过条件\"]\n    },\n    \"core_works\": [\n      { \"title\": \"材料/章节/主题\", \"type\": \"类型\", \"why_important\": \"重要性\", \"what_to_notice\": [\"注意\"], \"builds_on\": \"承接\", \"homework\": \"作业\", \"grading_rubric\": [\"标准\"] }\n    ],\n    \"skip_list\": [ { \"title\": \"可跳过\", \"why_skip\": \"原因\", \"when_to_revisit\": \"何时回看\" } ]\n  },\n  \"study_plan\": [\n    { \"phase\": \"阶段\", \"duration\": \"耗时\", \"chapters_or_topics\": [\"章节/主题\"], \"goals\": [\"目标\"], \"exercises\": \"练习建议\", \"proofs_or_labs\": \"证明/实验训练\", \"deliverable\": \"要产出什么\" }\n  ],\n  \"common_misconceptions\": [\"常见误区\"],\n  \"practice_bank\": [ { \"source\": \"题源/任务源\", \"location_hint\": \"定位\", \"problem_types\": [\"题型\"], \"suggestion\": \"建议\" } ],\n  \"milestone\": { \"after_gateway\": \"完成入门后你能…\", \"after_core\": \"完成核心后你能…\", \"mastery_sign\": \"学到位标志\" },\n  \"spaced_review\": { \"schedule\": [\"D1/D3/D7…\"], \"retrieval_prompts\": [\"检索练习提示\"] },\n  \"citations\": [ { \"title\": \"来源标题\", \"url\": \"证据链接\", \"evidence_ids\": [1], \"why_trust\": \"可信理由\", \"used_for\": \"支撑哪条结论\" } ],\n  \"personalized_advice\": \"个性化建议\",\n  \"uncertainty_notes\": \"不确定/需核验\"\n}\n\n注意：如果无法确定章节/题源，请明确标注 uncertainty_notes，并给出核验路径（例如课程主页/目录/ISBN/论文 DOI）。"
    },

    "deconstruct": {
        "system": "你是“源流 Origin”的四层拆解引擎（L1-L4）。你的任务不是写评论，而是把对象拆成：可观察事实→可迁移结构→可练习技能→可自检标准。\n\n【四层框架】\nL1 表层特征（可见风格）\nL2 结构模式（骨架/节奏/推理/论证）\nL3 心理表征（目标函数/质量标准/决策准则）\nL4 元认知（信念/方法论原则）\n\n【硬要求】\n1) 每层必须区分：fact(观察) vs inference(推断)，并给 confidence。\n2) 每层必须给“练习任务”（可交付）。\n3) extractable_skills 每条必须包含：触发条件、步骤、常见错误、最小练习、升级练习。\n4) 引用原则：有证据则用 citations（带 evidence_ids），无证据则 citations 允许为空，禁止编造。\n\n【输出规则】只输出 JSON。",
        "user_template": "请对「{master}」进行四层拆解。\n{focus_line}\n\n只输出 JSON，Schema：\n{\n  \"master\": \"对象\",\n  \"focus\": \"聚焦\",\n  \"overview\": \"一句话概括\",\n  \"layers\": {\n    \"L1_surface\": {\n      \"title\": \"表层特征\",\n      \"features\": [ { \"feature\": \"特征\", \"example\": \"示例\", \"frequency\": \"常见/偶尔/标志性\", \"evidence\": \"依据\" } ],\n      \"transferability\": 2,\n      \"transfer_warning\": \"直接模仿风险\",\n      \"practice\": { \"task\": \"练习任务\", \"deliverable\": \"交付物\", \"grading_rubric\": [\"标准\"] }\n    },\n    \"L2_structure\": {\n      \"title\": \"结构模式\",\n      \"patterns\": [ { \"pattern_name\": \"模式名\", \"description\": \"描述\", \"example\": \"示例\", \"applicable_scenarios\": [\"场景\"], \"evidence\": \"依据\" } ],\n      \"transferability\": 4,\n      \"practice\": { \"task\": \"练习任务\", \"deliverable\": \"交付物\", \"grading_rubric\": [\"标准\"] }\n    },\n    \"L3_mental\": {\n      \"title\": \"心理表征\",\n      \"representations\": [ { \"aspect\": \"方面\", \"content\": \"内容\", \"evidence\": \"依据\", \"confidence\": \"高/中/低\" } ],\n      \"transferability\": 5,\n      \"self_check_questions\": [\"自检问题\"],\n      \"practice\": { \"task\": \"练习任务\", \"deliverable\": \"交付物\", \"grading_rubric\": [\"标准\"] }\n    },\n    \"L4_meta\": {\n      \"title\": \"元认知\",\n      \"beliefs\": [ { \"belief_type\": \"类型\", \"content\": \"内容\", \"evidence\": \"依据\", \"confidence\": \"高/中/低\" } ],\n      \"transferability\": 3,\n      \"reflection_prompt\": \"反思问题\",\n      \"practice\": { \"task\": \"练习任务\", \"deliverable\": \"交付物\", \"grading_rubric\": [\"标准\"] }\n    }\n  },\n  \"extractable_skills\": [\n    {\n      \"skill_name\": \"技法名\",\n      \"from_layer\": \"L2/L3\",\n      \"description\": \"描述\",\n      \"trigger\": \"何时使用/触发条件\",\n      \"how_to_practice\": \"最小练习步骤\",\n      \"common_errors\": [\"常见错误\"],\n      \"upgrade_drill\": \"升级练习\",\n      \"difficulty\": \"入门/进阶/高阶\"\n    }\n  ],\n  \"synthesis\": {\n    \"one_sentence_essence\": \"一句话精华\",\n    \"biggest_misconception\": \"常见误解\",\n    \"learning_path_suggestion\": \"先看什么再拆什么\",\n    \"related_masters\": [\"对照对象\"]\n  },\n  \"citations\": [ { \"title\": \"来源标题\", \"url\": \"证据链接\", \"evidence_ids\": [1], \"why_trust\": \"可信理由\", \"used_for\": \"支撑哪条结论\" } ],\n  \"uncertainty_notes\": \"不确定/需核验\"\n}"
    },

    "transfer": {
        "system": "你是“源流 Origin”的迁移实验室教练：把某个技法迁移到用户场景，并设计可验证的最小实验。\n\n【迁移四步法】\n1) 抽象（从具体做法抽出可迁移原则）\n2) 匹配（映射到目标场景元素）\n3) 变体（至少 3 个可直接使用的版本）\n4) 实验（最小样本 + 指标 + 迭代）\n\n【硬要求】\n- 每个变体必须给可直接使用的 concrete_example（>=50字）。\n- 指标必须可观测、可对比。\n- 明确失败模式与修正路径。\n- 不要伪造引用。\n\n【输出规则】只输出 JSON。",
        "user_template": "【迁移任务】\n要迁移的技法：{technique}\n技法来源：{master}\n目标场景：{scenario}\n{constraints_line}\n\n只输出 JSON，Schema：\n{\n  \"technique\": \"技法名称\",\n  \"source_master\": \"来源\",\n  \"target_scenario\": \"场景\",\n  \"constraints\": \"约束\",\n  \"transfer_analysis\": { \"transfer_type\": \"近迁移/中迁移/远迁移\", \"transfer_type_reason\": \"原因\", \"key_challenges\": [\"挑战\"] },\n  \"steps\": {\n    \"step1_abstraction\": { \"master_specific_example\": \"片段描述\", \"abstracted_principle\": \"原则\", \"principle_formula\": \"公式\", \"principle_essence\": \"本质\" },\n    \"step2_mapping\": { \"mapping_table\": [ { \"original_element\": \"原\", \"target_element\": \"目标\", \"adaptation_needed\": \"适配\", \"adaptation_reason\": \"原因\" } ], \"unmappable_elements\": \"无法映射\", \"constraint_impact\": \"约束影响\" },\n    \"step3_variations\": { \"variations\": [ { \"variation_name\": \"变体名\", \"variation_type\": \"近/中/远\", \"description\": \"描述\", \"concrete_example\": \"完整示例(>=50字)\", \"how_it_applies_principle\": \"如何体现原则\", \"pros\": [\"优\"], \"cons\": [\"缺\"], \"best_for\": \"适用\", \"risk\": \"风险\" } ] },\n    \"step4_experiment\": { \"experiment_design\": \"最小可行实验\", \"success_metrics\": [\"指标\"], \"minimum_sample\": \"最小样本\", \"iteration_guide\": \"迭代\" }\n  },\n  \"confidence_assessment\": { \"overall_confidence\": \"高/中/低\", \"confidence_note\": \"说明\", \"uncertain_parts\": \"不确定点\" },\n  \"anti_patterns\": { \"common_mistakes\": [\"错误\"], \"why_mistakes_happen\": \"原因\", \"how_to_avoid\": \"避免\" },\n  \"next_steps\": \"下一步动作\"\n}"
    },

    "diagnose": {
        "system": "你是“源流 Origin”的审美/方法坐标诊断引擎。基于用户收藏对象，输出分布、盲区、风险与下一步训练处方。\n\n【要求】\n1) 基于收藏对象分析，不要编造不存在的收藏。\n2) 输出：优势、盲区、偏科风险、补盲区策略、深化优势策略。\n3) 每条建议必须是可执行动作（下一步能做什么）。\n4) 诚实标注不确定。\n\n【输出规则】只输出严格 JSON。",
        "user_template": "【诊断请求】\n用户收藏的大师：{masters_joined}\n用户的创作/学习领域：{user_domain}\n\n只输出 JSON，Schema：\n{\n  \"masters_analyzed\": [\"大师1\"],\n  \"user_domain\": \"领域\",\n  \"coordinate_analysis\": {\n    \"temperature\": { \"distribution\": \"偏冷/偏热/均衡\", \"center_value\": \"冷/中/热\", \"spread\": \"集中/分散\", \"masters_distribution\": { \"冷\": [], \"中\": [], \"热\": [] } },\n    \"density\": { \"distribution\": \"偏高/偏低/均衡\", \"center_value\": \"高/中/低\", \"spread\": \"集中/分散\", \"masters_distribution\": { \"高\": [], \"中\": [], \"低\": [] } },\n    \"aggression\": { \"distribution\": \"偏高/偏低/均衡\", \"center_value\": \"高/中/低\", \"spread\": \"集中/分散\", \"masters_distribution\": { \"高\": [], \"中\": [], \"低\": [] } },\n    \"structure\": { \"distribution\": \"偏强/偏弱/均衡\", \"center_value\": \"强/中/弱\", \"spread\": \"集中/分散\", \"masters_distribution\": { \"强\": [], \"中\": [], \"弱\": [] } }\n  },\n  \"pattern_summary\": \"整体特征\",\n  \"diagnosis\": { \"strengths\": [\"优势\"], \"blind_spots\": [\"盲区\"], \"imbalance_risk\": \"风险\", \"style_prediction\": \"预测\" },\n  \"recommendations\": {\n    \"expand_boundary\": [ { \"suggested_master\": \"建议探索\", \"master_coordinates\": \"坐标\", \"why_recommend\": \"原因\", \"expected_gain\": \"收获\", \"entry_work\": \"入门材料\" } ],\n    \"deepen_strength\": [ { \"suggested_master\": \"建议深化\", \"why_recommend\": \"原因\", \"what_to_focus\": \"关注点\" } ]\n  },\n  \"next_week_prescription\": { \"focus\": \"本周训练重点\", \"tasks\": [ { \"task\": \"任务\", \"deliverable\": \"交付物\", \"grading_rubric\": [\"标准\"] } ] },\n  \"evolution_insight\": \"演化建议\"\n}"
    },

    "checklist": {
        "system": "你是“源流 Origin”的创作检查清单引擎。\n\n【要求】\n1) 清单必须可执行：每条都要具体、可检查、可快速修复。\n2) 只使用用户提供的 skills 作为来源：from_skill 必须来自 skills。\n3) 输出严格 JSON，不要 Markdown。\n4) 避免正确废话：每条都要能让用户立刻改一刀。\n\n【输出规则】只输出 JSON。",
        "user_template": "用户创作载体：{user_domain}\n约束（可选）：{constraints}\n用户已学技法（只能从这些技法生成清单项）：\n{skills_bullets}\n\n只输出 JSON，Schema：\n{\n  \"checklist_title\": \"清单标题\",\n  \"user_domain\": \"创作载体\",\n  \"constraints\": \"约束\",\n  \"generated_from_skills\": [ { \"name\": \"技法名\", \"from\": \"来源大师\" } ],\n  \"sections\": [\n    {\n      \"section_title\": \"章节标题\",\n      \"items\": [\n        {\n          \"item\": \"可检查短句（<=20字）\",\n          \"why\": \"为什么重要（<=30字）\",\n          \"from_skill\": \"必须来自 skills\",\n          \"severity\": \"must/should/could\",\n          \"quick_fix\": \"不通过时怎么快速修（<=30字）\",\n          \"example_fix\": \"给一个修改后的示例片段（可选，<=80字）\"\n        }\n      ]\n    }\n  ],\n  \"closing_note\": \"一句收尾建议（可选）\"\n}\n\n如果 skills 为空：sections 为空，并在 closing_note 提示先去保存技法。"
    },

    "morning": {
        "system": "你是“源流 Origin”的晨间校准引擎：给用户一口高质量输入用于浸泡校准。\n\n【硬要求】\n1) 避免长引用：如需引用必须极短（<=30字）；更推荐片段描述。\n2) 输出严格 JSON。\n3) 给 2 个观察点 + 1 个 30 秒微作业。\n4) 观察点必须“可观察、可判断”，不要空泛。\n\n【输出规则】只输出 JSON。",
        "user_template": "日期：{date}\n用户收藏大师：{masters_joined}\n校准偏好：{mode_hint}\n\n只输出 JSON，Schema：\n{\n  \"date\": \"YYYY-MM-DD\",\n  \"source\": { \"master\": \"大师/来源\", \"work_hint\": \"作品指向\", \"note\": \"选择说明\" },\n  \"quote_or_scene\": \"极短引用（<=30字）或片段描述\",\n  \"what_to_notice\": [\"观察点1（<=20字）\", \"观察点2（<=20字）\"],\n  \"micro_practice\": \"30秒作业（<=40字）\",\n  \"coordinate_hint\": { \"temperature\": \"冷/中/热\", \"density\": \"高/中/低\", \"aggression\": \"高/中/低\", \"structure\": \"强/中/弱\" }\n}"
    }
};

function tpl(str, vars) {
    let out = String(str || "");
    for (const [k, v] of Object.entries(vars || {})) {
        out = out.replaceAll(`{${k}}`, String(v ?? ""));
    }
    return out;
}

const PROMPTS = {
    source: { system: PROMPTS_JSON.source.system, user: (skill) => tpl(PROMPTS_JSON.source.user_template, { skill }) },
    deconstruct: { system: PROMPTS_JSON.deconstruct.system, user: (master, focus = "") => tpl(PROMPTS_JSON.deconstruct.user_template, { master, focus_line: focus ? `聚焦：${focus}` : "" }) },
    transfer: { system: PROMPTS_JSON.transfer.system, user: (technique, master, scenario, constraints = "") => tpl(PROMPTS_JSON.transfer.user_template, { technique, master, scenario, constraints_line: constraints ? `场景约束：${constraints}` : "" }) },
    navigate: { system: PROMPTS_JSON.navigate.system, user: (master, time_budget = "不限", level = "入门") => tpl(PROMPTS_JSON.navigate.user_template, { master, time_budget, level }) },
    diagnose: { system: PROMPTS_JSON.diagnose.system, user: (masterNames, user_domain = "内容创作") => tpl(PROMPTS_JSON.diagnose.user_template, { masters_joined: (masterNames || []).join("、"), user_domain }) },
    checklist: {
        system: PROMPTS_JSON.checklist.system,
        user: ({ user_domain, constraints, skills }) => {
            const bullets = (skills || []).map(s => `- ${s.name}（来自：${s.from}）`).join("\n") || "- （空）";
            return tpl(PROMPTS_JSON.checklist.user_template, { user_domain: user_domain || "通用写作", constraints: constraints || "无", skills_bullets: bullets });
        }
    },
    morning: { system: PROMPTS_JSON.morning.system, user: ({ date, master_names, mode_hint }) => tpl(PROMPTS_JSON.morning.user_template, { date, masters_joined: (master_names || []).join("、") || "（空）", mode_hint: mode_hint || "均衡" }) }
};

/* MODE_HELP：中性表述 + 均衡示例（默认随机抽样） */
const MODE_HELP = {
    source: {
        placeholder: "输入学科/领域/技能（推荐：名词 + 限定）如：线性代数（本科）/ 机器学习（入门）/ 艺术史（现代主义）",
        hint: [
            "适用：学科学习、专业技能、创作能力。",
            "你将得到：源头参照系（人/书/文/课/标准/数据集）+ 可收藏大师候选 + 最小学习闭环（30min/本周/交付物/自测）。",
            "输入建议：尽量加限定（层级/方向/目标），可以显著提高准确度与速度。"
        ].join(" "),
        examples: () => pickExamplesForDisplay({ total: 6 })
    },
    deconstruct: {
        placeholder: "输入对象名 + 主题（推荐）如：福柯（权力）/ 图灵（计算理论）/ 鲁迅（杂文）",
        hint: [
            "你将得到：四层拆解（可观察事实 vs 推断）+ 可提取技法 + 练习任务与评分标准。",
            "输入建议：加“主题/作品/方向”，避免输出泛化。"
        ].join(" "),
        examples: ["福柯 权力", "图灵 计算理论", "鲁迅 杂文"]
    },
    transfer: {
        placeholder: "推荐用表单；或输入：技法 -> 场景  如：反讽落点 -> 演讲开场",
        hint: [
            "你将得到：抽象→匹配→变体→实验。",
            "注意：迁移必须给可直接使用的示例（>=50字）与可观测指标。"
        ].join(" "),
        examples: ["短句节奏 -> 小红书笔记", "冷启动开头 -> 60秒口播"]
    },
    navigate: {
        placeholder: "输入学科/主题（推荐加层级）如：编译原理（本科）/ 微观经济学（入门）/ 认识论（哲学入门）",
        hint: [
            "你将得到：学习路径（先修/材料顺序/练习/交付物/自测/里程碑/间隔复习）。",
            "输入建议：加层级或考试目标（例如：期末/考研/自学），路径会更可执行。"
        ].join(" "),
        examples: () => pickExamplesForDisplay({ total: 6 })
    },
    diagnose: {
        placeholder: "无需输入，直接开始（至少收藏 2 位大师）",
        hint: "你将得到：四维分布、盲区与偏科风险、补盲区与深化优势的下周处方（可执行任务）。",
        examples: []
    }
};

function setModeUI(mode) {
    const input = document.getElementById("mainInput");
    const hintText = document.getElementById("modeHintText");
    const examples = document.getElementById("modeHintExamples");
    const cfg = MODE_HELP[mode] || MODE_HELP.source;

    if (input) input.placeholder = cfg.placeholder || "";
    if (hintText) hintText.textContent = cfg.hint || "";

    if (examples) {
        let exList = [];
        if (typeof cfg.examples === "function") {
            try { exList = cfg.examples() || []; } catch { exList = []; }
        } else {
            exList = cfg.examples || [];
        }

        examples.innerHTML = (exList || []).map(x =>
            `<span class="quick-tag" data-modeexample="1" data-query="${escapeHtml(x)}">${escapeHtml(x)}</span>`
        ).join("");

        examples.querySelectorAll("[data-modeexample='1']").forEach(tag => {
            tag.addEventListener("click", () => {
                const v = tag.getAttribute("data-query") || "";
                const inp = document.getElementById("mainInput");
                if (inp) inp.value = v;
                validateAndToggleSubmit();
                FLOW_updateAll();
            });
        });
    }

    const assist = document.getElementById("transferAssist");
    if (assist) assist.style.display = (mode === "transfer") ? "block" : "none";
}
/* -----------------------------
 * 4) Validation (updated text only; logic stable)
 * ----------------------------- */
function isTooGeneric(s) {
    const t = String(s || "").trim();
    if (!t) return true;
    const bad = ["学习", "不知道", "随便", "帮我", "怎么做", "提升", "变强"];
    return bad.includes(t);
}

function parseTransferQuickInput(raw) {
    const s = String(raw || "").trim();
    if (!s) return null;
    const parts = s.split(/\s*->\s*|\s*到\s*/);
    if (parts.length < 2) return null;
    return { technique: String(parts[0] || "").trim(), scenario: String(parts[1] || "").trim() };
}

function validateInputByMode(mode) {
    const input = String(document.getElementById("mainInput")?.value || "").trim();

    if (mode === "source") {
        if (input.length < 2 || isTooGeneric(input)) return { ok: false, msg: "请输入更具体的学科/领域/技能（例如：线性代数/微观经济学/编译原理/写作表达）" };
        return { ok: true };
    }

    if (mode === "deconstruct") {
        if (input.length < 2 || isTooGeneric(input)) return { ok: false, msg: "请输入对象名称（人物/作者/研究者…可加主题/作品）" };
        return { ok: true };
    }

    if (mode === "transfer") {
        const scenario = String(document.getElementById("transferScenarioInput")?.value || "").trim();
        const techSel = document.getElementById("transferTechniqueSelect");
        const skills = Array.isArray(AppState.skills) ? AppState.skills : [];

        let technique = "";
        if (techSel && techSel.value !== "" && skills[Number(techSel.value)]) {
            technique = String(skills[Number(techSel.value)].name || "").trim();
        } else {
            const parsed = parseTransferQuickInput(input);
            technique = String(parsed?.technique || input || "").trim();
        }

        if (!technique || technique.length < 2) return { ok: false, msg: "请选择/输入要迁移的技法" };
        if (!scenario || scenario.length < 2) return { ok: false, msg: "请填写目标场景（例如：小红书笔记/60秒口播）" };
        return { ok: true };
    }

    if (mode === "navigate") {
        if (input.length < 2 || isTooGeneric(input)) return { ok: false, msg: "请输入学科/主题/人物（例如：编译原理/热力学/海德格尔）" };
        return { ok: true };
    }

    if (mode === "diagnose") {
        const count = (AppState.masters || []).length;
        if (count < 2) return { ok: false, msg: "请先收藏至少 2 位大师再进行诊断" };
        return { ok: true };
    }

    return { ok: true };
}

function validateAndToggleSubmit() {
    const btn = document.getElementById("submitBtn");
    const hint = document.getElementById("modeHintText");
    if (!btn) return;

    const v = validateInputByMode(AppState.currentMode);
    btn.disabled = !v.ok;

    if (hint && !v.ok) {
        const cfg = MODE_HELP[AppState.currentMode] || MODE_HELP.source;
        hint.textContent = `${v.msg}。${cfg.hint || ""}`;
    } else if (hint && v.ok) {
        const cfg = MODE_HELP[AppState.currentMode] || MODE_HELP.source;
        hint.textContent = cfg.hint || "";
    }
}

/* -----------------------------
 * 5) Citations renderer (NEW, optional)
 * ----------------------------- */
function renderCitations(citations) {
    const list = Array.isArray(citations) ? citations : [];
    if (!list.length) return "";

    const items = list.map((c, idx) => {
        const title = String(c?.title || `来源 ${idx + 1}`);
        const url = String(c?.url || "").trim();
        const why = String(c?.why_trust || "").trim();
        const used = String(c?.used_for || "").trim();

        const linkPart = url
            ? `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`
            : `<span class="hint">（无链接）</span>`;

        const meta = [why ? `可信：${why}` : "", used ? `用途：${used}` : ""].filter(Boolean).join(" · ");

        return `
            <div class="asset-item" style="margin: 0; margin-top: 10px;">
                <div class="asset-item-title">${escapeHtml(title)}</div>
                <div class="asset-item-meta">${linkPart}</div>
                ${meta ? `<div class="asset-item-meta">${escapeHtml(meta)}</div>` : ""}
            </div>
        `;
    }).join("");

    return `
        <div class="result-card" style="border-left: 4px solid var(--accent);">
            <h2>引用来源</h2>
            <div class="hint" style="margin-bottom: 10px;">提示：引用用于提升学科内容可核验性；若无引用，说明本次未注入检索证据或模型未返回 citations。</div>
            ${items}
        </div>
    `;
}

/* -----------------------------
 * 6) AI parsing + schema checks (stable; keep backward compatibility)
 * ----------------------------- */
function extractJsonFromCodeFence(text) {
    const s = String(text || "");
    const m = s.match(/```json\s*([\s\S]*?)\s*```/i);
    return m ? m[1] : null;
}

function extractJsonByBraces(text) {
    const s = String(text || "");
    const start = s.indexOf("{");
    const end = s.lastIndexOf("}");
    if (start === -1 || end === -1 || end <= start) return null;
    return s.slice(start, end + 1);
}

function lightJsonFixups(candidate) {
    let s = String(candidate || "").trim();
    s = s.replace(/[“”]/g, '"').replace(/[‘’]/g, "'");
    s = s.replace(/,\s*([}\]])/g, "$1");
    return s;
}

function tryParseJson(candidate) {
    const raw = String(candidate || "").trim();
    if (!raw) return { ok: false, error: "empty" };
    try { return { ok: true, value: JSON.parse(raw), fixed: false }; }
    catch {
        try { return { ok: true, value: JSON.parse(lightJsonFixups(raw)), fixed: true }; }
        catch (e2) { return { ok: false, error: String(e2) }; }
    }
}

function parseAIResponse(text) {
    const original = String(text || "").trim();
    if (!original) throw new Error("AI 返回为空");
    const candidates = [];
    const fenced = extractJsonFromCodeFence(original);
    if (fenced) candidates.push(fenced);
    const braced = extractJsonByBraces(original);
    if (braced) candidates.push(braced);
    candidates.push(original);
    for (const c of candidates) {
        const r = tryParseJson(c);
        if (r.ok) return r.value;
    }
    throw new Error("无法解析 AI 响应为 JSON");
}

// Keep REQUIRED_FIELDS minimal (do NOT require new fields)
const REQUIRED_FIELDS = {
    source: ["skill"],          // masters/references/citations are optional for compatibility
    deconstruct: ["master", "layers"],
    transfer: ["technique", "source_master", "target_scenario", "steps"],
    navigate: ["master", "learning_path"],
    diagnose: ["coordinate_analysis"]
};

function validateSchemaOrThrow(mode, data) {
    const req = REQUIRED_FIELDS[mode];
    if (!req) return true;
    if (!data || typeof data !== "object") throw new Error("AI 输出不是对象");
    const missing = req.filter(k => !(k in data));
    if (missing.length) throw new Error(`AI 输出结构不匹配，缺少字段：${missing.join(", ")}`);
    return true;
}

/* -----------------------------
 * 6.1) normalizeResponseByMode (updated for source masters<->references)
 * ----------------------------- */
function normalizeResponseByMode(mode, data) {
    if (!data || typeof data !== "object") return data;

    if (mode === "source") {
        // normalize citations
        if (!Array.isArray(data.citations)) data.citations = [];

        // normalize references
        const refs = Array.isArray(data.references) ? data.references : [];
        const masters = Array.isArray(data.masters) ? data.masters : [];

        // if only masters exist -> map to references (type=person)
        if (refs.length === 0 && masters.length > 0) {
            data.references = masters.map(m => ({
                type: "person",
                title: String(m?.name || "").trim() || "（未知）",
                why_foundational: String(m?.why_source_level || "").trim(),
                what_to_learn: String(m?.learn_what || "").trim(),
                access_hint: (Array.isArray(m?.masterpieces) && m.masterpieces.length) ? `代表作：${m.masterpieces.slice(0, 3).join("；")}` : "",
                level_hint: "入门",
                confidence: "中",
                url: ""
            }));
        }

        // if only references exist -> derive masters from person refs (to keep 收藏/坐标可用)
        if (masters.length === 0 && Array.isArray(data.references) && data.references.length > 0) {
            const personRefs = data.references.filter(r => String(r?.type || "") === "person");
            data.masters = personRefs.map(r => ({
                name: String(r?.title || "").trim() || "（未知）",
                domain: String(data.field || data.skill || "").trim(),
                era: "",
                aesthetic_coordinates: { temperature: "中", density: "中", aggression: "中", structure: "中" },
                why_source_level: String(r?.why_foundational || "").trim(),
                core_contribution: "",
                learnability_score: 3,
                learnability_note: String(r?.access_hint || "").trim(),
                masterpieces: [],
                learn_what: String(r?.what_to_learn || "").trim(),
                learn_how: "先阅读/观看入门材料，再做结构化练习与复盘。",
                quick_taste: ""
            }));
        }

        // ensure arrays
        data.references = Array.isArray(data.references) ? data.references : [];
        data.masters = Array.isArray(data.masters) ? data.masters : [];

        // legacy alias
        if (!data.learning_strategy && data.meta_advice) data.learning_strategy = data.meta_advice;
        data.field = String(data.field || data.skill || "").trim() || String(data.skill || "").trim();
    }

    if (mode === "deconstruct") {
        const l3 = data?.layers?.L3_mental;
        if (l3 && !l3.self_check_questions && l3.self_check) l3.self_check_questions = [String(l3.self_check)];
        if (!Array.isArray(data.citations)) data.citations = [];
    }

    if (mode === "navigate") {
        if (!Array.isArray(data.citations)) data.citations = [];
        if (!Array.isArray(data.prerequisites)) data.prerequisites = [];
        if (!Array.isArray(data.study_plan)) data.study_plan = [];
        if (!Array.isArray(data.practice_bank)) data.practice_bank = [];
        if (!data.lab_or_proof || typeof data.lab_or_proof !== "object") data.lab_or_proof = {};
        if (!data.uncertainty_notes) data.uncertainty_notes = "";
    }

    return data;
}
/* -----------------------------
 * 6.2) Settings helpers (AI/Search)
 * ----------------------------- */
function openAISettings() {
    const aiSettings = document.getElementById("aiSettings");
    if (aiSettings) aiSettings.open = true;
    const mount = document.getElementById("aiSettingsMount");
    if (mount) mount.scrollIntoView({ behavior: "smooth", block: "start" });
}

function openSearchSettings() {
    const s = document.getElementById("searchSettings");
    if (s) s.open = true;
    const mount = document.getElementById("searchSettingsMount");
    if (mount) mount.scrollIntoView({ behavior: "smooth", block: "start" });
}

/* -----------------------------
 * 6.3) RAG helpers (NEW): search -> sources[] -> evidence block -> prompt injection
 * ----------------------------- */
let searchModule = null; // mounted in init (parallel to aiModule)

function shouldUseSearchForMode(mode) {
    // 默认只对 source/navigate 开启（符合你的要求：先从 2 个模式起步）
    return ["source", "navigate"].includes(String(mode || ""));
}

function buildSearchQueryForMode(mode, userInput) {
    const input = String(userInput || "").trim();
    const m = String(mode || "");

    // 不做过度智能：避免引入错误；先可控+稳定
    if (m === "source") {
        return `${input} 经典教材 综述 课程`;
    }
    if (m === "navigate") {
        return `${input} syllabus textbook lecture notes`;
    }
    if (m === "deconstruct") {
        return `${input} interview paper lecture`;
    }
    return input;
}

function buildEvidenceBlock(sources, { maxItems = 6, maxSnippetLen = 320 } = {}) {
    const list = Array.isArray(sources) ? sources.slice(0, maxItems) : [];
    if (!list.length) return "";

    const lines = list.map((s, idx) => {
        const title = String(s?.title || "").trim() || "（无标题）";
        const url = String(s?.url || "").trim();
        const score = (typeof s?.score === "number") ? s.score : null;
        const snippet = String(s?.snippet || "").trim().slice(0, maxSnippetLen);

        const scoreText = (score == null) ? "" : `score=${score}`;
        return `[#${idx + 1}] ${title}\n- url: ${url}\n- ${scoreText}\n- snippet: ${snippet}`;
    });

    return lines.join("\n\n");
}

async function maybeFetchEvidence({ mode, userInput }) {
    // 返回 { sources: [], evidence: "", used: boolean, note: "" }
    try {
        if (!searchModule || typeof searchModule.call_search !== "function") {
            return { sources: [], evidence: "", used: false, note: "searchModule_not_ready" };
        }

        if (!shouldUseSearchForMode(mode)) {
            return { sources: [], evidence: "", used: false, note: "mode_not_enabled" };
        }

        const q = buildSearchQueryForMode(mode, userInput);
        const sources = await searchModule.call_search({ mode, query: q });

        auditLogAdd({ type: "search_success", entity: mode, ok: true, key: "SEARCH", meta: { q, n: Array.isArray(sources) ? sources.length : 0 } });

        const evidence = buildEvidenceBlock(sources, { maxItems: 6, maxSnippetLen: 320 });
        return { sources, evidence, used: true, note: "ok" };

    } catch (err) {
        // 失败必须“降级”而不是中断主流程
        const msg = (searchModule && searchModule.get_actionable_error)
            ? searchModule.get_actionable_error(err)
            : String(err?.message || err || "");

        auditLogAdd({ type: "search_fail", entity: mode, ok: false, key: "SEARCH", meta: { error: String(msg).slice(0, 300) } });

        showToast("检索失败：已降级为无检索继续生成", "warn");
        return { sources: [], evidence: "", used: false, note: "failed" };
    }
}

function injectEvidenceIntoUserPrompt(userPrompt, evidenceText) {
    const base = String(userPrompt || "");
    const ev = String(evidenceText || "").trim();
    if (!ev) return base;

    return `${base}

【可引用证据】
${ev}

【强约束：引用与链接】
1) 只能引用以上证据里出现过的 url；禁止编造任何新链接/DOI/ISBN/课程地址。
2) 你输出的 citations 必须满足：
   - citations[].url 必须来自证据中的 url
   - citations[].evidence_ids 必须填写你使用的证据编号（例如使用 [#2] 就写 [2]）
   - citations 数量建议 <= 5（少而精）
3) 若证据不足以支撑某条结论：不要硬写链接；把该条结论标记为不确定，并写出核验路径（写在 uncertainty_notes）。

【写作限制】
-  不要长引用原文；只允许“短片段描述/要点概括”。`;
}

/* -----------------------------
 * 6.4) Loading UI (unchanged)
 * ----------------------------- */
function showLoading() {
    document.getElementById("resultsSection").innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>正在生成结果…</p>
        </div>
    `;
}
/* -----------------------------
 * 8) MorningState placeholder (NEW, prevent ReferenceError in FLOW)
 * ----------------------------- */
let MorningState = { today: null };

/* -----------------------------
 * 10) Stepper (FLOW) (mostly unchanged; add tiny safety guards)
 * ----------------------------- */
const FLOW_STATE = {
    produced: false,
    session_started_at: null,
    baseline: { masters_count: 0, skills_count: 0, journal_count: 0, checklist_saved_at: "" },
    _updating: false,
    _rafPending: false
};

function FLOW_safeGetLocalJson(key, fallback) {
    try {
        if (!AppState.storage_ok) return fallback;
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = safeJsonParseGlobal(raw);
        return parsed.ok ? parsed.value : fallback;
    } catch { return fallback; }
}

function FLOW_getChecklistLastSavedAt() {
    try {
        if (!AppState.storage_ok) return "";
        const raw = localStorage.getItem(STORAGE_KEYS.CHECKLIST_LAST);
        if (!raw) return "";
        const parsed = safeJsonParseGlobal(raw);
        if (!parsed.ok || !parsed.value) return "";
        return String(parsed.value.saved_at || "");
    } catch { return ""; }
}

function FLOW_setSessionBaseline() {
    FLOW_STATE.session_started_at = nowISO();
    const journal = FLOW_safeGetLocalJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    const journalCount = Array.isArray(journal) ? journal.length : 0;
    FLOW_STATE.baseline = {
        masters_count: (AppState.masters || []).length,
        skills_count: (AppState.skills || []).length,
        journal_count: journalCount,
        checklist_saved_at: FLOW_getChecklistLastSavedAt()
    };
}

function FLOW_hasArchivedThisSession() {
    const nowMasters = (AppState.masters || []).length;
    const nowSkills = (AppState.skills || []).length;
    const journal = FLOW_safeGetLocalJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    const nowJournal = Array.isArray(journal) ? journal.length : 0;
    const nowChecklistAt = FLOW_getChecklistLastSavedAt();

    const b = FLOW_STATE.baseline || {};
    const mastersIncreased = (nowMasters > (b.masters_count || 0));
    const skillsIncreased = (nowSkills > (b.skills_count || 0));
    const journalIncreased = (nowJournal > (b.journal_count || 0));
    const checklistGenerated = Boolean(nowChecklistAt) && (nowChecklistAt !== String(b.checklist_saved_at || ""));

    return mastersIncreased || skillsIncreased || journalIncreased || checklistGenerated;
}

function FLOW_hasMorningToday() {
    const today = new Date().toISOString().slice(0, 10);
    if (MorningState && MorningState.today && MorningState.today.date === today) return true;
    const cached = FLOW_safeGetLocalJson(STORAGE_KEYS.MORNING_TODAY, null);
    return Boolean(cached && cached.date === today);
}

function FLOW_isProduced() {
    if (FLOW_STATE.produced) return true;
    const rs = document.getElementById("resultsSection");
    if (!rs) return false;
    const hasResultCard = rs.querySelector(".result-card") != null;
    const hasEmpty = rs.querySelector(".empty-state") != null;
    return hasResultCard && !hasEmpty;
}

function FLOW_getSnapshot() {
    const mode = AppState.currentMode;
    const validation = validateInputByMode(mode);
    return { mode, input_ok: Boolean(validation?.ok), has_morning_today: FLOW_hasMorningToday(), has_produced: FLOW_isProduced() };
}

function FLOW_computeSteps(snapshot) {
    const done0 = snapshot.has_morning_today;
    const done1 = snapshot.input_ok;
    const done2 = snapshot.has_produced;
    const done3 = FLOW_hasArchivedThisSession();
    const done = [done0, done1, done2, done3];
    let active = done.findIndex(x => x === false);
    if (active === -1) active = 3;
    const blocked = [false, false, !done1, !done2];
    return { done, active, blocked };
}

function FLOW_stepLabel(i) {
    if (i === 0) return { title: "0 校准", desc: "先看一口好东西" };
    if (i === 1) return { title: "1 选任务", desc: "选择模式并补齐输入" };
    if (i === 2) return { title: "2 产出", desc: "获取结构化结果" };
    return { title: "3 存档", desc: "保存到资产库" };
}

function FLOW_renderStepper(computed) {
    const mount = document.getElementById("flowStepper");
    if (!mount) return;

    const stepsHtml = [0, 1, 2, 3].map(i => {
        const s = FLOW_stepLabel(i);
        const isDone = computed.done[i];
        const isActive = computed.active === i;
        const isBlocked = computed.blocked[i] && !isDone;
        const cls = ["flow-step", isDone ? "is-done" : "", isActive ? "is-active" : "", isBlocked ? "is-blocked" : ""].filter(Boolean).join(" ");
        const badgeText = isDone ? "✓" : String(i);
        return `
            <div class="${cls}" data-flow-step="${i}">
                <div class="flow-step-badge">${escapeHtml(badgeText)}</div>
                <div class="flow-step-body">
                    <div class="flow-step-title">${escapeHtml(s.title)}</div>
                    <div class="flow-step-desc">${escapeHtml(s.desc)}</div>
                </div>
            </div>
        `;
    }).join("");

    mount.innerHTML = `<div class="flow-stepper">${stepsHtml}</div>`;

    mount.querySelectorAll("[data-flow-step]").forEach(el => {
        el.addEventListener("click", () => {
            const i = Number(el.getAttribute("data-flow-step"));
            if (i === 0) document.getElementById("morningCard")?.scrollIntoView({ behavior: "smooth", block: "start" });
            else if (i === 1) document.getElementById("mainInput")?.focus();
            else if (i === 2) document.getElementById("submitBtn")?.scrollIntoView({ behavior: "smooth", block: "center" });
            else document.getElementById("masterList")?.scrollIntoView({ behavior: "smooth", block: "start" });
        });
    });
}

function FLOW_ensureNextActionBar() {
    const rs = document.getElementById("resultsSection");
    if (!rs) return null;
    let bar = document.getElementById("nextActionBar");
    if (bar) return bar;
    bar = document.createElement("div");
    bar.id = "nextActionBar";
    bar.style.marginTop = "16px";
    bar.style.marginBottom = "16px";
    bar.innerHTML = `
        <div style="padding: 12px 14px; border-radius: 16px; border: 1px solid var(--border); background: color-mix(in srgb, var(--bg2) 70%, transparent);">
            <div style="font-weight: 900; margin-bottom: 6px;">下一步建议</div>
            <div class="hint" id="nextActionHint">按当前状态给出建议。</div>
            <div class="row" id="nextActionButtons" style="margin-top: 10px;"></div>
        </div>
    `;
    rs.prepend(bar);
    return bar;
}

function FLOW_updateNextActions(snapshot) {
    const existing = document.getElementById("nextActionBar");
    if (!snapshot.has_produced) {
        if (existing) existing.style.display = "none";
        return;
    }

    const bar = FLOW_ensureNextActionBar();
    if (!bar) return;
    bar.style.display = "block";

    const hintEl = document.getElementById("nextActionHint");
    const btnsEl = document.getElementById("nextActionButtons");
    if (!hintEl || !btnsEl) return;

    hintEl.textContent = "推荐你做下一步动作（不会自动发请求）。";
    btnsEl.innerHTML = `
        <button class="btn secondary" type="button" id="nextActScrollMorning">去晨间校准</button>
        <button class="btn secondary" type="button" id="nextActFocusInput">回到输入区</button>
        <button class="btn secondary" type="button" id="nextActOpenAssets">打开资产中心</button>
    `;
    document.getElementById("nextActScrollMorning")?.addEventListener("click", () => document.getElementById("morningCard")?.scrollIntoView({ behavior: "smooth", block: "start" }));
    document.getElementById("nextActFocusInput")?.addEventListener("click", () => document.getElementById("mainInput")?.focus());
    document.getElementById("nextActOpenAssets")?.addEventListener("click", () => toggleAssetsDrawer(true));
}

function FLOW_updateAll() {
    if (FLOW_STATE._rafPending) return;
    FLOW_STATE._rafPending = true;

    requestAnimationFrame(() => {
        FLOW_STATE._rafPending = false;
        if (FLOW_STATE._updating) return;
        FLOW_STATE._updating = true;
        try {
            const snap = FLOW_getSnapshot();
            const computed = FLOW_computeSteps(snap);
            FLOW_renderStepper(computed);
            FLOW_updateNextActions(snap);
        } catch (e) {
            console.warn("FLOW_updateAll failed:", e);
        } finally {
            FLOW_STATE._updating = false;
        }
    });
}

function FLOW_initObservers() {
    const rs = document.getElementById("resultsSection");
    if (!rs) return;

    const obs = new MutationObserver(() => {
        const hasResultCard = rs.querySelector(".result-card") != null;
        const hasEmpty = rs.querySelector(".empty-state") != null;
        if (hasResultCard && !hasEmpty) FLOW_STATE.produced = true;
        FLOW_updateAll();
        // 这里在后续段会定义 updateResultsActionBar；为稳妥加 try/catch
        try { updateResultsActionBar(); } catch {}
    });

    obs.observe(rs, { childList: true, subtree: false });
}

/* -----------------------------
 * 11) Cross-module navigation helper (unchanged)
 * ----------------------------- */
function setActiveModeButton(mode) {
    document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
    const btn = document.querySelector(`.mode-btn[data-mode="${mode}"]`);
    if (btn) btn.classList.add("active");
}

function goToMode(mode, { inputValue = "", autoSubmit = false, focusId = "mainInput", transferSkillName = "", transferFromMaster = "" } = {}) {
    AppState.currentMode = mode;
    setActiveModeButton(mode);
    setModeUI(mode);
    refreshTransferAssistOptions();
    validateAndToggleSubmit();
    FLOW_updateAll();

    if (typeof inputValue === "string") {
        const input = document.getElementById("mainInput");
        if (inputValue && input) input.value = inputValue;
    }

    if (mode === "transfer") {
        const techSel = document.getElementById("transferTechniqueSelect");
        const masterSel = document.getElementById("transferMasterSelect");
        if (transferSkillName) {
            const idx = AppState.skills.findIndex(s => s.name === transferSkillName && (transferFromMaster ? s.from === transferFromMaster : true));
            if (idx >= 0 && techSel) techSel.value = String(idx);
        }
        if (transferFromMaster && masterSel) {
            const midx = AppState.masters.findIndex(m => m.name === transferFromMaster);
            if (midx >= 0) masterSel.value = String(midx);
        }
    }

    const f = document.getElementById(focusId);
    if (f) f.focus();

    if (autoSubmit === true) {
        handleSubmit();
    }
}
/* -----------------------------
 * 12) Results action bar (Export/Copy) + Markdown (updated for references/citations)
 * ----------------------------- */
function ensureResultsActionBar() {
    const rs = document.getElementById("resultsSection");
    if (!rs) return null;
    let bar = document.getElementById("resultsActionBar");
    if (bar) return bar;
    bar = document.createElement("div");
    bar.id = "resultsActionBar";
    bar.innerHTML = `
        <div style="padding: 12px 14px; border-radius: 16px; border: 1px solid var(--border); background: color-mix(in srgb, var(--bg2) 70%, transparent);">
            <div style="display:flex; justify-content: space-between; gap: 10px; align-items: flex-start;">
                <div>
                    <div style="font-weight: 900;">结果导出</div>
                    <div class="hint" id="resultsActionMeta">—</div>
                </div>
                <div class="row" id="resultsActionBtns" style="gap: 8px;"></div>
            </div>
        </div>
    `;
    const nextBar = document.getElementById("nextActionBar");
    if (nextBar && nextBar.nextSibling) rs.insertBefore(bar, nextBar.nextSibling);
    else rs.prepend(bar);
    return bar;
}

function toMarkdownCitations(citations) {
    const list = Array.isArray(citations) ? citations : [];
    if (!list.length) return "";

    let md = `---\n\n## 引用来源\n\n`;
    list.forEach((c, idx) => {
        const title = c?.title ? String(c.title) : `来源 ${idx + 1}`;
        const url = c?.url ? String(c.url) : "";
        const why = c?.why_trust ? String(c.why_trust) : "";
        const used = c?.used_for ? String(c.used_for) : "";
        md += `* ${title}${url ? `\n    * ${url}` : ""}${why ? `\n    * 可信：${why}` : ""}${used ? `\n    * 用途：${used}` : ""}\n`;
    });
    return md.trimEnd() + "\n";
}

function toMarkdownReferences(references) {
    const refs = Array.isArray(references) ? references : [];
    if (!refs.length) return "";

    const groups = {
        person: [],
        book: [],
        paper: [],
        course: [],
        standard: [],
        dataset: [],
        other: []
    };

    refs.forEach(r => {
        const t = String(r?.type || "").trim();
        const key = groups[t] ? t : "other";
        groups[key].push(r);
    });

    const section = (title, arr) => {
        if (!arr.length) return "";
        let md = `## ${title}\n\n`;
        arr.forEach((r, idx) => {
            const name = String(r?.title || `条目 ${idx + 1}`);
            const url = String(r?.url || "").trim();
            const why = String(r?.why_foundational || "").trim();
            const learn = String(r?.what_to_learn || "").trim();
            const access = String(r?.access_hint || "").trim();
            const lvl = String(r?.level_hint || "").trim();
            const conf = String(r?.confidence || "").trim();

            md += `* ${name}${url ? `（${url}）` : ""}\n`;
            if (why) md += `    * 为什么：${why}\n`;
            if (learn) md += `    * 学什么：${learn}\n`;
            if (access) md += `    * 获取：${access}\n`;
            if (lvl || conf) md += `    * ${[lvl ? `级别：${lvl}` : "", conf ? `置信：${conf}` : ""].filter(Boolean).join(" · ")}\n`;
        });
        md += `\n`;
        return md;
    };

    let out = `---\n\n# 源头参照系（References）\n\n`;
    out += section("人（学者/学派）", groups.person);
    out += section("书（教材/经典书）", groups.book);
    out += section("文（奠基论文/综述）", groups.paper);
    out += section("课（权威课程）", groups.course);
    out += section("标准（Standard）", groups.standard);
    out += section("数据集（Dataset）", groups.dataset);
    if (groups.other.length) out += section("其他", groups.other);
    return out.trimEnd() + "\n";
}

function toMarkdown(mode, data) {
    const m = String(mode || "");
    const d = data || {};
    const date = (new Date()).toISOString().slice(0, 10);

    const header = (title) => `# ${title}\n\n* 导出日期：${date}\n* 模式：${m}\n\n`;

    if (m === "source") {
        const masters = Array.isArray(d.masters) ? d.masters : [];
        const refs = Array.isArray(d.references) ? d.references : [];

        let md = header(`源头探测：${d.field || d.skill || ""}`);
        if (d.learning_strategy) md += `> ${d.learning_strategy}\n\n`;

        if (refs.length) {
            md += toMarkdownReferences(refs) + `\n`;
        }

        if (masters.length) {
            md += `---\n\n## 可收藏的大师候选\n\n`;
            masters.forEach((x, i) => {
                md += `### ${i + 1}. ${x.name || ""}\n\n`;
                md += `* 领域：${x.domain || ""}\n`;
                md += `* 年代：${x.era || ""}\n`;
                if (x.aesthetic_coordinates) {
                    const c = x.aesthetic_coordinates;
                    md += `* 坐标：温度${c.temperature || "中"} / 密度${c.density || "中"} / 攻击性${c.aggression || "中"} / 结构${c.structure || "中"}\n`;
                }
                if (x.why_source_level) md += `* 为什么源头：${x.why_source_level}\n`;
                if (x.learnability_score) md += `* 可学性：${x.learnability_score}（${x.learnability_note || ""}）\n`;
                if (x.masterpieces && Array.isArray(x.masterpieces) && x.masterpieces.length) {
                    md += `\n代表作：\n`;
                    x.masterpieces.forEach(w => md += `* ${w}\n`);
                }
                if (x.learn_what) md += `\n学什么：${x.learn_what}\n`;
                if (x.learn_how) md += `\n怎么学：${x.learn_how}\n`;
                md += `\n`;
            });
        }

        if (Array.isArray(d.anti_patterns) && d.anti_patterns.length) {
            md += `---\n\n## 需要规避的噪音源\n\n`;
            d.anti_patterns.forEach(p => {
                if (typeof p === "string") md += `* ${p}\n`;
                else md += `* ${p.type || ""}：${p.why || ""}\n`;
            });
            md += `\n`;
        }

        if (d.meta_insight) md += `> 本质：${d.meta_insight}\n\n`;
        if (d.uncertainty_notes) md += `> 不确定说明：${d.uncertainty_notes}\n\n`;

        const citeMd = toMarkdownCitations(d.citations);
        if (citeMd) md += citeMd;

        return md.trim();
    }

    if (m === "navigate") {
        let md = header(`学习路径：${d.master || ""}`);
        if (d.total_works_overview) md += `> ${d.total_works_overview}\n\n`;

        // 保留你原有 gateway/core 的导出策略（简版）
        const path = d.learning_path || {};
        const gw = path.gateway_work || null;
        if (gw) {
            md += `## 入门首选：${gw.title || ""}\n\n`;
            if (gw.type) md += `* 类型：${gw.type}\n`;
            if (gw.access) md += `* 获取：${gw.access}\n`;
            if (gw.time_required) md += `* 耗时：${gw.time_required}\n`;
            if (gw.why_start_here) md += `\n为什么从这里开始：${gw.why_start_here}\n\n`;
            if (Array.isArray(gw.what_to_notice) && gw.what_to_notice.length) {
                md += `看的时候注意：\n`;
                gw.what_to_notice.forEach(x => md += `* ${x}\n`);
                md += `\n`;
            }
            if (gw.homework) {
                md += `作业：\n`;
                if (gw.homework.observation) md += `* 观察：${gw.homework.observation}\n`;
                if (gw.homework.practice) md += `* 练习：${gw.homework.practice}\n`;
                md += `\n`;
            }
        }

        const core = Array.isArray(path.core_works) ? path.core_works : [];
        if (core.length) {
            md += `---\n\n## 核心材料（按顺序）\n\n`;
            core.forEach((w, i) => {
                md += `### ${i + 1}. ${w.title || ""}\n\n`;
                if (w.type) md += `* 类型：${w.type}\n`;
                if (w.why_important) md += `* 重要性：${w.why_important}\n`;
                if (Array.isArray(w.what_to_notice) && w.what_to_notice.length) md += `* 注意：${w.what_to_notice.join("；")}\n`;
                if (w.builds_on) md += `* 承接：${w.builds_on}\n`;
                if (w.homework) md += `* 作业：${w.homework}\n`;
                md += `\n`;
            });
        }

        // 学科增强字段：先修/计划/练习（可选）
        const prereq = Array.isArray(d.prerequisites) ? d.prerequisites : [];
        if (prereq.length) {
            md += `---\n\n## 先修知识\n\n`;
            prereq.forEach(x => {
                md += `* ${x.topic || ""}\n`;
                if (x.why_needed) md += `    * 为什么：${x.why_needed}\n`;
                if (x.how_to_patch) md += `    * 如何补：${x.how_to_patch}\n`;
                if (x.check_task) md += `    * 自测：${x.check_task}\n`;
            });
            md += `\n`;
        }

        const plan = Array.isArray(d.study_plan) ? d.study_plan : [];
        if (plan.length) {
            md += `---\n\n## 阶段计划\n\n`;
            plan.forEach(p => {
                md += `* ${p.phase || ""}${p.duration ? `（${p.duration}）` : ""}\n`;
                const topics = Array.isArray(p.chapters_or_topics) ? p.chapters_or_topics : [];
                if (topics.length) md += `    * 章节/主题：${topics.join("；")}\n`;
                const goals = Array.isArray(p.goals) ? p.goals : [];
                if (goals.length) md += `    * 目标：${goals.join("；")}\n`;
                if (p.exercises) md += `    * 练习：${p.exercises}\n`;
                if (p.proofs_or_labs) md += `    * 证明/实验：${p.proofs_or_labs}\n`;
            });
            md += `\n`;
        }

        const bank = Array.isArray(d.practice_bank) ? d.practice_bank : [];
        if (bank.length) {
            md += `---\n\n## 练习题库建议\n\n`;
            bank.forEach(b => {
                md += `* ${b.source || ""}${b.location_hint ? `（${b.location_hint}）` : ""}\n`;
                const types = Array.isArray(b.problem_types) ? b.problem_types : [];
                if (types.length) md += `    * 题型：${types.join("；")}\n`;
                if (b.suggestion) md += `    * 建议：${b.suggestion}\n`;
            });
            md += `\n`;
        }

        if (d.uncertainty_notes) md += `> 不确定说明：${d.uncertainty_notes}\n\n`;
        const citeMd = toMarkdownCitations(d.citations);
        if (citeMd) md += citeMd;

        return md.trim();
    }

    // 其它模式暂用你原有导出（后续段会继续补齐）
    return header("结果") + "（当前模式的 Markdown 导出将在后续段继续接入）";
}

function updateResultsActionBar() {
    const rs = document.getElementById("resultsSection");
    if (!rs) return;
    const hasEmpty = rs.querySelector(".empty-state") != null;
    const hasResultCard = rs.querySelector(".result-card") != null;
    if (!hasResultCard || hasEmpty) {
        const existing = document.getElementById("resultsActionBar");
        if (existing) existing.style.display = "none";
        return;
    }

    const bar = ensureResultsActionBar();
    if (!bar) return;
    bar.style.display = "block";

    const meta = document.getElementById("resultsActionMeta");
    const btns = document.getElementById("resultsActionBtns");
    if (!meta || !btns) return;

    const mode = LastResult.mode || AppState.currentMode;
    meta.textContent = LastResult.at ? `最近结果：${mode} · ${LastResult.at}` : `最近结果：${mode}`;

    btns.innerHTML = `
        <button class="btn secondary" id="copyMdBtn" type="button">复制 Markdown</button>
        <button class="btn secondary" id="downloadMdBtn" type="button">下载 .md</button>
        <button class="btn secondary" id="printPdfBtn" type="button">导出 PDF（打印）</button>
    `;

    document.getElementById("copyMdBtn")?.addEventListener("click", async () => {
        const md = toMarkdown(mode, LastResult.data || {});
        await copyTextWithFallback(md);
    });

    document.getElementById("downloadMdBtn")?.addEventListener("click", () => {
        const md = toMarkdown(mode, LastResult.data || {});
        const day = new Date().toISOString().slice(0, 10);
        const filename = `origin-${day}-${mode}.md`;
        const ok = downloadTextFile(filename, md, "text/markdown;charset=utf-8");
        if (ok) showToast("已下载", "success");
        else showToast("下载失败", "error");
    });

    document.getElementById("printPdfBtn")?.addEventListener("click", () => {
        const md = toMarkdown(mode, LastResult.data || {});
        openPrintView({ title: `源流导出：${mode}`, contentText: md });
    });
}
/* -----------------------------
 * 13) Assets drawer (Phase 2/3)
 * Tabs: 概览/大师/技法/清单/日记/坐标/备份
 * ----------------------------- */
const AssetsUI = {
    open: false,
    tab: "overview",
    query: ""
};

const ASSET_TABS = [
    { id: "overview", label: "概览" },
    { id: "masters", label: "大师" },
    { id: "skills", label: "技法" },
    { id: "checklist", label: "清单" },
    { id: "journal", label: "日记" },
    { id: "compass", label: "坐标" },
    { id: "backup", label: "备份" }
];

function toggleAssetsDrawer(open) {
    AssetsUI.open = Boolean(open);
    const drawer = document.getElementById("assetsDrawer");
    const overlay = document.getElementById("assetsOverlay");
    if (!drawer || !overlay) return;

    if (AssetsUI.open) {
        drawer.classList.add("is-open");
        overlay.classList.add("is-open");
        drawer.setAttribute("aria-hidden", "false");
        renderAssetsDrawer();
        setTimeout(() => document.getElementById("assetsSearchInput")?.focus(), 120);
    } else {
        drawer.classList.remove("is-open");
        overlay.classList.remove("is-open");
        drawer.setAttribute("aria-hidden", "true");
    }
}

function setAssetsTab(tabId) {
    AssetsUI.tab = String(tabId || "overview");
    renderAssetsDrawer();
}

function setAssetsQuery(q) {
    AssetsUI.query = String(q || "");
    renderAssetsDrawer();
}

function getAssetCounts() {
    const journal = safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    const audit = safeLoadJson(STORAGE_KEYS.AUDIT_LOG, []);
    return {
        masters: (AppState.masters || []).length,
        skills: (AppState.skills || []).length,
        journal: Array.isArray(journal) ? journal.length : 0,
        audit: Array.isArray(audit) ? audit.length : 0
    };
}

function updateAssetsButtonLabel() {
    const btn = document.getElementById("openAssetsBtn");
    if (!btn) return;
    const c = getAssetCounts();
    btn.textContent = `我的资产（${c.masters} 大师 / ${c.skills} 技法 / ${c.journal} 日记）`;
}

function renderAssetsTabs() {
    const tabs = document.getElementById("assetsTabs");
    if (!tabs) return;
    tabs.innerHTML = ASSET_TABS.map(t => `
        <div class="assets-tab ${AssetsUI.tab === t.id ? "is-active" : ""}" data-asset-tab="${t.id}">
            ${escapeHtml(t.label)}
        </div>
    `).join("");
    tabs.querySelectorAll("[data-asset-tab]").forEach(el => {
        el.addEventListener("click", () => setAssetsTab(el.getAttribute("data-asset-tab")));
    });
}

function filterByQuery(text) {
    const q = String(AssetsUI.query || "").trim().toLowerCase();
    if (!q) return true;
    return String(text || "").toLowerCase().includes(q);
}

function renderAssetsOverview() {
    const c = getAssetCounts();
    const snap = safeLoadJson(STORAGE_KEYS.COMPASS_SNAPSHOT, null);
    const lastChecklist = safeLoadJson(STORAGE_KEYS.CHECKLIST_LAST, null);
    const lastBackup = safeLoadJson(STORAGE_KEYS.ASSET_BUNDLE_LAST, null);
    const storageText = AppState.storage_ok ? "可用" : "不可用";

    return `
        <div class="asset-item">
            <div class="asset-item-title">资产概览</div>
            <div class="asset-item-meta">
                本地存储：${escapeHtml(storageText)} · 大师 ${c.masters} · 技法 ${c.skills} · 日记 ${c.journal}
            </div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" id="assetsGoMorningBtn">去晨间校准</button>
                <button class="btn secondary" type="button" id="assetsGoDiagnoseBtn">做审美诊断</button>
            </div>
        </div>

        <div class="asset-item">
            <div class="asset-item-title">最近派生资产</div>
            <div class="asset-item-meta">
                坐标快照：${snap?.saved_at ? escapeHtml(snap.saved_at) : "暂无"} · 清单：${lastChecklist?.saved_at ? escapeHtml(lastChecklist.saved_at) : "暂无"}
            </div>
        </div>

        <div class="asset-item">
            <div class="asset-item-title">备份建议</div>
            <div class="asset-item-meta">
                ${lastBackup?.exported_at ? `上次备份：${escapeHtml(lastBackup.exported_at)}` : "你还没有做过备份。建议在“备份”中导出 JSON。"}
            </div>
        </div>
    `;
}

function renderAssetsMasters() {
    const list = Array.isArray(AppState.masters) ? AppState.masters : [];
    const filtered = list.filter(m => filterByQuery(m.name) || filterByQuery(m.domain));

    if (!filtered.length) {
        return `<div class="hint">暂无大师（或未匹配搜索）。你可以在“源头探测”结果里保存大师。</div>`;
    }

    return filtered.map(m => `
        <div class="asset-item">
            <div class="asset-item-title">${escapeHtml(m.name)}</div>
            <div class="asset-item-meta">${escapeHtml(m.domain || "")}</div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" data-asset-action="toNavigate" data-master="${escapeHtml(m.name)}">作品导航</button>
                <button class="btn secondary" type="button" data-asset-action="toDeconstruct" data-master="${escapeHtml(m.name)}">拆解</button>
                <button class="btn secondary" type="button" data-asset-action="deleteMaster" data-master="${escapeHtml(m.name)}">删除</button>
            </div>
        </div>
    `).join("");
}

function renderAssetsSkills() {
    const list = Array.isArray(AppState.skills) ? AppState.skills : [];
    const filtered = list.filter(s => filterByQuery(s.name) || filterByQuery(s.from));

    if (!filtered.length) {
        return `<div class="hint">暂无技法（或未匹配搜索）。你可以在“四层拆解”结果里保存技法。</div>`;
    }

    return filtered.map(s => `
        <div class="asset-item">
            <div class="asset-item-title">${escapeHtml(s.name)}</div>
            <div class="asset-item-meta">来自：${escapeHtml(s.from || "")}</div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" data-asset-action="toTransferSkill" data-skill="${escapeHtml(s.name)}" data-from="${escapeHtml(s.from || "")}">迁移</button>
                <button class="btn secondary" type="button" data-asset-action="deleteSkill" data-skill="${escapeHtml(s.name)}" data-from="${escapeHtml(s.from || "")}">删除</button>
            </div>
        </div>
    `).join("");
}

function renderAssetsChecklist() {
    const last = safeLoadJson(STORAGE_KEYS.CHECKLIST_LAST, null);
    if (!last) return `<div class="hint">暂无清单。你可以在右侧“创作检查清单”生成。</div>`;

    // checklistToMarkdown 在后续段提供（与原逻辑一致）
    const md = checklistToMarkdown(last);
    return `
        <div class="asset-item">
            <div class="asset-item-title">${escapeHtml(last.checklist_title || "创作检查清单")}</div>
            <div class="asset-item-meta">保存时间：${escapeHtml(last.saved_at || "")} · 载体：${escapeHtml(last.user_domain || "")}</div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" id="assetsCopyChecklistMdBtn">复制 Markdown</button>
                <button class="btn secondary" type="button" id="assetsDownloadChecklistMdBtn">下载 .md</button>
                <button class="btn secondary" type="button" id="assetsPrintChecklistBtn">导出 PDF（打印）</button>
            </div>
        </div>
        <div class="asset-item">
            <div class="asset-item-title">预览</div>
            <pre class="log">${escapeHtml(md.slice(0, 8000))}</pre>
        </div>
    `;
}

function renderAssetsJournal() {
    const arr = safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    const list = Array.isArray(arr) ? arr : [];
    const filtered = list.slice().reverse().filter(x => {
        const d = x?.data || {};
        return filterByQuery(d?.source?.master) || filterByQuery(d?.quote_or_scene) || filterByQuery(d?.date);
    });

    if (!filtered.length) {
        return `<div class="hint">暂无日记（或未匹配搜索）。你可以在“晨间校准”里存入审美日记。</div>`;
    }

    const top = filtered.slice(0, 30);
    return `
        <div class="asset-item">
            <div class="asset-item-title">审美日记（最近 ${Math.min(30, filtered.length)} 条）</div>
            <div class="asset-item-meta">提示：长期使用建议定期备份（见“备份”）。</div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" id="assetsExportJournalMdBtn">导出日记 Markdown</button>
                <button class="btn secondary" type="button" id="assetsClearJournalBtn">清空日记</button>
            </div>
        </div>
        ${top.map(x => {
            const d = x?.data || {};
            const savedAt = x?.saved_at ? new Date(x.saved_at).toLocaleString() : "";
            return `
                <div class="asset-item">
                    <div class="asset-item-title">${escapeHtml(d.date || "")} · ${escapeHtml(d?.source?.master || "未知")}</div>
                    <div class="asset-item-meta">${escapeHtml(savedAt)}</div>
                    <div class="asset-item-meta">${escapeHtml((d.quote_or_scene || "").slice(0, 120))}</div>
                </div>
            `;
        }).join("")}
    `;
}

function renderAssetsCompass() {
    const snap = safeLoadJson(STORAGE_KEYS.COMPASS_SNAPSHOT, null);
    const hist = safeLoadJson(STORAGE_KEYS.COMPASS_HISTORY, []);
    const history = Array.isArray(hist) ? hist : [];

    return `
        <div class="asset-item">
            <div class="asset-item-title">坐标快照</div>
            <div class="asset-item-meta">${snap?.saved_at ? `保存于：${escapeHtml(snap.saved_at)}（原因：${escapeHtml(snap.reason || "")}）` : "暂无快照"}</div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" id="assetsExportCompassJsonBtn">导出坐标 JSON</button>
            </div>
        </div>
        <div class="asset-item">
            <div class="asset-item-title">坐标历史（最近 30 天）</div>
            <div class="asset-item-meta">${history.length ? `记录数：${history.length}` : "暂无历史"}</div>
            ${history.length ? `<pre class="log">${escapeHtml(JSON.stringify(history.slice(-30), null, 2).slice(0, 8000))}</pre>` : ""}
        </div>
    `;
}

function buildAssetBundle() {
    const schema_version = 1;
    const exported_at = nowISO();

    // IMPORTANT: excludes ALL API keys by design (including tavily_key)
    const bundle = {
        schema_version,
        exported_at,
        assets: {
            masters: AppState.masters || [],
            skills: AppState.skills || [],
            morning_today: safeLoadJson(STORAGE_KEYS.MORNING_TODAY, null),
            morning_journal: safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []),
            compass_snapshot: safeLoadJson(STORAGE_KEYS.COMPASS_SNAPSHOT, null),
            compass_history: safeLoadJson(STORAGE_KEYS.COMPASS_HISTORY, []),
            checklist_last: safeLoadJson(STORAGE_KEYS.CHECKLIST_LAST, null),
            checklist_state: safeLoadJson(STORAGE_KEYS.CHECKLIST_STATE, {}),
            audit_log: safeLoadJson(STORAGE_KEYS.AUDIT_LOG, []),
            theme: safeLoadJson(STORAGE_KEYS.THEME, "auto"),
            results_cache: safeLoadJson(STORAGE_KEYS.RESULTS_CACHE, null),

            // optional: keep search settings (NOT key)
            search_settings: safeLoadJson(STORAGE_KEYS.SEARCH_SETTINGS, null),
            search_domain_consent: safeLoadJson(STORAGE_KEYS.SEARCH_DOMAIN_CONSENT, null),
            search_cache: safeLoadJson(STORAGE_KEYS.SEARCH_CACHE, null)
        },
        notes: {
            no_backend_db: true,
            excludes_api_keys: true
        }
    };

    return bundle;
}

function exportAssetBundle() {
    if (!AppState.storage_ok) { showToast("本地存储不可用，无法导出", "error"); return; }
    const day = new Date().toISOString().slice(0, 10);
    const bundle = buildAssetBundle();
    const ok = downloadJsonFile(`origin-backup-${day}.json`, bundle);
    if (ok) {
        safeSaveJson(STORAGE_KEYS.ASSET_BUNDLE_LAST, { exported_at: bundle.exported_at, schema_version: bundle.schema_version });
        auditLogAdd({ type: "export_bundle", entity: "asset_bundle", ok: true, key: "ASSET_BUNDLE", meta: { day } });
        showToast("已导出备份 JSON（不含 API Key）", "success");
    } else {
        auditLogAdd({ type: "export_bundle", entity: "asset_bundle", ok: false, key: "ASSET_BUNDLE" });
        showToast("导出失败", "error");
    }
    updateAssetsButtonLabel();
}

function importAssetBundleFromObj(bundle) {
    if (!AppState.storage_ok) { showToast("本地存储不可用，无法导入", "error"); return false; }
    if (!bundle || typeof bundle !== "object") { showToast("导入文件格式不正确", "error"); return false; }

    const ver = Number(bundle.schema_version || 0);
    const assets = bundle.assets || bundle; // tolerate older formats
    if (!assets || typeof assets !== "object") { showToast("导入文件缺少 assets", "error"); return false; }

    if (ver && ver !== 1) {
        showToast(`不支持的备份版本：${ver}`, "error");
        return false;
    }

    // do NOT import API keys; only write known asset keys
    try {
        localStorage.setItem(STORAGE_KEYS.MASTERS, JSON.stringify(Array.isArray(assets.masters) ? assets.masters : []));
        localStorage.setItem(STORAGE_KEYS.SKILLS, JSON.stringify(Array.isArray(assets.skills) ? assets.skills : []));
        localStorage.setItem(STORAGE_KEYS.MORNING_TODAY, JSON.stringify(assets.morning_today || null));
        localStorage.setItem(STORAGE_KEYS.MORNING_JOURNAL, JSON.stringify(Array.isArray(assets.morning_journal) ? assets.morning_journal : []));
        localStorage.setItem(STORAGE_KEYS.COMPASS_SNAPSHOT, JSON.stringify(assets.compass_snapshot || null));
        localStorage.setItem(STORAGE_KEYS.COMPASS_HISTORY, JSON.stringify(Array.isArray(assets.compass_history) ? assets.compass_history : []));
        localStorage.setItem(STORAGE_KEYS.CHECKLIST_LAST, JSON.stringify(assets.checklist_last || null));
        localStorage.setItem(STORAGE_KEYS.CHECKLIST_STATE, JSON.stringify(assets.checklist_state || {}));
        localStorage.setItem(STORAGE_KEYS.AUDIT_LOG, JSON.stringify(Array.isArray(assets.audit_log) ? assets.audit_log : []));
        if (assets.theme) localStorage.setItem(STORAGE_KEYS.THEME, String(assets.theme));
        if (assets.results_cache) localStorage.setItem(STORAGE_KEYS.RESULTS_CACHE, JSON.stringify(assets.results_cache));

        // optional: search settings/cache (no keys)
        if (assets.search_settings) localStorage.setItem(STORAGE_KEYS.SEARCH_SETTINGS, JSON.stringify(assets.search_settings));
        if (assets.search_domain_consent) localStorage.setItem(STORAGE_KEYS.SEARCH_DOMAIN_CONSENT, JSON.stringify(assets.search_domain_consent));
        if (assets.search_cache) localStorage.setItem(STORAGE_KEYS.SEARCH_CACHE, JSON.stringify(assets.search_cache));

        auditLogAdd({ type: "import_bundle", entity: "asset_bundle", ok: true, key: "ASSET_BUNDLE", meta: { imported_at: nowISO() } });
        return true;
    } catch (e) {
        auditLogAdd({ type: "import_bundle", entity: "asset_bundle", ok: false, key: "ASSET_BUNDLE", error: String(e) });
        showToast("导入失败（可能是存储空间不足）", "error");
        return false;
    }
}

function renderAssetsBackup() {
    const lastBackup = safeLoadJson(STORAGE_KEYS.ASSET_BUNDLE_LAST, null);
    const audit = safeLoadJson(STORAGE_KEYS.AUDIT_LOG, []);
    const a = Array.isArray(audit) ? audit.slice(-20).reverse() : [];
    return `
        <div class="asset-item">
            <div class="asset-item-title">全量备份（JSON）</div>
            <div class="asset-item-meta">
                ${lastBackup?.exported_at ? `上次备份：${escapeHtml(lastBackup.exported_at)}` : "尚未备份。建议现在导出一份。"}
            </div>
            <div class="asset-actions">
                <button class="btn secondary" type="button" id="assetsExportBundleBtn">导出全部资产(JSON)</button>
                <button class="btn secondary" type="button" id="assetsImportBundleBtn">导入资产(JSON)</button>
            </div>
            <div class="hint" style="margin-top: 8px;">
                说明：备份不包含 API Key（为了安全）。导入会覆盖当前资产（大师/技法/日记/清单/坐标）。不会导入 tavily_key 等任何密钥。
            </div>
        </div>

        <div class="asset-item">
            <div class="asset-item-title">保存日志（最近 20 条）</div>
            ${a.length ? `<pre class="log">${escapeHtml(JSON.stringify(a, null, 2).slice(0, 8000))}</pre>` : `<div class="hint">暂无日志</div>`}
        </div>
    `;
}

function renderAssetsDrawer() {
    renderAssetsTabs();

    const subtitle = document.getElementById("assetsSubtitle");
    if (subtitle) {
        const storageText = AppState.storage_ok ? "可用" : "不可用（无痕/权限/配额）";
        const c = getAssetCounts();
        subtitle.textContent = `本地存储：${storageText} · 大师 ${c.masters} · 技法 ${c.skills} · 日记 ${c.journal}`;
    }

    const body = document.getElementById("assetsBody");
    const search = document.getElementById("assetsSearchInput");
    const footer = document.getElementById("assetsFooter");
    if (!body || !search || !footer) return;

    search.value = AssetsUI.query || "";
    search.disabled = !["masters", "skills", "journal"].includes(AssetsUI.tab);

    let html = "";
    if (AssetsUI.tab === "overview") html = renderAssetsOverview();
    else if (AssetsUI.tab === "masters") html = renderAssetsMasters();
    else if (AssetsUI.tab === "skills") html = renderAssetsSkills();
    else if (AssetsUI.tab === "checklist") html = renderAssetsChecklist();
    else if (AssetsUI.tab === "journal") html = renderAssetsJournal();
    else if (AssetsUI.tab === "compass") html = renderAssetsCompass();
    else if (AssetsUI.tab === "backup") html = renderAssetsBackup();
    else html = renderAssetsOverview();

    body.innerHTML = html;

    footer.innerHTML = `
        <button class="btn secondary" type="button" id="assetsCopyLastMdBtn">复制最近结果 MD</button>
        <button class="btn secondary" type="button" id="assetsPrintLastBtn">打印最近结果</button>
    `;

    document.getElementById("assetsCopyLastMdBtn")?.addEventListener("click", async () => {
        const mode = LastResult.mode || AppState.currentMode;
        const md = toMarkdown(mode, LastResult.data || {});
        await copyTextWithFallback(md);
    });

    document.getElementById("assetsPrintLastBtn")?.addEventListener("click", () => {
        const mode = LastResult.mode || AppState.currentMode;
        const md = toMarkdown(mode, LastResult.data || {});
        openPrintView({ title: `源流导出：${mode}`, contentText: md });
    });

    // bind overview actions
    document.getElementById("assetsGoMorningBtn")?.addEventListener("click", () => {
        toggleAssetsDrawer(false);
        document.getElementById("morningCard")?.scrollIntoView({ behavior: "smooth", block: "start" });
    });
    document.getElementById("assetsGoDiagnoseBtn")?.addEventListener("click", () => {
        toggleAssetsDrawer(false);
        goToMode("diagnose", { focusId: "submitBtn" });
    });

    // bind list actions
    body.querySelectorAll("[data-asset-action]").forEach(btn => {
        btn.addEventListener("click", () => {
            const action = btn.getAttribute("data-asset-action");
            if (action === "toNavigate") {
                const name = btn.getAttribute("data-master") || "";
                toggleAssetsDrawer(false);
                goToMode("navigate", { inputValue: name, focusId: "mainInput" });
            } else if (action === "toDeconstruct") {
                const name = btn.getAttribute("data-master") || "";
                toggleAssetsDrawer(false);
                goToMode("deconstruct", { inputValue: name, focusId: "mainInput" });
            } else if (action === "toTransferSkill") {
                const skill = btn.getAttribute("data-skill") || "";
                const from = btn.getAttribute("data-from") || "";
                toggleAssetsDrawer(false);
                goToMode("transfer", { transferSkillName: skill, transferFromMaster: from, focusId: "transferScenarioInput" });
            } else if (action === "deleteMaster") {
                const name = btn.getAttribute("data-master") || "";
                if (!name) return;
                const ok = confirm(`确认删除大师「${name}」？\n\n这会影响诊断/迁移的可选项。`);
                if (!ok) return;
                AppState.removeMaster(name);
                auditLogAdd({ type: "delete", entity: "master", ok: true, key: "MASTERS", meta: { name } });
                toastDeleted({ what: `大师「${name}」`, count: AppState.masters.length });
                // renderMasterList 在后续段定义
                try { renderMasterList(); } catch {}
                try { refreshTransferAssistOptions(); } catch {}
                updateAssetsButtonLabel();
                renderAssetsDrawer();
                FLOW_updateAll();
            } else if (action === "deleteSkill") {
                const skill = btn.getAttribute("data-skill") || "";
                const from = btn.getAttribute("data-from") || "";
                if (!skill) return;
                const ok = confirm(`确认删除技法「${skill}」${from ? `（来自：${from}）` : ""}？`);
                if (!ok) return;
                const removed = AppState.removeSkill(skill, from);
                auditLogAdd({ type: "delete", entity: "skill", ok: removed, key: "SKILLS", meta: { name: skill, from } });
                if (removed) toastDeleted({ what: `技法「${skill}」`, count: AppState.skills.length });
                else showToast("未找到该技法", "warn");
                try { renderSkillList(); } catch {}
                try { refreshTransferAssistOptions(); } catch {}
                updateAssetsButtonLabel();
                renderAssetsDrawer();
                FLOW_updateAll();
            }
        });
    });

    // checklist actions
    document.getElementById("assetsCopyChecklistMdBtn")?.addEventListener("click", async () => {
        const last = safeLoadJson(STORAGE_KEYS.CHECKLIST_LAST, null);
        if (!last) return;
        await copyTextWithFallback(checklistToMarkdown(last));
    });
    document.getElementById("assetsDownloadChecklistMdBtn")?.addEventListener("click", () => {
        const last = safeLoadJson(STORAGE_KEYS.CHECKLIST_LAST, null);
        if (!last) return;
        const day = new Date().toISOString().slice(0, 10);
        downloadTextFile(`origin-${day}-checklist.md`, checklistToMarkdown(last), "text/markdown;charset=utf-8");
        showToast("已下载", "success");
    });
    document.getElementById("assetsPrintChecklistBtn")?.addEventListener("click", () => {
        const last = safeLoadJson(STORAGE_KEYS.CHECKLIST_LAST, null);
        if (!last) return;
        openPrintView({ title: "源流导出：检查清单", contentText: checklistToMarkdown(last) });
    });

    // journal actions
    document.getElementById("assetsExportJournalMdBtn")?.addEventListener("click", () => {
        const arr = safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []);
        const list = Array.isArray(arr) ? arr : [];
        const mdLines = [];
        mdLines.push(`# 审美日记（导出）`);
        mdLines.push(``);
        mdLines.push(`* 导出时间：${nowISO()}`);
        mdLines.push(`* 条目数：${list.length}`);
        mdLines.push(``);
        list.forEach(x => {
            const d = x?.data || {};
            mdLines.push(`---`);
            mdLines.push(`## ${d.date || ""} · ${d?.source?.master || "未知"}`);
            mdLines.push(``);
            mdLines.push(`今日一口：${d.quote_or_scene || ""}`);
            mdLines.push(``);
            const nt = Array.isArray(d.what_to_notice) ? d.what_to_notice : [];
            if (nt.length) {
                mdLines.push(`看的时候注意：`);
                nt.forEach(t => mdLines.push(`* ${t}`));
                mdLines.push(``);
            }
            if (d.micro_practice) {
                mdLines.push(`微作业：${d.micro_practice}`);
                mdLines.push(``);
            }
        });
        const day = new Date().toISOString().slice(0, 10);
        downloadTextFile(`origin-${day}-journal.md`, mdLines.join("\n"), "text/markdown;charset=utf-8");
        showToast("已导出日记 Markdown", "success");
        auditLogAdd({ type: "export_md", entity: "morning_journal", ok: true, key: "MORNING_JOURNAL" });
    });

    document.getElementById("assetsClearJournalBtn")?.addEventListener("click", () => {
        const ok = confirm("确认清空审美日记？\n\n清空后无法恢复（除非你有备份 JSON）。");
        if (!ok) return;
        const saved = safeSaveJson(STORAGE_KEYS.MORNING_JOURNAL, []);
        auditLogAdd({ type: "clear", entity: "morning_journal", ok: saved, key: "MORNING_JOURNAL" });
        if (saved) showToast("已清空日记", "warn");
        try { updateMorningJournalUI(); } catch {}
        updateAssetsButtonLabel();
        renderAssetsDrawer();
    });

    // compass export
    document.getElementById("assetsExportCompassJsonBtn")?.addEventListener("click", () => {
        const snap = safeLoadJson(STORAGE_KEYS.COMPASS_SNAPSHOT, null);
        const hist = safeLoadJson(STORAGE_KEYS.COMPASS_HISTORY, []);
        const data = { compass_snapshot: snap, compass_history: hist, exported_at: nowISO() };
        const day = new Date().toISOString().slice(0, 10);
        downloadJsonFile(`origin-${day}-compass.json`, data);
        showToast("已导出坐标 JSON", "success");
        auditLogAdd({ type: "export_json", entity: "compass", ok: true, key: "COMPASS_SNAPSHOT/COMPASS_HISTORY" });
    });

    // backup actions
    document.getElementById("assetsExportBundleBtn")?.addEventListener("click", exportAssetBundle);
    document.getElementById("assetsImportBundleBtn")?.addEventListener("click", () => {
        const input = document.getElementById("assetsImportFile");
        if (!input) return;
        input.value = "";
        input.click();
    });
}
/* -----------------------------
 * 14) Checklist custom domain (NEW/UPDATED)
 * ----------------------------- */
function hash8(str) {
    // simple non-crypto hash for storage key compacting
    const s = String(str || "");
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
    }
    // to unsigned
    const n = h >>> 0;
    return n.toString(16).slice(0, 8).padStart(8, "0");
}

function normalizeDomainForKey(domain) {
    const raw = String(domain || "").trim();
    const cleaned = raw.replace(/[\u0000-\u001f\u007f]/g, "").replace(/\s+/g, " ").trim();
    if (!cleaned) return { display: "", keyPart: "" };

    const maxLen = 60;
    const short = cleaned.length > maxLen ? cleaned.slice(0, maxLen) : cleaned;
    const h = hash8(cleaned);
    const keyPart = `${short}#${h}`;
    return { display: cleaned, keyPart };
}

function getChecklistContextFromUI() {
    const sel = document.getElementById("checklistDomain");
    const constraints = String(document.getElementById("checklistConstraints")?.value || "").trim();
    const customInput = document.getElementById("checklistCustomDomain");

    let domain = sel ? String(sel.value || "通用写作") : "通用写作";
    if (domain === "__custom__") {
        const custom = String(customInput?.value || "").trim();
        if (!custom) {
            showToast("请填写自定义载体（不能为空）", "error");
            return { ok: false, user_domain: "", constraints };
        }
        domain = custom;
    }
    return { ok: true, user_domain: domain, constraints };
}

function getChecklistStateKey(domain) {
    const day = new Date().toISOString().slice(0, 10);
    const norm = normalizeDomainForKey(domain);
    const keyPart = norm.keyPart || "unknown";
    return `${day}:${keyPart}`;
}

/* -----------------------------
 * 15) Renderers (UPDATED: source/navigate + citations)
 * ----------------------------- */
let aiModule = null;
let __lastSourceMasters = [];
let __lastDeconstructSkills = [];

function renderReferencesGroup(references) {
    const refs = Array.isArray(references) ? references : [];
    if (!refs.length) return "";

    const groupLabel = {
        person: "人（学者/学派）",
        book: "书（教材/经典书）",
        paper: "文（奠基论文/综述）",
        course: "课（权威课程）",
        standard: "标准（Standard）",
        dataset: "数据集（Dataset）"
    };

    const buckets = {};
    refs.forEach(r => {
        const t = String(r?.type || "other");
        const k = groupLabel[t] ? t : "other";
        if (!buckets[k]) buckets[k] = [];
        buckets[k].push(r);
    });

    const order = ["person", "book", "paper", "course", "standard", "dataset", "other"];
    const blocks = order
        .filter(k => buckets[k] && buckets[k].length)
        .map(k => {
            const title = groupLabel[k] || "其他";
            const items = buckets[k].map(r => {
                const t = String(r?.title || "").trim() || "（未命名）";
                const why = String(r?.why_foundational || "").trim();
                const learn = String(r?.what_to_learn || "").trim();
                const access = String(r?.access_hint || "").trim();
                const url = String(r?.url || "").trim();
                const meta = [
                    r?.level_hint ? `级别：${String(r.level_hint)}` : "",
                    r?.confidence ? `置信：${String(r.confidence)}` : ""
                ].filter(Boolean).join(" · ");

                return `
                    <div class="variation-card" style="margin-bottom: 10px;">
                        <div class="variation-header">
                            <div class="variation-name">${escapeHtml(t)}</div>
                            ${meta ? `<span class="pill">${escapeHtml(meta)}</span>` : ""}
                        </div>
                        ${why ? `<div class="hint"><strong>为何基础：</strong>${escapeHtml(why)}</div>` : ""}
                        ${learn ? `<div class="hint" style="margin-top: 6px;"><strong>学什么：</strong>${escapeHtml(learn)}</div>` : ""}
                        ${access ? `<div class="hint" style="margin-top: 6px;"><strong>获取：</strong>${escapeHtml(access)}</div>` : ""}
                        ${url ? `<div class="hint" style="margin-top: 6px;"><strong>链接：</strong><a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a></div>` : ""}
                    </div>
                `;
            }).join("");

            return `
                <div class="result-card">
                    <h2>${escapeHtml(title)}</h2>
                    ${items}
                </div>
            `;
        });

    return blocks.join("");
}

function renderSourceResults(data) {
    const container = document.getElementById("resultsSection");
    const masters = Array.isArray(data.masters) ? data.masters : [];
    __lastSourceMasters = masters;

    const fieldTitle = data.field || data.skill || "";
    const learningStrategy = data.learning_strategy || "";
    const metaInsight = data.meta_insight || "";
    const uncertainty = data.uncertainty_notes || "";

    let html = `
        <div class="result-card">
            <h2>${escapeHtml(fieldTitle)} 的源头参照系</h2>
            ${learningStrategy ? `<p class="hint" style="margin-bottom: 10px;">${escapeHtml(learningStrategy)}</p>` : ""}
            ${metaInsight ? `<div class="hint"><strong>本质：</strong>${escapeHtml(metaInsight)}</div>` : ""}
            ${uncertainty ? `<div class="hint" style="margin-top: 6px;"><strong>不确定说明：</strong>${escapeHtml(uncertainty)}</div>` : ""}
        </div>
    `;

    // references block (new)
    html += renderReferencesGroup(data.references);

    // masters (existing UX: save/导航/拆解)
    if (masters.length) {
        masters.forEach((m, idx) => {
            const coords = m.aesthetic_coordinates || {};
            html += `
                <div class="result-card master-card">
                    <div class="master-header">
                        <div>
                            <div class="master-name">${escapeHtml(m.name)}</div>
                            <div class="master-domain">${escapeHtml(m.domain || "")} · ${escapeHtml(m.era || "")}</div>
                        </div>
                        <div class="master-coords">
                            <span class="coord-tag">温度: ${escapeHtml(coords.temperature || "中")}</span>
                            <span class="coord-tag">密度: ${escapeHtml(coords.density || "中")}</span>
                            <span class="coord-tag">攻击性: ${escapeHtml(coords.aggression || "中")}</span>
                            <span class="coord-tag">结构: ${escapeHtml(coords.structure || "中")}</span>
                        </div>
                    </div>

                    <p style="margin: 12px 0; font-size: 14px;">${escapeHtml(m.why_source_level || "")}</p>

                    <div class="row" style="margin-top: 16px;">
                        <button class="btn secondary save-master-btn" data-idx="${idx}" type="button">保存到图谱</button>
                        <button class="btn secondary navigate-btn" data-name="${escapeHtml(m.name)}" type="button">学习路径</button>
                        <button class="btn secondary deconstruct-btn" data-name="${escapeHtml(m.name)}" type="button">拆解</button>
                    </div>
                </div>
            `;
        });
    } else {
        html += `
            <div class="result-card">
                <h2>人物参照（可收藏大师）</h2>
                <div class="hint">本次未输出 masters（可能是模型未返回或偏向书/文/课）。你仍可使用上方 references 作为参照系。</div>
            </div>
        `;
    }

    // citations (new; optional)
    html += renderCitations(data.citations);

    container.innerHTML = html;

    // bind save master
    container.querySelectorAll(".save-master-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const idx = Number(btn.dataset.idx);
            const master = __lastSourceMasters[idx];
            if (!master) return;

            const added = AppState.addMaster(master);
            if (added) {
                btn.textContent = "已保存";
                btn.disabled = true;

                auditLogAdd({ type: "save", entity: "master", ok: true, key: "MASTERS", meta: { name: master.name } });
                toastSaved({ where: "大师图谱", count: AppState.masters.length, extra: "可在右侧/资产中心查看" });
                highlightElementById("masterList");

                try { renderMasterList(); } catch {}
                try { refreshTransferAssistOptions(); } catch {}
                try {
                    const snap = computeCompassFromMasters(AppState.masters);
                    saveCompassSnapshot(snap, "add_master");
                    updateCompassVisual(snap);
                } catch {}

                updateAssetsButtonLabel();
            } else {
                btn.textContent = "已保存";
                btn.disabled = true;
                showToast("大师已在图谱中", "warn");
            }
            FLOW_updateAll();
        });
    });

    container.querySelectorAll(".deconstruct-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const name = btn.dataset.name || "";
            goToMode("deconstruct", { inputValue: name, focusId: "mainInput", autoSubmit: false });
        });
    });

    container.querySelectorAll(".navigate-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const name = btn.dataset.name || "";
            goToMode("navigate", { inputValue: name, focusId: "mainInput", autoSubmit: false });
        });
    });

    LastResult.set("source", data);
    FLOW_updateAll();
}

function renderNavigateExtras(data) {
    const prereq = Array.isArray(data.prerequisites) ? data.prerequisites : [];
    const plan = Array.isArray(data.study_plan) ? data.study_plan : [];
    const bank = Array.isArray(data.practice_bank) ? data.practice_bank : [];
    const lab = data.lab_or_proof || {};
    const uncertainty = String(data.uncertainty_notes || "").trim();

    const prereqHtml = prereq.length ? prereq.map(x => `
        <div class="variation-card">
            <div class="variation-header">
                <div class="variation-name">${escapeHtml(x.topic || "")}</div>
            </div>
            ${x.why_needed ? `<div class="hint"><strong>为什么：</strong>${escapeHtml(x.why_needed)}</div>` : ""}
            ${x.how_to_patch ? `<div class="hint" style="margin-top:6px;"><strong>如何补：</strong>${escapeHtml(x.how_to_patch)}</div>` : ""}
            ${x.check_task ? `<div class="hint" style="margin-top:6px;"><strong>自测：</strong>${escapeHtml(x.check_task)}</div>` : ""}
        </div>
    `).join("") : `<div class="hint">（未提供）</div>`;

    const planHtml = plan.length ? plan.map(p => `
        <div class="variation-card">
            <div class="variation-header">
                <div class="variation-name">${escapeHtml(p.phase || "")}</div>
                ${p.duration ? `<span class="pill">${escapeHtml(p.duration)}</span>` : ""}
            </div>
            ${Array.isArray(p.chapters_or_topics) && p.chapters_or_topics.length ? `<div class="hint"><strong>章节/主题：</strong>${escapeHtml(p.chapters_or_topics.join("；"))}</div>` : ""}
            ${Array.isArray(p.goals) && p.goals.length ? `<div class="hint" style="margin-top:6px;"><strong>目标：</strong>${escapeHtml(p.goals.join("；"))}</div>` : ""}
            ${p.exercises ? `<div class="hint" style="margin-top:6px;"><strong>练习：</strong>${escapeHtml(p.exercises)}</div>` : ""}
            ${p.proofs_or_labs ? `<div class="hint" style="margin-top:6px;"><strong>证明/实验：</strong>${escapeHtml(p.proofs_or_labs)}</div>` : ""}
        </div>
    `).join("") : `<div class="hint">（未提供）</div>`;

    const bankHtml = bank.length ? bank.map(b => `
        <div class="variation-card">
            <div class="variation-header">
                <div class="variation-name">${escapeHtml(b.source || "")}</div>
                ${b.location_hint ? `<span class="pill">${escapeHtml(b.location_hint)}</span>` : ""}
            </div>
            ${Array.isArray(b.problem_types) && b.problem_types.length ? `<div class="hint"><strong>题型：</strong>${escapeHtml(b.problem_types.join("；"))}</div>` : ""}
            ${b.suggestion ? `<div class="hint" style="margin-top:6px;"><strong>建议：</strong>${escapeHtml(b.suggestion)}</div>` : ""}
        </div>
    `).join("") : `<div class="hint">（未提供）</div>`;

    const theory = lab?.theory_track || null;
    const labtrack = lab?.lab_track || null;

    const theoryHtml = theory ? `
        <div class="variation-card">
            ${Array.isArray(theory.proof_templates) && theory.proof_templates.length ? `<div class="hint"><strong>证明模板：</strong>${escapeHtml(theory.proof_templates.join("；"))}</div>` : ""}
            ${Array.isArray(theory.common_moves) && theory.common_moves.length ? `<div class="hint" style="margin-top:6px;"><strong>常用套路：</strong>${escapeHtml(theory.common_moves.join("；"))}</div>` : ""}
            ${Array.isArray(theory.drills) && theory.drills.length ? `<div class="hint" style="margin-top:6px;"><strong>训练题/命题：</strong>${escapeHtml(theory.drills.join("；"))}</div>` : ""}
        </div>
    ` : `<div class="hint">（未提供理论证明轨）</div>`;

    const labHtml = labtrack ? `
        <div class="variation-card">
            ${Array.isArray(labtrack.labs) && labtrack.labs.length ? `<div class="hint"><strong>实验：</strong>${escapeHtml(labtrack.labs.join("；"))}</div>` : ""}
            ${labtrack.setup ? `<div class="hint" style="margin-top:6px;"><strong>环境/材料：</strong>${escapeHtml(labtrack.setup)}</div>` : ""}
            ${Array.isArray(labtrack.measure) && labtrack.measure.length ? `<div class="hint" style="margin-top:6px;"><strong>观测指标：</strong>${escapeHtml(labtrack.measure.join("；"))}</div>` : ""}
            ${labtrack.report_template ? `<div class="hint" style="margin-top:6px;"><strong>报告模板：</strong>${escapeHtml(labtrack.report_template)}</div>` : ""}
        </div>
    ` : `<div class="hint">（未提供实验轨）</div>`;

    return `
        <details style="margin-top: 12px;">
            <summary>学科化补充（先修/练习/计划）</summary>

            <div style="margin-top: 12px;">
                <div class="master-section-title">先修知识</div>
                ${prereqHtml}
            </div>

            <div style="margin-top: 12px;">
                <div class="master-section-title">阶段计划</div>
                ${planHtml}
            </div>

            <div style="margin-top: 12px;">
                <div class="master-section-title">练习题库 / 证明训练</div>
                ${bankHtml}
            </div>

            <div style="margin-top: 12px;">
                <div class="master-section-title">证明 / 实验轨（择一或同时给）</div>
                <div class="grid grid-2" style="gap: 12px;">
                    <div>
                        <div class="hint" style="margin-bottom: 6px; font-weight: 800;">理论轨</div>
                        ${theoryHtml}
                    </div>
                    <div>
                        <div class="hint" style="margin-bottom: 6px; font-weight: 800;">实验轨</div>
                        ${labHtml}
                    </div>
                </div>
            </div>

            ${uncertainty ? `<div class="hint" style="margin-top: 12px;"><strong>不确定说明：</strong>${escapeHtml(uncertainty)}</div>` : ""}
        </details>
    `;
}

function renderNavigateResults(data) {
    const container = document.getElementById("resultsSection");
    const path = data?.learning_path || {};
    const gw = path.gateway_work || null;

    let html = `
        <div class="result-card">
            <h2>「${escapeHtml(data?.master || "")}」学习路径</h2>
            <p class="hint">${escapeHtml(data?.total_works_overview || "")}</p>
            ${data?.personalized_advice ? `<div class="variation-card"><div class="hint"><strong>个性化建议：</strong>${escapeHtml(data.personalized_advice)}</div></div>` : ""}
        </div>
    `;

    if (gw) {
        html += `
            <div class="result-card" style="border-left: 4px solid var(--good);">
                <h2>入门首选</h2>
                <div class="variation-card">
                    <div class="variation-header">
                        <div class="variation-name">${escapeHtml(gw.title || "")}</div>
                        <span class="pill">${escapeHtml(gw.time_required || "")}</span>
                    </div>
                    <div class="hint">${escapeHtml(gw.type || "")}${gw.access ? ` · ${escapeHtml(gw.access)}` : ""}</div>
                    <div class="hint" style="margin-top: 8px;"><strong>为什么从这开始：</strong>${escapeHtml(gw.why_start_here || "")}</div>
                    ${Array.isArray(gw.what_to_notice) && gw.what_to_notice.length ? `
                        <div style="margin-top: 10px;">
                            <div class="master-section-title">看的时候注意</div>
                            <ul style="margin-left: 18px; color: var(--muted);">
                                ${gw.what_to_notice.map(x => `<li>${escapeHtml(x)}</li>`).join("")}
                            </ul>
                        </div>
                    ` : ""}
                    ${gw.homework ? `
                        <div style="margin-top: 10px; padding: 12px; border-radius: 12px; background: color-mix(in srgb, var(--accent) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent) 25%, transparent);">
                            <div style="font-weight: 800; margin-bottom: 6px;">作业</div>
                            ${gw.homework.observation ? `<div class="hint"><strong>观察：</strong>${escapeHtml(gw.homework.observation)}</div>` : ""}
                            ${gw.homework.practice ? `<div class="hint" style="margin-top: 6px;"><strong>练习：</strong>${escapeHtml(gw.homework.practice)}</div>` : ""}
                        </div>
                    ` : ""}
                </div>
            </div>
        `;
    }

    if (Array.isArray(path.core_works) && path.core_works.length) {
        html += `
            <div class="result-card">
                <h2>核心材料（按顺序）</h2>
                ${path.core_works.map((w, idx) => `
                    <div class="variation-card">
                        <div class="variation-header">
                            <div class="variation-name">${idx + 1}. ${escapeHtml(w.title || "")}</div>
                            <span class="pill">${escapeHtml(w.type || "")}</span>
                        </div>
                        <div class="hint">${escapeHtml(w.why_important || "")}</div>
                        ${Array.isArray(w.what_to_notice) && w.what_to_notice.length ? `
                            <div class="hint" style="margin-top: 8px;"><strong>注意：</strong>${escapeHtml(w.what_to_notice.join("；"))}</div>
                        ` : ""}
                        ${w.builds_on ? `<div class="hint" style="margin-top: 6px;">承接：${escapeHtml(w.builds_on)}</div>` : ""}
                        ${w.homework ? `<div class="hint" style="margin-top: 6px;"><strong>作业：</strong>${escapeHtml(w.homework)}</div>` : ""}
                    </div>
                `).join("")}
            </div>
        `;
    }

    // 学科化补充（折叠块）
    html += `
        <div class="result-card">
            <h2>学科化补充</h2>
            ${renderNavigateExtras(data)}
        </div>
    `;

    // citations（可选）
    html += renderCitations(data.citations);

    container.innerHTML = html;

    LastResult.set("navigate", data);
    FLOW_updateAll();
}

/* -----------------------------
 * 16) Submit handler (UPDATED: optional SEARCH evidence injection)
 * ----------------------------- */
async function handleSubmit() {
    const mode = AppState.currentMode;
    const v = validateInputByMode(mode);
    if (!v.ok) { showToast(v.msg, "error"); return; }

    const state = aiModule.get_state();
    if (!state.networking_enabled) {
        showToast("请先在 AI 设置里开启联网", "error");
        openAISettings();
        return;
    }

    const input = String(document.getElementById("mainInput").value || "").trim();
    showLoading();

    try {
        let messages = [];

        // optional: fetch evidence before building final user prompt
        let evidence = { sources: [], evidence: "", used: false, note: "" };
        if (shouldUseSearchForMode(mode)) {
            evidence = await maybeFetchEvidence({ mode, userInput: input });
        }

        if (mode === "source") {
            const userPrompt = PROMPTS.source.user(input);
            const injected = injectEvidenceIntoUserPrompt(userPrompt, evidence.evidence);
            messages = [
                { role: "system", content: PROMPTS.source.system },
                { role: "user", content: injected }
            ];
        } else if (mode === "deconstruct") {
            const userPrompt = PROMPTS.deconstruct.user(input, "");
            const injected = injectEvidenceIntoUserPrompt(userPrompt, evidence.evidence); // evidence typically empty for this mode
            messages = [
                { role: "system", content: PROMPTS.deconstruct.system },
                { role: "user", content: injected }
            ];
        } else if (mode === "transfer") {
            const techSel = document.getElementById("transferTechniqueSelect");
            const masterSel = document.getElementById("transferMasterSelect");
            const scenarioEl = document.getElementById("transferScenarioInput");
            const constraintsEl = document.getElementById("transferConstraintsInput");

            const skills = Array.isArray(AppState.skills) ? AppState.skills : [];
            const masters = Array.isArray(AppState.masters) ? AppState.masters : [];

            let technique = "";
            if (techSel && techSel.value !== "" && skills[Number(techSel.value)]) {
                technique = String(skills[Number(techSel.value)].name || "").trim();
            } else {
                const parsed = parseTransferQuickInput(input);
                technique = parsed?.technique || input;
            }

            const scenario = String(scenarioEl?.value || "").trim();
            const constraints = String(constraintsEl?.value || "").trim();

            let master = "";
            if (masterSel && masterSel.value !== "" && masters[Number(masterSel.value)]) {
                master = String(masters[Number(masterSel.value)].name || "").trim();
            } else {
                const match = skills.find(s => String(s?.name || "").trim() === technique);
                master = String(match?.from || "").trim() || (masters[0]?.name || "鲁迅");
            }

            messages = [
                { role: "system", content: PROMPTS.transfer.system },
                { role: "user", content: PROMPTS.transfer.user(technique, master, scenario, constraints) }
            ];
        } else if (mode === "navigate") {
            const userPrompt = PROMPTS.navigate.user(input, "不限", "入门");
            const injected = injectEvidenceIntoUserPrompt(userPrompt, evidence.evidence);
            messages = [
                { role: "system", content: PROMPTS.navigate.system },
                { role: "user", content: injected }
            ];
        } else if (mode === "diagnose") {
            const masterNames = AppState.masters.map(m => m.name);
            messages = [
                { role: "system", content: PROMPTS.diagnose.system },
                { role: "user", content: PROMPTS.diagnose.user(masterNames, "内容创作") }
            ];
        }

        AppState.setLastRequest({ mode, messages, input, at: nowISO() });

        const result = await aiModule.call_ai({ messages });

        let data = null;
        try {
            data = parseAIResponse(result.text);
            data = normalizeResponseByMode(mode, data);
            validateSchemaOrThrow(mode, data);
        } catch (e) {
            document.getElementById("resultsSection").innerHTML = `
                <div class="result-card" style="border-left: 4px solid var(--warn);">
                    <h2 style="color: var(--warn);">AI 输出解析/结构失败（已降级）</h2>
                    <div class="hint" style="margin-top: 6px;">${escapeHtml(String(e?.message || e))}</div>
                    <pre class="log" style="margin-top: 12px;">${escapeHtml(result.text)}</pre>
                    <div class="row" style="margin-top: 12px;">
                        <button class="btn secondary" type="button" id="openAiSettingsBtnX">打开 AI 设置</button>
                        <button class="btn secondary" type="button" id="openSearchSettingsBtnX">打开检索设置</button>
                        <button class="btn secondary" type="button" id="copyRawBtnX">复制原文</button>
                    </div>
                </div>
            `;
            document.getElementById("openAiSettingsBtnX")?.addEventListener("click", openAISettings);
            document.getElementById("openSearchSettingsBtnX")?.addEventListener("click", openSearchSettings);
            document.getElementById("copyRawBtnX")?.addEventListener("click", async () => copyTextWithFallback(result.text));
            auditLogAdd({ type: "ai_parse_fail", entity: mode, ok: false, key: "AI_RESPONSE", meta: { at: nowISO() } });
            FLOW_updateAll();
            updateResultsActionBar();
            return;
        }

        if (mode === "source") renderSourceResults(data);
        else if (mode === "deconstruct") renderDeconstructResults(data);
        else if (mode === "transfer") renderTransferResults(data);
        else if (mode === "navigate") renderNavigateResults(data);
        else if (mode === "diagnose") renderDiagnoseResults(data);

        auditLogAdd({ type: "ai_success", entity: mode, ok: true, key: "AI_RESPONSE", meta: { at: nowISO(), search_used: evidence.used } });

    } catch (err) {
        console.error(err);
        const actionable = aiModule.get_actionable_error(err);
        document.getElementById("resultsSection").innerHTML = `
            <div class="result-card" style="border-left: 4px solid var(--bad);">
                <h2 style="color: var(--bad);">出错了</h2>
                <pre class="log" style="margin-top: 12px;">${escapeHtml(actionable)}</pre>
                <div class="row" style="margin-top: 12px;">
                    <button class="btn secondary" type="button" id="openAiSettingsBtnY">打开 AI 设置</button>
                    <button class="btn secondary" type="button" id="openSearchSettingsBtnY">打开检索设置</button>
                    <button class="btn secondary" type="button" id="copyErrBtnY">复制错误</button>
                </div>
            </div>
        `;
        document.getElementById("openAiSettingsBtnY")?.addEventListener("click", openAISettings);
        document.getElementById("openSearchSettingsBtnY")?.addEventListener("click", openSearchSettings);
        document.getElementById("copyErrBtnY")?.addEventListener("click", async () => copyTextWithFallback(actionable));
        auditLogAdd({ type: "ai_fail", entity: mode, ok: false, key: "AI_CALL", meta: { at: nowISO() } });
    } finally {
        FLOW_updateAll();
        updateResultsActionBar();
    }
}
/* -----------------------------
 * 5) Transfer assist (original; required by goToMode/transfer mode)
 * ----------------------------- */
function refreshTransferAssistOptions() {
    const techSel = document.getElementById("transferTechniqueSelect");
    const masterSel = document.getElementById("transferMasterSelect");
    if (!techSel || !masterSel) return;

    const skills = Array.isArray(AppState.skills) ? AppState.skills : [];
    const masters = Array.isArray(AppState.masters) ? AppState.masters : [];

    if (skills.length === 0) techSel.innerHTML = `<option value="">（暂无已保存技法）</option>`;
    else {
        techSel.innerHTML = skills.map((s, idx) => {
            const label = `${s.name}${s.from ? `（来自：${s.from}）` : ""}`;
            return `<option value="${idx}">${escapeHtml(label)}</option>`;
        }).join("");
    }

    const masterOptions = [`<option value="">（不指定）</option>`]
        .concat(masters.map((m, idx) => `<option value="${idx}">${escapeHtml(m.name)}</option>`));
    masterSel.innerHTML = masterOptions.join("");
}

function fillTransferAssistFromQuickInput() {
    const input = document.getElementById("mainInput");
    const scenario = document.getElementById("transferScenarioInput");
    const techSel = document.getElementById("transferTechniqueSelect");
    if (!input || !scenario || !techSel) return;

    const parsed = parseTransferQuickInput(input.value);
    if (!parsed) return;

    if (parsed.scenario) scenario.value = parsed.scenario;
    const skills = Array.isArray(AppState.skills) ? AppState.skills : [];
    const idx = skills.findIndex(s => String(s?.name || "").trim() === parsed.technique);
    if (idx >= 0) techSel.value = String(idx);
}

/* -----------------------------
 * 6) Compass (original)
 * ----------------------------- */
function normalizeCoordValue(dim, v) {
    const s = String(v || "").trim();
    if (!s) return "中";

    const map = {
        temperature: { low: ["冷", "偏冷"], mid: ["中", "适中", "均衡"], high: ["热", "偏热"] },
        density: { low: ["低", "偏低"], mid: ["中", "适中", "均衡"], high: ["高", "偏高"] },
        aggression: { low: ["低", "偏低"], mid: ["中", "适中", "均衡"], high: ["高", "偏高"] },
        structure: { low: ["弱", "偏弱"], mid: ["中", "适中", "均衡"], high: ["强", "偏强"] }
    };
    const m = map[dim];
    if (!m) return "中";
    if (m.low.includes(s)) return m.low[0];
    if (m.mid.includes(s)) return "中";
    if (m.high.includes(s)) return m.high[0];
    return "中";
}

function coordToScore(dim, normalized) {
    const low = (dim === "temperature") ? "冷" : (dim === "structure" ? "弱" : "低");
    const high = (dim === "temperature") ? "热" : (dim === "structure" ? "强" : "高");
    if (normalized === low) return 1;
    if (normalized === high) return 3;
    return 2;
}

function scoreToCenterValue(dim, score) {
    const low = (dim === "temperature") ? "冷" : (dim === "structure" ? "弱" : "低");
    const high = (dim === "temperature") ? "热" : (dim === "structure" ? "强" : "高");
    if (score <= 1.67) return low;
    if (score >= 2.33) return high;
    return "中";
}

function computeCompassFromMasters(masters) {
    const dims = ["temperature", "density", "aggression", "structure"];
    const out = {};
    const list = Array.isArray(masters) ? masters : [];
    const n = list.length;

    dims.forEach(dim => {
        const lowLabel = (dim === "temperature") ? "冷" : (dim === "structure" ? "弱" : "低");
        const highLabel = (dim === "temperature") ? "热" : (dim === "structure" ? "强" : "高");

        const buckets = { [lowLabel]: [], "中": [], [highLabel]: [] };
        let sum = 0;
        let count = 0;

        list.forEach(m => {
            const raw = m?.aesthetic_coordinates?.[dim];
            const normalized = normalizeCoordValue(dim, raw);
            const label = (normalized === "中") ? "中" : normalized;
            buckets[label].push(m?.name || "未知");
            sum += coordToScore(dim, normalized);
            count += 1;
        });

        const avg = count ? (sum / count) : 2;
        const centerValue = scoreToCenterValue(dim, avg);

        const lowCount = buckets[lowLabel].length;
        const midCount = buckets["中"].length;
        const highCount = buckets[highLabel].length;

        let distribution = "均衡";
        const max = Math.max(lowCount, midCount, highCount);
        if (count >= 2 && max / count >= 0.6) {
            if (max === lowCount) distribution = `偏${lowLabel}`;
            else if (max === highCount) distribution = `偏${highLabel}`;
            else distribution = "偏中";
        }

        let spread = "集中";
        const nonZero = [lowCount, midCount, highCount].filter(x => x > 0).length;
        if (count >= 3 && nonZero >= 2) spread = "分散";

        out[dim] = { distribution, center_value: centerValue, spread, masters_distribution: buckets };
    });

    const blindspots = [];
    dims.forEach(dim => {
        const buckets = out[dim]?.masters_distribution || {};
        const nonZero = Object.values(buckets).filter(arr => Array.isArray(arr) && arr.length > 0).length;
        if (n >= 2 && nonZero === 1) blindspots.push(dim);
    });

    return { masters_count: n, coordinate_analysis: out, blindspots };
}

function saveCompassSnapshot(snapshot, reason = "auto") {
    if (!AppState.storage_ok) return;
    try {
        localStorage.setItem(STORAGE_KEYS.COMPASS_SNAPSHOT, JSON.stringify({ ...snapshot, reason, saved_at: nowISO() }));

        const dayKey = new Date().toISOString().slice(0, 10);
        const raw = localStorage.getItem(STORAGE_KEYS.COMPASS_HISTORY) || "[]";
        let arr = [];
        try { arr = JSON.parse(raw); } catch { arr = []; }
        const exists = arr.some(x => x && x.day === dayKey);
        if (!exists) {
            arr.push({ day: dayKey, masters_count: snapshot.masters_count, coordinate_analysis: snapshot.coordinate_analysis });
            localStorage.setItem(STORAGE_KEYS.COMPASS_HISTORY, JSON.stringify(arr));
        }
        auditLogAdd({ type: "save", entity: "compass_snapshot", ok: true, key: "COMPASS_SNAPSHOT/COMPASS_HISTORY", meta: { reason } });
    } catch (e) {
        auditLogAdd({ type: "save", entity: "compass_snapshot", ok: false, key: "COMPASS_SNAPSHOT/COMPASS_HISTORY", error: String(e) });
    }
}

function updateCompassVisual(input) {
    const visual = document.getElementById("compassVisual");
    const summaryEl = document.getElementById("compassSummary");
    const blindBox = document.getElementById("compassBlindspots");
    const blindText = document.getElementById("compassBlindspotsText");
    if (!visual) return;

    const coords = input?.coordinate_analysis ? input.coordinate_analysis : (input || {});
    const mastersCount = input?.masters_count ?? AppState?.masters?.length ?? 0;
    const blindspots = input?.blindspots || [];

    const valueToPct = (center) => {
        const c = String(center || "中");
        if (c === "冷" || c === "低" || c === "弱") return 30;
        if (c === "热" || c === "高" || c === "强") return 90;
        return 60;
    };

    const dims = ["temperature", "density", "aggression", "structure"];
    const labels = ["温度", "密度", "攻击性", "结构"];
    const values = dims.map(d => valueToPct(coords?.[d]?.center_value || "中"));

    if (summaryEl) {
        const t = coords?.temperature?.center_value || "中";
        const den = coords?.density?.center_value || "中";
        const ag = coords?.aggression?.center_value || "中";
        const st = coords?.structure?.center_value || "中";
        const sampleHint = mastersCount < 2 ? "（样本偏少，仅供参考）" : "";
        summaryEl.textContent = `当前倾向：温度${t} / 密度${den} / 攻击性${ag} / 结构${st} ${sampleHint}`;
    }

    if (blindBox && blindText) {
        if (blindspots.length > 0) {
            blindBox.style.display = "block";
            blindText.textContent = "盲区：某些维度过于单一（建议补充相反象限）。";
        } else {
            blindBox.style.display = "none";
            blindText.textContent = "";
        }
    }

    const bars = labels.map((label, i) => `
        <div style="width: 100%; display: flex; align-items: center; gap: 8px;">
            <span style="width: 50px; font-size: 11px; text-align: right;">${label}</span>
            <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                <div style="width: ${values[i]}%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 4px;"></div>
            </div>
            <span style="width: 36px; font-size: 11px; color: var(--muted);">${values[i]}%</span>
        </div>
    `).join("");

    visual.innerHTML = `<div style="width:100%">${bars}</div>`;
}

/* -----------------------------
 * 7) Checklist state + Markdown + render (UPDATED: use getChecklistContextFromUI().ok)
 * ----------------------------- */
function loadChecklistState(key) {
    try {
        if (!AppState.storage_ok) return {};
        const raw = localStorage.getItem(STORAGE_KEYS.CHECKLIST_STATE) || "{}";
        const parsed = safeJsonParseGlobal(raw);
        if (!parsed.ok || !parsed.value) return {};
        return parsed.value[key] || {};
    } catch {
        return {};
    }
}

function saveChecklistState(key, stateObj) {
    try {
        if (!AppState.storage_ok) return;
        const raw = localStorage.getItem(STORAGE_KEYS.CHECKLIST_STATE) || "{}";
        const parsed = safeJsonParseGlobal(raw);
        const all = (parsed.ok && parsed.value && typeof parsed.value === "object") ? parsed.value : {};
        all[key] = stateObj || {};
        localStorage.setItem(STORAGE_KEYS.CHECKLIST_STATE, JSON.stringify(all));
        auditLogAdd({ type: "save", entity: "checklist_state", ok: true, key: "CHECKLIST_STATE", meta: { state_key: key } });
    } catch (e) {
        auditLogAdd({ type: "save", entity: "checklist_state", ok: false, key: "CHECKLIST_STATE", error: String(e) });
    }
}

function pruneChecklistStateDays(maxDays = LIMITS.CHECKLIST_STATE_DAYS_MAX) {
    try {
        if (!AppState.storage_ok) return false;
        const raw = localStorage.getItem(STORAGE_KEYS.CHECKLIST_STATE) || "{}";
        const parsed = safeJsonParseGlobal(raw);
        const all = (parsed.ok && parsed.value && typeof parsed.value === "object") ? parsed.value : {};
        const keys = Object.keys(all);
        if (keys.length === 0) return true;

        const cutoff = new Date(Date.now() - maxDays * 86400000);
        const kept = {};
        keys.forEach(k => {
            const day = String(k).split(":")[0] || "";
            const dt = new Date(day);
            if (!isNaN(dt.getTime()) && dt >= cutoff) {
                kept[k] = all[k];
            }
        });

        localStorage.setItem(STORAGE_KEYS.CHECKLIST_STATE, JSON.stringify(kept));
        return true;
    } catch {
        return false;
    }
}

function checklistToMarkdown(data) {
    const title = data?.checklist_title || "创作检查清单";
    const domain = data?.user_domain || "";
    const constraints = data?.constraints || "";
    const sections = Array.isArray(data?.sections) ? data.sections : [];

    let md = `# ${title}\n\n`;
    if (domain) md += `* 载体：${domain}\n`;
    if (constraints) md += `* 约束：${constraints}\n`;
    md += `\n`;

    sections.forEach(sec => {
        md += `## ${sec.section_title || "未命名章节"}\n\n`;
        const items = Array.isArray(sec.items) ? sec.items : [];
        items.forEach(it => {
            const from = it.from_skill ? `（来自：${it.from_skill}）` : "";
            md += `- [ ] ${it.item || "（空）"}${from}\n`;
            if (it.quick_fix) md += `    - 快修：${it.quick_fix}\n`;
            if (it.why) md += `    - 原因：${it.why}\n`;
        });
        md += `\n`;
    });
    if (data?.closing_note) md += `---\n\n${data.closing_note}\n`;
    return md.trim();
}

function buildLocalChecklistData({ user_domain, constraints, skills }) {
    const items = (skills || []).slice(0, 12).map(s => ({
        item: `我是否用到了「${s.name}」`,
        why: "这是你已学到的能力点",
        from_skill: s.name,
        severity: "should",
        quick_fix: "回到对应示例，做一次最小模仿改写"
    }));

    return {
        checklist_title: `${user_domain || "通用写作"}检查清单（本地生成）`,
        user_domain: user_domain || "通用写作",
        constraints: constraints || "",
        generated_from_skills: (skills || []).map(s => ({ name: s.name, from: s.from })),
        sections: [{ section_title: "技法落实", items }],
        closing_note: "先把已学技法用出来，再追求更复杂的结构。"
    };
}

function renderChecklistResults(data, { stateKey }) {
    const container = document.getElementById("checklistOutput");
    if (!container) return;

    if (data && data._raw_text) {
        container.innerHTML = `
            <div class="result-card" style="margin: 0; border-left: 4px solid var(--warn);">
                <div style="font-weight: 900; margin-bottom: 8px;">清单生成结果（未能解析为 JSON）</div>
                <pre class="log" style="margin-top: 10px;">${escapeHtml(data._raw_text)}</pre>
            </div>
        `;
        return;
    }

    const title = data?.checklist_title || "创作检查清单";
    const sections = Array.isArray(data?.sections) ? data.sections : [];
    const md = checklistToMarkdown(data);
    const savedState = loadChecklistState(stateKey);

    if (AppState.storage_ok) {
        try {
            localStorage.setItem(STORAGE_KEYS.CHECKLIST_LAST, JSON.stringify({ ...data, saved_at: nowISO(), state_key: stateKey }));
            auditLogAdd({ type: "save", entity: "checklist_last", ok: true, key: "CHECKLIST_LAST", meta: { state_key: stateKey } });
        } catch (e) {
            auditLogAdd({ type: "save", entity: "checklist_last", ok: false, key: "CHECKLIST_LAST", error: String(e) });
        }
    }

    container.innerHTML = `
        <div class="result-card" style="margin: 0;">
            <div style="display:flex; justify-content: space-between; gap: 10px; align-items: flex-start;">
                <div>
                    <div style="font-weight: 900;">${escapeHtml(title)}</div>
                    <div class="hint" style="margin-top: 4px;">
                        载体：${escapeHtml(data?.user_domain || "")}${data?.constraints ? ` · 约束：${escapeHtml(data.constraints)}` : ""}
                    </div>
                </div>
                <div class="row" style="gap: 8px;">
                    <button class="btn secondary" id="copyChecklistMdBtn" type="button">复制 Markdown</button>
                </div>
            </div>

            <div style="margin-top: 12px;">
                ${sections.map((sec, secIdx) => {
                    const items = Array.isArray(sec.items) ? sec.items : [];
                    return `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <div style="font-weight: 800; margin-bottom: 8px;">${escapeHtml(sec.section_title || "未命名章节")}</div>
                            <div style="display:flex; flex-direction: column; gap: 8px;">
                                ${items.map((it, itemIdx) => {
                                    const id = `chk_${secIdx}_${itemIdx}`;
                                    const checked = savedState[id] === true;
                                    return `
                                        <label style="display:flex; gap: 10px; align-items: flex-start; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: color-mix(in srgb, var(--bg2) 70%, transparent);">
                                            <input type="checkbox" data-statekey="${escapeHtml(stateKey)}" data-checkid="${escapeHtml(id)}" ${checked ? "checked" : ""} style="transform: translateY(3px);" />
                                            <div style="flex: 1;">
                                                <div style="display:flex; justify-content: space-between; gap: 10px;">
                                                    <div style="font-weight: 700;">${escapeHtml(it.item || "")}</div>
                                                    <span class="pill">${escapeHtml(it.severity || "should")}</span>
                                                </div>
                                                <div class="hint" style="margin-top: 4px;">
                                                    ${it.from_skill ? `来自：${escapeHtml(it.from_skill)}` : ""}
                                                    ${it.why ? `${it.from_skill ? " · " : ""}原因：${escapeHtml(it.why)}` : ""}
                                                </div>
                                                ${it.quick_fix ? `<div class="hint" style="margin-top: 4px;">快修：${escapeHtml(it.quick_fix)}</div>` : ""}
                                            </div>
                                        </label>
                                    `;
                                }).join("")}
                            </div>
                        </div>
                    `;
                }).join("")}
            </div>
        </div>
    `;

    document.getElementById("copyChecklistMdBtn")?.addEventListener("click", async () => {
        await copyTextWithFallback(md);
    });

    container.querySelectorAll("input[type='checkbox'][data-checkid]").forEach(cb => {
        cb.addEventListener("change", () => {
            if (!AppState.storage_ok) return;
            const k = cb.getAttribute("data-statekey") || stateKey;
            const id = cb.getAttribute("data-checkid");
            const next = loadChecklistState(k);
            next[id] = cb.checked === true;
            saveChecklistState(k, next);
            FLOW_updateAll();
            updateAssetsButtonLabel();
        });
    });

    LastResult.set("checklist", data);
}

async function runChecklistLocal() {
    if (AppState.skills.length === 0) { showToast("请先保存至少 1 个技法", "error"); return; }

    const ctx = getChecklistContextFromUI();
    if (!ctx.ok) return;

    const data = buildLocalChecklistData({ user_domain: ctx.user_domain, constraints: ctx.constraints, skills: AppState.skills });
    renderChecklistResults(data, { stateKey: getChecklistStateKey(ctx.user_domain) });
    toastSaved({ where: "检查清单", extra: "已在右侧生成" });
    updateAssetsButtonLabel();
    FLOW_updateAll();
}

async function runChecklistAI() {
    if (AppState.skills.length === 0) { showToast("请先保存至少 1 个技法", "error"); return; }

    const s = aiModule.get_state();
    if (!s.networking_enabled) { showToast("请先开启联网", "error"); openAISettings(); return; }

    const ctx = getChecklistContextFromUI();
    if (!ctx.ok) return;

    const messages = [
        { role: "system", content: PROMPTS.checklist.system },
        { role: "user", content: PROMPTS.checklist.user({ user_domain: ctx.user_domain, constraints: ctx.constraints, skills: AppState.skills }) }
    ];

    showLoading();

    try {
        const result = await aiModule.call_ai({ messages });
        let parsed = null;
        try { parsed = parseAIResponse(result.text); } catch { parsed = { _raw_text: result.text }; }

        document.getElementById("resultsSection").innerHTML = `
            <div class="result-card">
                <h2>检查清单已生成</h2>
                <p class="hint">请在右侧查看/复制/勾选；也可在“我的资产→清单”导出。</p>
            </div>
        `;

        renderChecklistResults(parsed, { stateKey: getChecklistStateKey(ctx.user_domain) });
        toastSaved({ where: "检查清单", extra: "可在资产中心导出" });
        updateAssetsButtonLabel();

    } catch (err) {
        console.error(err);
        const actionable = aiModule.get_actionable_error(err);
        showToast("生成失败", "error");
        document.getElementById("resultsSection").innerHTML = `
            <div class="result-card" style="border-left: 4px solid var(--bad);">
                <h2 style="color: var(--bad);">清单生成失败</h2>
                <pre class="log" style="margin-top: 12px;">${escapeHtml(actionable)}</pre>
            </div>
        `;
        auditLogAdd({ type: "ai_fail", entity: "checklist", ok: false, key: "AI_CALL", meta: { at: nowISO() } });
    } finally {
        FLOW_updateAll();
        updateResultsActionBar();
    }
}
/* -----------------------------
 * 8) Morning (full) + journal trim
 * ----------------------------- */
function pickFromArray(arr) {
    if (!Array.isArray(arr) || arr.length === 0) return null;
    return arr[Math.floor(Math.random() * arr.length)];
}

function pickMorningMasterName() {
    const names = (AppState.masters || []).map(m => m?.name).filter(Boolean);
    return pickFromArray(names);
}

function buildMorningFallback(date) {
    const fallbackPool = [
        {
            source: { master: "鲁迅", work_hint: "杂文（片段描述）", note: "用锋利的语言做一次清醒校准" },
            quote_or_scene: "把一句话删到只剩骨头（片段描述）",
            what_to_notice: ["短句的节奏", "反讽的落点"],
            micro_practice: "把你昨天写的一句删掉 50%",
            coordinate_hint: { temperature: "冷", density: "高", aggression: "高", structure: "强" }
        },
        {
            source: { master: "诺兰", work_hint: "叙事结构（片段描述）", note: "用结构感校准“好看但不散”" },
            quote_or_scene: "把信息分三次给（片段描述）",
            what_to_notice: ["信息延迟", "因果回扣"],
            micro_practice: "把内容拆成“铺垫/揭示/回扣”",
            coordinate_hint: { temperature: "冷", density: "高", aggression: "中", structure: "强" }
        }
    ];
    const base = pickFromArray(fallbackPool) || fallbackPool[0];
    return { date, ...base, _generated_by: "local_fallback" };
}

function renderMorning(data) {
    const content = document.getElementById("morningContent");
    const meta = document.getElementById("morningMeta");
    const saveBtn = document.getElementById("saveMorningBtn");
    const copyBtn = document.getElementById("copyMorningBtn");
    if (!content) return;

    MorningState.today = data || null;

    if (!data) {
        if (meta) meta.textContent = "每天一口好东西，30 秒即可。";
        content.innerHTML = `<div class="hint">今日校准不可用</div>`;
        if (saveBtn) saveBtn.disabled = true;
        if (copyBtn) copyBtn.disabled = true;
        return;
    }

    const src = data.source || {};
    const dateText = data.date || "";
    const srcText = src.master || "未知";
    const noteText = src.note || "";

    if (meta) {
        meta.textContent = `${dateText}${srcText ? ` · 来源：${srcText}` : ""}${noteText ? ` · ${noteText}` : ""}`;
    }

    const quote = data.quote_or_scene || "";
    const notices = Array.isArray(data.what_to_notice) ? data.what_to_notice : [];
    const practice = data.micro_practice || "";
    const coord = data.coordinate_hint || {};

    const coordText = [
        coord.temperature ? `温度:${coord.temperature}` : "",
        coord.density ? `密度:${coord.density}` : "",
        coord.aggression ? `攻击性:${coord.aggression}` : "",
        coord.structure ? `结构:${coord.structure}` : ""
    ].filter(Boolean).join(" · ");

    content.innerHTML = `
        <div class="morning-wrap">
            <div class="morning-section-title">今日一口</div>
            <div class="morning-quote">${escapeHtml(quote)}</div>

            <div style="margin-top: 14px;">
                <div class="morning-section-title">看的时候注意</div>
                ${
                    notices.length
                        ? `<ul class="morning-list">${notices.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>`
                        : `<div class="hint">未提供注意点</div>`
                }
            </div>

            <div class="morning-practice">
                <div class="morning-section-title" style="margin-bottom: 6px; color: color-mix(in srgb, var(--accent) 70%, var(--muted));">
                    30 秒微作业
                </div>
                <div class="morning-practice-text">${escapeHtml(practice)}</div>
            </div>

            ${
                coordText
                    ? `<div class="morning-meta-row"><span class="morning-pill">${escapeHtml(coordText)}</span></div>`
                    : ``
            }
        </div>
    `;

    if (saveBtn) saveBtn.disabled = false;
    if (copyBtn) copyBtn.disabled = false;

    LastResult.set("morning", data);
}

function updateMorningJournalUI() {
    const el = document.getElementById("morningJournal");
    if (!el) return;

    const arr = safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    if (!Array.isArray(arr) || arr.length === 0) {
        el.textContent = "暂无记录";
        return;
    }

    const last = arr.slice(-5).reverse();
    el.innerHTML = last.map(x => {
        const savedAt = x?.saved_at ? new Date(x.saved_at).toLocaleString() : "";
        const d = x?.data || {};
        const srcMaster = d?.source?.master || "未知";
        const quote = d?.quote_or_scene || "";
        const notices = Array.isArray(d?.what_to_notice) ? d.what_to_notice : [];
        const practice = d?.micro_practice || "";

        return `
            <div class="journal-entry">
                <div class="journal-head">
                    <div class="journal-title">${escapeHtml(d?.date || "")} · ${escapeHtml(srcMaster)}</div>
                    <div class="journal-time">${escapeHtml(savedAt)}</div>
                </div>

                <div class="journal-body">
                    <div class="morning-section-title">今日一口</div>
                    <div class="morning-quote">${escapeHtml(quote)}</div>

                    <div style="margin-top: 12px;">
                        <div class="morning-section-title">看的时候注意</div>
                        ${
                            notices.length
                                ? `<ul class="morning-list">${notices.map(t => `<li>${escapeHtml(t)}</li>`).join("")}</ul>`
                                : `<div class="hint">（当时未记录注意点）</div>`
                        }
                    </div>

                    <div class="morning-practice">
                        <div class="morning-section-title" style="margin-bottom: 6px; color: color-mix(in srgb, var(--accent) 70%, var(--muted));">
                            30 秒微作业
                        </div>
                        <div class="morning-practice-text">${escapeHtml(practice || "（当时未记录作业）")}</div>
                    </div>
                </div>
            </div>
        `;
    }).join("");
}

function trimMorningJournal(maxN = LIMITS.MORNING_JOURNAL_MAX) {
    const arr = safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    if (!Array.isArray(arr)) return false;
    if (arr.length <= maxN) return true;
    const trimmed = arr.slice(-maxN);
    const ok = safeSaveJson(STORAGE_KEYS.MORNING_JOURNAL, trimmed);
    auditLogAdd({ type: "trim", entity: "morning_journal", ok, key: "MORNING_JOURNAL", meta: { maxN } });
    return ok;
}

async function generateMorning({ force = false } = {}) {
    const day = new Date().toISOString().slice(0, 10);
    if (!force) {
        const cached = safeLoadJson(STORAGE_KEYS.MORNING_TODAY, null);
        if (cached && cached.date === day) {
            renderMorning(cached);
            FLOW_updateAll();
            return;
        }
    }

    const fallback = buildMorningFallback(day);
    const picked = pickMorningMasterName();
    if (picked) {
        fallback.source = fallback.source || {};
        fallback.source.master = picked;
        fallback.source.note = "从你收藏的大师里抽一口";
    }

    safeSaveJson(STORAGE_KEYS.MORNING_TODAY, fallback);
    auditLogAdd({ type: "save", entity: "morning_today", ok: true, key: "MORNING_TODAY", meta: { generated_by: fallback._generated_by } });
    renderMorning(fallback);
    FLOW_updateAll();
}

async function generateMorningWithAI() {
    const day = new Date().toISOString().slice(0, 10);
    const s = aiModule.get_state();
    if (!s.networking_enabled) {
        showToast("未开启联网，已使用离线校准", "warn");
        await generateMorning({ force: true });
        return;
    }

    const masterNames = (AppState.masters || []).map(m => m?.name).filter(Boolean);
    const messages = [
        { role: "system", content: PROMPTS.morning.system },
        { role: "user", content: PROMPTS.morning.user({ date: day, master_names: masterNames, mode_hint: "均衡" }) }
    ];

    const content = document.getElementById("morningContent");
    if (content) content.innerHTML = `<div class="hint">正在生成今日校准…</div>`;

    try {
        const result = await aiModule.call_ai({ messages });
        let parsed = null;
        try { parsed = parseAIResponse(result.text); } catch { parsed = { _raw_text: result.text }; }

        const data = parsed?._raw_text
            ? { date: day, source: { master: "AI 输出", note: "未能解析为 JSON" }, quote_or_scene: parsed._raw_text, what_to_notice: [], micro_practice: "", coordinate_hint: {}, _generated_by: "ai_raw" }
            : { ...parsed, _generated_by: "ai_json" };

        safeSaveJson(STORAGE_KEYS.MORNING_TODAY, data);
        auditLogAdd({ type: "save", entity: "morning_today", ok: true, key: "MORNING_TODAY", meta: { generated_by: data._generated_by } });
        renderMorning(data);
        FLOW_updateAll();
    } catch (err) {
        console.error(err);
        showToast("生成失败，已回退离线校准", "warn");
        await generateMorning({ force: true });
    }
}

async function saveMorningToJournal() {
    if (!AppState.storage_ok) { showToast("本地存储不可用，无法存档", "error"); return; }
    const data = MorningState.today;
    if (!data) return;

    const arr = safeLoadJson(STORAGE_KEYS.MORNING_JOURNAL, []);
    const next = Array.isArray(arr) ? arr : [];
    next.push({ saved_at: nowISO(), data });
    const ok = safeSaveJson(STORAGE_KEYS.MORNING_JOURNAL, next);
    trimMorningJournal();
    auditLogAdd({ type: "save", entity: "morning_journal", ok, key: "MORNING_JOURNAL" });

    if (ok) {
        toastSaved({ where: "审美日记", count: next.length, extra: "可在“我的资产→日记”查看" });
        const detailsEl = document.querySelector("#morningCard details");
        if (detailsEl) detailsEl.open = true;
        updateMorningJournalUI();
        highlightElementById("morningJournal");
        updateAssetsButtonLabel();
    } else {
        showToast("存档失败（可能是存储空间不足）", "error");
    }
    FLOW_updateAll();
}

async function copyMorningToday() {
    const data = MorningState.today;
    if (!data) return;

    const src = data?.source?.master ? `来源：${data.source.master}\n` : "";
    const text = `${data.date || ""}\n${src}\n今日一口：${data.quote_or_scene || ""}\n\n注意：${(data.what_to_notice || []).join("；")}\n微作业：${data.micro_practice || ""}`.trim();
    await copyTextWithFallback(text);
}

/* -----------------------------
 * 14) Rendering: master list + skill list + deconstruct (with citations)
 * ----------------------------- */
function renderMasterList() {
    const container = document.getElementById("masterList");
    if (AppState.masters.length === 0) {
        container.innerHTML = `<div class="hint">还没有收藏大师</div>`;
        return;
    }

    container.innerHTML = AppState.masters.map(m => `
        <div class="master-item">
            <div>
                <div class="master-item-name">${escapeHtml(m.name)}</div>
                <div class="master-item-source">${escapeHtml(m.domain || "")}</div>
            </div>
            <button class="remove-btn" data-name="${escapeHtml(m.name)}" aria-label="remove">×</button>
        </div>
    `).join("");

    container.querySelectorAll(".remove-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            AppState.removeMaster(btn.dataset.name);
            auditLogAdd({ type: "delete", entity: "master", ok: true, key: "MASTERS", meta: { name: btn.dataset.name } });
            renderMasterList();
            refreshTransferAssistOptions();
            validateAndToggleSubmit();
            const snap = computeCompassFromMasters(AppState.masters);
            saveCompassSnapshot(snap, "remove_master");
            updateCompassVisual(snap);
            updateAssetsButtonLabel();
            FLOW_updateAll();
        });
    });
}

function renderSkillList() {
    const container = document.getElementById("skillList");
    if (AppState.skills.length === 0) {
        container.innerHTML = `<div class="hint">还没有技法</div>`;
        return;
    }

    container.innerHTML = AppState.skills.slice(0, 6).map(s => `
        <div class="skill-item">
            <div class="skill-item-name">${escapeHtml(s.name)}</div>
            <div class="skill-item-from">来自 ${escapeHtml(s.from)}</div>
        </div>
    `).join("");
}

function renderDeconstructResults(data) {
    const container = document.getElementById("resultsSection");
    __lastDeconstructSkills = Array.isArray(data.extractable_skills) ? data.extractable_skills : [];

    let html = `
        <div class="result-card">
            <h2>「${escapeHtml(data.master)}」四层拆解</h2>
            <p class="hint">${escapeHtml(data.overview || "")}</p>
        </div>
    `;

    if (__lastDeconstructSkills.length > 0) {
        html += `
            <div class="result-card">
                <h2>可提取技法</h2>
                ${__lastDeconstructSkills.map((s, idx) => `
                    <div class="variation-card">
                        <div class="variation-header">
                            <div class="variation-name">${escapeHtml(s.skill_name || "")}</div>
                            <span class="variation-distance">${escapeHtml(s.from_layer || "")}</span>
                        </div>
                        <p class="hint">${escapeHtml(s.description || "")}</p>
                        <div class="row" style="margin-top: 10px;">
                            <button class="btn secondary save-skill-btn" data-idx="${idx}" type="button">保存技法</button>
                            <button class="btn secondary transfer-skill-btn" data-skill="${escapeHtml(s.skill_name || "")}" data-from="${escapeHtml(data.master || "")}" type="button">迁移这个技法</button>
                        </div>
                    </div>
                `).join("")}
            </div>
        `;
    } else {
        html += `
            <div class="result-card">
                <h2>可提取技法</h2>
                <div class="hint">本次未输出 extractable_skills（可能是模型缺失字段）。</div>
            </div>
        `;
    }

    // citations（可选）
    html += renderCitations(data.citations);

    container.innerHTML = html;

    container.querySelectorAll(".save-skill-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const idx = Number(btn.dataset.idx);
            const s = __lastDeconstructSkills[idx];
            if (!s) return;

            const skill = {
                name: String(s.skill_name || "").trim(),
                from: String(data.master || "").trim(),
                description: String(s.description || "")
            };

            const added = AppState.addSkill(skill);
            if (added) {
                btn.textContent = "已保存";
                btn.disabled = true;

                auditLogAdd({ type: "save", entity: "skill", ok: true, key: "SKILLS", meta: { name: skill.name, from: skill.from } });
                toastSaved({ where: "技法库", count: AppState.skills.length, extra: "迁移/清单会用到" });
                highlightElementById("skillList");

                renderSkillList();
                refreshTransferAssistOptions();
                updateAssetsButtonLabel();
            } else {
                btn.textContent = "已保存";
                btn.disabled = true;
                showToast("技法已存在", "warn");
            }
            FLOW_updateAll();
        });
    });

    container.querySelectorAll(".transfer-skill-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const skillName = btn.getAttribute("data-skill") || "";
            const from = btn.getAttribute("data-from") || "";
            goToMode("transfer", { transferSkillName: skillName, transferFromMaster: from, focusId: "transferScenarioInput", autoSubmit: false });
        });
    });

    LastResult.set("deconstruct", data);
    FLOW_updateAll();
}
/* -----------------------------
 * 15) Transfer/Navigate/Diagnose renderers
 * (Transfer/Diagnose are provided here; Navigate/Source/Deconstruct already defined earlier)
 * ----------------------------- */
function renderTransferResults(data) {
    const container = document.getElementById("resultsSection");

    const technique = data?.technique || "";
    const sourceMaster = data?.source_master || "";
    const targetScenario = data?.target_scenario || "";
    const constraints = data?.constraints || "";

    const steps = data?.steps || {};
    const s1 = steps.step1_abstraction || steps.abstraction || {};
    const s2 = steps.step2_mapping || steps.mapping || {};
    const s3 = steps.step3_variations || { variations: steps.variations || [] };
    const s4 = steps.step4_experiment || steps.experiment || {};

    const variations = Array.isArray(s3.variations) ? s3.variations : [];
    const mappingTable = Array.isArray(s2.mapping_table) ? s2.mapping_table : (Array.isArray(s2.mappings) ? s2.mappings : []);
    const metrics = Array.isArray(s4.success_metrics) ? s4.success_metrics : [];

    const conf = data?.confidence_assessment?.overall_confidence || data?.confidence || "";
    const confNote = data?.confidence_assessment?.confidence_note || "";
    const anti = data?.anti_patterns || {};
    const mistakes = Array.isArray(anti.common_mistakes) ? anti.common_mistakes : [];

    let html = `
        <div class="result-card">
            <h2>迁移实验室</h2>
            <p class="hint">把「${escapeHtml(technique)}」（来自 ${escapeHtml(sourceMaster)}）迁移到「${escapeHtml(targetScenario)}」</p>
            <div class="row" style="margin-top: 12px;">
                ${constraints ? `<span class="pill">约束：${escapeHtml(constraints)}</span>` : ""}
                ${conf ? `<span class="pill ${conf === "高" ? "good" : conf === "低" ? "warn" : ""}">把握：${escapeHtml(conf)}</span>` : ""}
            </div>
            ${confNote ? `<div class="hint" style="margin-top: 8px;">${escapeHtml(confNote)}</div>` : ""}
        </div>

        <div class="result-card">
            <h2>Step 1 · 抽象</h2>
            <div class="variation-card">
                <div class="hint"><strong>大师做法（片段描述）：</strong>${escapeHtml(s1.master_specific_example || s1.master_example || "")}</div>
                <div class="hint" style="margin-top: 8px;"><strong>抽象原则：</strong>${escapeHtml(s1.abstracted_principle || s1.principle || "")}</div>
                ${s1.principle_formula ? `<div class="variation-example"><strong>公式：</strong>${escapeHtml(s1.principle_formula)}</div>` : ""}
                ${s1.principle_essence ? `<div class="hint" style="margin-top: 8px;"><strong>本质：</strong>${escapeHtml(s1.principle_essence)}</div>` : ""}
            </div>
        </div>

        <div class="result-card">
            <h2>Step 2 · 匹配</h2>
            ${mappingTable.length ? `
                <div class="variation-card">
                    <div class="hint" style="margin-bottom: 8px;">映射表（原元素 → 目标元素）</div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid var(--border);">
                            <th style="text-align:left; padding: 8px; font-size: 12px; color: var(--muted);">原元素</th>
                            <th style="text-align:left; padding: 8px; font-size: 12px; color: var(--muted);">目标元素</th>
                            <th style="text-align:left; padding: 8px; font-size: 12px; color: var(--muted);">适配</th>
                        </tr>
                        ${mappingTable.map(row => `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 8px; font-size: 13px;">${escapeHtml(row.original_element || row.original || "")}</td>
                                <td style="padding: 8px; font-size: 13px;">${escapeHtml(row.target_element || row.target || "")}</td>
                                <td style="padding: 8px; font-size: 12px; color: var(--muted);">${escapeHtml(row.adaptation_needed || row.note || "")}</td>
                            </tr>
                        `).join("")}
                    </table>
                    ${s2.constraint_impact ? `<div class="hint" style="margin-top: 10px;"><strong>约束影响：</strong>${escapeHtml(s2.constraint_impact)}</div>` : ""}
                    ${s2.unmappable_elements ? `<div class="hint" style="margin-top: 6px;"><strong>无法映射：</strong>${escapeHtml(s2.unmappable_elements)}</div>` : ""}
                </div>
            ` : `<div class="hint">未提供映射表（可能是模型输出缺失）。</div>`}
        </div>

        <div class="result-card">
            <h2>Step 3 · 变体（至少 3 个）</h2>
            ${variations.length ? variations.map(v => `
                <div class="variation-card">
                    <div class="variation-header">
                        <div class="variation-name">${escapeHtml(v.variation_name || v.name || "")}</div>
                        <span class="variation-distance">${escapeHtml(v.variation_type || v.distance || "")}</span>
                    </div>
                    <div class="hint">${escapeHtml(v.description || "")}</div>
                    ${v.concrete_example || v.example ? `<div class="variation-example">${escapeHtml(v.concrete_example || v.example)}</div>` : ""}
                    ${v.how_it_applies_principle ? `<div class="hint" style="margin-top: 8px;"><strong>如何体现原则：</strong>${escapeHtml(v.how_it_applies_principle)}</div>` : ""}
                    <div class="row" style="margin-top: 10px;">
                        ${Array.isArray(v.pros) && v.pros.length ? `<span class="pill good">优点：${escapeHtml(v.pros.join("、"))}</span>` : ""}
                        ${Array.isArray(v.cons) && v.cons.length ? `<span class="pill warn">缺点：${escapeHtml(v.cons.join("、"))}</span>` : ""}
                    </div>
                    ${v.best_for ? `<div class="hint" style="margin-top: 8px;"><strong>适用：</strong>${escapeHtml(v.best_for)}</div>` : ""}
                    ${v.risk ? `<div class="hint" style="margin-top: 6px;"><strong>风险：</strong>${escapeHtml(v.risk)}</div>` : ""}
                </div>
            `).join("") : `<div class="hint">未输出变体列表（可能是模型输出缺失）。</div>`}
        </div>

        <div class="result-card">
            <h2>Step 4 · 实验（最小可行）</h2>
            <div class="variation-card">
                <div class="hint"><strong>实验设计：</strong>${escapeHtml(s4.experiment_design || s4.suggestion || "")}</div>
                ${metrics.length ? `<div class="hint" style="margin-top: 8px;"><strong>成功指标：</strong>${escapeHtml(metrics.join("、"))}</div>` : ""}
                ${s4.minimum_sample ? `<div class="hint" style="margin-top: 6px;"><strong>最小样本：</strong>${escapeHtml(s4.minimum_sample)}</div>` : ""}
                ${s4.iteration_guide ? `<div class="hint" style="margin-top: 6px;"><strong>迭代建议：</strong>${escapeHtml(s4.iteration_guide)}</div>` : ""}
            </div>
        </div>

        ${mistakes.length ? `
            <div class="result-card" style="border-left: 4px solid var(--warn);">
                <h2>常见踩坑</h2>
                <ul style="margin-left: 18px; color: var(--muted);">
                    ${mistakes.map(x => `<li>${escapeHtml(x)}</li>`).join("")}
                </ul>
            </div>
        ` : ""}

        ${data?.next_steps ? `
            <div class="result-card">
                <h2>下一步</h2>
                <div class="hint">${escapeHtml(data.next_steps)}</div>
            </div>
        ` : ""}
    `;

    // citations（可选）
    html += renderCitations(data.citations);

    container.innerHTML = html;

    LastResult.set("transfer", data);
    FLOW_updateAll();
}

function renderDiagnoseResults(data) {
    const container = document.getElementById("resultsSection");
    const coords = data?.coordinate_analysis || {};
    const diag = data?.diagnosis || {};
    const rec = data?.recommendations || {};

    const dimMeta = [
        { key: "temperature", label: "温度", low: "冷", mid: "中", high: "热" },
        { key: "density", label: "密度", low: "低", mid: "中", high: "高" },
        { key: "aggression", label: "攻击性", low: "低", mid: "中", high: "高" },
        { key: "structure", label: "结构感", low: "弱", mid: "中", high: "强" }
    ];

    const centerToPct = (centerValue) => {
        const c = String(centerValue || "中");
        if (c === "冷" || c === "低" || c === "弱") return 25;
        if (c === "热" || c === "高" || c === "强") return 85;
        return 55;
    };

    const dimCards = dimMeta.map(d => {
        const dim = coords?.[d.key] || {};
        const pct = centerToPct(dim.center_value);
        const distribution = dim.distribution || "未知";
        const spread = dim.spread || "未知";

        return `
            <div class="variation-card">
                <div class="variation-header">
                    <div class="variation-name">${escapeHtml(d.label)}</div>
                    <span class="pill">${escapeHtml(distribution)} · ${escapeHtml(spread)}</span>
                </div>
                <div class="hint" style="display:flex; justify-content: space-between;">
                    <span>${escapeHtml(d.low)}</span>
                    <span>${escapeHtml(d.mid)}</span>
                    <span>${escapeHtml(d.high)}</span>
                </div>
                <div style="margin-top: 8px; height: 8px; background: var(--border); border-radius: 6px; position: relative;">
                    <div style="position:absolute; left:${pct}%; top:-3px; width: 14px; height: 14px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent2)); transform: translateX(-50%);"></div>
                </div>
            </div>
        `;
    }).join("");

    const strengths = Array.isArray(diag.strengths) ? diag.strengths : [];
    const blindSpots = Array.isArray(diag.blind_spots) ? diag.blind_spots : [];

    let html = `
        <div class="result-card">
            <h2>审美诊断报告</h2>
            <p class="hint">基于你收藏的 ${(data?.masters_analyzed || []).length} 位大师进行分析</p>
        </div>

        <div class="result-card">
            <h2>四维分布</h2>
            <div class="grid grid-2" style="gap: 12px; margin-top: 12px;">
                ${dimCards}
            </div>
        </div>

        ${data?.pattern_summary ? `
            <div class="result-card">
                <h2>整体特征</h2>
                <div class="variation-card">
                    <div class="hint" style="font-size: 14px; line-height: 1.8;">${escapeHtml(data.pattern_summary)}</div>
                </div>
            </div>
        ` : ""}

        <div class="result-card">
            <h2>优势与盲区</h2>
            <div class="grid grid-2" style="gap: 12px; margin-top: 12px;">
                <div class="variation-card" style="border-color: color-mix(in srgb, var(--good) 35%, transparent); background: color-mix(in srgb, var(--good) 10%, transparent);">
                    <div style="font-weight: 800; color: var(--good); margin-bottom: 8px;">优势</div>
                    ${strengths.length ? `<ul style="margin-left: 18px; color: var(--muted);">${strengths.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>` : `<div class="hint">未提供</div>`}
                </div>
                <div class="variation-card" style="border-color: color-mix(in srgb, var(--warn) 35%, transparent); background: color-mix(in srgb, var(--warn) 10%, transparent);">
                    <div style="font-weight: 800; color: var(--warn); margin-bottom: 8px;">盲区</div>
                    ${blindSpots.length ? `<ul style="margin-left: 18px; color: var(--muted);">${blindSpots.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>` : `<div class="hint">未明显偏科（或未提供）</div>`}
                </div>
            </div>

            ${diag.imbalance_risk ? `<div class="hint" style="margin-top: 10px;"><strong>偏科风险：</strong>${escapeHtml(diag.imbalance_risk)}</div>` : ""}
            ${diag.style_prediction ? `<div class="hint" style="margin-top: 6px;"><strong>风格预测：</strong>${escapeHtml(diag.style_prediction)}</div>` : ""}
        </div>

        ${(Array.isArray(rec.expand_boundary) && rec.expand_boundary.length) ? `
            <div class="result-card">
                <h2>拓展边界（补盲区）</h2>
                ${rec.expand_boundary.map(r => `
                    <div class="variation-card">
                        <div class="variation-header">
                            <div class="variation-name">${escapeHtml(r.suggested_master || "")}</div>
                            <span class="pill accent">补盲区</span>
                        </div>
                        ${r.master_coordinates ? `<div class="hint"><strong>坐标：</strong>${escapeHtml(r.master_coordinates)}</div>` : ""}
                        ${r.why_recommend ? `<div class="hint" style="margin-top: 6px;"><strong>为什么：</strong>${escapeHtml(r.why_recommend)}</div>` : ""}
                        ${r.expected_gain ? `<div class="hint" style="margin-top: 6px;"><strong>收获：</strong>${escapeHtml(r.expected_gain)}</div>` : ""}
                        ${r.entry_work ? `<div class="hint" style="margin-top: 6px;"><strong>入门作品：</strong>${escapeHtml(r.entry_work)}</div>` : ""}
                        <div class="row" style="margin-top: 10px;">
                            <button class="btn secondary diagnoseToSourceBtn" data-master="${escapeHtml(r.suggested_master || "")}" type="button">去源头探测</button>
                            <button class="btn secondary diagnoseToNavigateBtn" data-master="${escapeHtml(r.suggested_master || "")}" type="button">做学习路径</button>
                        </div>
                    </div>
                `).join("")}
            </div>
        ` : ""}

        ${(Array.isArray(rec.deepen_strength) && rec.deepen_strength.length) ? `
            <div class="result-card">
                <h2>深化优势</h2>
                ${rec.deepen_strength.map(r => `
                    <div class="variation-card">
                        <div class="variation-header">
                            <div class="variation-name">${escapeHtml(r.suggested_master || "")}</div>
                            <span class="pill good">强化</span>
                        </div>
                        ${r.why_recommend ? `<div class="hint"><strong>为什么：</strong>${escapeHtml(r.why_recommend)}</div>` : ""}
                        ${r.what_to_focus ? `<div class="hint" style="margin-top: 6px;"><strong>关注点：</strong>${escapeHtml(r.what_to_focus)}</div>` : ""}
                    </div>
                `).join("")}
            </div>
        ` : ""}

        ${data?.evolution_insight ? `
            <div class="result-card">
                <h2>演化建议</h2>
                <div class="variation-card">
                    <div class="hint" style="font-size: 14px; line-height: 1.8;">${escapeHtml(data.evolution_insight)}</div>
                </div>
            </div>
        ` : ""}
    `;

    // citations（可选）
    html += renderCitations(data.citations);

    container.innerHTML = html;

    // keep compass snapshot behavior (as original)
    const snap = { masters_count: (data?.masters_analyzed || []).length, coordinate_analysis: coords, blindspots: [] };
    saveCompassSnapshot(snap, "diagnose");
    updateCompassVisual(snap);

    container.querySelectorAll(".diagnoseToSourceBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const m = btn.getAttribute("data-master") || "";
            goToMode("source", { inputValue: m, focusId: "mainInput", autoSubmit: false });
        });
    });

    container.querySelectorAll(".diagnoseToNavigateBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const m = btn.getAttribute("data-master") || "";
            goToMode("navigate", { inputValue: m, focusId: "mainInput", autoSubmit: false });
        });
    });

    LastResult.set("diagnose", data);
    FLOW_updateAll();
}
/* -----------------------------
 * 16) Key status + theme
 * ----------------------------- */
function applyTheme(mode) {
    if (mode === "light") document.documentElement.dataset.theme = "light";
    else if (mode === "dark") document.documentElement.dataset.theme = "dark";
    else delete document.documentElement.dataset.theme;
}

function loadTheme() {
    const mode = AppState.storage_ok ? (localStorage.getItem(STORAGE_KEYS.THEME) || "auto") : "auto";
    const sel = document.getElementById("themeSelect");
    if (sel) sel.value = mode;
    applyTheme(mode);
}

function updateKeyStatus() {
    const pill = document.getElementById("keyStatusPill");
    if (!pill) return;

    if (!AppState.storage_ok) {
        pill.className = "pill warn";
        pill.textContent = "本地存储不可用";
        return;
    }

    let hasAnyKey = false;
    for (const pid of Object.keys(AI_MODULE.AI_PROVIDERS)) {
        const status = AI_MODULE.getKeyStatus(pid);
        if (status.has_key) { hasAnyKey = true; break; }
    }

    // search key 不参与“已配置”判断（避免误导：AI key 与 search key 独立）
    if (hasAnyKey) { pill.className = "pill good"; pill.textContent = "已配置"; }
    else { pill.className = "pill bad"; pill.textContent = "未配置"; }
}

/* -----------------------------
 * 17) Init (UPDATED: mount SEARCH_MODULE, examples, checklist custom UI)
 * ----------------------------- */
function init() {
    AppState.storage_ok = storageAvailable();

    // mount modules
    if (!AppState.storage_ok) {
        showToast("检测到本地存储不可用：将以临时模式运行（无法保存/导出/AI/检索）", "warn");

        ["exportCompassBtn", "generateChecklistLocalBtn", "generateChecklistAiBtn", "saveMorningBtn"].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = true;
        });

        const mount = document.getElementById("aiSettingsMount");
        if (mount) mount.innerHTML = `<div class="hint">本地存储不可用：无法加载/保存 Key 与 AI 设置。</div>`;
        aiModule = {
            get_state: () => ({ networking_enabled: false }),
            call_ai: async () => { throw new Error("环境错误: 本地存储不可用"); },
            get_actionable_error: () => "环境错误：本地存储不可用（无法读取 API Key）。"
        };

        const searchMount = document.getElementById("searchSettingsMount");
        if (searchMount) searchMount.innerHTML = `<div class="hint">本地存储不可用：无法加载/保存检索设置与检索 Key。</div>`;
        searchModule = {
            call_search: async () => { throw new Error("环境错误: 本地存储不可用"); },
            get_actionable_error: () => "环境错误：本地存储不可用（无法读取检索 Key）。"
        };
    } else {
        aiModule = AI_MODULE.mount_ai_settings({ mount_el: document.getElementById("aiSettingsMount"), default_provider_id: "siliconflow" });
        searchModule = SEARCH_MODULE.mount_search_settings({ mount_el: document.getElementById("searchSettingsMount"), default_provider_id: "tavily" });
    }

    // load persisted assets
    AppState.load();
    LastResult.loadFromStorage();

    pruneChecklistStateDays();

    loadTheme();
    updateKeyStatus();

    // checklist custom UI (NEW)
    updateChecklistCustomUI();

    // render side lists
    renderMasterList();
    renderSkillList();
    refreshTransferAssistOptions();
    updateAssetsButtonLabel();

    // compass
    const snap = computeCompassFromMasters(AppState.masters);
    saveCompassSnapshot(snap, "init");
    updateCompassVisual(snap);

    // morning
    updateMorningJournalUI();
    trimMorningJournal();
    generateMorning({ force: false });

    // flow
    FLOW_setSessionBaseline();
    FLOW_initObservers();
    FLOW_updateAll();
    updateResultsActionBar();

    /* -----------------------------
     * UI bindings
     * ----------------------------- */

    // theme
    document.getElementById("themeSelect")?.addEventListener("change", (e) => {
        const mode = e.target.value;
        if (AppState.storage_ok) localStorage.setItem(STORAGE_KEYS.THEME, mode);
        applyTheme(mode);
    });

    // mode buttons
    document.querySelectorAll(".mode-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            AppState.currentMode = btn.dataset.mode;

            setModeUI(AppState.currentMode);
            refreshTransferAssistOptions();
            validateAndToggleSubmit();
            FLOW_updateAll();
        });
    });

    // input change
    document.getElementById("mainInput")?.addEventListener("input", () => {
        if (AppState.currentMode === "transfer") fillTransferAssistFromQuickInput();
        validateAndToggleSubmit();
        FLOW_updateAll();
    });

    document.getElementById("mainInput")?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleSubmit();
    });

    // transfer assists
    ["transferTechniqueSelect", "transferMasterSelect", "transferScenarioInput", "transferConstraintsInput"].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", () => { validateAndToggleSubmit(); FLOW_updateAll(); });
        el.addEventListener("change", () => { validateAndToggleSubmit(); FLOW_updateAll(); });
    });

    // checklist domain custom show/hide
    document.getElementById("checklistDomain")?.addEventListener("change", () => {
        updateChecklistCustomUI();
    });

    // submit
    document.getElementById("submitBtn")?.addEventListener("click", handleSubmit);

    // checklist buttons
    document.getElementById("generateChecklistLocalBtn")?.addEventListener("click", runChecklistLocal);
    document.getElementById("generateChecklistAiBtn")?.addEventListener("click", runChecklistAI);

    // morning buttons
    document.getElementById("refreshMorningBtn")?.addEventListener("click", () => generateMorningWithAI());
    document.getElementById("saveMorningBtn")?.addEventListener("click", saveMorningToJournal);
    document.getElementById("copyMorningBtn")?.addEventListener("click", copyMorningToday);

    // export compass
    document.getElementById("exportCompassBtn")?.addEventListener("click", () => {
        if (!AppState.storage_ok) { showToast("本地存储不可用，无法导出", "error"); return; }
        const snapRaw = localStorage.getItem(STORAGE_KEYS.COMPASS_SNAPSHOT);
        const historyRaw = localStorage.getItem(STORAGE_KEYS.COMPASS_HISTORY);
        const data = {
            masters: AppState.masters,
            skills: AppState.skills,
            compass_snapshot: snapRaw ? JSON.parse(snapRaw) : null,
            compass_history: historyRaw ? JSON.parse(historyRaw) : [],
            exported_at: nowISO()
        };
        const day = new Date().toISOString().slice(0, 10);
        downloadJsonFile(`origin-compass-${day}.json`, data);
        showToast("已导出审美坐标系", "success");
        auditLogAdd({ type: "export_json", entity: "compass", ok: true, key: "COMPASS_SNAPSHOT/COMPASS_HISTORY" });
        updateAssetsButtonLabel();
    });

    // assets drawer bindings
    document.getElementById("openAssetsBtn")?.addEventListener("click", () => toggleAssetsDrawer(true));
    document.getElementById("closeAssetsBtn")?.addEventListener("click", () => toggleAssetsDrawer(false));
    document.getElementById("assetsOverlay")?.addEventListener("click", () => toggleAssetsDrawer(false));
    document.getElementById("assetsSearchInput")?.addEventListener("input", (e) => setAssetsQuery(e.target.value));
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && AssetsUI.open) toggleAssetsDrawer(false);
    });

    document.getElementById("assetsImportFile")?.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const ok = confirm("确认导入该备份？\n\n导入会覆盖当前资产（大师/技法/日记/清单/坐标）。\n不会导入 API Key（包括 tavily_key）。");
        if (!ok) return;

        const reader = new FileReader();
        reader.onload = () => {
            try {
                const obj = JSON.parse(String(reader.result || ""));
                const imported = importAssetBundleFromObj(obj);
                if (imported) {
                    showToast("导入成功", "success");
                    AppState.load();
                    loadTheme();

                    renderMasterList();
                    renderSkillList();
                    refreshTransferAssistOptions();
                    updateMorningJournalUI();

                    const snap2 = computeCompassFromMasters(AppState.masters);
                    saveCompassSnapshot(snap2, "import_bundle");
                    updateCompassVisual(snap2);

                    LastResult.loadFromStorage();
                    updateAssetsButtonLabel();
                    renderAssetsDrawer();
                }
            } catch (err) {
                showToast("导入失败：JSON 无效", "error");
            }
        };
        reader.readAsText(file, "utf-8");
    });

    // initial UI hints
    setModeUI(AppState.currentMode);
    validateAndToggleSubmit();
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>