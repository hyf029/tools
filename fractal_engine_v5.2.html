<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å½¢è®¤çŸ¥å¼•æ“ v5.2 | ä¸­æ–‡å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f8fafc;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* å¡ç‰‡åŠ¨æ•ˆ */
        .fractal-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fractal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }

        /* åŠ è½½å…‰æ•ˆ */
        .shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Markdown æ ·å¼å¾®è°ƒ */
        .markdown-body p {
            margin-bottom: 0.5em;
            line-height: 1.7;
            color: #334155;
        }

        .markdown-body strong {
            color: #0f172a;
            font-weight: 700;
            background: rgba(226, 232, 240, 0.3);
            padding: 0 2px;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <header
        class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center flex-none z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div
                class="bg-indigo-600 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-indigo-200 shadow-lg">
                <i class="fa-solid fa-brain"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-slate-900 leading-tight">åˆ†å½¢è®¤çŸ¥å¼•æ“ <span
                        class="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded-full border border-indigo-100 align-middle ml-1">v5.2
                        CN</span></h1>
            </div>
        </div>
        <button onclick="toggleSettings()"
            class="group flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-indigo-600 transition-colors bg-slate-50 hover:bg-indigo-50 px-3 py-1.5 rounded-md border border-slate-200 hover:border-indigo-200">
            <i class="fa-solid fa-sliders group-hover:rotate-180 transition-transform duration-500"></i> é…ç½®æ¨¡å‹
        </button>
    </header>

    <details id="settingsPanel" class="bg-white border-b border-slate-200 flex-none relative z-10 shadow-sm" open>
        <summary class="list-none cursor-pointer"></summary>
        <div class="px-6 py-5 max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-4 items-end">

            <div class="md:col-span-3">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">API æœåŠ¡å•†</label>
                <select id="providerSelect" onchange="updateUI()"
                    class="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-shadow">
                </select>
            </div>

            <div class="md:col-span-4">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">é€‰æ‹©æ¨¡å‹</label>
                <div class="relative">
                    <select id="modelSelect" onchange="handleModelChange()"
                        class="w-full bg-slate-50 border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 appearance-none">
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-500"><i
                            class="fa-solid fa-chevron-down text-xs"></i></div>
                </div>
                <input type="text" id="manualModelInput" placeholder="è¾“å…¥æ¨¡å‹ ID (å¦‚ Qwen/Qwen2.5-Coder-32B...)"
                    class="mt-2 w-full hidden bg-white border border-indigo-300 rounded-lg py-2 px-3 text-sm text-indigo-700 placeholder-indigo-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono animate-fade-in-down">
            </div>

            <div class="md:col-span-5">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 flex justify-between">
                    <span>API Key</span>
                    <span id="keyStatus" class="font-normal normal-case text-[10px]"></span>
                </label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i
                            class="fa-solid fa-key text-xs"></i></span>
                    <input type="password" id="directApiKey" placeholder="sk-..."
                        class="w-full pl-9 bg-slate-50 border border-slate-300 rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono transition-shadow"
                        onchange="saveKeyManual()">
                </div>
            </div>

            <div id="customConfig" class="md:col-span-12 hidden mt-2">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1.5">Custom Base URL</label>
                <input type="text" id="customBaseUrl" placeholder="http://localhost:11434/v1"
                    class="w-full border border-slate-300 p-2 rounded text-sm font-mono">
            </div>
        </div>
    </details>

    <main class="flex-1 flex overflow-hidden">

        <div class="w-1/3 border-r border-slate-200 flex flex-col bg-white relative group z-0">
            <div class="flex-1 relative">
                <textarea id="rawInput"
                    class="w-full h-full p-6 resize-none focus:outline-none text-slate-700 leading-relaxed font-light placeholder:text-slate-300 text-base"
                    placeholder="åœ¨æ­¤ç²˜è´´é•¿æ–‡æœ¬... (Ctrl+V)&#10;&#10;å¼•æ“å°†è‡ªåŠ¨æ‰§è¡Œï¼š&#10;1. æ¯æ—¥åç›´è§‰æŒ–æ˜&#10;2. æ¯å‘¨ç»“æ„å·®å¼‚åˆ†æ&#10;3. å¹´åº¦äººæ€§å‘¨æœŸå»ºæ¨¡"></textarea>
                <div id="dropOverlay"
                    class="absolute inset-0 bg-indigo-50/90 flex flex-col items-center justify-center text-indigo-600 opacity-0 pointer-events-none transition-opacity duration-200 backdrop-blur-sm">
                    <i class="fa-solid fa-file-import text-4xl mb-4"></i>
                    <span class="font-bold">é‡Šæ”¾æ–‡ä»¶ä»¥å¯¼å…¥</span>
                </div>
            </div>

            <div
                class="p-4 border-t border-slate-100 bg-slate-50/50 flex justify-between items-center backdrop-blur-sm">
                <span id="charCount"
                    class="text-xs text-slate-400 font-mono bg-white px-2 py-1 rounded border border-slate-200">0
                    å­—</span>
                <button onclick="runAnalysis()" id="analyzeBtn"
                    class="bg-slate-900 hover:bg-indigo-600 text-white px-6 py-2.5 rounded-lg font-semibold text-sm shadow-lg shadow-slate-200 hover:shadow-indigo-200 transition-all flex items-center gap-2 transform active:scale-95">
                    <i class="fa-solid fa-bolt"></i> <span>å¼€å§‹åˆ†å½¢ (Fractalize)</span>
                </button>
            </div>
        </div>

        <div class="w-2/3 bg-slate-50/50 p-6 overflow-y-auto relative">
            <div class="max-w-4xl mx-auto grid grid-cols-1 gap-5 pb-20">

                <div class="fractal-card bg-white rounded-xl border border-slate-200/60 p-5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-emerald-400"></div>
                    <div class="flex items-center gap-2.5 mb-3 border-b border-slate-50 pb-2">
                        <span
                            class="bg-emerald-50 text-emerald-600 w-6 h-6 flex items-center justify-center rounded-md text-xs"><i
                                class="fa-solid fa-magnifying-glass"></i></span>
                        <h3 class="font-bold text-slate-800 text-sm">æ—¥çº¿ä¿¡å· (Daily Signal)</h3>
                        <span class="text-[10px] text-slate-400 ml-auto font-mono">åç›´è§‰ / ç»†èŠ‚</span>
                    </div>
                    <div id="dailyOutput" class="markdown-body text-sm">
                        <p class="italic text-slate-300">ç­‰å¾…è¾“å…¥...</p>
                    </div>
                </div>

                <div class="fractal-card bg-white rounded-xl border border-slate-200/60 p-5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-blue-500"></div>
                    <div class="flex items-center gap-2.5 mb-3 border-b border-slate-50 pb-2">
                        <span
                            class="bg-blue-50 text-blue-600 w-6 h-6 flex items-center justify-center rounded-md text-xs"><i
                                class="fa-solid fa-arrow-trend-up"></i></span>
                        <h3 class="font-bold text-slate-800 text-sm">å‘¨çº¿æ¨¡å¼ (Weekly Pattern)</h3>
                        <span class="text-[10px] text-slate-400 ml-auto font-mono">è¶‹åŠ¿ / ç»“æ„</span>
                    </div>
                    <div id="weeklyOutput" class="markdown-body text-sm">
                        <p class="italic text-slate-300">ç­‰å¾…è¾“å…¥...</p>
                    </div>
                </div>

                <div class="fractal-card bg-white rounded-xl border border-slate-200/60 p-5 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-purple-500"></div>
                    <div class="flex items-center gap-2.5 mb-3 border-b border-slate-50 pb-2">
                        <span
                            class="bg-purple-50 text-purple-600 w-6 h-6 flex items-center justify-center rounded-md text-xs"><i
                                class="fa-solid fa-cube"></i></span>
                        <h3 class="font-bold text-slate-800 text-sm">å¹´çº¿æ¨¡å‹ (Yearly Model)</h3>
                        <span class="text-[10px] text-slate-400 ml-auto font-mono">å‘¨æœŸ / äººæ€§</span>
                    </div>
                    <div id="yearlyOutput" class="markdown-body text-sm">
                        <p class="italic text-slate-300">ç­‰å¾…è¾“å…¥...</p>
                    </div>
                </div>

            </div>

            <div id="actionBar"
                class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex gap-3 opacity-50 pointer-events-none transition-opacity duration-300">
                <button onclick="copyToClipboard('md')"
                    class="bg-white border border-slate-200 hover:border-indigo-300 text-slate-600 hover:text-indigo-600 px-4 py-2 rounded-full shadow-lg text-xs font-bold flex items-center gap-2 transition-all hover:-translate-y-1">
                    <i class="fa-brands fa-markdown"></i> å¤åˆ¶ Markdown
                </button>
                <button onclick="copyToClipboard('json')"
                    class="bg-white border border-slate-200 hover:border-indigo-300 text-slate-600 hover:text-indigo-600 px-4 py-2 rounded-full shadow-lg text-xs font-bold flex items-center gap-2 transition-all hover:-translate-y-1">
                    <i class="fa-solid fa-code"></i> å¤åˆ¶ JSON
                </button>
            </div>

        </div>
    </main>

    <div id="toast"
        class="fixed bottom-10 right-10 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-xl text-xs font-bold opacity-0 transition-opacity pointer-events-none z-50">
    </div>

    <script>
        // --- 1. é…ç½®æ•°æ® (æ›´æ–°ï¼šæ”¯æŒ manual é€‰é¡¹) ---
        const AI_PROVIDERS = {
            "siliconflow": {
                name: "ç¡…åŸºæµåŠ¨ (SiliconFlow)",
                keyName: "siliconflow_key",
                baseUrl: "https://api.siliconflow.cn/v1",
                models: [
                    { id: "deepseek-ai/DeepSeek-V3", name: "DeepSeek V3 (æ¨è)" },
                    { id: "Qwen/Qwen2.5-72B-Instruct", name: "Qwen 2.5 72B (å‡è¡¡)" },
                    { id: "Qwen/Qwen2.5-Coder-32B-Instruct", name: "Qwen 2.5 Coder 32B (ä»£ç å¼º)" },
                    { id: "deepseek-ai/DeepSeek-R1-Distill-Llama-70B", name: "DeepSeek R1 (æ¨ç†)" }
                ]
            },
            "openrouter": {
                name: "OpenRouter",
                keyName: "openrouter_key",
                baseUrl: "https://openrouter.ai/api/v1",
                models: [
                    { id: "google/gemini-2.0-flash-exp:free", name: "Gemini 2.0 Flash (å…è´¹)" },
                    { id: "anthropic/claude-3.5-sonnet", name: "Claude 3.5 Sonnet" }
                ]
            },
            "deepseek": {
                name: "DeepSeek Official",
                keyName: "deepseek_key",
                baseUrl: "https://api.deepseek.com",
                models: [
                    { id: "deepseek-chat", name: "DeepSeek V3" },
                    { id: "deepseek-reasoner", name: "DeepSeek R1" }
                ]
            },
            "custom": {
                name: "Custom / Local",
                keyName: "custom_key",
                baseUrl: "http://localhost:11434/v1",
                models: []
            }
        };

        const STATE = { provider: 'siliconflow', lastResult: null };

        // --- 2. æ ¸å¿ƒï¼šä¸­æ–‡ System Prompt ---
        const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½åŸºäºâ€œIndigo Talkâ€æ–¹æ³•è®ºçš„â€œåˆ†å½¢è®¤çŸ¥æ¶æ„å¸ˆâ€ã€‚
ä½ çš„ä»»åŠ¡ä¸æ˜¯åšæ‘˜è¦ï¼Œè€Œæ˜¯å¯¹è¾“å…¥å†…å®¹è¿›è¡Œâ€œåˆ†å½¢å‹ç¼©â€ã€‚
è¯·é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªæ—¶é—´å°ºåº¦é€é•œè¿›è¡Œæ·±åº¦åˆ†æã€‚

1. **æ—¥çº¿ä¿¡å· (Daily Signal)**: 
   - å¯»æ‰¾â€œåç›´è§‰æ•°æ®â€æˆ–å…·ä½“çš„â€œShadow AIâ€è¡Œä¸ºï¼ˆå¦‚å‘˜å·¥è‡ªè´¹ä¹°å·¥å…·ï¼‰ã€‚
   - å…³æ³¨â€œå•æ¬¡å½•åˆ¶ (One-take)â€å¼çš„å…·ä½“æ‰§è¡Œç»†èŠ‚ï¼Œå¿½ç•¥å…¬å…³å¥—è¯ã€‚
   - å­—æ•°é™åˆ¶ï¼š50å­—ä»¥å†…ã€‚

2. **å‘¨çº¿æ¨¡å¼ (Weekly Pattern)**:
   - è¯†åˆ«â€œåœ°ç¼˜åˆ†æµâ€ï¼ˆç¾å›½æ¨¡å‹åŸºå»º vs ä¸­å›½åº”ç”¨è½åœ°ï¼‰ã€‚
   - è¯†åˆ«ç»„ç»‡å¼‚åŒ–ï¼ˆContextå®šä¹‰è€… vs ç»“æœéªŒæ”¶è€…ï¼‰ã€‚
   - å­—æ•°é™åˆ¶ï¼š100å­—ä»¥å†…ã€‚

3. **å¹´çº¿æ¨¡å‹ (Yearly Model)**:
   - æå–â€œäººæ€§é‡æ„â€ï¼ˆAI æä¾›çš„é‡æ–°å…»è‚²/æƒ…ç»ªä»·å€¼ï¼‰ã€‚
   - æå–åˆ†å½¢è§„å¾‹ï¼ˆScaling Laws åœ¨å¾®è§‚å®è§‚çš„åŒæ„ï¼‰ã€‚
   - å­—æ•°é™åˆ¶ï¼š50å­—ä»¥å†…ã€‚

**é‡è¦çº¦æŸ**ï¼š
1. **å¿…é¡»ä½¿ç”¨ä¸­æ–‡å›å¤**ã€‚
2. è¾“å‡ºæ ¼å¼å¿…é¡»ä¸ºçº¯å‡€çš„ JSON å¯¹è±¡ï¼š{ "daily": "...", "weekly": "...", "yearly": "..." }ã€‚
3. ä¸è¦åŒ…å« Markdown ä»£ç å—æ ‡è®°ã€‚`;

        // --- 3. åˆå§‹åŒ–é€»è¾‘ ---
        document.addEventListener('DOMContentLoaded', () => {
            initUI();

            // ç²˜è´´ç›‘å¬
            window.addEventListener('paste', (e) => {
                if (e.target.tagName === 'INPUT') return;
                const text = (e.clipboardData || window.clipboardData).getData('text');
                if (text) {
                    const el = document.getElementById('rawInput');
                    el.value = text;
                    updateCharCount();
                    el.parentElement.classList.add('ring-2', 'ring-indigo-100');
                    setTimeout(() => el.parentElement.classList.remove('ring-2', 'ring-indigo-100'), 300);
                }
            });

            // æ‹–æ‹½ç›‘å¬
            const dropOverlay = document.getElementById('dropOverlay');
            ['dragenter', 'dragover'].forEach(evt => {
                document.body.addEventListener(evt, (e) => {
                    e.preventDefault(); dropOverlay.style.opacity = '1';
                });
            });
            ['dragleave', 'drop'].forEach(evt => {
                document.body.addEventListener(evt, (e) => {
                    e.preventDefault(); dropOverlay.style.opacity = '0';
                    if (evt === 'drop' && e.dataTransfer.files.length > 0) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            document.getElementById('rawInput').value = ev.target.result;
                            updateCharCount();
                        };
                        reader.readAsText(e.dataTransfer.files[0]);
                    }
                });
            });

            document.getElementById('rawInput').addEventListener('input', updateCharCount);
        });

        // --- 4. UI é€»è¾‘ ---
        function initUI() {
            const pSelect = document.getElementById('providerSelect');
            Object.keys(AI_PROVIDERS).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.textContent = AI_PROVIDERS[k].name;
                pSelect.appendChild(opt);
            });

            // æ¢å¤ä¸Šæ¬¡é€‰æ‹©
            const saved = localStorage.getItem('fractal_last_provider');
            if (saved && AI_PROVIDERS[saved]) pSelect.value = saved;

            updateUI();
        }

        function updateUI() {
            const pKey = document.getElementById('providerSelect').value;
            STATE.provider = pKey;
            localStorage.setItem('fractal_last_provider', pKey);

            const config = AI_PROVIDERS[pKey];
            const mSelect = document.getElementById('modelSelect');
            mSelect.innerHTML = '';

            // å¡«å……æ¨¡å‹åˆ—è¡¨
            config.models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id; opt.textContent = m.name;
                mSelect.appendChild(opt);
            });

            // æ·»åŠ â€œæ‰‹åŠ¨è¾“å…¥â€é€‰é¡¹ (æ ¸å¿ƒä¿®å¤ç‚¹)
            if (pKey !== 'custom') {
                const manualOpt = document.createElement('option');
                manualOpt.value = 'manual_entry';
                manualOpt.textContent = 'ğŸ“ æ‰‹åŠ¨è¾“å…¥æ¨¡å‹ ID...';
                mSelect.appendChild(manualOpt);
            }

            // API Key çŠ¶æ€æ£€æŸ¥
            const savedKey = localStorage.getItem(config.keyName) || '';
            document.getElementById('directApiKey').value = savedKey;
            document.getElementById('keyStatus').innerHTML = savedKey
                ? '<span class="text-emerald-600 font-bold"><i class="fa-solid fa-check"></i> å·²å°±ç»ª</span>'
                : '<span class="text-amber-500">éœ€è¾“å…¥</span>';

            // è‡ªå®šä¹‰ URL æ˜¾ç¤ºé€»è¾‘
            document.getElementById('customConfig').style.display = (pKey === 'custom') ? 'block' : 'none';

            handleModelChange(); // è§¦å‘æ‰‹åŠ¨è¾“å…¥æ¡†çš„æ˜¾ç¤ºé€»è¾‘æ£€æŸ¥
        }

        function handleModelChange() {
            const select = document.getElementById('modelSelect');
            const manualInput = document.getElementById('manualModelInput');

            if (select.value === 'manual_entry' || STATE.provider === 'custom') {
                manualInput.classList.remove('hidden');
                if (select.value === 'manual_entry') manualInput.focus();
            } else {
                manualInput.classList.add('hidden');
            }
        }

        function saveKeyManual() {
            const pKey = STATE.provider;
            const val = document.getElementById('directApiKey').value.trim();
            if (val) {
                localStorage.setItem(AI_PROVIDERS[pKey].keyName, val);
                updateUI();
            }
        }

        function updateCharCount() {
            document.getElementById('charCount').innerText = document.getElementById('rawInput').value.length + " å­—";
        }

        function toggleSettings() {
            const p = document.getElementById('settingsPanel');
            p.open = !p.open;
        }

        // --- 5. æ‰§è¡Œåˆ†æ ---
        async function runAnalysis() {
            const input = document.getElementById('rawInput').value;
            if (!input) return showToast("è¯·å…ˆè¾“å…¥å†…å®¹", "error");

            const btn = document.getElementById('analyzeBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> æ·±åº¦æ€è€ƒä¸­...';
            btn.disabled = true;

            // éšè— Action Bar
            document.getElementById('actionBar').style.opacity = '0';
            document.getElementById('actionBar').style.pointerEvents = 'none';

            try {
                const pKey = STATE.provider;
                const config = AI_PROVIDERS[pKey];
                const apiKey = document.getElementById('directApiKey').value || localStorage.getItem(config.keyName);

                if (!apiKey && pKey !== 'custom') throw new Error("è¯·å…ˆè¾“å…¥ API Key");

                let url = config.baseUrl + "/chat/completions";
                if (pKey === 'custom') url = document.getElementById('customBaseUrl').value + "/chat/completions";

                // ç¡®å®šæœ€ç»ˆæ¨¡å‹ ID
                let modelId = document.getElementById('modelSelect').value;
                if (modelId === 'manual_entry' || pKey === 'custom') {
                    modelId = document.getElementById('manualModelInput').value;
                    if (!modelId) throw new Error("è¯·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹ ID");
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Fractal Engine CN'
                    },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: input }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000,
                        response_format: { type: "json_object" }
                    })
                });

                if (!res.ok) throw new Error((await res.json()).error?.message || res.statusText);

                const data = await res.json();
                let content = data.choices[0].message.content;
                // æ¸…æ´—å¯èƒ½å­˜åœ¨çš„ Markdown æ ‡è®°
                content = content.replace(/```json/g, '').replace(/```/g, '').trim();

                const json = JSON.parse(content);
                STATE.lastResult = json;

                // æ¸²æŸ“ç»“æœ
                document.getElementById('dailyOutput').innerHTML = marked.parse(json.daily || "æ— ä¿¡å·");
                document.getElementById('weeklyOutput').innerHTML = marked.parse(json.weekly || "æ— æ¨¡å¼");
                document.getElementById('yearlyOutput').innerHTML = marked.parse(json.yearly || "æ— æ¨¡å‹");

                // æˆåŠŸåè‡ªåŠ¨æŠ˜å è®¾ç½®é¢æ¿ï¼Œå±•ç¤º Action Bar
                document.getElementById('settingsPanel').open = false;
                document.getElementById('actionBar').style.opacity = '1';
                document.getElementById('actionBar').style.pointerEvents = 'auto';

            } catch (e) {
                alert("é”™è¯¯: " + e.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        // --- 6. å¤åˆ¶åŠŸèƒ½ (ä¿®å¤ç‚¹) ---
        function copyToClipboard(type) {
            if (!STATE.lastResult) return;
            let text = "";

            if (type === 'json') {
                text = JSON.stringify(STATE.lastResult, null, 2);
            } else {
                const date = new Date().toLocaleDateString();
                text = `# åˆ†å½¢è®¤çŸ¥æŠ¥å‘Š [${date}]\n\n## æ—¥çº¿ä¿¡å·\n${STATE.lastResult.daily}\n\n## å‘¨çº¿æ¨¡å¼\n${STATE.lastResult.weekly}\n\n## å¹´çº¿æ¨¡å‹\n${STATE.lastResult.yearly}\n`;
            }

            navigator.clipboard.writeText(text).then(() => {
                showToast(type === 'json' ? "JSON å·²å¤åˆ¶" : "Markdown å·²å¤åˆ¶");
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2000);
        }
    </script>

    <!-- P4: tool_meta (for tools-index.html) -->
    <script type="application/json" id="tool_meta">
{
  "tool_id": "fractal-engine",
  "tool_name": "åˆ†å½¢è®¤çŸ¥å¼•æ“",
  "tool_version": "5.2.0",
  "description": "åŸºäºåˆ†å½¢å­¦ä¹ æ³•å°†å¤æ‚æ¦‚å¿µé€’å½’æ‹†è§£ä¸ºè‡ªç›¸ä¼¼ç»“æ„çš„æ·±åº¦å­¦ä¹ å·¥å…·",
  "capabilities": {
    "paste_first": true,
    "file_input": true,
    "download_output": false,
    "url_state": false,
    "local_draft": false,
    "networking": true,
    "ai": true
  },
  "tags": ["learning", "cognition", "structure", "ai"]
}
    </script>
</body>

</html>