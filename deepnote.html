<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepNote - ç”¨ AI é‡Šæ”¾æµæ°´è´¦ç¬”è®°çš„å…¨éƒ¨æ½œåŠ›</title>
    <meta name="description" content="åŸºäº Karpathy å’Œé©¬ä¼¯åº¸çš„ Append-and-Review ç¬”è®°æ³•ï¼Œç”¨ AI æ·±åº¦æŒ–æ˜ç¬”è®°ä»·å€¼">

    <!-- tool_meta -->
    <script type="application/json" id="tool_meta">
    {
        "name": "DeepNote",
        "version": "3.0.0",
        "description": "ç”¨ AI é‡Šæ”¾æµæ°´è´¦ç¬”è®°çš„å…¨éƒ¨æ½œåŠ›",
        "author": "AI Tool Factory",
        "created": "2026-01-11",
        "category": "çŸ¥è¯†ç®¡ç†",
        "tags": ["ç¬”è®°", "AI", "çŸ¥è¯†ç®¡ç†", "Append-and-Review"]
    }
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Textarea styling */
        textarea {
            resize: vertical;
            min-height: 150px;
        }

        /* Mode card styling */
        .mode-card {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .mode-card.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .mode-card.active .mode-icon {
            background-color: #3b82f6;
            color: white;
        }

        /* Path styling */
        .path-container {
            position: relative;
        }
        .path-arrow {
            color: #9ca3af;
            font-size: 1.25rem;
        }

        /* Result card styling */
        .result-card {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Markdown content styling */
        .markdown-content h1 { font-size: 1.5rem; font-weight: 700; margin: 1.5rem 0 1rem; color: #1e293b; }
        .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin: 1.25rem 0 0.75rem; color: #334155; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin: 1rem 0 0.5rem; color: #475569; }
        .markdown-content p { margin: 0.75rem 0; line-height: 1.7; }
        .markdown-content ul, .markdown-content ol { margin: 0.75rem 0; padding-left: 1.5rem; }
        .markdown-content li { margin: 0.25rem 0; line-height: 1.6; }
        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            padding: 0.75rem 1rem;
            margin: 1rem 0;
            background: #f8fafc;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .markdown-content code {
            background: #f1f5f9;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .markdown-content pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .markdown-content th, .markdown-content td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem 0.75rem;
            text-align: left;
        }
        .markdown-content th {
            background: #f8fafc;
            font-weight: 600;
        }
        .markdown-content hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 1.5rem 0;
        }
        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .markdown-content a:hover {
            color: #2563eb;
        }

        /* Loading animation */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Progress steps */
        .progress-step {
            transition: all 0.3s ease;
        }
        .progress-step.completed {
            color: #22c55e;
        }
        .progress-step.active {
            color: #3b82f6;
        }
        .progress-step.pending {
            color: #9ca3af;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .mode-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .path-arrow {
                display: none;
            }
        }
        @media (max-width: 480px) {
            .mode-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Settings panel animation */
        .settings-panel {
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        .settings-panel.open {
            max-height: 500px;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 0.75rem;
            background: #1e293b;
            color: white;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 50;
        }
        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Word count indicator */
        .word-count {
            transition: color 0.2s ease;
        }
        .word-count.warning { color: #f59e0b; }
        .word-count.error { color: #ef4444; }
        .word-count.success { color: #22c55e; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">
                        ğŸ“ DeepNote
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">ç”¨ AI é‡Šæ”¾æµæ°´è´¦ç¬”è®°çš„å…¨éƒ¨æ½œåŠ›</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="https://karpathy.ai/blog/append-only.html" target="_blank"
                       class="text-gray-400 hover:text-blue-500 transition-colors tooltip"
                       data-tooltip="äº†è§£ A&R ç¬”è®°æ³•">
                        <i class="fas fa-question-circle text-lg"></i>
                    </a>
                    <button onclick="toggleSettings()"
                            class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-lg hover:bg-gray-100"
                            id="settingsBtn">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Panel (collapsible) -->
            <div id="settingsPanel" class="settings-panel mt-4 pt-4 border-t border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Provider Select -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">AI æœåŠ¡å•†</label>
                        <select id="providerSelect" onchange="updateModelSelector()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                            <option value="siliconflow">ç¡…åŸºæµåŠ¨ (SiliconFlow)</option>
                            <option value="openrouter">å¼€æ”¾è·¯ç”± (OpenRouter)</option>
                            <option value="claude">Claude (Anthropic)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="custom">è‡ªå®šä¹‰æœåŠ¡å•†</option>
                        </select>
                    </div>

                    <!-- Model Select -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹</label>
                        <select id="modelSelect" onchange="handleModelChange()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </select>
                        <input type="text" id="customModelInput" placeholder="è¾“å…¥æ¨¡å‹åç§°"
                               oninput="handleCustomModelInput()"
                               class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm mt-2">
                    </div>

                    <!-- Key Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Key çŠ¶æ€</label>
                        <div id="keyStatus" class="px-3 py-2 bg-gray-50 rounded-lg text-sm">
                            <span class="text-gray-400">æ£€æŸ¥ä¸­...</span>
                        </div>
                    </div>
                </div>

                <!-- Custom Endpoint (hidden by default) -->
                <div id="customEndpointContainer" class="hidden mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå®šä¹‰ API ç«¯ç‚¹</label>
                    <input type="text" id="customEndpoint" placeholder="https://api.example.com/v1/chat/completions"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                </div>

                <!-- Privacy Notice -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-700">
                    <i class="fas fa-shield-alt mr-1"></i>
                    <strong>éšç§è¯´æ˜ï¼š</strong>ä½ çš„ç¬”è®°ç›´æ¥å‘é€åˆ°ä½ é…ç½®çš„ AI æœåŠ¡ï¼Œæœ¬å·¥å…·ä¸å­˜å‚¨ä»»ä½•æ•°æ®ã€‚å†å²è®°å½•ä»…ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ã€‚
                </div>
            </div>
        </header>
        <!-- Input Area -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-edit text-blue-500 mr-2"></i>è¾“å…¥ä½ çš„ç¬”è®°
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="loadSampleData()"
                            class="text-sm text-blue-600 hover:text-blue-700 hover:underline">
                        <i class="fas fa-lightbulb mr-1"></i>æŸ¥çœ‹ç¤ºä¾‹
                    </button>
                    <a href="https://karpathy.ai/blog/append-only.html" target="_blank"
                       class="text-sm text-gray-500 hover:text-gray-700 hover:underline">
                        <i class="fas fa-book mr-1"></i>äº†è§£ A&R ç¬”è®°æ³•
                    </a>
                </div>
            </div>

            <textarea id="notesInput"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm leading-relaxed"
                      rows="8"
                      placeholder="ç²˜è´´ä½ çš„ Append-and-Review é£æ ¼ç¬”è®°...

ç¤ºä¾‹æ ¼å¼ï¼š
watch: ã€Šå¥¥æœ¬æµ·é»˜ã€‹æœ‹å‹æ¨è
read: ã€ŠåŸå­ä¹ æƒ¯ã€‹çœ‹äº†å‰ä¸‰ç« 
ä»Šå¤©å’Œè€ç‹èŠäº† AI å·¥å…·çš„æƒ³æ³•
TODO: æ•´ç†ä¸Šå‘¨çš„ä¼šè®®çºªè¦
å’–å•¡åº—çš„é‚£ä¸ªåˆ›ä¸šç‚¹å­ï¼Œå›å¤´å†æƒ³æƒ³
listen: æ’­å®¢ã€Œå¾—æ„å¿˜å½¢ã€æœ€æ–°ä¸€æœŸ"></textarea>

            <!-- Word Count & Status -->
            <div class="flex items-center justify-between mt-2 text-sm">
                <div id="wordCount" class="word-count text-gray-400">
                    <i class="fas fa-file-alt mr-1"></i>
                    <span id="charCount">0</span> å­— Â· çº¦ <span id="noteCount">0</span> æ¡ç¬”è®°
                </div>
                <div id="inputStatus" class="text-gray-400">
                    <span id="statusText">ç­‰å¾…è¾“å…¥...</span>
                </div>
            </div>

            <!-- History (if available) -->
            <div id="historyArea" class="hidden mt-3 pt-3 border-t border-gray-100">
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-gray-500"><i class="fas fa-history mr-1"></i>å†å²è®°å½•ï¼š</span>
                    <div id="historyList" class="flex flex-wrap gap-2">
                        <!-- History items will be inserted here -->
                    </div>
                    <button onclick="clearHistory()" class="text-red-500 hover:text-red-600 ml-auto">
                        <i class="fas fa-trash-alt mr-1"></i>æ¸…é™¤
                    </button>
                </div>
            </div>
        </section>
        <!-- Smart Search Bar -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center gap-3">
                <div class="flex-1 relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput"
                           class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                           placeholder="æœ‰é—®é¢˜ï¼Ÿç›´æ¥é—®ä½ çš„ç¬”è®°... ä¾‹å¦‚ï¼šæˆ‘ä¹‹å‰è®°å½•è¿‡ä»€ä¹ˆç”µå½±ï¼Ÿ">
                </div>
                <button onclick="executeSearch()"
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm whitespace-nowrap">
                    <i class="fas fa-search mr-2"></i>æœç´¢
                </button>
            </div>
        </section>
        <!-- Mode Selector - Deep Analysis -->
        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>æ·±åº¦åˆ†æ
            </h2>

            <!-- Path A: Discovery -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-600 mb-3">
                    <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs mr-2">è·¯å¾„ A</span>
                    å‘ç°æ´å¯Ÿï¼ˆç†è§£è‡ªå·±ï¼‰
                </h3>
                <div class="flex items-center gap-2 flex-wrap">
                    <div class="mode-card flex-1 min-w-[140px] p-3 bg-gray-50 rounded-lg" data-mode="cluster" onclick="selectMode('cluster')">
                        <div class="flex items-center gap-2">
                            <span class="mode-icon w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg text-gray-600">ğŸ—‚ï¸</span>
                            <div>
                                <div class="font-medium text-sm text-gray-800">ä¸»é¢˜èšç±»</div>
                                <div class="text-xs text-gray-500">æˆ‘éƒ½è®°äº†ä»€ä¹ˆï¼Ÿ</div>
                            </div>
                        </div>
                    </div>
                    <span class="path-arrow hidden md:block">â†’</span>
                    <div class="mode-card flex-1 min-w-[140px] p-3 bg-gray-50 rounded-lg" data-mode="insight" onclick="selectMode('insight')">
                        <div class="flex items-center gap-2">
                            <span class="mode-icon w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg text-gray-600">ğŸ’¡</span>
                            <div>
                                <div class="font-medium text-sm text-gray-800">æ´å¯Ÿç”Ÿæˆ</div>
                                <div class="text-xs text-gray-500">è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</div>
                            </div>
                        </div>
                    </div>
                    <span class="path-arrow hidden md:block">â†’</span>
                    <div class="mode-card flex-1 min-w-[140px] p-3 bg-gray-50 rounded-lg" data-mode="action" onclick="selectMode('action')">
                        <div class="flex items-center gap-2">
                            <span class="mode-icon w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg text-gray-600">âœ…</span>
                            <div>
                                <div class="font-medium text-sm text-gray-800">è¡ŒåŠ¨æå–</div>
                                <div class="text-xs text-gray-500">æˆ‘è¯¥åšä»€ä¹ˆï¼Ÿ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Path B: Output -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-600 mb-3">
                    <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs mr-2">è·¯å¾„ B</span>
                    æ•´ç†è¾“å‡ºï¼ˆç”Ÿæˆå†…å®¹ï¼‰
                </h3>
                <div class="flex items-center gap-2 flex-wrap">
                    <div class="mode-card flex-1 min-w-[140px] p-3 bg-gray-50 rounded-lg" data-mode="timeline" onclick="selectMode('timeline')">
                        <div class="flex items-center gap-2">
                            <span class="mode-icon w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg text-gray-600">ğŸ“…</span>
                            <div>
                                <div class="font-medium text-sm text-gray-800">æ—¶é—´çº¿æ¢³ç†</div>
                                <div class="text-xs text-gray-500">äº‹æƒ…æ€ä¹ˆå‘å±•ï¼Ÿ</div>
                            </div>
                        </div>
                    </div>
                    <span class="path-arrow hidden md:block">â†’</span>
                    <div class="mode-card flex-1 min-w-[140px] p-3 bg-gray-50 rounded-lg" data-mode="summary" onclick="selectMode('summary')">
                        <div class="flex items-center gap-2">
                            <span class="mode-icon w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg text-gray-600">ğŸ“Š</span>
                            <div>
                                <div class="font-medium text-sm text-gray-800">å‘¨æœŸæ€»ç»“</div>
                                <div class="text-xs text-gray-500">ç”Ÿæˆå‘¨æŠ¥/æœˆæŠ¥</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- One-Click Deep Dive -->
            <div class="pt-4 border-t border-gray-100">
                <button onclick="executeDeepDive()"
                        class="w-full py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all font-semibold text-lg shadow-lg hover:shadow-xl">
                    <i class="fas fa-rocket mr-2"></i>ä¸€é”®æ·±æŒ–ï¼ˆæ¨èï¼‰
                </button>
                <p class="text-center text-xs text-gray-500 mt-2">è‡ªåŠ¨æ‰§è¡Œï¼šä¸»é¢˜èšç±» â†’ æ´å¯Ÿç”Ÿæˆ â†’ è¡ŒåŠ¨å»ºè®®</p>
            </div>

            <!-- Extra Input Area (for timeline focus) -->
            <div id="extraInputArea" class="hidden mt-4 pt-4 border-t border-gray-100">
                <label id="extraInputLabel" class="block text-sm font-medium text-gray-700 mb-2">èšç„¦ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                <input type="text" id="extraInput"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                       placeholder="ä¾‹å¦‚ï¼šé¡¹ç›® Aã€AI å·¥å…·...">
            </div>

            <!-- Period Selector (for summary mode) -->
            <div id="periodSelector" class="hidden mt-4 pt-4 border-t border-gray-100">
                <label class="block text-sm font-medium text-gray-700 mb-2">æ€»ç»“å‘¨æœŸ</label>
                <div class="flex gap-2">
                    <button onclick="setPeriod('å‘¨')" class="period-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50" data-period="å‘¨">æœ¬å‘¨</button>
                    <button onclick="setPeriod('æœˆ')" class="period-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50" data-period="æœˆ">æœ¬æœˆ</button>
                    <button onclick="setPeriod('å­£åº¦')" class="period-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50" data-period="å­£åº¦">æœ¬å­£åº¦</button>
                    <button onclick="setPeriod('å¹´')" class="period-btn px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50" data-period="å¹´">æœ¬å¹´</button>
                </div>
            </div>

            <!-- Execute Button -->
            <div id="executeBtnArea" class="hidden mt-4">
                <button id="executeBtn" onclick="executeMode()"
                        class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium">
                    <span id="executeBtnText">æ‰§è¡Œåˆ†æ</span>
                </button>
            </div>
        </section>
        <!-- AI Config is integrated into header settings panel -->
        <!-- This file is kept for structure consistency but content is in part03_header.html -->
        <!-- Result Area -->
        <section id="resultSection" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6 result-card">
            <!-- Result Header -->
            <div class="flex items-center justify-between mb-4">
                <h2 id="resultTitle" class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-file-alt text-blue-500 mr-2"></i>åˆ†æç»“æœ
                </h2>
                <div class="flex items-center gap-2">
                    <button onclick="copyResult()" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-copy mr-1"></i>å¤åˆ¶
                    </button>
                    <button onclick="downloadResult()" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-download mr-1"></i>å¯¼å‡º
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden py-12 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                </div>
                <p class="text-gray-600 font-medium">æ­£åœ¨åˆ†æ<span class="loading-dots"></span></p>
                <p class="text-sm text-gray-400 mt-2">AI æ­£åœ¨æ·±åº¦æŒ–æ˜ä½ çš„ç¬”è®°ä»·å€¼</p>

                <!-- Progress Steps (for deep dive) -->
                <div id="progressSteps" class="hidden mt-6 max-w-md mx-auto">
                    <div class="flex items-center justify-between text-sm">
                        <div id="step1" class="progress-step pending flex items-center gap-2">
                            <i class="fas fa-circle text-xs"></i>
                            <span>ä¸»é¢˜èšç±»</span>
                        </div>
                        <div class="flex-1 h-px bg-gray-200 mx-2"></div>
                        <div id="step2" class="progress-step pending flex items-center gap-2">
                            <i class="fas fa-circle text-xs"></i>
                            <span>æ´å¯Ÿç”Ÿæˆ</span>
                        </div>
                        <div class="flex-1 h-px bg-gray-200 mx-2"></div>
                        <div id="step3" class="progress-step pending flex items-center gap-2">
                            <i class="fas fa-circle text-xs"></i>
                            <span>è¡ŒåŠ¨å»ºè®®</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden py-8 text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                </div>
                <p class="text-red-600 font-medium">åˆ†æå¤±è´¥</p>
                <p id="errorMessage" class="text-sm text-gray-500 mt-2">è¯·æ£€æŸ¥ API é…ç½®åé‡è¯•</p>
                <button onclick="retryAnalysis()" class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                    <i class="fas fa-redo mr-1"></i>é‡è¯•
                </button>
            </div>

            <!-- Result Content -->
            <div id="resultContent" class="hidden markdown-content prose prose-sm max-w-none">
                <!-- Markdown content will be rendered here -->
            </div>

            <!-- Continue Deep Dive -->
            <div id="continueArea" class="hidden mt-6 pt-4 border-t border-gray-100">
                <p class="text-sm text-gray-500 mb-3">ç»§ç»­æ·±æŒ–ï¼š</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="continueWithMode('insight')" class="continue-btn px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>ç”Ÿæˆæ´å¯Ÿ
                    </button>
                    <button onclick="continueWithMode('action')" class="continue-btn px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-check-circle mr-1 text-green-500"></i>æå–è¡ŒåŠ¨
                    </button>
                    <button onclick="continueWithMode('summary')" class="continue-btn px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-file-alt mr-1 text-blue-500"></i>ç”Ÿæˆæ€»ç»“
                    </button>
                </div>
            </div>
        </section>
    <script>
    // ==================== AI Providers Configuration ====================
    const AI_PROVIDERS = {
        siliconflow: {
            name: 'ç¡…åŸºæµåŠ¨ (SiliconFlow)',
            keyName: 'siliconflow_key',
            endpoint: 'https://api.siliconflow.cn/v1/chat/completions',
            models: [
                'Pro/zai-org/GLM-4.7',
                'Pro/moonshotai/Kimi-K2-Thinking',
                'Pro/deepseek/DeepSeek-V3',
                'Qwen/Qwen2.5-72B-Instruct',
                'deepseek-ai/DeepSeek-V3',
                'Qwen/Qwen2.5-32B-Instruct'
            ],
            defaultModel: 'Pro/zai-org/GLM-4.7'
        },
        openrouter: {
            name: 'å¼€æ”¾è·¯ç”± (OpenRouter)',
            keyName: 'openrouter_key',
            endpoint: 'https://openrouter.ai/api/v1/chat/completions',
            models: [
                'anthropic/claude-opus-4.5',
                'anthropic/claude-sonnet-4',
                'anthropic/claude-opus-4',
                'openai/gpt-4o',
                'google/gemini-2.0-flash-exp',
                'deepseek/deepseek-chat'
            ],
            defaultModel: 'anthropic/claude-opus-4.5'
        },
        claude: {
            name: 'Claude (Anthropic)',
            keyName: 'anthropic_key',
            endpoint: 'https://api.anthropic.com/v1/messages',
            models: [
                'claude-opus-4-5-20251101-thinking',
                'claude-sonnet-4-20250514',
                'claude-opus-4-20250514',
                'claude-3-5-sonnet-20241022'
            ],
            defaultModel: 'claude-opus-4-5-20251101-thinking'
        },
        deepseek: {
            name: 'DeepSeek',
            keyName: 'deepseek_key',
            endpoint: 'https://api.deepseek.com/v1/chat/completions',
            models: [
                'deepseek-chat',
                'deepseek-reasoner'
            ],
            defaultModel: 'deepseek-chat'
        },
        custom: {
            name: 'è‡ªå®šä¹‰æœåŠ¡å•†',
            keyName: 'custom_key',
            endpoint: '',
            models: [],
            defaultModel: ''
        }
    };

    // Allowed domains for API calls
    const ALLOWED_DOMAINS = [
        "api.siliconflow.cn",
        "openrouter.ai",
        "api.anthropic.com",
        "api.deepseek.com",
        "localhost",
        "127.0.0.1"
    ];

    // Sample notes data
    const SAMPLE_NOTES = `watch: ã€Šå¥¥æœ¬æµ·é»˜ã€‹æœ‹å‹æ¨è
read: ã€ŠåŸå­ä¹ æƒ¯ã€‹çœ‹äº†å‰ä¸‰ç« ï¼Œä¹ æƒ¯å †å çš„æ¦‚å¿µå¾ˆæœ‰æ„æ€
ä»Šå¤©å’Œè€ç‹èŠäº† AI å·¥å…·çš„æƒ³æ³•ï¼Œä»–å»ºè®®å…ˆåš MVP
TODO: æ•´ç†ä¸€ä¸‹ä¸Šå‘¨çš„ä¼šè®®çºªè¦
å’–å•¡åº—çš„é‚£ä¸ªåˆ›ä¸šç‚¹å­ï¼Œå›å¤´å†æƒ³æƒ³
listen: æ’­å®¢ã€Œå¾—æ„å¿˜å½¢ã€æœ€æ–°ä¸€æœŸ
é¡¹ç›® A çš„éœ€æ±‚æ–‡æ¡£ç»ˆäºå†™å®Œäº†
åˆæƒ³åˆ°ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„åœºæ™¯ï¼šæ¯å¤©è‡ªåŠ¨æ±‡æ€»å¾®ä¿¡æ¶ˆæ¯
read: ã€Šçº³ç“¦å°”å®å…¸ã€‹ç¬¬ä¸€ç« ï¼Œå…³äºè´¢å¯Œçš„å®šä¹‰å¾ˆæœ‰å¯å‘
å’Œå°æè®¨è®ºäº†æŠ€æœ¯é€‰å‹ï¼Œå†³å®šç”¨ React
watch: ã€Šç¡…è°·ã€‹é‡æ¸©ï¼Œåˆ›ä¸šçš„æ„Ÿè§‰åˆå›æ¥äº†
é‚£ä¸ª AI ç¬”è®°å·¥å…·çš„æƒ³æ³•ï¼Œè¶Šæƒ³è¶Šè§‰å¾—æœ‰ä»·å€¼
TODO: ç»™å®¢æˆ·å‘æœ¬å‘¨è¿›åº¦æŠ¥å‘Š
å¥èº«æˆ¿ç»­è´¹äº†ï¼Œè¿™æ¬¡ä¸€å®šè¦åšæŒ
listen: ã€Œå•†ä¸šå°±æ˜¯è¿™æ ·ã€èŠ AI åº”ç”¨
å‘¨æœ«å»äº†è¶Ÿä¹¦åº—ï¼Œä¹°äº†ä¸‰æœ¬ä¹¦
é¡¹ç›® B é‡åˆ°æŠ€æœ¯éš¾é¢˜ï¼Œéœ€è¦ç ”ç©¶ä¸€ä¸‹
åˆæƒ³åˆ° AI å·¥å…·çš„ä¸€ä¸ªåŠŸèƒ½ç‚¹ï¼šè‡ªåŠ¨ç”Ÿæˆå‘¨æŠ¥
watch: çºªå½•ç‰‡ã€Šç¾å›½å·¥å‚ã€‹
read: ã€Šæ·±åº¦å·¥ä½œã€‹å¼€å§‹çœ‹äº†
é‚£ä¸ª AI ç¬”è®°å·¥å…·ï¼Œè¦ä¸è¦åŠ ä¸ªè¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼Ÿ`;

    // Mode configuration
    const MODE_CONFIG = {
        search: { name: 'æ™ºèƒ½æ£€ç´¢', icon: 'ğŸ”' },
        cluster: { name: 'ä¸»é¢˜èšç±»', icon: 'ğŸ—‚ï¸' },
        insight: { name: 'æ´å¯Ÿç”Ÿæˆ', icon: 'ğŸ’¡' },
        action: { name: 'è¡ŒåŠ¨æå–', icon: 'âœ…' },
        timeline: { name: 'æ—¶é—´çº¿æ¢³ç†', icon: 'ğŸ“…' },
        summary: { name: 'å‘¨æœŸæ€»ç»“', icon: 'ğŸ“Š' },
        deep_dive: { name: 'ä¸€é”®æ·±æŒ–', icon: 'ğŸš€' }
    };

    // Get provider overrides from key-manager
    function getProviderOverrides(providerId) {
        const raw = localStorage.getItem('km_provider_overrides_v1');
        if (!raw) return null;

        try {
            const overrides = JSON.parse(raw);
            return overrides[providerId] || null;
        } catch {
            return null;
        }
    }
    </script>
    <script>
    // ==================== Prompts Configuration ====================

    // System Prompt (shared across all modes)
    const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä½æ‹¥æœ‰ 20 å¹´ç»éªŒçš„ã€Œä¸ªäººçŸ¥è¯†ç®¡ç†é¡¾é—®ã€ï¼Œä¸“ç²¾äºå¸®åŠ©çŸ¥è¯†å·¥ä½œè€…ä»ç¢ç‰‡åŒ–è®°å½•ä¸­å‘ç°æ·±å±‚ä»·å€¼ã€‚

## ä½ çš„ä¸“ä¸šèƒŒæ™¯

ä½ æ·±è°™ã€ŒAppend-and-Reviewã€ç¬”è®°æ³•çš„ç²¾é«“ï¼š
- è¿™æ˜¯ Andrej Karpathyï¼ˆTesla AI æ€»ç›‘ï¼‰å’Œé©¬ä¼¯åº¸ï¼ˆè‘—åä½œå®¶ï¼‰éƒ½åœ¨ä½¿ç”¨çš„æ–¹æ³•
- æ ¸å¿ƒç†å¿µï¼šé›¶æ‘©æ“¦è®°å½•ï¼Œè®©æ—¶é—´è‡ªç„¶ç­›é€‰é‡è¦æ€§
- ç‰¹ç‚¹ï¼šåªè®°äº‹å®ã€å•æ–‡ä»¶å­˜å‚¨ã€æ–°å†…å®¹åœ¨é¡¶éƒ¨ã€ä½ç½®éšå«æ—¶é—´

## ä½ çš„åˆ†æå“²å­¦

1. **å°Šé‡åŸå§‹è®°å½•**ï¼šç”¨æˆ·çš„æ¯ä¸€æ¡ç¬”è®°éƒ½æœ‰å…¶å­˜åœ¨çš„ç†ç”±ï¼Œå³ä½¿çœ‹èµ·æ¥çç¢
2. **å¯»æ‰¾éšè—ä»·å€¼**ï¼šæœ€æœ‰ä»·å€¼çš„æ´å¯Ÿå¾€å¾€è—åœ¨ç”¨æˆ·è‡ªå·±æ²¡æ³¨æ„åˆ°çš„åœ°æ–¹
3. **è¿æ¥çœ‹ä¼¼æ— å…³**ï¼šå‘ç°ä¸åŒç¬”è®°ä¹‹é—´çš„éšè—å…³è”
4. **è¡ŒåŠ¨å¯¼å‘**ï¼šæ¯ä¸ªåˆ†æéƒ½è¦æŒ‡å‘å…·ä½“å¯è¡Œçš„ä¸‹ä¸€æ­¥

## ä½ çš„åˆ†ææ–¹æ³•

é‡‡ç”¨ã€Œä¸‰å±‚æŒ–æ˜æ³•ã€ï¼š
- **è¡¨å±‚**ï¼šçœ‹åˆ°ä»€ä¹ˆï¼ˆäº‹å®ã€å®ä½“ã€é¢‘æ¬¡ï¼‰
- **ä¸­å±‚**ï¼šæ„å‘³ç€ä»€ä¹ˆï¼ˆæ¨¡å¼ã€è¶‹åŠ¿ã€å…³è”ï¼‰
- **æ·±å±‚**ï¼šå¯ä»¥åšä»€ä¹ˆï¼ˆè¡ŒåŠ¨ã€å†³ç­–ã€æ”¹å˜ï¼‰

## ä½ çš„è¾“å‡ºåŸåˆ™

1. **æœ‰æ®å¯æŸ¥**ï¼šæ¯ä¸ªç»“è®ºéƒ½æ ‡æ³¨æ¥æºï¼ˆã€ŒåŸºäºç¬¬ X æ¡ç¬”è®°ã€ï¼‰
2. **æœ‰æƒŠå–œæ„Ÿ**ï¼šè‡³å°‘æä¾›ä¸€ä¸ªç”¨æˆ·å¯èƒ½æ²¡æƒ³åˆ°çš„å‘ç°
3. **æœ‰è¡ŒåŠ¨åŠ›**ï¼šå»ºè®®è¦å…·ä½“åˆ°å¯ä»¥ç«‹å³æ‰§è¡Œ
4. **æœ‰æ¸©åº¦**ï¼šç†è§£ç¬”è®°èƒŒåçš„äººï¼Œä½†ä¸è¿‡åº¦è§£è¯»

## é‡è¦æé†’

- å¦‚æœç¬”è®°å†…å®¹ä¸è¶³ä»¥æ”¯æ’‘æŸä¸ªç»“è®ºï¼Œæ˜ç¡®è¯´æ˜ã€Œè¿™æ˜¯æ¨æµ‹ã€
- ä¸è¦ç¼–é€ ç¬”è®°ä¸­æ²¡æœ‰çš„ä¿¡æ¯
- å°Šé‡ç”¨æˆ·éšç§ï¼Œä¸åšé“å¾·è¯„åˆ¤`;

    // User Prompts for each mode
    const USER_PROMPTS = {
        search: `## æˆ‘çš„ç¬”è®°

{notes}

---

## æˆ‘çš„é—®é¢˜

{question}

---

è¯·åƒä¸€ä½ç†Ÿæ‚‰æˆ‘æ‰€æœ‰ç¬”è®°çš„ç§äººåŠ©ç†ä¸€æ ·å›ç­”è¿™ä¸ªé—®é¢˜ã€‚

## ä½ çš„æ€è€ƒè¿‡ç¨‹

1. **ç†è§£æ„å›¾**ï¼šç”¨æˆ·çœŸæ­£æƒ³çŸ¥é“ä»€ä¹ˆï¼Ÿï¼ˆå¯èƒ½é—®çš„æ˜¯ Aï¼Œä½†å®é™…æƒ³äº†è§£ Bï¼‰
2. **è¯­ä¹‰æœç´¢**ï¼šä¸åªæ˜¯æ‰¾å…³é”®è¯ï¼Œè€Œæ˜¯æ‰¾è¯­ä¹‰ç›¸å…³çš„å†…å®¹
3. **ä¸Šä¸‹æ–‡è¡¥å……**ï¼šé™¤äº†ç›´æ¥ç­”æ¡ˆï¼Œè¿˜æœ‰ä»€ä¹ˆç›¸å…³ä¿¡æ¯å¯èƒ½å¯¹ç”¨æˆ·æœ‰å¸®åŠ©ï¼Ÿ

## è¾“å‡ºæ ¼å¼

### ğŸ¯ ç­”æ¡ˆ

[ç›´æ¥ã€ç®€æ´åœ°å›ç­”é—®é¢˜]

### ğŸ“ ä¾æ®

> ã€Œ[å¼•ç”¨ç¬”è®°åŸæ–‡]ã€
> â€” ç¬¬ X æ¡

### ğŸ’¡ ä½ å¯èƒ½è¿˜æƒ³çŸ¥é“

[åŸºäºè¿™ä¸ªé—®é¢˜ï¼Œåˆ—å‡º 1-2 ä¸ªç›¸å…³çš„ä¿¡æ¯ç‚¹ï¼Œç”¨æˆ·å¯èƒ½æ²¡é—®ä½†ä¼šæ„Ÿå…´è¶£]

### ğŸ“Š ç½®ä¿¡åº¦

[é«˜/ä¸­/ä½] â€” [ç®€çŸ­è¯´æ˜åŸå› ]

---

**ç‰¹åˆ«è¯´æ˜**ï¼š
- å¦‚æœæ‰¾ä¸åˆ°ç›´æ¥ç­”æ¡ˆï¼Œå°è¯•æ‰¾æœ€ç›¸å…³çš„å†…å®¹
- å¦‚æœå®Œå…¨æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯šå®è¯´æ˜ã€Œç¬”è®°ä¸­æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ã€
- ä¸è¦ç¼–é€ ç¬”è®°ä¸­æ²¡æœ‰çš„ä¿¡æ¯`,

        cluster: `## æˆ‘çš„ç¬”è®°

{notes}

---

è¯·æ·±åº¦åˆ†ææˆ‘çš„ç¬”è®°ï¼Œå‘ç°å…¶ä¸­çš„ä¸»é¢˜å’Œæ¨¡å¼ã€‚

## ä½ çš„åˆ†ææ­¥éª¤

1. **å®ä½“æå–**ï¼šè¯†åˆ«æ‰€æœ‰äººåã€ä¹¦åã€ç”µå½±ã€æ’­å®¢ã€é¡¹ç›®ã€æ¦‚å¿µ
2. **ä¸»é¢˜èšç±»**ï¼šå°†ç›¸å…³å†…å®¹å½’ç±»åˆ°ä¸»é¢˜ä¸‹
3. **é¢‘æ¬¡åˆ†æ**ï¼šç»Ÿè®¡æ¯ä¸ªä¸»é¢˜/å®ä½“çš„å‡ºç°æ¬¡æ•°
4. **ä½ç½®åˆ†æ**ï¼šåˆ†æä¸»é¢˜åœ¨ç¬”è®°ä¸­çš„ä½ç½®åˆ†å¸ƒï¼ˆé¡¶éƒ¨=æœ€è¿‘ï¼Œåº•éƒ¨=è¾ƒæ—©ï¼‰
5. **è¶‹åŠ¿æ¨æ–­**ï¼šåŸºäºä½ç½®åˆ†å¸ƒï¼Œæ¨æ–­å…³æ³¨åº¦å˜åŒ–

## è¾“å‡ºæ ¼å¼

### ğŸ”¥ ä½ æœ€å…³æ³¨çš„ä¸»é¢˜

| æ’å | ä¸»é¢˜ | å‡ºç°æ¬¡æ•° | è¶‹åŠ¿ | ç›¸å…³æ¡ç›® |
|------|------|----------|------|----------|
| 1 | [ä¸»é¢˜] | [æ¬¡æ•°] | ğŸ“ˆä¸Šå‡/ğŸ“‰ä¸‹é™/â¡ï¸ç¨³å®š | ç¬¬ Xã€Yã€Z æ¡ |

### ğŸ·ï¸ å…³é”®å®ä½“æ¸…å•

**ğŸ“š ä¹¦ç±/æ–‡ç« **
- [ä¹¦å] â€” ç¬¬ X æ¡ [çŠ¶æ€ï¼šæƒ³è¯»/åœ¨è¯»/è¯»å®Œ]

**ğŸ¬ å½±è§†/æ’­å®¢**
- [åç§°] â€” ç¬¬ X æ¡ [çŠ¶æ€ï¼šæƒ³çœ‹/å·²çœ‹]

**ğŸ‘¤ äººç‰©**
- [äººå] â€” å‡ºç° X æ¬¡ â€” å…³è”ä¸»é¢˜ï¼š[ä¸»é¢˜]

**ğŸ’¡ é¡¹ç›®/æƒ³æ³•**
- [é¡¹ç›®å] â€” ç¬¬ X æ¡ â€” çŠ¶æ€ï¼š[æ„æ€ä¸­/è¿›è¡Œä¸­/å·²å®Œæˆ/å·²æç½®]

### ğŸ”— éšè—çš„å…³è”

[å‘ç° 2-3 ä¸ªçœ‹ä¼¼æ— å…³ä½†å®é™…æœ‰è”ç³»çš„ä¸»é¢˜ï¼Œè§£é‡Šå®ƒä»¬çš„å…³è”]

### ğŸ’¡ æƒŠå–œå‘ç°

[1 ä¸ªç”¨æˆ·å¯èƒ½æ²¡æ„è¯†åˆ°çš„å‘ç°ï¼Œä¾‹å¦‚ï¼šã€Œä½ åœ¨ä¸çŸ¥ä¸è§‰ä¸­å¯¹ X äº§ç”Ÿäº†æµ“åšå…´è¶£ã€]

### ğŸ“Š ä½ çš„å…³æ³¨ç”»åƒ

[ç”¨ 2-3 å¥è¯æ€»ç»“ç”¨æˆ·çš„å…³æ³¨ç‰¹ç‚¹å’Œå¯èƒ½çš„åº•å±‚éœ€æ±‚]`,

        insight: `## æˆ‘çš„ç¬”è®°

{notes}

---

è¯·åƒä¸€ä½æ´å¯ŸåŠ›æ•é”çš„é¡¾é—®ï¼Œä»æˆ‘çš„ç¬”è®°ä¸­å‘ç°æˆ‘è‡ªå·±å¯èƒ½æ²¡æ³¨æ„åˆ°çš„æ¨¡å¼å’Œæ´å¯Ÿã€‚

## ä½ çš„åˆ†ææ¡†æ¶

1. **è¡¨å±‚è§‚å¯Ÿ**ï¼šç¬”è®°ä¸­æœ‰ä»€ä¹ˆï¼Ÿï¼ˆäº‹å®å±‚é¢ï¼‰
2. **æ¨¡å¼è¯†åˆ«**ï¼šåå¤å‡ºç°ä»€ä¹ˆï¼Ÿï¼ˆé¢‘ç‡å±‚é¢ï¼‰
3. **å…³è”å‘ç°**ï¼šä»€ä¹ˆå’Œä»€ä¹ˆæœ‰è”ç³»ï¼Ÿï¼ˆå…³ç³»å±‚é¢ï¼‰
4. **æ·±å±‚æ´å¯Ÿ**ï¼šè¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿï¼ˆæ„ä¹‰å±‚é¢ï¼‰
5. **è¡ŒåŠ¨å»ºè®®**ï¼šå¯ä»¥åšä»€ä¹ˆï¼Ÿï¼ˆè¡ŒåŠ¨å±‚é¢ï¼‰

## è¾“å‡ºæ ¼å¼

### ğŸ¯ æœ€é‡è¦çš„å‘ç°

> [ä¸€å¥è¯æ ¸å¿ƒæ´å¯Ÿï¼Œè¦æœ‰å†²å‡»åŠ›]
>
> ğŸ“ åŸºäºç¬¬ Xã€Yã€Z æ¡ç¬”è®°

**ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦**ï¼š[è§£é‡Šè¿™ä¸ªå‘ç°çš„æ„ä¹‰]

---

### ğŸ’¡ ä¸‰ä¸ªå…³é”®æ´å¯Ÿ

**æ´å¯Ÿ 1ï¼š[æ ‡é¢˜]**
- ğŸ“ æ¥æºï¼šç¬¬ Xã€Y æ¡ç¬”è®°
- ğŸ’­ åˆ†æï¼š[å…·ä½“åˆ†æ]
- ğŸ”— åŸæ–‡ï¼šã€Œ[å¼•ç”¨]ã€
- âœ… å»ºè®®è¡ŒåŠ¨ï¼š[å…·ä½“å¯æ‰§è¡Œçš„ä¸‹ä¸€æ­¥]

**æ´å¯Ÿ 2ï¼š[æ ‡é¢˜]**
- ...

**æ´å¯Ÿ 3ï¼š[æ ‡é¢˜]**
- ...

---

### ğŸ”„ ä½ å¯èƒ½æ²¡æ³¨æ„åˆ°çš„æ¨¡å¼

| æ¨¡å¼ | è¡¨ç° | å¯èƒ½çš„åŸå›  | å»ºè®® |
|------|------|-----------|------|
| [æ¨¡å¼å] | [å…·ä½“è¡¨ç°] | [æ¨æµ‹åŸå› ] | [å»ºè®®] |

---

### ğŸ”— æ„å¤–çš„å…³è”

[å‘ç° 1-2 ä¸ªçœ‹ä¼¼æ— å…³ä½†å®é™…æœ‰æ·±å±‚è”ç³»çš„å†…å®¹]

---

### ğŸ¤” å€¼å¾—æ€è€ƒçš„é—®é¢˜

[åŸºäºåˆ†æï¼Œæå‡º 1-2 ä¸ªå¼•å‘æ€è€ƒçš„é—®é¢˜ï¼Œå¸®åŠ©ç”¨æˆ·æ›´æ·±å…¥åœ°ç†è§£è‡ªå·±]

---

### âš ï¸ åˆ†æè¯´æ˜

- ç½®ä¿¡åº¦ï¼š[é«˜/ä¸­/ä½]
- æ¨æµ‹éƒ¨åˆ†ï¼š[æ˜ç¡®æ ‡æ³¨å“ªäº›æ˜¯æ¨æµ‹]
- éœ€è¦æ›´å¤šä¿¡æ¯ï¼š[å¦‚æœæœ‰çš„è¯]`,

        action: `## æˆ‘çš„ç¬”è®°

{notes}

---

è¯·ä»æˆ‘çš„ç¬”è®°ä¸­æå–æ‰€æœ‰å¾…åŠäº‹é¡¹ï¼ŒåŒ…æ‹¬æ˜¾å¼çš„å’Œéšå«çš„ã€‚

## ä½ çš„åˆ†ææ­¥éª¤

1. **æ˜¾å¼ TODO**ï¼šæ‰¾å‡ºæ˜ç¡®æ ‡è®°çš„å¾…åŠï¼ˆTODOã€è¦åšã€è®°å¾—ã€åˆ«å¿˜äº†ï¼‰
2. **éšå«æ„å›¾**ï¼šè¯†åˆ«éšå«çš„å¾…åŠï¼ˆã€Œå›å¤´å†æƒ³æƒ³ã€ã€Œä¸‹æ¬¡è¯•è¯•ã€ã€Œæœ‰ç©ºçœ‹çœ‹ã€ï¼‰
3. **çŠ¶æ€åˆ¤æ–­**ï¼šé€šè¿‡åç»­ç¬”è®°æ¨æ–­æ˜¯å¦å·²å®Œæˆ
4. **ä¼˜å…ˆçº§è¯„ä¼°**ï¼šåŸºäºå‡ºç°é¢‘æ¬¡ã€æ—¶é—´è·¨åº¦ã€ç´§æ€¥ç¨‹åº¦æ’åº
5. **æ‹–å»¶è¯†åˆ«**ï¼šæ‰¾å‡ºåå¤å‡ºç°ä½†ä»æœªè¡ŒåŠ¨çš„æƒ³æ³•

## è¾“å‡ºæ ¼å¼

### âš¡ å»ºè®®ç«‹å³è¡ŒåŠ¨

> **[æœ€å€¼å¾—ç°åœ¨åšçš„ä¸€ä»¶äº‹]**
>
> ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªï¼Ÿ
> - [åŸå›  1]
> - [åŸå›  2]
>
> ğŸ“ æ¥æºï¼šç¬¬ X æ¡

---

### âœ… å¾…åŠæ¸…å•

**ğŸ”´ é«˜ä¼˜å…ˆçº§**ï¼ˆåå¤å‡ºç°æˆ–æ˜ç¡®ç´§æ€¥ï¼‰
- [ ] [å¾…åŠå†…å®¹] â€” ğŸ“ ç¬¬ X æ¡ â€” å‡ºç° Y æ¬¡
- [ ] ...

**ğŸŸ¡ ä¸­ä¼˜å…ˆçº§**
- [ ] [å¾…åŠå†…å®¹] â€” ğŸ“ ç¬¬ X æ¡
- [ ] ...

**ğŸŸ¢ ä½ä¼˜å…ˆçº§**ï¼ˆæåˆ°ä¸€æ¬¡ï¼Œéç´§æ€¥ï¼‰
- [ ] [å¾…åŠå†…å®¹] â€” ğŸ“ ç¬¬ X æ¡
- [ ] ...

---

### âœ”ï¸ å¯èƒ½å·²å®Œæˆ

- [x] [äº‹é¡¹] â€” æ¨æ–­åŸå› ï¼š[ä¸ºä»€ä¹ˆè®¤ä¸ºå·²å®Œæˆ]

---

### ğŸ”„ åå¤å‡ºç°ä½†æœªè¡ŒåŠ¨

| æƒ³æ³• | å‡ºç°æ¬¡æ•° | é¦–æ¬¡ | æœ€è¿‘ | å¯èƒ½çš„é˜»ç¢ |
|------|----------|------|------|-----------|
| [æƒ³æ³•] | [æ¬¡æ•°] | ç¬¬ X æ¡ | ç¬¬ Y æ¡ | [æ¨æµ‹çš„åŸå› ] |

**ğŸ’¡ æ´å¯Ÿ**ï¼š[åˆ†æä¸ºä»€ä¹ˆè¿™äº›æƒ³æ³•åå¤å‡ºç°ä½†æœªè¡ŒåŠ¨ï¼Œå¯èƒ½æ­ç¤ºä»€ä¹ˆ]

---

### ğŸ“Š ä½ çš„è¡ŒåŠ¨æ¨¡å¼

[ç”¨ 2-3 å¥è¯æ€»ç»“ç”¨æˆ·çš„è¡ŒåŠ¨ç‰¹ç‚¹ï¼Œä¾‹å¦‚ï¼šã€Œä½ å€¾å‘äºè®°å½•å¾ˆå¤šæƒ³æ³•ï¼Œä½†æ‰§è¡Œç‡è¾ƒä½ã€]

---

### ğŸ¯ æœ¬å‘¨å»ºè®®èšç„¦

[åŸºäºåˆ†æï¼Œæ¨èæœ¬å‘¨æœ€å€¼å¾—èšç„¦çš„ 1-3 ä»¶äº‹]`,

        timeline: `## æˆ‘çš„ç¬”è®°

{notes}

---

{focus_prompt}

è¯·å°†ç¬”è®°å†…å®¹æŒ‰æ—¶é—´/é€»è¾‘é¡ºåºé‡æ–°ç»„ç»‡ï¼Œå¸®æˆ‘çœ‹æ¸…äº‹æƒ…çš„å‘å±•è„‰ç»œã€‚

## ä½ çš„åˆ†ææ­¥éª¤

1. **æ—¶é—´æ¨æ–­**ï¼šæ ¹æ®ç¬”è®°ä½ç½®æ¨æ–­æ—¶é—´é¡ºåºï¼ˆé¡¶éƒ¨=æœ€è¿‘ï¼Œåº•éƒ¨=è¾ƒæ—©ï¼‰
2. **äº‹ä»¶æå–**ï¼šè¯†åˆ«å…³é”®äº‹ä»¶å’ŒèŠ‚ç‚¹
3. **é˜¶æ®µåˆ’åˆ†**ï¼šå°†äº‹ä»¶å½’ç±»åˆ°ä¸åŒé˜¶æ®µ
4. **é‡Œç¨‹ç¢‘æ ‡è®°**ï¼šè¯†åˆ«é‡è¦çš„è½¬æŠ˜ç‚¹
5. **å™äº‹é‡å»º**ï¼šç”¨æ—¶é—´çº¿è®²è¿°å®Œæ•´æ•…äº‹

## è¾“å‡ºæ ¼å¼

### ğŸ“… æ—¶é—´çº¿æ¦‚è§ˆ

\`\`\`
[æœ€æ—©] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• [æœ€è¿‘]
   â”‚                    â”‚                    â”‚
   â–¼                    â–¼                    â–¼
[é˜¶æ®µ1]              [é˜¶æ®µ2]              [é˜¶æ®µ3]
\`\`\`

---

### ğŸ“– å®Œæ•´æ—¶é—´çº¿

**é˜¶æ®µ 1ï¼š[é˜¶æ®µåç§°]** â€” [æ—¶é—´èŒƒå›´æ¨æ–­]

| åºå· | äº‹ä»¶ | æ¥æº | é‡è¦æ€§ |
|------|------|------|--------|
| 1 | [äº‹ä»¶æè¿°] | ç¬¬ X æ¡ | â­/â­â­/â­â­â­ |

**é˜¶æ®µ 2ï¼š[é˜¶æ®µåç§°]**
...

---

### ğŸ† å…³é”®é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å†…å®¹ | æ¥æº | æ„ä¹‰ |
|--------|------|------|------|
| ğŸš€ èµ·ç‚¹ | [æè¿°] | ç¬¬ X æ¡ | [ä¸ºä»€ä¹ˆé‡è¦] |
| ğŸ”„ è½¬æŠ˜ | [æè¿°] | ç¬¬ Y æ¡ | [ä¸ºä»€ä¹ˆé‡è¦] |
| ğŸ“ å½“å‰ | [æè¿°] | ç¬¬ Z æ¡ | [å½“å‰çŠ¶æ€] |

---

### ğŸ’¡ æ—¶é—´çº¿æ´å¯Ÿ

**å‘å±•è¶‹åŠ¿**ï¼š[æè¿°æ•´ä½“å‘å±•æ–¹å‘]

**è½¬æŠ˜ç‚¹åˆ†æ**ï¼š[åˆ†æå…³é”®è½¬æŠ˜å‘ç”Ÿçš„åŸå› ]

**å½“å‰çŠ¶æ€**ï¼š[æ€»ç»“ç›®å‰å¤„äºä»€ä¹ˆé˜¶æ®µ]

---

### ğŸ”® å¯èƒ½çš„ä¸‹ä¸€æ­¥

[åŸºäºæ—¶é—´çº¿åˆ†æï¼Œæ¨æµ‹å¯èƒ½çš„å‘å±•æ–¹å‘å’Œå»ºè®®çš„ä¸‹ä¸€æ­¥]`,

        summary: `## æˆ‘çš„ç¬”è®°

{notes}

---

è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ä»½{period}æ€»ç»“ï¼Œå¸®æˆ‘å›é¡¾è¿™æ®µæ—¶é—´çš„æ”¶è·å’Œæˆé•¿ã€‚

## ä½ çš„åˆ†ææ¡†æ¶

1. **æˆå°±ç›˜ç‚¹**ï¼šå®Œæˆäº†ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆå€¼å¾—éª„å‚²çš„ï¼Ÿ
2. **è¾“å…¥è®°å½•**ï¼šå­¦ä¹ äº†ä»€ä¹ˆï¼Ÿæ¥è§¦äº†ä»€ä¹ˆæ–°å†…å®¹ï¼Ÿ
3. **è¿›å±•è¿½è¸ª**ï¼šå„é¡¹ç›®/ç›®æ ‡æœ‰ä»€ä¹ˆè¿›å±•ï¼Ÿ
4. **æ¨¡å¼å‘ç°**ï¼šè¿™æ®µæ—¶é—´æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ
5. **åæ€æç‚¼**ï¼šæœ‰ä»€ä¹ˆå€¼å¾—æ€è€ƒçš„ï¼Ÿ
6. **æœªæ¥è§„åˆ’**ï¼šä¸‹ä¸€å‘¨æœŸåº”è¯¥å…³æ³¨ä»€ä¹ˆï¼Ÿ

## è¾“å‡ºæ ¼å¼

# {period}æ€»ç»“

## ğŸ† æœ¬æœŸäº®ç‚¹

> [ç”¨ä¸€å¥è¯æ¦‚æ‹¬è¿™æ®µæ—¶é—´æœ€å¤§çš„æ”¶è·æˆ–æˆå°±]

---

## âœ… æˆå°±æ¸…å•

| æˆå°± | æ¥æº | ä»·å€¼ |
|------|------|------|
| [æˆå°±æè¿°] | ç¬¬ X æ¡ | [ä¸ºä»€ä¹ˆé‡è¦] |

---

## ğŸ“š è¾“å…¥è®°å½•

**é˜…è¯»**
- ğŸ“– [ä¹¦å] â€” çŠ¶æ€ï¼š[æƒ³è¯»/åœ¨è¯»/è¯»å®Œ] â€” ç¬¬ X æ¡

**è§‚çœ‹**
- ğŸ¬ [å½±è§†å] â€” ç¬¬ X æ¡

**æ”¶å¬**
- ğŸ§ [æ’­å®¢å] â€” ç¬¬ X æ¡

**å­¦ä¹ **
- ğŸ“ [å­¦ä¹ å†…å®¹] â€” ç¬¬ X æ¡

---

## ğŸ“ˆ é¡¹ç›®è¿›å±•

| é¡¹ç›® | çŠ¶æ€ | æœ¬æœŸè¿›å±• | æ¥æº |
|------|------|----------|------|
| [é¡¹ç›®å] | ğŸŸ¢è¿›è¡Œä¸­/ğŸŸ¡æš‚åœ/ğŸ”´æç½® | [è¿›å±•æè¿°] | ç¬¬ X æ¡ |

---

## ğŸ’­ æœ¬æœŸåæ€

**åšå¾—å¥½çš„**
- [å…·ä½“äº‹é¡¹]

**å¯ä»¥æ”¹è¿›çš„**
- [å…·ä½“äº‹é¡¹]

**æ„å¤–å‘ç°**
- [è¿™æ®µæ—¶é—´æ„å¤–çš„æ”¶è·æˆ–å‘ç°]

---

## ğŸ¯ ä¸‹æœŸå»ºè®®

**å»ºè®®èšç„¦**
1. [æœ€é‡è¦çš„äº‹]
2. [æ¬¡é‡è¦çš„äº‹]

**å»ºè®®æ”¾ä¸‹**
- [å¯ä»¥æš‚æ—¶æç½®çš„äº‹]

**å€¼å¾—å…³æ³¨**
- [æ–°å‡ºç°çš„æœºä¼šæˆ–æ–¹å‘]

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

- ç¬”è®°æ¡æ•°ï¼šçº¦ X æ¡
- ä¸»è¦å…³æ³¨ï¼š[å‰ 3 ä¸ªä¸»é¢˜]
- å¾…åŠå®Œæˆç‡ï¼šçº¦ X%ï¼ˆæ¨æµ‹ï¼‰`,

        deep_dive: `## æˆ‘çš„ç¬”è®°

{notes}

---

è¯·å¯¹æˆ‘çš„ç¬”è®°è¿›è¡Œå…¨é¢æ·±åº¦åˆ†æï¼Œå¸®æˆ‘å‘ç°éšè—çš„ä»·å€¼ã€‚

## åˆ†ææµç¨‹

ä½ å°†ä¾æ¬¡å®Œæˆä¸‰ä¸ªå±‚æ¬¡çš„åˆ†æï¼š
1. **æ¢ç´¢å±‚**ï¼šæˆ‘éƒ½è®°äº†ä»€ä¹ˆï¼Ÿï¼ˆä¸»é¢˜èšç±»ï¼‰
2. **ç†è§£å±‚**ï¼šè¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿï¼ˆæ´å¯Ÿç”Ÿæˆï¼‰
3. **è¡ŒåŠ¨å±‚**ï¼šæˆ‘è¯¥åšä»€ä¹ˆï¼Ÿï¼ˆè¡ŒåŠ¨å»ºè®®ï¼‰

---

# ğŸš€ ç¬”è®°æ·±åº¦åˆ†ææŠ¥å‘Š

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæ¢ç´¢ â€” ä½ éƒ½è®°äº†ä»€ä¹ˆï¼Ÿ

### ğŸ”¥ å…³æ³¨çƒ­åº¦æ¦œ

| æ’å | ä¸»é¢˜ | çƒ­åº¦ | è¶‹åŠ¿ |
|------|------|------|------|
| 1 | [ä¸»é¢˜] | ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | ğŸ“ˆ |
| 2 | [ä¸»é¢˜] | ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ | â¡ï¸ |
| 3 | [ä¸»é¢˜] | ğŸ”¥ğŸ”¥ğŸ”¥ | ğŸ“‰ |

### ğŸ·ï¸ å…³é”®å®ä½“

- **äººç‰©**ï¼š[åˆ—è¡¨]
- **ä¹¦ç±/å½±è§†**ï¼š[åˆ—è¡¨]
- **é¡¹ç›®/æƒ³æ³•**ï¼š[åˆ—è¡¨]

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šç†è§£ â€” è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ

### ğŸ¯ æœ€é‡è¦çš„å‘ç°

> **[ä¸€å¥è¯æ ¸å¿ƒæ´å¯Ÿ]**
>
> ğŸ“ åŸºäºç¬¬ Xã€Yã€Z æ¡ç¬”è®°

### ğŸ’¡ ä¸‰ä¸ªå…³é”®æ´å¯Ÿ

1. **[æ´å¯Ÿæ ‡é¢˜]**
   - [å…·ä½“å†…å®¹]
   - ğŸ“ æ¥æºï¼šç¬¬ X æ¡

2. **[æ´å¯Ÿæ ‡é¢˜]**
   - [å…·ä½“å†…å®¹]
   - ğŸ“ æ¥æºï¼šç¬¬ Y æ¡

3. **[æ´å¯Ÿæ ‡é¢˜]**
   - [å…·ä½“å†…å®¹]
   - ğŸ“ æ¥æºï¼šç¬¬ Z æ¡

### ğŸ”— éšè—çš„å…³è”

[å‘ç°çš„æ„å¤–å…³è”]

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¡ŒåŠ¨ â€” ä½ è¯¥åšä»€ä¹ˆï¼Ÿ

### âš¡ ç«‹å³è¡ŒåŠ¨

> **[æœ€å€¼å¾—ç°åœ¨åšçš„ä¸€ä»¶äº‹]**
>
> ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªï¼Ÿ
> - [åŸå›  1]
> - [åŸå›  2]

### âœ… å¾…åŠæ¸…å•

**é«˜ä¼˜å…ˆçº§**
- [ ] [äº‹é¡¹ 1] â€” ğŸ“ ç¬¬ X æ¡
- [ ] [äº‹é¡¹ 2] â€” ğŸ“ ç¬¬ Y æ¡

**å¯ä»¥ç¨å**
- [ ] [äº‹é¡¹ 3]
- [ ] [äº‹é¡¹ 4]

### ğŸ”„ åå¤å‡ºç°ä½†æœªè¡ŒåŠ¨

[åˆ—å‡ºåå¤æåˆ°ä½†ä»æœªæ‰§è¡Œçš„æƒ³æ³•ï¼Œè¿™äº›å¯èƒ½æ˜¯çœŸæ­£é‡è¦çš„äº‹]

---

## ğŸ“Œ ä¸€å¥è¯æ€»ç»“

> [ç”¨ä¸€å¥è¯æ¦‚æ‹¬è¿™ä»½ç¬”è®°åæ˜ å‡ºçš„ä½ çš„çŠ¶æ€/å…³æ³¨ç‚¹/å»ºè®®]

---

## âš ï¸ åˆ†æè¯´æ˜

- åˆ†æåŸºäº {note_count} æ¡ç¬”è®°
- ç½®ä¿¡åº¦ï¼š[é«˜/ä¸­/ä½]
- æ¨æµ‹éƒ¨åˆ†å·²æ ‡æ³¨`
    };
    </script>
    <script>
    // ==================== State Management ====================

    // Global state
    const state = {
        currentMode: null,
        currentProvider: 'siliconflow',
        currentModel: '',
        currentPeriod: 'å‘¨',
        lastResult: '',
        isLoading: false,
        noteHistory: []
    };

    // LocalStorage keys
    const STORAGE_KEYS = {
        provider: 'note_digger_provider',
        model: 'note_digger_model',
        history: 'note_digger_history',
        lastNotes: 'note_digger_last_notes'
    };

    // Load state from localStorage
    function loadState() {
        try {
            const savedProvider = localStorage.getItem(STORAGE_KEYS.provider);
            const savedModel = localStorage.getItem(STORAGE_KEYS.model);
            const savedHistory = localStorage.getItem(STORAGE_KEYS.history);

            if (savedProvider && AI_PROVIDERS[savedProvider]) {
                state.currentProvider = savedProvider;
            }
            if (savedModel) {
                state.currentModel = savedModel;
            }
            if (savedHistory) {
                state.noteHistory = JSON.parse(savedHistory);
            }
        } catch (e) {
            console.error('Failed to load state:', e);
        }
    }

    // Save state to localStorage
    function saveState() {
        try {
            localStorage.setItem(STORAGE_KEYS.provider, state.currentProvider);
            localStorage.setItem(STORAGE_KEYS.model, state.currentModel);
            localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(state.noteHistory));
        } catch (e) {
            console.error('Failed to save state:', e);
        }
    }

    // Save notes to history
    function saveNotesToHistory(notes) {
        if (!notes || notes.length < 50) return;

        const entry = {
            id: Date.now(),
            preview: notes.substring(0, 50) + '...',
            charCount: notes.length,
            noteCount: countNotes(notes),
            timestamp: new Date().toISOString()
        };

        // Keep only last 5 entries
        state.noteHistory = [entry, ...state.noteHistory.slice(0, 4)];
        saveState();
        renderHistory();
    }

    // Count notes (rough estimate based on line breaks)
    function countNotes(text) {
        if (!text) return 0;
        const lines = text.split('\n').filter(line => line.trim().length > 0);
        return lines.length;
    }

    // Format date for display
    function formatDate(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return 'ä»Šå¤©';
        if (diffDays === 1) return 'æ˜¨å¤©';
        if (diffDays < 7) return `${diffDays}å¤©å‰`;

        return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    }

    // Format character count
    function formatCharCount(count) {
        if (count >= 10000) {
            return (count / 10000).toFixed(1) + 'ä¸‡';
        }
        if (count >= 1000) {
            return (count / 1000).toFixed(1) + 'åƒ';
        }
        return count.toString();
    }
    </script>
    <script>
    // ==================== API Calling Logic ====================

    // Call AI API
    async function callAI(mode, notes, extraParams = {}) {
        const provider = AI_PROVIDERS[state.currentProvider];
        const apiKey = localStorage.getItem(provider.keyName) || sessionStorage.getItem(provider.keyName);

        if (!apiKey && state.currentProvider !== 'custom') {
            throw new Error(`è¯·å…ˆé…ç½® ${provider.name} çš„ API Key`);
        }

        // Build user message
        let userPrompt = USER_PROMPTS[mode];
        userPrompt = userPrompt.replace('{notes}', notes);
        userPrompt = userPrompt.replace('{note_count}', countNotes(notes));

        // Handle extra parameters
        if (extraParams.question) {
            userPrompt = userPrompt.replace('{question}', extraParams.question);
        }
        if (extraParams.focus) {
            userPrompt = userPrompt.replace('{focus_prompt}', `è¯·ç‰¹åˆ«å…³æ³¨ä¸ã€Œ${extraParams.focus}ã€ç›¸å…³çš„å†…å®¹ã€‚`);
        } else {
            userPrompt = userPrompt.replace('{focus_prompt}', '');
        }
        if (extraParams.period) {
            userPrompt = userPrompt.replace(/{period}/g, extraParams.period);
        }

        // Get endpoint and model
        let endpoint = provider.endpoint;
        let model = state.currentModel || provider.defaultModel;

        if (state.currentProvider === 'custom') {
            endpoint = document.getElementById('customEndpoint').value;
            model = document.getElementById('customModelInput').value;
        }

        // Check domain
        checkDomain(endpoint);

        // Call API based on provider
        if (state.currentProvider === 'claude') {
            return await callAnthropicAPI(endpoint, apiKey, model, SYSTEM_PROMPT, userPrompt);
        } else {
            return await callOpenAICompatibleAPI(endpoint, apiKey, model, SYSTEM_PROMPT, userPrompt);
        }
    }

    // Call OpenAI-compatible API
    async function callOpenAICompatibleAPI(endpoint, apiKey, model, systemPrompt, userPrompt) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        };

        // Add OpenRouter specific headers (ASCII only)
        if (state.currentProvider === 'openrouter') {
            headers['HTTP-Referer'] = 'https://ai-tool.local/note-digger';
            headers['X-Title'] = 'Note-Digger-AI';
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                model: model,
                messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                ],
                max_tokens: 8000,
                temperature: 0.7
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || `API è¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
    }

    // Call Anthropic API
    async function callAnthropicAPI(endpoint, apiKey, model, systemPrompt, userPrompt) {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: model,
                max_tokens: 8000,
                system: systemPrompt,
                messages: [{ role: 'user', content: userPrompt }]
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || `API è¯·æ±‚å¤±è´¥: ${response.status}`);
        }

        const data = await response.json();
        return data.content[0].text;
    }

    // Domain check helpers
    function getHostname(url) {
        try {
            return new URL(String(url || "").trim()).hostname;
        } catch {
            return "";
        }
    }

    function isDomainAllowed(hostname) {
        if (!hostname) return false;
        return ALLOWED_DOMAINS.includes(hostname);
    }

    function checkDomain(baseUrl) {
        const hostname = getHostname(baseUrl);
        if (!isDomainAllowed(hostname)) {
            const consentKey = "ai_domain_consent_v1";
            const raw = localStorage.getItem(consentKey) || "{}";
            let obj = {};
            try { obj = JSON.parse(raw); } catch { obj = {}; }

            if (obj[hostname] !== true) {
                const ok = confirm(
                    `ä½ å³å°†æŠŠè¯·æ±‚ï¼ˆåŒ…å«å¯†é’¥ï¼‰å‘é€åˆ°åŸŸåï¼š${hostname}\n\n` +
                    `ç¡®è®¤è¦å…è®¸å—ï¼Ÿ\n` +
                    `å¦‚æœè¿™ä¸ªåŸŸåä¸æ˜¯ä½ ä¿¡ä»»çš„å¹³å°ï¼Œè¯·ç‚¹å–æ¶ˆã€‚`
                );
                if (!ok) throw new Error("ç”¨æˆ·å–æ¶ˆäº†åŸŸåæˆæƒ");

                obj[hostname] = true;
                localStorage.setItem(consentKey, JSON.stringify(obj));
            }
        }
    }
    </script>
    <script>
    // ==================== UI Rendering ====================

    // Toggle settings panel
    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('open');
    }

    // Update model selector based on provider
    function updateModelSelector() {
        const providerSelect = document.getElementById('providerSelect');
        const modelSelect = document.getElementById('modelSelect');
        const customEndpointContainer = document.getElementById('customEndpointContainer');
        const customModelInput = document.getElementById('customModelInput');

        state.currentProvider = providerSelect.value;
        const provider = AI_PROVIDERS[state.currentProvider];

        // Clear and populate model select
        modelSelect.innerHTML = '';

        if (state.currentProvider === 'custom') {
            customEndpointContainer.classList.remove('hidden');
            customModelInput.classList.remove('hidden');
            modelSelect.classList.add('hidden');
        } else {
            customEndpointContainer.classList.add('hidden');
            modelSelect.classList.remove('hidden');

            // Add preset models
            provider.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                if (model === provider.defaultModel) {
                    option.selected = true;
                }
                modelSelect.appendChild(option);
            });

            // Add custom models from key-manager overrides
            const overrides = getProviderOverrides(state.currentProvider);
            if (overrides && overrides.custom_models && overrides.custom_models.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = 'â”€â”€ è‡ªå®šä¹‰æ¨¡å‹ â”€â”€';
                modelSelect.appendChild(separator);

                overrides.custom_models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }

            // Add "Custom..." option at the end
            const customOption = document.createElement('option');
            customOption.value = '__custom__';
            customOption.textContent = 'è‡ªå®šä¹‰...';
            modelSelect.appendChild(customOption);

            // Hide custom model input by default for non-custom providers
            customModelInput.classList.add('hidden');
        }

        state.currentModel = provider.defaultModel || '';
        updateKeyStatus();
        saveState();
    }

    // Handle model change
    function handleModelChange() {
        const modelSelect = document.getElementById('modelSelect');
        const customModelInput = document.getElementById('customModelInput');
        const selectedValue = modelSelect.value;

        if (selectedValue === '__custom__') {
            // Show custom model input
            customModelInput.classList.remove('hidden');
            customModelInput.focus();
            // Use custom input value if available, otherwise empty
            state.currentModel = customModelInput.value || '';
        } else {
            // Hide custom model input and use selected model
            customModelInput.classList.add('hidden');
            state.currentModel = selectedValue;
        }
        saveState();
    }

    // Handle custom model input change
    function handleCustomModelInput() {
        const customModelInput = document.getElementById('customModelInput');
        state.currentModel = customModelInput.value;
        saveState();
    }

    // Update key status indicator
    function updateKeyStatus() {
        const statusDiv = document.getElementById('keyStatus');
        const provider = AI_PROVIDERS[state.currentProvider];
        const keyName = provider.keyName;
        const key = localStorage.getItem(keyName) || sessionStorage.getItem(keyName);

        if (key) {
            statusDiv.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Key å·²é…ç½®</span>`;
        } else {
            statusDiv.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>æœªé…ç½® Key Â· <a href="../key-manager.html" class="underline">å»é…ç½®</a></span>`;
        }
    }

    // Update word count
    function updateWordCount() {
        const input = document.getElementById('notesInput');
        const text = input.value;
        const charCount = text.length;
        const noteCount = countNotes(text);

        document.getElementById('charCount').textContent = charCount;
        document.getElementById('noteCount').textContent = noteCount;

        // Update status
        const wordCountDiv = document.getElementById('wordCount');
        const statusText = document.getElementById('statusText');

        wordCountDiv.classList.remove('warning', 'error', 'success');

        if (charCount === 0) {
            statusText.textContent = 'ç­‰å¾…è¾“å…¥...';
        } else if (charCount < 100) {
            wordCountDiv.classList.add('warning');
            statusText.textContent = 'å†…å®¹è¾ƒå°‘ï¼Œå»ºè®®æ·»åŠ æ›´å¤š';
        } else if (charCount > 50000) {
            wordCountDiv.classList.add('error');
            statusText.textContent = 'å†…å®¹è¿‡é•¿ï¼Œå»ºè®®ç­›é€‰';
        } else {
            wordCountDiv.classList.add('success');
            statusText.textContent = 'âœ… é€‚åˆåˆ†æ';
        }
    }

    // Render history
    function renderHistory() {
        const historyArea = document.getElementById('historyArea');
        const historyList = document.getElementById('historyList');

        if (state.noteHistory.length === 0) {
            historyArea.classList.add('hidden');
            return;
        }

        historyArea.classList.remove('hidden');
        historyList.innerHTML = state.noteHistory.map(entry => `
            <button onclick="loadFromHistory(${entry.id})"
                    class="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs text-gray-600 transition-colors">
                ${formatDate(entry.timestamp)} (${formatCharCount(entry.charCount)}å­—)
            </button>
        `).join('');
    }

    // Load from history
    function loadFromHistory(id) {
        const entry = state.noteHistory.find(e => e.id === id);
        if (entry) {
            // We need to store full content, not just preview
            // For now, show a message
            alert('å†å²è®°å½•åŠŸèƒ½éœ€è¦å®Œæ•´å®ç°ã€‚å½“å‰ä»…ä¿å­˜é¢„è§ˆã€‚');
        }
    }

    // Clear history
    function clearHistory() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
            state.noteHistory = [];
            saveState();
            renderHistory();
        }
    }

    // Show loading state
    function showLoading(showProgress = false) {
        state.isLoading = true;
        const resultSection = document.getElementById('resultSection');
        const loadingState = document.getElementById('loadingState');
        const resultContent = document.getElementById('resultContent');
        const errorState = document.getElementById('errorState');
        const continueArea = document.getElementById('continueArea');
        const progressSteps = document.getElementById('progressSteps');

        resultSection.classList.remove('hidden');
        loadingState.classList.remove('hidden');
        resultContent.classList.add('hidden');
        errorState.classList.add('hidden');
        continueArea.classList.add('hidden');

        if (showProgress) {
            progressSteps.classList.remove('hidden');
            updateProgressStep(1, 'active');
            updateProgressStep(2, 'pending');
            updateProgressStep(3, 'pending');
        } else {
            progressSteps.classList.add('hidden');
        }
    }

    // Update progress step
    function updateProgressStep(step, status) {
        const stepEl = document.getElementById(`step${step}`);
        stepEl.classList.remove('completed', 'active', 'pending');
        stepEl.classList.add(status);

        const icon = stepEl.querySelector('i');
        if (status === 'completed') {
            icon.className = 'fas fa-check-circle text-xs';
        } else if (status === 'active') {
            icon.className = 'fas fa-spinner fa-spin text-xs';
        } else {
            icon.className = 'fas fa-circle text-xs';
        }
    }

    // Show error state
    function showError(message) {
        state.isLoading = false;
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');

        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('errorMessage').textContent = message;
    }

    // Show result
    function showResult(result, mode) {
        state.isLoading = false;
        state.lastResult = result;

        const loadingState = document.getElementById('loadingState');
        const resultContent = document.getElementById('resultContent');
        const continueArea = document.getElementById('continueArea');

        loadingState.classList.add('hidden');
        resultContent.classList.remove('hidden');

        // Update title
        const modeConfig = MODE_CONFIG[mode] || MODE_CONFIG.deep_dive;
        document.getElementById('resultTitle').innerHTML = `<i class="fas fa-file-alt text-blue-500 mr-2"></i>${modeConfig.icon} ${modeConfig.name} ç»“æœ`;

        // Render markdown
        resultContent.innerHTML = marked.parse(result);

        // Show continue area for certain modes
        if (['cluster', 'insight', 'timeline'].includes(mode)) {
            continueArea.classList.remove('hidden');
        } else {
            continueArea.classList.add('hidden');
        }

        // Scroll to result
        document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    </script>
    <script>
    // ==================== Event Handlers ====================

    // Load sample data
    function loadSampleData() {
        document.getElementById('notesInput').value = SAMPLE_NOTES;
        updateWordCount();
    }

    // Select mode
    function selectMode(modeId) {
        // Update UI
        document.querySelectorAll('.mode-card').forEach(card => {
            card.classList.remove('active');
        });
        const selectedCard = document.querySelector(`[data-mode="${modeId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('active');
        }

        state.currentMode = modeId;

        // Show/hide extra inputs
        const extraInputArea = document.getElementById('extraInputArea');
        const periodSelector = document.getElementById('periodSelector');
        const executeBtnArea = document.getElementById('executeBtnArea');

        extraInputArea.classList.add('hidden');
        periodSelector.classList.add('hidden');

        if (modeId === 'timeline') {
            extraInputArea.classList.remove('hidden');
            document.getElementById('extraInputLabel').textContent = 'èšç„¦ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰';
            document.getElementById('extraInput').placeholder = 'ä¾‹å¦‚ï¼šé¡¹ç›® Aã€AI å·¥å…·...';
        } else if (modeId === 'summary') {
            periodSelector.classList.remove('hidden');
        }

        // Show execute button
        executeBtnArea.classList.remove('hidden');
        const modeConfig = MODE_CONFIG[modeId];
        document.getElementById('executeBtnText').textContent = `æ‰§è¡Œã€Œ${modeConfig.name}ã€`;
    }

    // Set period for summary
    function setPeriod(period) {
        state.currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('border-gray-300');
        });
        const selectedBtn = document.querySelector(`[data-period="${period}"]`);
        if (selectedBtn) {
            selectedBtn.classList.remove('border-gray-300');
            selectedBtn.classList.add('bg-blue-500', 'text-white');
        }
    }

    // Execute search
    async function executeSearch() {
        const notes = document.getElementById('notesInput').value.trim();
        const question = document.getElementById('searchInput').value.trim();

        if (!notes) {
            alert('è¯·å…ˆè¾“å…¥ç¬”è®°å†…å®¹');
            return;
        }
        if (!question) {
            alert('è¯·è¾“å…¥æœç´¢é—®é¢˜');
            return;
        }

        showLoading();
        document.getElementById('resultTitle').innerHTML = `<i class="fas fa-file-alt text-blue-500 mr-2"></i>ğŸ” æ™ºèƒ½æ£€ç´¢ ç»“æœ`;

        try {
            const result = await callAI('search', notes, { question });
            showResult(result, 'search');
            saveNotesToHistory(notes);
        } catch (error) {
            showError(error.message);
        }
    }

    // Execute mode
    async function executeMode() {
        if (!state.currentMode) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ææ¨¡å¼');
            return;
        }

        const notes = document.getElementById('notesInput').value.trim();
        if (!notes) {
            alert('è¯·å…ˆè¾“å…¥ç¬”è®°å†…å®¹');
            return;
        }

        showLoading();

        try {
            const extraParams = {};

            if (state.currentMode === 'timeline') {
                const focus = document.getElementById('extraInput').value.trim();
                if (focus) extraParams.focus = focus;
            } else if (state.currentMode === 'summary') {
                extraParams.period = state.currentPeriod;
            }

            const result = await callAI(state.currentMode, notes, extraParams);
            showResult(result, state.currentMode);
            saveNotesToHistory(notes);
        } catch (error) {
            showError(error.message);
        }
    }

    // Execute deep dive (one-click)
    async function executeDeepDive() {
        const notes = document.getElementById('notesInput').value.trim();
        if (!notes) {
            alert('è¯·å…ˆè¾“å…¥ç¬”è®°å†…å®¹');
            return;
        }

        showLoading(true);

        try {
            const result = await callAI('deep_dive', notes);
            showResult(result, 'deep_dive');
            saveNotesToHistory(notes);
        } catch (error) {
            showError(error.message);
        }
    }

    // Continue with another mode
    async function continueWithMode(mode) {
        const notes = document.getElementById('notesInput').value.trim();
        if (!notes) {
            alert('è¯·å…ˆè¾“å…¥ç¬”è®°å†…å®¹');
            return;
        }

        state.currentMode = mode;
        showLoading();

        try {
            const result = await callAI(mode, notes);
            showResult(result, mode);
        } catch (error) {
            showError(error.message);
        }
    }

    // Retry analysis
    function retryAnalysis() {
        if (state.currentMode) {
            executeMode();
        }
    }

    // Copy result
    function copyResult() {
        if (!state.lastResult) return;
        navigator.clipboard.writeText(state.lastResult).then(() => {
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    }

    // Download result
    function downloadResult() {
        if (!state.lastResult) return;

        const modeConfig = MODE_CONFIG[state.currentMode] || { name: 'åˆ†æç»“æœ' };
        const blob = new Blob([state.lastResult], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${modeConfig.name}_${new Date().toISOString().slice(0, 10)}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Handle Enter key in search input
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeSearch();
                }
            });
        }
    });
    </script>
    <script>
    // ==================== Initialization ====================

    function init() {
        // Load saved state
        loadState();

        // Set up provider selector
        const providerSelect = document.getElementById('providerSelect');
        if (providerSelect) {
            providerSelect.value = state.currentProvider;
            updateModelSelector();

            // Restore saved model if available
            if (state.currentModel) {
                const modelSelect = document.getElementById('modelSelect');
                const option = Array.from(modelSelect.options).find(opt => opt.value === state.currentModel);
                if (option) {
                    modelSelect.value = state.currentModel;
                }
            }
        }

        // Set up word count listener
        const notesInput = document.getElementById('notesInput');
        if (notesInput) {
            notesInput.addEventListener('input', updateWordCount);
            updateWordCount();
        }

        // Render history
        renderHistory();

        // Set default period
        setPeriod('å‘¨');

        console.log('DeepNote v3.0 åˆå§‹åŒ–å®Œæˆ');
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', init);
    </script>
        <!-- Footer -->
        <footer class="text-center py-6 text-gray-400 text-sm">
            <p>Powered by AI Â· Built with â¤ï¸ Â· æ•°æ®ä»…å­˜æœ¬åœ°</p>
            <p class="mt-1 text-xs">
                åŸºäº <a href="https://karpathy.ai/blog/append-only.html" target="_blank" class="hover:text-blue-500">Karpathy</a> å’Œ
                <a href="#" class="hover:text-blue-500">é©¬ä¼¯åº¸</a> çš„ Append-and-Review ç¬”è®°æ³•
            </p>
        </footer>
    </main>
</body>
</html>
